name: Force Update Server Files

on:
  workflow_dispatch:

jobs:
  force-update:
    runs-on: ubuntu-latest
    
    steps:
    - name: Force update server files
      uses: appleboy/ssh-action@v1.0.0
      with:
        host: ${{ secrets.SERVER_HOST }}
        username: ${{ secrets.SERVER_USER }}
        password: ${{ secrets.SERVER_PASSWORD }}
        port: ${{ secrets.SERVER_PORT }}
        script: |
          echo "üîÑ –ü–†–ò–ù–£–î–ò–¢–ï–õ–¨–ù–û–ï –û–ë–ù–û–í–õ–ï–ù–ò–ï –°–ï–†–í–ï–†–ê"
          echo "===================================="
          
          cd /var/www/bot_business_card
          
          # –ü–æ–∫–∞–∑—ã–≤–∞–µ–º —Ç–µ–∫—É—â–µ–µ —Å–æ—Å—Ç–æ—è–Ω–∏–µ
          echo "üìç –¢–µ–∫—É—â–∏–π –∫–æ–º–º–∏—Ç:"
          git log -1 --oneline
          
          echo "üìã Git —Å—Ç–∞—Ç—É—Å:"
          git status
          
          # –ü–†–ò–ù–£–î–ò–¢–ï–õ–¨–ù–û —Å–±—Ä–∞—Å—ã–≤–∞–µ–º –≤—Å–µ –∏–∑–º–µ–Ω–µ–Ω–∏—è
          echo "üîÑ –°–±—Ä–∞—Å—ã–≤–∞–µ–º –ª–æ–∫–∞–ª—å–Ω—ã–µ –∏–∑–º–µ–Ω–µ–Ω–∏—è..."
          git stash
          git reset --hard HEAD
          git clean -fd
          
          # –ü–†–ò–ù–£–î–ò–¢–ï–õ–¨–ù–û –ø–æ–ª—É—á–∞–µ–º –ø–æ—Å–ª–µ–¥–Ω–∏–µ –∏–∑–º–µ–Ω–µ–Ω–∏—è
          echo "üì• –ü—Ä–∏–Ω—É–¥–∏—Ç–µ–ª—å–Ω–æ –ø–æ–ª—É—á–∞–µ–º –∏–∑–º–µ–Ω–µ–Ω–∏—è..."
          git fetch --all
          git reset --hard origin/main
          
          # –ü—Ä–æ–≤–µ—Ä—è–µ–º —á—Ç–æ –ø–æ–ª—É—á–∏–ª–∏
          echo "‚úÖ –ù–æ–≤—ã–π –∫–æ–º–º–∏—Ç:"
          git log -1 --oneline
          
          # –ü—Ä–æ–≤–µ—Ä—è–µ–º –Ω–∞—à —Ñ–∞–π–ª
          echo "üîç –ü—Ä–æ–≤–µ—Ä—è–µ–º avito_messenger.html:"
          if grep -q "üö® –û–¢–õ–ê–î–ö–ê" app/admin/templates/avito_messenger.html; then
            echo "‚úÖ DEBUG –ë–õ–û–ö –ù–ê–ô–î–ï–ù!"
            echo "‚úÖ –†–∞–∑–º–µ—Ä —Ñ–∞–π–ª–∞: $(wc -c < app/admin/templates/avito_messenger.html) bytes"
          else
            echo "‚ùå –§–ê–ô–õ –í–°–Å–©–ï –ù–ï –û–ë–ù–û–í–õ–Å–ù!"
            echo "üìù –ü–µ—Ä–≤—ã–µ 10 —Å—Ç—Ä–æ–∫:"
            head -10 app/admin/templates/avito_messenger.html
          fi
          
          # –ü–µ—Ä–µ–∑–∞–ø—É—Å–∫–∞–µ–º PM2 –¥–ª—è –ø—Ä–∏–º–µ–Ω–µ–Ω–∏—è –∏–∑–º–µ–Ω–µ–Ω–∏–π
          echo "üöÄ –ü–µ—Ä–µ–∑–∞–ø—É—Å–∫–∞–µ–º PM2..."
          pm2 restart bot-business-card
          
          # –ñ–¥–µ–º –∑–∞–ø—É—Å–∫–∞
          sleep 5
          
          # –ü—Ä–æ–≤–µ—Ä—è–µ–º —Å—Ç–∞—Ç—É—Å
          echo "üìä PM2 —Å—Ç–∞—Ç—É—Å:"
          pm2 status
          
          echo "‚úÖ –ü–†–ò–ù–£–î–ò–¢–ï–õ–¨–ù–û–ï –û–ë–ù–û–í–õ–ï–ù–ò–ï –ó–ê–í–ï–†–®–ï–ù–û!"