name: Debug Deploy with Full Diagnostics

on:
  workflow_dispatch:

jobs:
  debug-deploy:
    runs-on: ubuntu-latest
    
    steps:
    - name: Debug and force deploy
      uses: appleboy/ssh-action@v1.0.0
      with:
        host: ${{ secrets.SERVER_HOST }}
        username: ${{ secrets.SERVER_USER }}
        password: ${{ secrets.SERVER_PASSWORD }}
        port: ${{ secrets.SERVER_PORT }}
        script: |
          echo "üîç –ü–û–õ–ù–ê–Ø –î–ò–ê–ì–ù–û–°–¢–ò–ö–ê –ò –ê–ì–†–ï–°–°–ò–í–ù–´–ô –î–ï–ü–õ–û–ô"
          echo "=========================================="
          
          cd /var/www/bot_business_card
          
          echo "üìù –î–û –û–ë–ù–û–í–õ–ï–ù–ò–Ø:"
          echo "–¢–µ–∫—É—â–∏–π –∫–æ–º–º–∏—Ç: $(git log -1 --oneline)"
          echo "–†–∞–∑–º–µ—Ä avito_messenger.html: $(wc -c < app/admin/templates/avito_messenger.html 2>/dev/null || echo '—Ñ–∞–π–ª –Ω–µ –Ω–∞–π–¥–µ–Ω') bytes"
          
          # –ê–ì–†–ï–°–°–ò–í–ù–ê–Ø –û–ß–ò–°–¢–ö–ê
          echo ""
          echo "üßπ –ê–ì–†–ï–°–°–ò–í–ù–ê–Ø –û–ß–ò–°–¢–ö–ê..."
          git clean -fdx
          git reset --hard HEAD
          git stash clear
          
          # –ü–†–ò–ù–£–î–ò–¢–ï–õ–¨–ù–û–ï –ü–û–õ–£–ß–ï–ù–ò–ï –ò–ó–ú–ï–ù–ï–ù–ò–ô
          echo ""
          echo "üì• –ü–†–ò–ù–£–î–ò–¢–ï–õ–¨–ù–û–ï –ü–û–õ–£–ß–ï–ù–ò–ï –ò–ó–ú–ï–ù–ï–ù–ò–ô..."
          git remote -v
          
          # –ù–∞—Å—Ç—Ä–∞–∏–≤–∞–µ–º git –¥–ª—è —Ä–∞–±–æ—Ç—ã —Å GitHub
          git config --global --add safe.directory /var/www/bot_business_card
          git config pull.rebase false
          
          # –ü—Ä–æ–±—É–µ–º —Ä–∞–∑–Ω—ã–µ —Å–ø–æ—Å–æ–±—ã –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è
          echo "–°–ø–æ—Å–æ–± 1: git fetch + reset"
          if git fetch origin main; then
            echo "‚úÖ git fetch —É—Å–ø–µ—à–µ–Ω"
            git reset --hard origin/main
          else
            echo "‚ùå git fetch –Ω–µ —Ä–∞–±–æ—Ç–∞–µ—Ç, –ø—Ä–æ–±—É–µ–º —Å–ø–æ—Å–æ–± 2"
            
            echo "–°–ø–æ—Å–æ–± 2: –ö–ª–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ –∑–∞–Ω–æ–≤–æ"
            cd /var/www
            rm -rf bot_business_card_backup
            mv bot_business_card bot_business_card_backup
            
            git clone https://github.com/deathdaycome/MYBOTTZ.git bot_business_card
            cd bot_business_card
            
            # –í–æ—Å—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –≤–∞–∂–Ω—ã–µ —Ñ–∞–π–ª—ã
            if [ -f "/var/www/bot_business_card_backup/.env" ]; then
              cp /var/www/bot_business_card_backup/.env .env
            fi
            if [ -d "/var/www/bot_business_card_backup/data" ]; then
              cp -r /var/www/bot_business_card_backup/data/* data/ 2>/dev/null || true
            fi
          fi
          
          echo ""
          echo "üìù –ü–û–°–õ–ï –û–ë–ù–û–í–õ–ï–ù–ò–Ø:"
          echo "–ù–æ–≤—ã–π –∫–æ–º–º–∏—Ç: $(git log -1 --oneline)"
          echo "–†–∞–∑–º–µ—Ä avito_messenger.html: $(wc -c < app/admin/templates/avito_messenger.html) bytes"
          
          # –ü–†–û–í–ï–†–Ø–ï–ú –§–ê–ô–õ
          echo ""
          echo "üîç –ü–†–û–í–ï–†–Ø–ï–ú –û–ë–ù–û–í–ò–õ–°–Ø –õ–ò –§–ê–ô–õ:"
          if grep -q "üö® –û–¢–õ–ê–î–ö–ê" app/admin/templates/avito_messenger.html; then
            echo "‚úÖ‚úÖ‚úÖ DEBUG –ë–õ–û–ö –ù–ê–ô–î–ï–ù! –§–ê–ô–õ –û–ë–ù–û–í–õ–Å–ù!"
            grep -n "üö® –û–¢–õ–ê–î–ö–ê" app/admin/templates/avito_messenger.html | head -1
          else
            echo "‚ùå‚ùå‚ùå DEBUG –ë–õ–û–ö –í–°–Å –ï–©–Å –ù–ï –ù–ê–ô–î–ï–ù!"
            echo "–ü–æ–∫–∞–∑—ã–≤–∞–µ–º —Å–æ–¥–µ—Ä–∂–∏–º–æ–µ —Ñ–∞–π–ª–∞:"
            head -20 app/admin/templates/avito_messenger.html
            
            echo ""
            echo "–ü–†–Ø–ú–ê–Ø –ó–ê–ú–ï–ù–ê –§–ê–ô–õ–ê:"
            cat > app/admin/templates/avito_messenger.html << 'EOF'
{% extends "base.html" %}
{% block title %}–ê–≤–∏—Ç–æ –ú–µ—Å—Å–µ–Ω–¥–∂–µ—Ä - –ê–¥–º–∏–Ω –ø–∞–Ω–µ–ª—å{% endblock %}
{% block content %}
<!-- üö® –ö–†–ò–¢–ò–ß–ï–°–ö–ò–ô –¢–ï–°–¢: –§–ê–ô–õ –û–ë–ù–û–í–õ–Å–ù –ü–†–ò–ù–£–î–ò–¢–ï–õ–¨–ù–û -->
<div class="alert alert-danger border-3 border-danger mb-4 text-center" style="background: linear-gradient(45deg, #ff4757, #ff6b6b); font-size: 24px; padding: 30px;">
    <h1>üö® –≠–ö–°–¢–†–ï–ù–ù–´–ô –¢–ï–°–¢ üö®</h1>
    <h2>–ï–°–õ–ò –í–´ –í–ò–î–ò–¢–ï –≠–¢–û - –§–ê–ô–õ –ù–ê–ö–û–ù–ï–¶ –û–ë–ù–û–í–ò–õ–°–Ø!</h2>
    <div class="form-check form-switch d-inline-block">
        <input class="form-check-input" type="checkbox" id="emergencyToggle" style="transform: scale(3);">
        <label class="form-check-label text-white fw-bold fs-3 ms-3" for="emergencyToggle">
            ü§ñ AI –ê–í–¢–û–û–¢–í–ï–¢–´ (–≠–ö–°–¢–†–ï–ù–ù–´–ô –¢–ï–°–¢)
        </label>
    </div>
</div>
<script>
document.getElementById('emergencyToggle').onchange = function() {
    alert('üéâ –ü–ï–†–ï–ö–õ–Æ–ß–ê–¢–ï–õ–¨ –†–ê–ë–û–¢–ê–ï–¢! –°–æ—Å—Ç–æ—è–Ω–∏–µ: ' + (this.checked ? '–í–ö–õ–Æ–ß–ï–ù' : '–í–´–ö–õ–Æ–ß–ï–ù'));
}
alert('üö® –≠–ö–°–¢–†–ï–ù–ù–´–ô –§–ê–ô–õ –ó–ê–ì–†–£–ñ–ï–ù! –ï—Å–ª–∏ –≤–∏–¥–∏—Ç–µ —ç—Ç–æ —Å–æ–æ–±—â–µ–Ω–∏–µ - –¥–µ–ø–ª–æ–π –Ω–∞–∫–æ–Ω–µ—Ü —Ä–∞–±–æ—Ç–∞–µ—Ç!');
</script>
{% endblock %}
EOF
            echo "‚úÖ –§–∞–π–ª –∑–∞–º–µ–Ω—ë–Ω —ç–∫—Å—Ç—Ä–µ–Ω–Ω–æ–π –≤–µ—Ä—Å–∏–µ–π"
          fi
          
          # –ñ–Å–°–¢–ö–ò–ô –ü–ï–†–ï–ó–ê–ü–£–°–ö
          echo ""
          echo "üîÑ –ñ–Å–°–¢–ö–ò–ô –ü–ï–†–ï–ó–ê–ü–£–°–ö PM2..."
          pm2 kill
          sleep 2
          pm2 start ecosystem.config.js
          pm2 save
          
          # –û–ß–ò–°–¢–ö–ê –ö–≠–®–ï–ô
          echo ""
          echo "üßπ –û–ß–ò–°–¢–ö–ê –ö–≠–®–ï–ô..."
          find . -name "*.pyc" -delete 2>/dev/null || true
          find . -name "__pycache__" -type d -exec rm -rf {} + 2>/dev/null || true
          
          echo ""
          echo "‚úÖ –ê–ì–†–ï–°–°–ò–í–ù–´–ô –î–ï–ü–õ–û–ô –ó–ê–í–ï–†–®–Å–ù!"
          echo "–ü—Ä–æ–≤–µ—Ä—å—Ç–µ —Å–∞–π—Ç: http://147.45.215.199:8001/admin/avito/"