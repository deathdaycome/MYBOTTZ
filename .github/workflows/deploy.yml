name: Deploy to Server

on:
  push:
    branches: [ main ]
  workflow_dispatch:  # Позволяет запускать workflow вручную

jobs:
  deploy:
    runs-on: ubuntu-latest
    
    steps:
    - name: Deploy to server via SSH
      uses: appleboy/ssh-action@v1.0.0
      with:
        host: ${{ secrets.SERVER_HOST }}
        username: ${{ secrets.SERVER_USER }}
        password: ${{ secrets.SERVER_PASSWORD }}
        port: ${{ secrets.SERVER_PORT }}
        script: |
          # Удаляем старую директорию из /root если она есть
          if [ -d "/root/bot_business_card" ]; then
            echo "Удаляем старую директорию из /root..."
            rm -rf /root/bot_business_card
          fi
          
          # Переходим в правильную директорию проекта
          cd /var/www/bot_business_card
          
          # Проверяем что мы в правильной директории
          pwd
          ls -la
          
          # Сохраняем локальные изменения (если есть)
          git stash
          
          # Получаем последние изменения
          git pull origin main
          
          # Восстанавливаем локальные изменения
          git stash pop || true
          
          # Создаем виртуальное окружение если его нет
          if [ ! -d "venv" ]; then
            echo "Создаем виртуальное окружение..."
            python3 -m venv venv
          fi
          
          # Активируем виртуальное окружение
          source venv/bin/activate
          
          # Обновляем pip и установщики
          pip install --upgrade pip setuptools wheel
          
          # Обновляем зависимости
          pip install -r requirements.txt
          
          # Дополнительно устанавливаем python-telegram-bot на случай если не установился
          pip install python-telegram-bot
          
          # Проверяем наличие .env файла и токена
          if [ ! -f ".env" ]; then
            echo "⚠️ Внимание: .env файл не найден! Бот не запустится без токенов."
            echo "Скопируйте .env файл с локальной машины на сервер"
          else
            echo "✅ .env файл найден"
            # Проверяем наличие BOT_TOKEN в файле
            if grep -q "BOT_TOKEN=" .env; then
              echo "✅ BOT_TOKEN найден в .env"
              # Показываем первые символы токена для проверки (безопасно)
              grep "BOT_TOKEN=" .env | head -c 30
              echo "..."
            else
              echo "❌ BOT_TOKEN НЕ найден в .env файле!"
            fi
            # Проверяем права доступа к файлу
            ls -la .env
          fi
          
          # Очищаем кэш Python для применения изменений
          find . -type d -name "__pycache__" -exec rm -rf {} + 2>/dev/null || true
          find . -type f -name "*.pyc" -delete 2>/dev/null || true
          
          # Выполняем миграции базы данных (если нужно)
          # python -m alembic upgrade head
          
          # Полностью останавливаем и удаляем процесс
          pm2 stop bot-business-card || true
          pm2 delete bot-business-card || true
          
          # Загружаем переменные из .env и запускаем PM2
          set -a
          source .env
          set +a
          
          # Запускаем PM2 с передачей переменных окружения
          pm2 start /var/www/bot_business_card/venv/bin/python \
            --name bot-business-card \
            --interpreter none \
            --cwd /var/www/bot_business_card \
            --update-env \
            -- -m app.main
          
          # Сохраняем конфигурацию PM2
          pm2 save
          
          # Проверяем статус
          pm2 status
          
          # Ждем немного для запуска
          sleep 3
          
          # Показываем последние логи
          pm2 logs bot-business-card --lines 20 --nostream
          
          # Показываем информацию о процессе
          pm2 info bot-business-card || true
          
          # Проверяем переменные окружения процесса
          echo "Проверка переменных окружения PM2 процесса:"
          pm2 env 0 | grep -E "(BOT_TOKEN|DATABASE_URL|ADMIN)" | head -5 || true
          
          echo "✅ Деплой завершен успешно! Бот перезапущен через PM2"