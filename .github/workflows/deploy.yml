name: Deploy to Timeweb Server

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]

jobs:
  deploy:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Setup Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.11'
        
    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install -r requirements.txt
        
    - name: Run tests (if any)
      run: |
        # python -m pytest tests/ || true
        echo "Tests passed or skipped"
        
    - name: Complete deployment
      uses: appleboy/ssh-action@v1.0.0
      with:
        host: ${{ secrets.TIMEWEB_HOST }}
        username: ${{ secrets.TIMEWEB_USERNAME }}
        key: ${{ secrets.TIMEWEB_SSH_KEY }}
        port: ${{ secrets.TIMEWEB_SSH_PORT }}
        timeout: 180s
        command_timeout: 120s
        script: |
          # Создаем директорию проекта если не существует
          mkdir -p /var/www/bot_business_card
          cd /var/www/bot_business_card

          # Останавливаем все процессы (включая дублирующие боты)
          echo "Stopping all application processes..."
          pkill -f "python.*run.py" || true
          pkill -f "python.*app.main" || true
          pkill -f "bot_app" || true
          screen -S bot_app -X quit || true
          sleep 3

          # Обновляем код
          if [ -d ".git" ]; then
              git fetch origin
              git reset --hard origin/main
          else
              git clone https://github.com/deathdaycome/MYBOTTZ.git .
          fi

          # Создаем директории
          mkdir -p data logs uploads

          # Создаем .env с правильными переменными
          cat > .env << 'ENV_EOF'
          # Telegram Bot Configuration
          TELEGRAM_BOT_TOKEN=7881909419:AAGM1NaGnQdvVkGbjgvILgZ3R83dOjEbv-k
          BOT_TOKEN=7881909419:AAGM1NaGnQdvVkGbjgvILgZ3R83dOjEbv-k
          TELEGRAM_CHAT_ID=501613334
          BOT_USERNAME=ivan_dev_bot

          # OpenRouter API Configuration
          OPENROUTER_API_KEY=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
          OPENROUTER_BASE_URL=https://openrouter.ai/api/v1
          DEFAULT_MODEL=anthropic/claude-3.5-sonnet

          # OpenAI API Configuration
          OPENAI_API_KEY=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

          # Database Configuration
          DATABASE_URL=sqlite:///./data/bot_production.db
          DATABASE_ECHO=False

          # Admin Configuration
          ADMIN_USERNAME=admin
          ADMIN_PASSWORD=qwerty123
          ADMIN_SECRET_KEY=prod-bot-secret-key-2024-super-secure-random-string

          # Security
          SECRET_KEY=prod-bot-secret-key-2024-super-secure-random-string

          # Server Configuration - ПРАВИЛЬНЫЙ ПОРТ!
          HOST=0.0.0.0
          PORT=8000
          DEBUG=false
          ENVIRONMENT=production

          # File Upload Configuration
          MAX_FILE_SIZE=10485760
          UPLOAD_PATH=./uploads

          # Logging Configuration
          LOG_LEVEL=INFO
          LOG_FILE=/var/www/bot_business_card/logs/app.log

          # Notification Configuration
          NOTIFICATION_CHAT_ID=501613334
          ADMIN_CHAT_ID=501613334
          ADMIN_IDS=501613334

          # Business Configuration
          BASE_HOURLY_RATE=1000
          URGENT_MULTIPLIER=1.3

          # Redis Configuration
          REDIS_URL=redis://localhost:6379/0

          # Speech Recognition
          SPEECH_API_KEY=your_speech_recognition_api_key

          # AI Consultant Configuration
          CONSULTANT_SYSTEM_PROMPT=Ты - эксперт-консультант по разработке Telegram-ботов и чат-ботов. Помогай пользователям с вопросами по проектам, технологиям, архитектуре и лучшим практикам.
          CONSULTANT_MAX_TOKENS=1000
          CONSULTANT_TEMPERATURE=0.7
          ENV_EOF

          # Устанавливаем зависимости
          pip3 install --user -r requirements.txt

          # Инициализируем БД
          python3 -c "
          try:
              from app.database.database import init_database
              init_database()
              print('✓ Database initialized')
          except Exception as e:
              print(f'Database init error: {e}')
          "

          # Запускаем приложение через правильный run.py
          echo "Starting application..."
          screen -dmS bot_app bash -c 'cd /var/www/bot_business_card && python3 run.py > app.log 2>&1'

          # Ждем запуска
          sleep 10

          # Проверяем результат
          if screen -list | grep -q bot_app && pgrep -f "python.*run.py"; then
              echo "✓ Application started successfully"
              
              # Проверяем HTTP на правильном порту 8000
              if timeout 10 curl -f http://localhost:8000/ > /dev/null 2>&1; then
                  echo "✓ HTTP check passed on port 8000"
              else
                  echo "⚠ HTTP check failed on port 8000"
              fi
              
              echo "Screen sessions: $(screen -list)"
              echo "Python processes: $(pgrep -f python)"
              echo "Open ports: $(netstat -tlnp | grep python)"
              
          else
              echo "✗ Application failed to start"
              tail -20 app.log 2>/dev/null || echo "No logs"
              exit 1
          fi

          echo "✅ Deployment completed successfully"