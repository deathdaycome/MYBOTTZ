name: Deploy to Server

on:
  push:
    branches: [ main ]
  workflow_dispatch:  # ÐŸÐ¾Ð·Ð²Ð¾Ð»ÑÐµÑ‚ Ð·Ð°Ð¿ÑƒÑÐºÐ°Ñ‚ÑŒ workflow Ð²Ñ€ÑƒÑ‡Ð½ÑƒÑŽ (Ð¾Ð±Ð½Ð¾Ð²Ð»ÐµÐ½Ð¾ Ð´Ð»Ñ Ð¿Ñ€Ð¸Ð½ÑƒÐ´Ð¸Ñ‚ÐµÐ»ÑŒÐ½Ð¾Ð³Ð¾ Ð´ÐµÐ¿Ð»Ð¾Ñ)

jobs:
  deploy:
    runs-on: ubuntu-latest
    
    steps:
    - name: Deploy to server via SSH
      uses: appleboy/ssh-action@v1.0.0
      with:
        host: ${{ secrets.SERVER_HOST }}
        username: ${{ secrets.SERVER_USER }}
        password: ${{ secrets.SERVER_PASSWORD }}
        port: ${{ secrets.SERVER_PORT }}
        script: |
          # Ð£Ð´Ð°Ð»ÑÐµÐ¼ ÑÑ‚Ð°Ñ€ÑƒÑŽ Ð´Ð¸Ñ€ÐµÐºÑ‚Ð¾Ñ€Ð¸ÑŽ Ð¸Ð· /root ÐµÑÐ»Ð¸ Ð¾Ð½Ð° ÐµÑÑ‚ÑŒ
          if [ -d "/root/bot_business_card" ]; then
            echo "Ð£Ð´Ð°Ð»ÑÐµÐ¼ ÑÑ‚Ð°Ñ€ÑƒÑŽ Ð´Ð¸Ñ€ÐµÐºÑ‚Ð¾Ñ€Ð¸ÑŽ Ð¸Ð· /root..."
            rm -rf /root/bot_business_card
          fi
          
          # ÐŸÐµÑ€ÐµÑ…Ð¾Ð´Ð¸Ð¼ Ð² Ð¿Ñ€Ð°Ð²Ð¸Ð»ÑŒÐ½ÑƒÑŽ Ð´Ð¸Ñ€ÐµÐºÑ‚Ð¾Ñ€Ð¸ÑŽ Ð¿Ñ€Ð¾ÐµÐºÑ‚Ð°
          cd /var/www/bot_business_card
          
          # ÐŸÑ€Ð¾Ð²ÐµÑ€ÑÐµÐ¼ Ñ‡Ñ‚Ð¾ Ð¼Ñ‹ Ð² Ð¿Ñ€Ð°Ð²Ð¸Ð»ÑŒÐ½Ð¾Ð¹ Ð´Ð¸Ñ€ÐµÐºÑ‚Ð¾Ñ€Ð¸Ð¸
          pwd
          ls -la
          
          # Ð¡ÐžÐ¥Ð ÐÐÐ¯Ð•Ðœ Ð‘ÐÐ—Ð£ Ð”ÐÐÐÐ«Ð¥ ÐŸÐ•Ð Ð•Ð” ÐžÐ‘ÐÐžÐ’Ð›Ð•ÐÐ˜Ð•Ðœ
          echo "ðŸ“ Ð¡Ð¾Ñ…Ñ€Ð°Ð½ÑÐµÐ¼ Ñ‚ÐµÐºÑƒÑ‰ÑƒÑŽ Ð±Ð°Ð·Ñƒ Ð´Ð°Ð½Ð½Ñ‹Ñ…..."
          if [ -f "business_card_bot.db" ]; then
            cp business_card_bot.db business_card_bot_backup.db
            echo "âœ… Ð‘Ð°Ð·Ð° Ð´Ð°Ð½Ð½Ñ‹Ñ… ÑÐ¾Ñ…Ñ€Ð°Ð½ÐµÐ½Ð° Ð² business_card_bot_backup.db"
            ls -la *.db
          else
            echo "âš ï¸ Ð‘Ð°Ð·Ð° Ð´Ð°Ð½Ð½Ñ‹Ñ… Ð½Ðµ Ð½Ð°Ð¹Ð´ÐµÐ½Ð° Ð´Ð»Ñ Ñ€ÐµÐ·ÐµÑ€Ð²Ð½Ð¾Ð³Ð¾ ÐºÐ¾Ð¿Ð¸Ñ€Ð¾Ð²Ð°Ð½Ð¸Ñ"
          fi
          
          # Ð¡Ð¾Ñ…Ñ€Ð°Ð½ÑÐµÐ¼ Ð»Ð¾ÐºÐ°Ð»ÑŒÐ½Ñ‹Ðµ Ð¸Ð·Ð¼ÐµÐ½ÐµÐ½Ð¸Ñ (ÐµÑÐ»Ð¸ ÐµÑÑ‚ÑŒ)
          git stash
          
          # ÐŸÐ¾Ð»ÑƒÑ‡Ð°ÐµÐ¼ Ð¿Ð¾ÑÐ»ÐµÐ´Ð½Ð¸Ðµ Ð¸Ð·Ð¼ÐµÐ½ÐµÐ½Ð¸Ñ
          git pull origin main
          
          # ÐžÐ±Ð½Ð¾Ð²Ð»ÑÐµÐ¼ .env Ñ Ð½Ð¾Ð²Ñ‹Ð¼ OpenRouter ÐºÐ»ÑŽÑ‡Ð¾Ð¼
          echo "ðŸ”‘ ÐžÐ±Ð½Ð¾Ð²Ð»ÑÐµÐ¼ OpenRouter ÐºÐ»ÑŽÑ‡ Ð² .env..."
          if [ -f ".env" ]; then
            # Ð—Ð°Ð¼ÐµÐ½ÑÐµÐ¼ ÑÑ‚Ð°Ñ€Ñ‹Ð¹ ÐºÐ»ÑŽÑ‡ Ð½Ð° Ð½Ð¾Ð²Ñ‹Ð¹
            sed -i 's/OPENROUTER_API_KEY=.*/OPENROUTER_API_KEY=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/' .env
            echo "âœ… OpenRouter ÐºÐ»ÑŽÑ‡ Ð¾Ð±Ð½Ð¾Ð²Ð»ÐµÐ½ Ð² .env"
          else
            echo "âŒ .env Ñ„Ð°Ð¹Ð» Ð½Ðµ Ð½Ð°Ð¹Ð´ÐµÐ½!"
          fi
          
          # Ð’Ð¾ÑÑÑ‚Ð°Ð½Ð°Ð²Ð»Ð¸Ð²Ð°ÐµÐ¼ Ð»Ð¾ÐºÐ°Ð»ÑŒÐ½Ñ‹Ðµ Ð¸Ð·Ð¼ÐµÐ½ÐµÐ½Ð¸Ñ
          git stash pop || true
          
          # Ð’ÐžÐ¡Ð¡Ð¢ÐÐÐÐ’Ð›Ð˜Ð’ÐÐ•Ðœ Ð‘ÐÐ—Ð£ Ð”ÐÐÐÐ«Ð¥ ÐŸÐžÐ¡Ð›Ð• ÐžÐ‘ÐÐžÐ’Ð›Ð•ÐÐ˜Ð¯
          echo "ðŸ“ Ð’Ð¾ÑÑÑ‚Ð°Ð½Ð°Ð²Ð»Ð¸Ð²Ð°ÐµÐ¼ Ð±Ð°Ð·Ñƒ Ð´Ð°Ð½Ð½Ñ‹Ñ…..."
          if [ -f "business_card_bot_backup.db" ]; then
            cp business_card_bot_backup.db business_card_bot.db
            echo "âœ… Ð‘Ð°Ð·Ð° Ð´Ð°Ð½Ð½Ñ‹Ñ… Ð²Ð¾ÑÑÑ‚Ð°Ð½Ð¾Ð²Ð»ÐµÐ½Ð° Ð¸Ð· Ñ€ÐµÐ·ÐµÑ€Ð²Ð½Ð¾Ð¹ ÐºÐ¾Ð¿Ð¸Ð¸"
          else
            echo "âš ï¸ Ð ÐµÐ·ÐµÑ€Ð²Ð½Ð°Ñ ÐºÐ¾Ð¿Ð¸Ñ Ð±Ð°Ð·Ñ‹ Ð´Ð°Ð½Ð½Ñ‹Ñ… Ð½Ðµ Ð½Ð°Ð¹Ð´ÐµÐ½Ð°"
          fi
          
          # Ð¡Ð¾Ð·Ð´Ð°ÐµÐ¼ Ð²Ð¸Ñ€Ñ‚ÑƒÐ°Ð»ÑŒÐ½Ð¾Ðµ Ð¾ÐºÑ€ÑƒÐ¶ÐµÐ½Ð¸Ðµ ÐµÑÐ»Ð¸ ÐµÐ³Ð¾ Ð½ÐµÑ‚
          if [ ! -d "venv" ]; then
            echo "Ð¡Ð¾Ð·Ð´Ð°ÐµÐ¼ Ð²Ð¸Ñ€Ñ‚ÑƒÐ°Ð»ÑŒÐ½Ð¾Ðµ Ð¾ÐºÑ€ÑƒÐ¶ÐµÐ½Ð¸Ðµ..."
            python3 -m venv venv
          fi
          
          # ÐÐºÑ‚Ð¸Ð²Ð¸Ñ€ÑƒÐµÐ¼ Ð²Ð¸Ñ€Ñ‚ÑƒÐ°Ð»ÑŒÐ½Ð¾Ðµ Ð¾ÐºÑ€ÑƒÐ¶ÐµÐ½Ð¸Ðµ
          source venv/bin/activate
          
          # ÐžÐ±Ð½Ð¾Ð²Ð»ÑÐµÐ¼ pip Ð¸ ÑƒÑÑ‚Ð°Ð½Ð¾Ð²Ñ‰Ð¸ÐºÐ¸
          pip install --upgrade pip setuptools wheel
          
          # ÐžÐ±Ð½Ð¾Ð²Ð»ÑÐµÐ¼ Ð·Ð°Ð²Ð¸ÑÐ¸Ð¼Ð¾ÑÑ‚Ð¸
          pip install -r requirements.txt
          
          # Ð”Ð¾Ð¿Ð¾Ð»Ð½Ð¸Ñ‚ÐµÐ»ÑŒÐ½Ð¾ ÑƒÑÑ‚Ð°Ð½Ð°Ð²Ð»Ð¸Ð²Ð°ÐµÐ¼ python-telegram-bot Ð½Ð° ÑÐ»ÑƒÑ‡Ð°Ð¹ ÐµÑÐ»Ð¸ Ð½Ðµ ÑƒÑÑ‚Ð°Ð½Ð¾Ð²Ð¸Ð»ÑÑ
          pip install python-telegram-bot
          
          # Ð—Ð°Ð¿ÑƒÑÐºÐ°ÐµÐ¼ Ð¼Ð¸Ð³Ñ€Ð°Ñ†Ð¸Ð¸ Ð±Ð°Ð·Ñ‹ Ð´Ð°Ð½Ð½Ñ‹Ñ… ÐµÑÐ»Ð¸ ÐµÑÑ‚ÑŒ
          echo "ðŸ”„ ÐŸÑ€Ð¾Ð²ÐµÑ€ÑÐµÐ¼ Ð¸ Ð·Ð°Ð¿ÑƒÑÐºÐ°ÐµÐ¼ Ð¼Ð¸Ð³Ñ€Ð°Ñ†Ð¸Ð¸ Ð±Ð°Ð·Ñ‹ Ð´Ð°Ð½Ð½Ñ‹Ñ…..."
          if [ -f "scripts/migrate_add_is_archived.py" ]; then
            python3 scripts/migrate_add_is_archived.py || echo "âš ï¸ ÐœÐ¸Ð³Ñ€Ð°Ñ†Ð¸Ñ Ð·Ð°Ð²ÐµÑ€ÑˆÐµÐ½Ð° Ñ Ð¿Ñ€ÐµÐ´ÑƒÐ¿Ñ€ÐµÐ¶Ð´ÐµÐ½Ð¸ÑÐ¼Ð¸"
          fi
          
          # Ð—Ð°Ð¿ÑƒÑÐºÐ°ÐµÐ¼ Ð¼Ð¸Ð³Ñ€Ð°Ñ†Ð¸ÑŽ Ð´Ð»Ñ Ð´Ð¾Ð±Ð°Ð²Ð»ÐµÐ½Ð¸Ñ Ð½ÐµÐ´Ð¾ÑÑ‚Ð°ÑŽÑ‰Ð¸Ñ… ÐºÐ¾Ð»Ð¾Ð½Ð¾Ðº
          echo "ðŸ”„ Ð—Ð°Ð¿ÑƒÑÐºÐ°ÐµÐ¼ Ð¼Ð¸Ð³Ñ€Ð°Ñ†Ð¸ÑŽ Ð´Ð»Ñ Ð´Ð¾Ð±Ð°Ð²Ð»ÐµÐ½Ð¸Ñ Ð½ÐµÐ´Ð¾ÑÑ‚Ð°ÑŽÑ‰Ð¸Ñ… ÐºÐ¾Ð»Ð¾Ð½Ð¾Ðº Ð² projects..."
          if [ -f "scripts/migrate_add_project_dates.py" ]; then
            python3 scripts/migrate_add_project_dates.py || echo "âš ï¸ ÐœÐ¸Ð³Ñ€Ð°Ñ†Ð¸Ñ project_dates Ð·Ð°Ð²ÐµÑ€ÑˆÐµÐ½Ð° Ñ Ð¿Ñ€ÐµÐ´ÑƒÐ¿Ñ€ÐµÐ¶Ð´ÐµÐ½Ð¸ÑÐ¼Ð¸"
          fi
          
          # Ð—Ð°Ð¿ÑƒÑÐºÐ°ÐµÐ¼ Ð½Ð¾Ð²ÑƒÑŽ Ð¼Ð¸Ð³Ñ€Ð°Ñ†Ð¸ÑŽ Ð´Ð»Ñ Ð´Ð¾Ð±Ð°Ð²Ð»ÐµÐ½Ð¸Ñ ÐºÐ¾Ð»Ð¾Ð½Ð¾Ðº Ð² projects
          if [ -f "app/database/migrations/011_add_project_dates.py" ]; then
            echo "ðŸ”„ Ð—Ð°Ð¿ÑƒÑÐºÐ°ÐµÐ¼ Ð¼Ð¸Ð³Ñ€Ð°Ñ†Ð¸ÑŽ 011_add_project_dates..."
            python3 app/database/migrations/011_add_project_dates.py || echo "âš ï¸ ÐœÐ¸Ð³Ñ€Ð°Ñ†Ð¸Ñ 011 Ð·Ð°Ð²ÐµÑ€ÑˆÐµÐ½Ð° Ñ Ð¿Ñ€ÐµÐ´ÑƒÐ¿Ñ€ÐµÐ¶Ð´ÐµÐ½Ð¸ÑÐ¼Ð¸"
          fi
          
          # Ð—Ð°Ð¿ÑƒÑÐºÐ°ÐµÐ¼ Ð¼Ð¸Ð³Ñ€Ð°Ñ†Ð¸ÑŽ Ð´Ð»Ñ Ð´Ð¾Ð±Ð°Ð²Ð»ÐµÐ½Ð¸Ñ Ð²ÑÐµÑ… Ð½ÐµÐ´Ð¾ÑÑ‚Ð°ÑŽÑ‰Ð¸Ñ… ÐºÐ¾Ð»Ð¾Ð½Ð¾Ðº
          if [ -f "scripts/migrate_add_missing_columns.py" ]; then
            echo "ðŸ”„ Ð—Ð°Ð¿ÑƒÑÐºÐ°ÐµÐ¼ Ð¼Ð¸Ð³Ñ€Ð°Ñ†Ð¸ÑŽ Ð´Ð»Ñ Ð¸ÑÐ¿Ñ€Ð°Ð²Ð»ÐµÐ½Ð¸Ñ Ð²ÑÐµÑ… Ð½ÐµÐ´Ð¾ÑÑ‚Ð°ÑŽÑ‰Ð¸Ñ… ÐºÐ¾Ð»Ð¾Ð½Ð¾Ðº..."
            python3 scripts/migrate_add_missing_columns.py || echo "âš ï¸ ÐœÐ¸Ð³Ñ€Ð°Ñ†Ð¸Ñ Ð½ÐµÐ´Ð¾ÑÑ‚Ð°ÑŽÑ‰Ð¸Ñ… ÐºÐ¾Ð»Ð¾Ð½Ð¾Ðº Ð·Ð°Ð²ÐµÑ€ÑˆÐµÐ½Ð°"
          fi
          
          # Ð—Ð°Ð¿ÑƒÑÐºÐ°ÐµÐ¼ Ð¼Ð¸Ð³Ñ€Ð°Ñ†Ð¸ÑŽ Ð´Ð»Ñ CRM Ñ‚Ð°Ð±Ð»Ð¸Ñ†
          if [ -f "scripts/migrate_add_crm_tables.py" ]; then
            echo "ðŸ”„ Ð—Ð°Ð¿ÑƒÑÐºÐ°ÐµÐ¼ Ð¼Ð¸Ð³Ñ€Ð°Ñ†Ð¸ÑŽ Ð´Ð»Ñ ÑÐ¾Ð·Ð´Ð°Ð½Ð¸Ñ CRM Ñ‚Ð°Ð±Ð»Ð¸Ñ†..."
            python3 scripts/migrate_add_crm_tables.py || echo "âš ï¸ ÐœÐ¸Ð³Ñ€Ð°Ñ†Ð¸Ñ CRM Ð·Ð°Ð²ÐµÑ€ÑˆÐµÐ½Ð°"
          fi
          
          # ÐŸÑ€Ð¾Ð²ÐµÑ€ÑÐµÐ¼ Ð½Ð°Ð»Ð¸Ñ‡Ð¸Ðµ .env Ñ„Ð°Ð¹Ð»Ð° Ð¸ Ñ‚Ð¾ÐºÐµÐ½Ð°
          if [ ! -f ".env" ]; then
            echo "âš ï¸ Ð’Ð½Ð¸Ð¼Ð°Ð½Ð¸Ðµ: .env Ñ„Ð°Ð¹Ð» Ð½Ðµ Ð½Ð°Ð¹Ð´ÐµÐ½! Ð‘Ð¾Ñ‚ Ð½Ðµ Ð·Ð°Ð¿ÑƒÑÑ‚Ð¸Ñ‚ÑÑ Ð±ÐµÐ· Ñ‚Ð¾ÐºÐµÐ½Ð¾Ð²."
            echo "Ð¡ÐºÐ¾Ð¿Ð¸Ñ€ÑƒÐ¹Ñ‚Ðµ .env Ñ„Ð°Ð¹Ð» Ñ Ð»Ð¾ÐºÐ°Ð»ÑŒÐ½Ð¾Ð¹ Ð¼Ð°ÑˆÐ¸Ð½Ñ‹ Ð½Ð° ÑÐµÑ€Ð²ÐµÑ€"
          else
            echo "âœ… .env Ñ„Ð°Ð¹Ð» Ð½Ð°Ð¹Ð´ÐµÐ½"
            # ÐŸÑ€Ð¾Ð²ÐµÑ€ÑÐµÐ¼ Ð½Ð°Ð»Ð¸Ñ‡Ð¸Ðµ BOT_TOKEN Ð² Ñ„Ð°Ð¹Ð»Ðµ
            if grep -q "BOT_TOKEN=" .env; then
              echo "âœ… BOT_TOKEN Ð½Ð°Ð¹Ð´ÐµÐ½ Ð² .env"
              # ÐŸÐ¾ÐºÐ°Ð·Ñ‹Ð²Ð°ÐµÐ¼ Ð¿ÐµÑ€Ð²Ñ‹Ðµ ÑÐ¸Ð¼Ð²Ð¾Ð»Ñ‹ Ñ‚Ð¾ÐºÐµÐ½Ð° Ð´Ð»Ñ Ð¿Ñ€Ð¾Ð²ÐµÑ€ÐºÐ¸ (Ð±ÐµÐ·Ð¾Ð¿Ð°ÑÐ½Ð¾)
              grep "BOT_TOKEN=" .env | head -c 30
              echo "..."
            else
              echo "âŒ BOT_TOKEN ÐÐ• Ð½Ð°Ð¹Ð´ÐµÐ½ Ð² .env Ñ„Ð°Ð¹Ð»Ðµ!"
            fi
            # ÐŸÑ€Ð¾Ð²ÐµÑ€ÑÐµÐ¼ Ð¿Ñ€Ð°Ð²Ð° Ð´Ð¾ÑÑ‚ÑƒÐ¿Ð° Ðº Ñ„Ð°Ð¹Ð»Ñƒ
            ls -la .env
          fi
          
          # ÐžÑ‡Ð¸Ñ‰Ð°ÐµÐ¼ ÐºÑÑˆ Python Ð´Ð»Ñ Ð¿Ñ€Ð¸Ð¼ÐµÐ½ÐµÐ½Ð¸Ñ Ð¸Ð·Ð¼ÐµÐ½ÐµÐ½Ð¸Ð¹
          find . -type d -name "__pycache__" -exec rm -rf {} + 2>/dev/null || true
          find . -type f -name "*.pyc" -delete 2>/dev/null || true
          
          # Ð’Ñ‹Ð¿Ð¾Ð»Ð½ÑÐµÐ¼ Ð¼Ð¸Ð³Ñ€Ð°Ñ†Ð¸Ð¸ Ð±Ð°Ð·Ñ‹ Ð´Ð°Ð½Ð½Ñ‹Ñ…
          echo "ðŸ”„ Ð’Ñ‹Ð¿Ð¾Ð»Ð½ÑÐµÐ¼ Ð¼Ð¸Ð³Ñ€Ð°Ñ†Ð¸Ð¸ Ð±Ð°Ð·Ñ‹ Ð´Ð°Ð½Ð½Ñ‹Ñ…..."
          if [ -f "scripts/migrate_db.py" ]; then
            chmod +x scripts/migrate_db.py
            python3 scripts/migrate_db.py
            echo "âœ… ÐœÐ¸Ð³Ñ€Ð°Ñ†Ð¸Ð¸ Ð²Ñ‹Ð¿Ð¾Ð»Ð½ÐµÐ½Ñ‹"
          else
            echo "âš ï¸ Ð¡ÐºÑ€Ð¸Ð¿Ñ‚ Ð¼Ð¸Ð³Ñ€Ð°Ñ†Ð¸Ð¸ Ð½Ðµ Ð½Ð°Ð¹Ð´ÐµÐ½, Ð¿Ñ‹Ñ‚Ð°ÐµÐ¼ÑÑ Ð´Ð¾Ð±Ð°Ð²Ð¸Ñ‚ÑŒ ÐºÐ¾Ð»Ð¾Ð½ÐºÑƒ Ð²Ñ€ÑƒÑ‡Ð½ÑƒÑŽ..."
            # Ð˜ÑÐ¿Ð¾Ð»ÑŒÐ·ÑƒÐµÐ¼ Ð¾Ð´Ð½Ð¾ÑÑ‚Ñ€Ð¾Ñ‡Ð½Ñ‹Ð¹ Python Ð´Ð»Ñ Ð¸Ð·Ð±ÐµÐ¶Ð°Ð½Ð¸Ñ Ð¿Ñ€Ð¾Ð±Ð»ÐµÐ¼ Ñ YAML
            python3 -c "import sqlite3, os; conn = sqlite3.connect('business_card_bot.db') if os.path.exists('business_card_bot.db') else None; cursor = conn.cursor() if conn else None; cursor.execute('ALTER TABLE projects ADD COLUMN color VARCHAR(20) DEFAULT \"default\"') if cursor else None; conn.commit() if conn else None; print('âœ… ÐœÐ¸Ð³Ñ€Ð°Ñ†Ð¸Ñ Ð²Ñ‹Ð¿Ð¾Ð»Ð½ÐµÐ½Ð°') if conn else print('âš ï¸ Ð‘Ð” Ð½Ðµ Ð½Ð°Ð¹Ð´ÐµÐ½Ð°')" 2>/dev/null || echo "â„¹ï¸ ÐšÐ¾Ð»Ð¾Ð½ÐºÐ° color ÑƒÐ¶Ðµ ÑÑƒÑ‰ÐµÑÑ‚Ð²ÑƒÐµÑ‚ Ð¸Ð»Ð¸ Ð‘Ð” Ð½Ðµ Ð½Ð°Ð¹Ð´ÐµÐ½Ð°"
          fi
          
          # ÐŸÐ¾Ð»Ð½Ð¾ÑÑ‚ÑŒÑŽ Ð¾ÑÑ‚Ð°Ð½Ð°Ð²Ð»Ð¸Ð²Ð°ÐµÐ¼ Ð¸ ÑƒÐ´Ð°Ð»ÑÐµÐ¼ Ð¿Ñ€Ð¾Ñ†ÐµÑÑ
          pm2 stop bot-business-card || true
          pm2 delete bot-business-card || true
          
          # Ð¡Ð¾Ð·Ð´Ð°ÐµÐ¼ ecosystem.config.js Ð¸Ð· .env Ð¿ÐµÑ€ÐµÐ¼ÐµÐ½Ð½Ñ‹Ñ…
          echo "ðŸ”§ Ð¡Ð¾Ð·Ð´Ð°ÐµÐ¼ ecosystem.config.js Ð¸Ð· .env..."
          source .env
          
          cat > ecosystem.config.js << EOF
          module.exports = {
            apps: [{
              name: 'bot-business-card',
              script: '/var/www/bot_business_card/venv/bin/python',
              args: '-m app.main',
              cwd: '/var/www/bot_business_card',
              interpreter: 'none',
              instances: 1,
              autorestart: true,
              watch: false,
              max_memory_restart: '500M',
              env: {
                BOT_TOKEN: '${BOT_TOKEN}',
                TELEGRAM_BOT_TOKEN: '${TELEGRAM_BOT_TOKEN}',
                BOT_USERNAME: '${BOT_USERNAME}',
                OPENROUTER_API_KEY: '${OPENROUTER_API_KEY}',
                OPENROUTER_BASE_URL: '${OPENROUTER_BASE_URL}',
                DEFAULT_MODEL: '${DEFAULT_MODEL}',
                DATABASE_URL: '${DATABASE_URL}',
                DATABASE_ECHO: '${DATABASE_ECHO}',
                ADMIN_SECRET_KEY: '${ADMIN_SECRET_KEY}',
                ADMIN_USERNAME: '${ADMIN_USERNAME}',
                ADMIN_PASSWORD: '${ADMIN_PASSWORD}',
                ADMIN_PORT: '${ADMIN_PORT}',
                MAX_FILE_SIZE: '${MAX_FILE_SIZE}',
                UPLOAD_PATH: '${UPLOAD_PATH}',
                LOG_LEVEL: '${LOG_LEVEL}',
                LOG_FILE: '${LOG_FILE}',
                NOTIFICATION_CHAT_ID: '${NOTIFICATION_CHAT_ID}',
                ADMIN_CHAT_ID: '${ADMIN_CHAT_ID}',
                ADMIN_IDS: '${ADMIN_IDS}',
                BASE_HOURLY_RATE: '${BASE_HOURLY_RATE}',
                URGENT_MULTIPLIER: '${URGENT_MULTIPLIER}',
                REDIS_URL: '${REDIS_URL}',
                CONSULTANT_SYSTEM_PROMPT: '${CONSULTANT_SYSTEM_PROMPT}',
                CONSULTANT_MAX_TOKENS: '${CONSULTANT_MAX_TOKENS}',
                CONSULTANT_TEMPERATURE: '${CONSULTANT_TEMPERATURE}',
                AVITO_CLIENT_ID: '${AVITO_CLIENT_ID}',
                AVITO_CLIENT_SECRET: '${AVITO_CLIENT_SECRET}',
                AVITO_USER_ID: '${AVITO_USER_ID}'
              }
            }]
          };
          EOF
          
          echo "âœ… ecosystem.config.js ÑÐ¾Ð·Ð´Ð°Ð½ Ð¸Ð· .env Ð¿ÐµÑ€ÐµÐ¼ÐµÐ½Ð½Ñ‹Ñ…"
          
          # Ð—Ð°Ð¿ÑƒÑÐºÐ°ÐµÐ¼ PM2 Ñ Ð½Ð¾Ð²Ð¾Ð¹ ÐºÐ¾Ð½Ñ„Ð¸Ð³ÑƒÑ€Ð°Ñ†Ð¸ÐµÐ¹
          pm2 start ecosystem.config.js
          
          # Ð¡Ð¾Ñ…Ñ€Ð°Ð½ÑÐµÐ¼ ÐºÐ¾Ð½Ñ„Ð¸Ð³ÑƒÑ€Ð°Ñ†Ð¸ÑŽ PM2
          pm2 save
          
          # ÐŸÑ€Ð¾Ð²ÐµÑ€ÑÐµÐ¼ ÑÑ‚Ð°Ñ‚ÑƒÑ
          pm2 status
          
          # Ð–Ð´ÐµÐ¼ Ð½ÐµÐ¼Ð½Ð¾Ð³Ð¾ Ð´Ð»Ñ Ð·Ð°Ð¿ÑƒÑÐºÐ°
          sleep 3
          
          # ÐŸÐ¾ÐºÐ°Ð·Ñ‹Ð²Ð°ÐµÐ¼ Ð¿Ð¾ÑÐ»ÐµÐ´Ð½Ð¸Ðµ Ð»Ð¾Ð³Ð¸
          pm2 logs bot-business-card --lines 20 --nostream
          
          # ÐŸÐ¾ÐºÐ°Ð·Ñ‹Ð²Ð°ÐµÐ¼ Ð¸Ð½Ñ„Ð¾Ñ€Ð¼Ð°Ñ†Ð¸ÑŽ Ð¾ Ð¿Ñ€Ð¾Ñ†ÐµÑÑÐµ
          pm2 info bot-business-card || true
          
          # ÐŸÑ€Ð¾Ð²ÐµÑ€ÑÐµÐ¼ Ð¿ÐµÑ€ÐµÐ¼ÐµÐ½Ð½Ñ‹Ðµ Ð¾ÐºÑ€ÑƒÐ¶ÐµÐ½Ð¸Ñ Ð¿Ñ€Ð¾Ñ†ÐµÑÑÐ°
          echo "ÐŸÑ€Ð¾Ð²ÐµÑ€ÐºÐ° Ð¿ÐµÑ€ÐµÐ¼ÐµÐ½Ð½Ñ‹Ñ… Ð¾ÐºÑ€ÑƒÐ¶ÐµÐ½Ð¸Ñ PM2 Ð¿Ñ€Ð¾Ñ†ÐµÑÑÐ°:"
          pm2 env 0 | grep -E "(OPENROUTER|BOT_TOKEN|DATABASE_URL|ADMIN)" | head -10 || true
          
          # ÐŸÐ Ð˜ÐÐ£Ð”Ð˜Ð¢Ð•Ð›Ð¬ÐÐÐ¯ ÐŸÐ•Ð Ð•Ð—ÐÐ“Ð Ð£Ð—ÐšÐ Ð´Ð»Ñ Ð¾Ð±Ð½Ð¾Ð²Ð»ÐµÐ½Ð¸Ñ Ð¿ÐµÑ€ÐµÐ¼ÐµÐ½Ð½Ñ‹Ñ…
          echo "ðŸ”„ ÐŸÐ Ð˜ÐÐ£Ð”Ð˜Ð¢Ð•Ð›Ð¬ÐÐž Ð¿ÐµÑ€ÐµÐ·Ð°Ð³Ñ€ÑƒÐ¶Ð°ÐµÐ¼ Ð¿Ñ€Ð¾Ñ†ÐµÑÑ Ð´Ð»Ñ Ð¿Ñ€Ð¸Ð¼ÐµÐ½ÐµÐ½Ð¸Ñ Ð½Ð¾Ð²Ñ‹Ñ… Ð¿ÐµÑ€ÐµÐ¼ÐµÐ½Ð½Ñ‹Ñ…..."
          pm2 stop bot-business-card || true
          pm2 delete bot-business-card || true
          pm2 start ecosystem.config.js
          pm2 save
          
          echo "â³ Ð–Ð´ÐµÐ¼ Ð¿Ð¾Ð»Ð½Ð¾Ð³Ð¾ Ð·Ð°Ð¿ÑƒÑÐºÐ° (10 ÑÐµÐºÑƒÐ½Ð´)..."
          sleep 10
          
          # Ð¤Ð¸Ð½Ð°Ð»ÑŒÐ½Ð°Ñ Ð¿Ñ€Ð¾Ð²ÐµÑ€ÐºÐ° OpenRouter Ð¿ÐµÑ€ÐµÐ¼ÐµÐ½Ð½Ñ‹Ñ…
          echo "ðŸ” Ð¤Ð˜ÐÐÐ›Ð¬ÐÐÐ¯ ÐŸÐ ÐžÐ’Ð•Ð ÐšÐ OpenRouter Ð¿ÐµÑ€ÐµÐ¼ÐµÐ½Ð½Ñ‹Ñ…:"
          pm2 env 0 | grep -E "(OPENROUTER)" || echo "âŒ ÐšÐ Ð˜Ð¢Ð˜Ð§Ð•Ð¡ÐšÐÐ¯ ÐžÐ¨Ð˜Ð‘ÐšÐ: OpenRouter Ð¿ÐµÑ€ÐµÐ¼ÐµÐ½Ð½Ñ‹Ðµ ÐÐ• Ð—ÐÐ“Ð Ð£Ð–Ð•ÐÐ«!"
          
          # ÐŸÑ€Ð¾Ð²ÐµÑ€ÑÐµÐ¼ Ñ‡Ñ‚Ð¾ Ð½Ð¾Ð²Ñ‹Ð¹ ÐºÐ»ÑŽÑ‡ Ð·Ð°Ð³Ñ€ÑƒÐ·Ð¸Ð»ÑÑ
          echo "ðŸ”‘ ÐŸÑ€Ð¾Ð²ÐµÑ€ÑÐµÐ¼ Ð½Ð¾Ð²Ñ‹Ð¹ OpenRouter ÐºÐ»ÑŽÑ‡:"
          if pm2 env 0 | grep "OPENROUTER_API_KEY" | grep -q "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"; then
            echo "âœ…âœ…âœ… ÐÐžÐ’Ð«Ð™ OPENROUTER ÐšÐ›Ð®Ð§ Ð£Ð¡ÐŸÐ•Ð¨ÐÐž Ð—ÐÐ“Ð Ð£Ð–Ð•Ð!"
          else
            echo "âŒâŒâŒ Ð’ÐÐ˜ÐœÐÐÐ˜Ð•: ÐÐ¾Ð²Ñ‹Ð¹ ÐºÐ»ÑŽÑ‡ Ð½Ðµ Ð½Ð°Ð¹Ð´ÐµÐ½, Ð¿Ñ€Ð¾Ð²ÐµÑ€ÑŒÑ‚Ðµ .env Ñ„Ð°Ð¹Ð»"
          fi
          
          # ÐŸÐ¾ÐºÐ°Ð·Ñ‹Ð²Ð°ÐµÐ¼ Ñ„Ð¸Ð½Ð°Ð»ÑŒÐ½Ñ‹Ðµ Ð»Ð¾Ð³Ð¸
          echo "ðŸ“‹ Ð¤Ð¸Ð½Ð°Ð»ÑŒÐ½Ñ‹Ðµ Ð»Ð¾Ð³Ð¸ Ð¿Ð¾ÑÐ»Ðµ Ð¿ÐµÑ€ÐµÐ·Ð°Ð¿ÑƒÑÐºÐ°:"
          pm2 logs bot-business-card --lines 10 --nostream
          
          echo "âœ… Ð”ÐµÐ¿Ð»Ð¾Ð¹ Ð·Ð°Ð²ÐµÑ€ÑˆÐµÐ½ ÑƒÑÐ¿ÐµÑˆÐ½Ð¾! Ð‘Ð¾Ñ‚ Ð¿ÐµÑ€ÐµÐ·Ð°Ð¿ÑƒÑ‰ÐµÐ½ Ñ‡ÐµÑ€ÐµÐ· PM2"