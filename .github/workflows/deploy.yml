name: Deploy to Server

on:
  push:
    branches: [ main ]
  workflow_dispatch:  # ÐŸÐ¾Ð·Ð²Ð¾Ð»ÑÐµÑ‚ Ð·Ð°Ð¿ÑƒÑÐºÐ°Ñ‚ÑŒ workflow Ð²Ñ€ÑƒÑ‡Ð½ÑƒÑŽ

jobs:
  deploy:
    runs-on: ubuntu-latest
    
    steps:
    - name: Deploy to server via SSH
      uses: appleboy/ssh-action@v1.0.0
      with:
        host: ${{ secrets.SERVER_HOST }}
        username: ${{ secrets.SERVER_USER }}
        password: ${{ secrets.SERVER_PASSWORD }}
        port: ${{ secrets.SERVER_PORT }}
        script: |
          # Ð£Ð´Ð°Ð»ÑÐµÐ¼ ÑÑ‚Ð°Ñ€ÑƒÑŽ Ð´Ð¸Ñ€ÐµÐºÑ‚Ð¾Ñ€Ð¸ÑŽ Ð¸Ð· /root ÐµÑÐ»Ð¸ Ð¾Ð½Ð° ÐµÑÑ‚ÑŒ
          if [ -d "/root/bot_business_card" ]; then
            echo "Ð£Ð´Ð°Ð»ÑÐµÐ¼ ÑÑ‚Ð°Ñ€ÑƒÑŽ Ð´Ð¸Ñ€ÐµÐºÑ‚Ð¾Ñ€Ð¸ÑŽ Ð¸Ð· /root..."
            rm -rf /root/bot_business_card
          fi
          
          # ÐŸÐµÑ€ÐµÑ…Ð¾Ð´Ð¸Ð¼ Ð² Ð¿Ñ€Ð°Ð²Ð¸Ð»ÑŒÐ½ÑƒÑŽ Ð´Ð¸Ñ€ÐµÐºÑ‚Ð¾Ñ€Ð¸ÑŽ Ð¿Ñ€Ð¾ÐµÐºÑ‚Ð°
          cd /var/www/bot_business_card
          
          # ÐŸÑ€Ð¾Ð²ÐµÑ€ÑÐµÐ¼ Ñ‡Ñ‚Ð¾ Ð¼Ñ‹ Ð² Ð¿Ñ€Ð°Ð²Ð¸Ð»ÑŒÐ½Ð¾Ð¹ Ð´Ð¸Ñ€ÐµÐºÑ‚Ð¾Ñ€Ð¸Ð¸
          pwd
          ls -la
          
          # Ð¡ÐžÐ¥Ð ÐÐÐ¯Ð•Ðœ Ð‘ÐÐ—Ð£ Ð”ÐÐÐÐ«Ð¥ ÐŸÐ•Ð Ð•Ð” ÐžÐ‘ÐÐžÐ’Ð›Ð•ÐÐ˜Ð•Ðœ
          echo "ðŸ“ Ð¡Ð¾Ñ…Ñ€Ð°Ð½ÑÐµÐ¼ Ñ‚ÐµÐºÑƒÑ‰ÑƒÑŽ Ð±Ð°Ð·Ñƒ Ð´Ð°Ð½Ð½Ñ‹Ñ…..."
          if [ -f "business_card_bot.db" ]; then
            cp business_card_bot.db business_card_bot_backup.db
            echo "âœ… Ð‘Ð°Ð·Ð° Ð´Ð°Ð½Ð½Ñ‹Ñ… ÑÐ¾Ñ…Ñ€Ð°Ð½ÐµÐ½Ð° Ð² business_card_bot_backup.db"
            ls -la *.db
          else
            echo "âš ï¸ Ð‘Ð°Ð·Ð° Ð´Ð°Ð½Ð½Ñ‹Ñ… Ð½Ðµ Ð½Ð°Ð¹Ð´ÐµÐ½Ð° Ð´Ð»Ñ Ñ€ÐµÐ·ÐµÑ€Ð²Ð½Ð¾Ð³Ð¾ ÐºÐ¾Ð¿Ð¸Ñ€Ð¾Ð²Ð°Ð½Ð¸Ñ"
          fi
          
          # Ð¡Ð¾Ñ…Ñ€Ð°Ð½ÑÐµÐ¼ Ð»Ð¾ÐºÐ°Ð»ÑŒÐ½Ñ‹Ðµ Ð¸Ð·Ð¼ÐµÐ½ÐµÐ½Ð¸Ñ (ÐµÑÐ»Ð¸ ÐµÑÑ‚ÑŒ)
          git stash
          
          # ÐŸÐ¾Ð»ÑƒÑ‡Ð°ÐµÐ¼ Ð¿Ð¾ÑÐ»ÐµÐ´Ð½Ð¸Ðµ Ð¸Ð·Ð¼ÐµÐ½ÐµÐ½Ð¸Ñ
          git pull origin main
          
          # Ð’Ð¾ÑÑÑ‚Ð°Ð½Ð°Ð²Ð»Ð¸Ð²Ð°ÐµÐ¼ Ð»Ð¾ÐºÐ°Ð»ÑŒÐ½Ñ‹Ðµ Ð¸Ð·Ð¼ÐµÐ½ÐµÐ½Ð¸Ñ
          git stash pop || true
          
          # Ð’ÐžÐ¡Ð¡Ð¢ÐÐÐÐ’Ð›Ð˜Ð’ÐÐ•Ðœ Ð‘ÐÐ—Ð£ Ð”ÐÐÐÐ«Ð¥ ÐŸÐžÐ¡Ð›Ð• ÐžÐ‘ÐÐžÐ’Ð›Ð•ÐÐ˜Ð¯
          echo "ðŸ“ Ð’Ð¾ÑÑÑ‚Ð°Ð½Ð°Ð²Ð»Ð¸Ð²Ð°ÐµÐ¼ Ð±Ð°Ð·Ñƒ Ð´Ð°Ð½Ð½Ñ‹Ñ…..."
          if [ -f "business_card_bot_backup.db" ]; then
            cp business_card_bot_backup.db business_card_bot.db
            echo "âœ… Ð‘Ð°Ð·Ð° Ð´Ð°Ð½Ð½Ñ‹Ñ… Ð²Ð¾ÑÑÑ‚Ð°Ð½Ð¾Ð²Ð»ÐµÐ½Ð° Ð¸Ð· Ñ€ÐµÐ·ÐµÑ€Ð²Ð½Ð¾Ð¹ ÐºÐ¾Ð¿Ð¸Ð¸"
          else
            echo "âš ï¸ Ð ÐµÐ·ÐµÑ€Ð²Ð½Ð°Ñ ÐºÐ¾Ð¿Ð¸Ñ Ð±Ð°Ð·Ñ‹ Ð´Ð°Ð½Ð½Ñ‹Ñ… Ð½Ðµ Ð½Ð°Ð¹Ð´ÐµÐ½Ð°"
          fi
          
          # Ð¡Ð¾Ð·Ð´Ð°ÐµÐ¼ Ð²Ð¸Ñ€Ñ‚ÑƒÐ°Ð»ÑŒÐ½Ð¾Ðµ Ð¾ÐºÑ€ÑƒÐ¶ÐµÐ½Ð¸Ðµ ÐµÑÐ»Ð¸ ÐµÐ³Ð¾ Ð½ÐµÑ‚
          if [ ! -d "venv" ]; then
            echo "Ð¡Ð¾Ð·Ð´Ð°ÐµÐ¼ Ð²Ð¸Ñ€Ñ‚ÑƒÐ°Ð»ÑŒÐ½Ð¾Ðµ Ð¾ÐºÑ€ÑƒÐ¶ÐµÐ½Ð¸Ðµ..."
            python3 -m venv venv
          fi
          
          # ÐÐºÑ‚Ð¸Ð²Ð¸Ñ€ÑƒÐµÐ¼ Ð²Ð¸Ñ€Ñ‚ÑƒÐ°Ð»ÑŒÐ½Ð¾Ðµ Ð¾ÐºÑ€ÑƒÐ¶ÐµÐ½Ð¸Ðµ
          source venv/bin/activate
          
          # ÐžÐ±Ð½Ð¾Ð²Ð»ÑÐµÐ¼ pip Ð¸ ÑƒÑÑ‚Ð°Ð½Ð¾Ð²Ñ‰Ð¸ÐºÐ¸
          pip install --upgrade pip setuptools wheel
          
          # ÐžÐ±Ð½Ð¾Ð²Ð»ÑÐµÐ¼ Ð·Ð°Ð²Ð¸ÑÐ¸Ð¼Ð¾ÑÑ‚Ð¸
          pip install -r requirements.txt
          
          # Ð”Ð¾Ð¿Ð¾Ð»Ð½Ð¸Ñ‚ÐµÐ»ÑŒÐ½Ð¾ ÑƒÑÑ‚Ð°Ð½Ð°Ð²Ð»Ð¸Ð²Ð°ÐµÐ¼ python-telegram-bot Ð½Ð° ÑÐ»ÑƒÑ‡Ð°Ð¹ ÐµÑÐ»Ð¸ Ð½Ðµ ÑƒÑÑ‚Ð°Ð½Ð¾Ð²Ð¸Ð»ÑÑ
          pip install python-telegram-bot
          
          # ÐŸÑ€Ð¾Ð²ÐµÑ€ÑÐµÐ¼ Ð½Ð°Ð»Ð¸Ñ‡Ð¸Ðµ .env Ñ„Ð°Ð¹Ð»Ð° Ð¸ Ñ‚Ð¾ÐºÐµÐ½Ð°
          if [ ! -f ".env" ]; then
            echo "âš ï¸ Ð’Ð½Ð¸Ð¼Ð°Ð½Ð¸Ðµ: .env Ñ„Ð°Ð¹Ð» Ð½Ðµ Ð½Ð°Ð¹Ð´ÐµÐ½! Ð‘Ð¾Ñ‚ Ð½Ðµ Ð·Ð°Ð¿ÑƒÑÑ‚Ð¸Ñ‚ÑÑ Ð±ÐµÐ· Ñ‚Ð¾ÐºÐµÐ½Ð¾Ð²."
            echo "Ð¡ÐºÐ¾Ð¿Ð¸Ñ€ÑƒÐ¹Ñ‚Ðµ .env Ñ„Ð°Ð¹Ð» Ñ Ð»Ð¾ÐºÐ°Ð»ÑŒÐ½Ð¾Ð¹ Ð¼Ð°ÑˆÐ¸Ð½Ñ‹ Ð½Ð° ÑÐµÑ€Ð²ÐµÑ€"
          else
            echo "âœ… .env Ñ„Ð°Ð¹Ð» Ð½Ð°Ð¹Ð´ÐµÐ½"
            # ÐŸÑ€Ð¾Ð²ÐµÑ€ÑÐµÐ¼ Ð½Ð°Ð»Ð¸Ñ‡Ð¸Ðµ BOT_TOKEN Ð² Ñ„Ð°Ð¹Ð»Ðµ
            if grep -q "BOT_TOKEN=" .env; then
              echo "âœ… BOT_TOKEN Ð½Ð°Ð¹Ð´ÐµÐ½ Ð² .env"
              # ÐŸÐ¾ÐºÐ°Ð·Ñ‹Ð²Ð°ÐµÐ¼ Ð¿ÐµÑ€Ð²Ñ‹Ðµ ÑÐ¸Ð¼Ð²Ð¾Ð»Ñ‹ Ñ‚Ð¾ÐºÐµÐ½Ð° Ð´Ð»Ñ Ð¿Ñ€Ð¾Ð²ÐµÑ€ÐºÐ¸ (Ð±ÐµÐ·Ð¾Ð¿Ð°ÑÐ½Ð¾)
              grep "BOT_TOKEN=" .env | head -c 30
              echo "..."
            else
              echo "âŒ BOT_TOKEN ÐÐ• Ð½Ð°Ð¹Ð´ÐµÐ½ Ð² .env Ñ„Ð°Ð¹Ð»Ðµ!"
            fi
            # ÐŸÑ€Ð¾Ð²ÐµÑ€ÑÐµÐ¼ Ð¿Ñ€Ð°Ð²Ð° Ð´Ð¾ÑÑ‚ÑƒÐ¿Ð° Ðº Ñ„Ð°Ð¹Ð»Ñƒ
            ls -la .env
          fi
          
          # ÐžÑ‡Ð¸Ñ‰Ð°ÐµÐ¼ ÐºÑÑˆ Python Ð´Ð»Ñ Ð¿Ñ€Ð¸Ð¼ÐµÐ½ÐµÐ½Ð¸Ñ Ð¸Ð·Ð¼ÐµÐ½ÐµÐ½Ð¸Ð¹
          find . -type d -name "__pycache__" -exec rm -rf {} + 2>/dev/null || true
          find . -type f -name "*.pyc" -delete 2>/dev/null || true
          
          # Ð’Ñ‹Ð¿Ð¾Ð»Ð½ÑÐµÐ¼ Ð¼Ð¸Ð³Ñ€Ð°Ñ†Ð¸Ð¸ Ð±Ð°Ð·Ñ‹ Ð´Ð°Ð½Ð½Ñ‹Ñ…
          echo "ðŸ”„ Ð’Ñ‹Ð¿Ð¾Ð»Ð½ÑÐµÐ¼ Ð¼Ð¸Ð³Ñ€Ð°Ñ†Ð¸Ð¸ Ð±Ð°Ð·Ñ‹ Ð´Ð°Ð½Ð½Ñ‹Ñ…..."
          if [ -f "scripts/migrate_db.py" ]; then
            chmod +x scripts/migrate_db.py
            python3 scripts/migrate_db.py
            echo "âœ… ÐœÐ¸Ð³Ñ€Ð°Ñ†Ð¸Ð¸ Ð²Ñ‹Ð¿Ð¾Ð»Ð½ÐµÐ½Ñ‹"
          else
            echo "âš ï¸ Ð¡ÐºÑ€Ð¸Ð¿Ñ‚ Ð¼Ð¸Ð³Ñ€Ð°Ñ†Ð¸Ð¸ Ð½Ðµ Ð½Ð°Ð¹Ð´ÐµÐ½, Ð¿Ñ‹Ñ‚Ð°ÐµÐ¼ÑÑ Ð´Ð¾Ð±Ð°Ð²Ð¸Ñ‚ÑŒ ÐºÐ¾Ð»Ð¾Ð½ÐºÑƒ Ð²Ñ€ÑƒÑ‡Ð½ÑƒÑŽ..."
            # Ð”Ð¾Ð±Ð°Ð²Ð»ÑÐµÐ¼ ÐºÐ¾Ð»Ð¾Ð½ÐºÑƒ color ÐµÑÐ»Ð¸ ÐµÑ‘ Ð½ÐµÑ‚
            python3 -c "
import sqlite3
import os
if os.path.exists('business_card_bot.db'):
    conn = sqlite3.connect('business_card_bot.db')
    cursor = conn.cursor()
    try:
        cursor.execute('ALTER TABLE projects ADD COLUMN color VARCHAR(20) DEFAULT \\"default\\"')
        conn.commit()
        print('âœ… ÐšÐ¾Ð»Ð¾Ð½ÐºÐ° color Ð´Ð¾Ð±Ð°Ð²Ð»ÐµÐ½Ð°')
    except:
        print('â„¹ï¸ ÐšÐ¾Ð»Ð¾Ð½ÐºÐ° color ÑƒÐ¶Ðµ ÑÑƒÑ‰ÐµÑÑ‚Ð²ÑƒÐµÑ‚')
    conn.close()
"
          fi
          
          # ÐŸÐ¾Ð»Ð½Ð¾ÑÑ‚ÑŒÑŽ Ð¾ÑÑ‚Ð°Ð½Ð°Ð²Ð»Ð¸Ð²Ð°ÐµÐ¼ Ð¸ ÑƒÐ´Ð°Ð»ÑÐµÐ¼ Ð¿Ñ€Ð¾Ñ†ÐµÑÑ
          pm2 stop bot-business-card || true
          pm2 delete bot-business-card || true
          
          # Ð¡Ð¾Ð·Ð´Ð°ÐµÐ¼ ecosystem.config.js Ñ Ð¿ÐµÑ€ÐµÐ¼ÐµÐ½Ð½Ñ‹Ð¼Ð¸ Ð¾ÐºÑ€ÑƒÐ¶ÐµÐ½Ð¸Ñ
          cat > ecosystem.config.js << 'EOF'
          module.exports = {
            apps: [{
              name: 'bot-business-card',
              script: '/var/www/bot_business_card/venv/bin/python',
              args: '-m app.main',
              cwd: '/var/www/bot_business_card',
              interpreter: 'none',
              instances: 1,
              autorestart: true,
              watch: false,
              max_memory_restart: '500M',
              env: {
                BOT_TOKEN: '7881909419:AAEeAZIRYxQZxkVfKKUV5WYCemBk7qxkFP8',
                TELEGRAM_BOT_TOKEN: '7881909419:AAEeAZIRYxQZxkVfKKUV5WYCemBk7qxkFP8',
                BOT_USERNAME: 'ivan_dev_bot',
                OPENROUTER_API_KEY: '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',
                OPENROUTER_BASE_URL: 'https://openrouter.ai/api/v1',
                DEFAULT_MODEL: 'openai/gpt-4o-mini',
                DATABASE_URL: 'sqlite:///./data/bot.db',
                DATABASE_ECHO: 'False',
                ADMIN_SECRET_KEY: 'your_super_secret_key_here_make_it_long_and_random',
                ADMIN_USERNAME: 'admin',
                ADMIN_PASSWORD: 'qwerty123',
                ADMIN_PORT: '8001',
                MAX_FILE_SIZE: '10485760',
                UPLOAD_PATH: './uploads',
                LOG_LEVEL: 'INFO',
                LOG_FILE: './logs/bot.log',
                NOTIFICATION_CHAT_ID: '501613334',
                ADMIN_CHAT_ID: '501613334',
                ADMIN_IDS: '501613334',
                BASE_HOURLY_RATE: '1000',
                URGENT_MULTIPLIER: '1.3',
                REDIS_URL: 'redis://localhost:6379/0',
                CONSULTANT_SYSTEM_PROMPT: 'Ð¢Ñ‹ - ÑÐºÑÐ¿ÐµÑ€Ñ‚-ÐºÐ¾Ð½ÑÑƒÐ»ÑŒÑ‚Ð°Ð½Ñ‚ Ð¿Ð¾ Ñ€Ð°Ð·Ñ€Ð°Ð±Ð¾Ñ‚ÐºÐµ Telegram-Ð±Ð¾Ñ‚Ð¾Ð² Ð¸ Ñ‡Ð°Ñ‚-Ð±Ð¾Ñ‚Ð¾Ð².',
                CONSULTANT_MAX_TOKENS: '1000',
                CONSULTANT_TEMPERATURE: '0.7'
              }
            }]
          };
          EOF
          
          # Ð—Ð°Ð¿ÑƒÑÐºÐ°ÐµÐ¼ PM2 Ñ Ð½Ð¾Ð²Ð¾Ð¹ ÐºÐ¾Ð½Ñ„Ð¸Ð³ÑƒÑ€Ð°Ñ†Ð¸ÐµÐ¹
          pm2 start ecosystem.config.js
          
          # Ð¡Ð¾Ñ…Ñ€Ð°Ð½ÑÐµÐ¼ ÐºÐ¾Ð½Ñ„Ð¸Ð³ÑƒÑ€Ð°Ñ†Ð¸ÑŽ PM2
          pm2 save
          
          # ÐŸÑ€Ð¾Ð²ÐµÑ€ÑÐµÐ¼ ÑÑ‚Ð°Ñ‚ÑƒÑ
          pm2 status
          
          # Ð–Ð´ÐµÐ¼ Ð½ÐµÐ¼Ð½Ð¾Ð³Ð¾ Ð´Ð»Ñ Ð·Ð°Ð¿ÑƒÑÐºÐ°
          sleep 3
          
          # ÐŸÐ¾ÐºÐ°Ð·Ñ‹Ð²Ð°ÐµÐ¼ Ð¿Ð¾ÑÐ»ÐµÐ´Ð½Ð¸Ðµ Ð»Ð¾Ð³Ð¸
          pm2 logs bot-business-card --lines 20 --nostream
          
          # ÐŸÐ¾ÐºÐ°Ð·Ñ‹Ð²Ð°ÐµÐ¼ Ð¸Ð½Ñ„Ð¾Ñ€Ð¼Ð°Ñ†Ð¸ÑŽ Ð¾ Ð¿Ñ€Ð¾Ñ†ÐµÑÑÐµ
          pm2 info bot-business-card || true
          
          # ÐŸÑ€Ð¾Ð²ÐµÑ€ÑÐµÐ¼ Ð¿ÐµÑ€ÐµÐ¼ÐµÐ½Ð½Ñ‹Ðµ Ð¾ÐºÑ€ÑƒÐ¶ÐµÐ½Ð¸Ñ Ð¿Ñ€Ð¾Ñ†ÐµÑÑÐ°
          echo "ÐŸÑ€Ð¾Ð²ÐµÑ€ÐºÐ° Ð¿ÐµÑ€ÐµÐ¼ÐµÐ½Ð½Ñ‹Ñ… Ð¾ÐºÑ€ÑƒÐ¶ÐµÐ½Ð¸Ñ PM2 Ð¿Ñ€Ð¾Ñ†ÐµÑÑÐ°:"
          pm2 env 0 | grep -E "(BOT_TOKEN|DATABASE_URL|ADMIN)" | head -5 || true
          
          echo "âœ… Ð”ÐµÐ¿Ð»Ð¾Ð¹ Ð·Ð°Ð²ÐµÑ€ÑˆÐµÐ½ ÑƒÑÐ¿ÐµÑˆÐ½Ð¾! Ð‘Ð¾Ñ‚ Ð¿ÐµÑ€ÐµÐ·Ð°Ð¿ÑƒÑ‰ÐµÐ½ Ñ‡ÐµÑ€ÐµÐ· PM2"