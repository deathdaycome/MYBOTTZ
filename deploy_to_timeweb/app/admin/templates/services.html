{% extends "base.html" %}

{% block title %}–£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ —Å–µ—Ä–≤–∏—Å–∞–º–∏ - –ê–¥–º–∏–Ω-–ø–∞–Ω–µ–ª—å{% endblock %}

{% block page_title %}üñ•Ô∏è –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ —Å–µ—Ä–≤–∏—Å–∞–º–∏{% endblock %}

{% block header_actions %}
<div class="btn-group">
    <button class="btn btn-primary btn-custom" onclick="showAddServiceModal()">
        <i class="fas fa-plus me-1"></i> –î–æ–±–∞–≤–∏—Ç—å —Å–µ—Ä–≤–∏—Å
    </button>
    <button class="btn btn-success btn-custom" onclick="refreshServices()">
        <i class="fas fa-sync-alt me-1"></i> –û–±–Ω–æ–≤–∏—Ç—å
    </button>
    <button class="btn btn-info btn-custom" onclick="exportServices()">
        <i class="fas fa-download me-1"></i> –≠–∫—Å–ø–æ—Ä—Ç
    </button>
</div>
{% endblock %}

{% block content %}
<!-- –§–∏–ª—å—Ç—Ä—ã -->
<div class="card mb-4">
    <div class="card-body">
        <div class="row">
            <div class="col-md-3">
                <div class="input-group">
                    <input type="text" class="form-control" id="searchInput" placeholder="–ü–æ–∏—Å–∫ —Å–µ—Ä–≤–∏—Å–æ–≤...">
                    <button class="btn btn-outline-secondary" onclick="filterServices()">
                        <i class="fas fa-search"></i>
                    </button>
                </div>
            </div>
            <div class="col-md-2">
                <select class="form-select" id="typeFilter" onchange="filterServices()">
                    <option value="">–í—Å–µ —Ç–∏–ø—ã</option>
                    <option value="ai">–ò–ò-—Å–µ—Ä–≤–∏—Å—ã</option>
                    <option value="hosting">–•–æ—Å—Ç–∏–Ω–≥</option>
                    <option value="payment">–ü–ª–∞—Ç–µ–∂–∏</option>
                    <option value="analytics">–ê–Ω–∞–ª–∏—Ç–∏–∫–∞</option>
                    <option value="storage">–•—Ä–∞–Ω–∏–ª–∏—â–µ</option>
                    <option value="other">–î—Ä—É–≥–æ–µ</option>
                </select>
            </div>
            <div class="col-md-2">
                <select class="form-select" id="statusFilter" onchange="filterServices()">
                    <option value="">–í—Å–µ —Å—Ç–∞—Ç—É—Å—ã</option>
                    <option value="active">–ê–∫—Ç–∏–≤–Ω—ã–µ</option>
                    <option value="inactive">–ù–µ–∞–∫—Ç–∏–≤–Ω—ã–µ</option>
                </select>
            </div>
            <div class="col-md-2">
                <select class="form-select" id="sortBy" onchange="sortServices()">
                    <option value="name">–ü–æ –Ω–∞–∑–≤–∞–Ω–∏—é</option>
                    <option value="cost">–ü–æ —Å—Ç–æ–∏–º–æ—Å—Ç–∏</option>
                    <option value="created_at">–ü–æ –¥–∞—Ç–µ</option>
                </select>
            </div>
            <div class="col-md-3">
                <button class="btn btn-outline-danger w-100" onclick="clearFilters()">
                    <i class="fas fa-times me-1"></i> –û—á–∏—Å—Ç–∏—Ç—å —Ñ–∏–ª—å—Ç—Ä—ã
                </button>
            </div>
        </div>
    </div>
</div>

<!-- –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ -->
<div class="row mb-4">
    <div class="col-md-3">
        <div class="stat-card primary">
            <div class="d-flex align-items-center">
                <i class="fas fa-server fa-2x me-3"></i>
                <div>
                    <div class="h4 mb-0" id="totalServices">0</div>
                    <small>–í—Å–µ–≥–æ —Å–µ—Ä–≤–∏—Å–æ–≤</small>
                </div>
            </div>
        </div>
    </div>
    <div class="col-md-3">
        <div class="stat-card success">
            <div class="d-flex align-items-center">
                <i class="fas fa-check-circle fa-2x me-3"></i>
                <div>
                    <div class="h4 mb-0" id="activeServices">0</div>
                    <small>–ê–∫—Ç–∏–≤–Ω—ã–µ</small>
                </div>
            </div>
        </div>
    </div>
    <div class="col-md-3">
        <div class="stat-card warning">
            <div class="d-flex align-items-center">
                <i class="fas fa-ruble-sign fa-2x me-3"></i>
                <div>
                    <div class="h4 mb-0" id="monthlyExpenses">0‚ÇΩ</div>
                    <small>–†–∞—Å—Ö–æ–¥—ã –∑–∞ –º–µ—Å—è—Ü</small>
                </div>
            </div>
        </div>
    </div>
    <div class="col-md-3">
        <div class="stat-card info">
            <div class="d-flex align-items-center">
                <i class="fas fa-chart-line fa-2x me-3"></i>
                <div>
                    <div class="h4 mb-0" id="yearlyExpenses">0‚ÇΩ</div>
                    <small>–†–∞—Å—Ö–æ–¥—ã –∑–∞ –≥–æ–¥</small>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- –°–ø–∏—Å–æ–∫ —Å–µ—Ä–≤–∏—Å–æ–≤ -->
<div class="card">
    <div class="card-header d-flex justify-content-between align-items-center">
        <h5 class="card-title mb-0">–°–ø–∏—Å–æ–∫ —Å–µ—Ä–≤–∏—Å–æ–≤</h5>
        <span class="text-muted" id="servicesCount">–ü–æ–∫–∞–∑–∞–Ω–æ: 0</span>
    </div>
    <div class="card-body p-0">
        <div class="table-responsive">
            <table class="table table-hover mb-0" id="servicesTable">
                <thead class="table-dark">
                    <tr>
                        <th>–ù–∞–∑–≤–∞–Ω–∏–µ</th>
                        <th>–¢–∏–ø</th>
                        <th>–ú–æ–¥–µ–ª—å —Ü–µ–Ω–æ–æ–±—Ä–∞–∑–æ–≤–∞–Ω–∏—è</th>
                        <th>–ú–µ—Å—è—á–Ω—ã–π —Ä–∞—Å—Ö–æ–¥</th>
                        <th>–°—Ç–∞—Ç—É—Å</th>
                        <th>–ü–æ—Å–ª–µ–¥–Ω–∏–π –ø–ª–∞—Ç–µ–∂</th>
                        <th>–î–µ–π—Å—Ç–≤–∏—è</th>
                    </tr>
                </thead>
                <tbody id="servicesTableBody">
                    <!-- –î–∞–Ω–Ω—ã–µ –∑–∞–≥—Ä—É–∂–∞—é—Ç—Å—è —á–µ—Ä–µ–∑ JavaScript -->
                </tbody>
            </table>
        </div>
    </div>
</div>

<!-- –ú–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ –¥–æ–±–∞–≤–ª–µ–Ω–∏—è —Å–µ—Ä–≤–∏—Å–∞ -->
<div class="modal fade" id="addServiceModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">–î–æ–±–∞–≤–∏—Ç—å –Ω–æ–≤—ã–π —Å–µ—Ä–≤–∏—Å</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <form id="addServiceForm">
                    <div class="row">
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label for="serviceName" class="form-label">–ù–∞–∑–≤–∞–Ω–∏–µ —Å–µ—Ä–≤–∏—Å–∞</label>
                                <input type="text" class="form-control" id="serviceName" required>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label for="serviceType" class="form-label">–¢–∏–ø —Å–µ—Ä–≤–∏—Å–∞</label>
                                <select class="form-select" id="serviceType" required>
                                    <option value="">–í—ã–±–µ—Ä–∏—Ç–µ —Ç–∏–ø</option>
                                    <option value="ai">–ò–ò-—Å–µ—Ä–≤–∏—Å—ã</option>
                                    <option value="hosting">–•–æ—Å—Ç–∏–Ω–≥</option>
                                    <option value="payment">–ü–ª–∞—Ç–µ–∂–Ω—ã–µ —Å–∏—Å—Ç–µ–º—ã</option>
                                    <option value="analytics">–ê–Ω–∞–ª–∏—Ç–∏–∫–∞</option>
                                    <option value="storage">–•—Ä–∞–Ω–∏–ª–∏—â–µ –¥–∞–Ω–Ω—ã—Ö</option>
                                    <option value="email">Email-—Å–µ—Ä–≤–∏—Å—ã</option>
                                    <option value="sms">SMS-—Å–µ—Ä–≤–∏—Å—ã</option>
                                    <option value="cdn">CDN</option>
                                    <option value="monitoring">–ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥</option>
                                    <option value="other">–î—Ä—É–≥–æ–µ</option>
                                </select>
                            </div>
                        </div>
                    </div>
                    
                    <div class="mb-3">
                        <label for="serviceDescription" class="form-label">–û–ø–∏—Å–∞–Ω–∏–µ</label>
                        <textarea class="form-control" id="serviceDescription" rows="3"></textarea>
                    </div>
                    
                    <div class="row">
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label for="serviceWebsite" class="form-label">–í–µ–±-—Å–∞–π—Ç</label>
                                <input type="url" class="form-control" id="serviceWebsite">
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label for="pricingModel" class="form-label">–ú–æ–¥–µ–ª—å —Ü–µ–Ω–æ–æ–±—Ä–∞–∑–æ–≤–∞–Ω–∏—è</label>
                                <select class="form-select" id="pricingModel">
                                    <option value="monthly">–ï–∂–µ–º–µ—Å—è—á–Ω–∞—è –ø–æ–¥–ø–∏—Å–∫–∞</option>
                                    <option value="yearly">–ì–æ–¥–æ–≤–∞—è –ø–æ–¥–ø–∏—Å–∫–∞</option>
                                    <option value="usage">–ü–æ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—é</option>
                                    <option value="per_request">–ó–∞ –∑–∞–ø—Ä–æ—Å</option>
                                    <option value="one_time">–†–∞–∑–æ–≤—ã–π –ø–ª–∞—Ç–µ–∂</option>
                                    <option value="custom">–ò–Ω–¥–∏–≤–∏–¥—É–∞–ª—å–Ω–∞—è</option>
                                </select>
                            </div>
                        </div>
                    </div>
                    
                    <div class="mb-3">
                        <label for="contactInfo" class="form-label">–ö–æ–Ω—Ç–∞–∫—Ç–Ω–∞—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è (JSON)</label>
                        <textarea class="form-control" id="contactInfo" rows="3" placeholder='{"email": "support@service.com", "phone": "+1234567890"}'></textarea>
                        <div class="form-text">–í–≤–µ–¥–∏—Ç–µ –∫–æ–Ω—Ç–∞–∫—Ç–Ω—É—é –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –≤ —Ñ–æ—Ä–º–∞—Ç–µ JSON</div>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">–û—Ç–º–µ–Ω–∞</button>
                <button type="button" class="btn btn-primary" onclick="submitAddService()">–î–æ–±–∞–≤–∏—Ç—å —Å–µ—Ä–≤–∏—Å</button>
            </div>
        </div>
    </div>
</div>

<!-- –ú–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è —Å–µ—Ä–≤–∏—Å–∞ -->
<div class="modal fade" id="editServiceModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å —Å–µ—Ä–≤–∏—Å</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <form id="editServiceForm">
                    <input type="hidden" id="editServiceId">
                    <div class="row">
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label for="editServiceName" class="form-label">–ù–∞–∑–≤–∞–Ω–∏–µ —Å–µ—Ä–≤–∏—Å–∞</label>
                                <input type="text" class="form-control" id="editServiceName" required>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label for="editServiceType" class="form-label">–¢–∏–ø —Å–µ—Ä–≤–∏—Å–∞</label>
                                <select class="form-select" id="editServiceType" required>
                                    <option value="ai">–ò–ò-—Å–µ—Ä–≤–∏—Å—ã</option>
                                    <option value="hosting">–•–æ—Å—Ç–∏–Ω–≥</option>
                                    <option value="payment">–ü–ª–∞—Ç–µ–∂–Ω—ã–µ —Å–∏—Å—Ç–µ–º—ã</option>
                                    <option value="analytics">–ê–Ω–∞–ª–∏—Ç–∏–∫–∞</option>
                                    <option value="storage">–•—Ä–∞–Ω–∏–ª–∏—â–µ –¥–∞–Ω–Ω—ã—Ö</option>
                                    <option value="email">Email-—Å–µ—Ä–≤–∏—Å—ã</option>
                                    <option value="sms">SMS-—Å–µ—Ä–≤–∏—Å—ã</option>
                                    <option value="cdn">CDN</option>
                                    <option value="monitoring">–ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥</option>
                                    <option value="other">–î—Ä—É–≥–æ–µ</option>
                                </select>
                            </div>
                        </div>
                    </div>
                    
                    <div class="mb-3">
                        <label for="editServiceDescription" class="form-label">–û–ø–∏—Å–∞–Ω–∏–µ</label>
                        <textarea class="form-control" id="editServiceDescription" rows="3"></textarea>
                    </div>
                    
                    <div class="row">
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label for="editServiceWebsite" class="form-label">–í–µ–±-—Å–∞–π—Ç</label>
                                <input type="url" class="form-control" id="editServiceWebsite">
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label for="editPricingModel" class="form-label">–ú–æ–¥–µ–ª—å —Ü–µ–Ω–æ–æ–±—Ä–∞–∑–æ–≤–∞–Ω–∏—è</label>
                                <select class="form-select" id="editPricingModel">
                                    <option value="monthly">–ï–∂–µ–º–µ—Å—è—á–Ω–∞—è –ø–æ–¥–ø–∏—Å–∫–∞</option>
                                    <option value="yearly">–ì–æ–¥–æ–≤–∞—è –ø–æ–¥–ø–∏—Å–∫–∞</option>
                                    <option value="usage">–ü–æ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—é</option>
                                    <option value="per_request">–ó–∞ –∑–∞–ø—Ä–æ—Å</option>
                                    <option value="one_time">–†–∞–∑–æ–≤—ã–π –ø–ª–∞—Ç–µ–∂</option>
                                    <option value="custom">–ò–Ω–¥–∏–≤–∏–¥—É–∞–ª—å–Ω–∞—è</option>
                                </select>
                            </div>
                        </div>
                    </div>
                    
                    <div class="row">
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label for="editContactInfo" class="form-label">–ö–æ–Ω—Ç–∞–∫—Ç–Ω–∞—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è (JSON)</label>
                                <textarea class="form-control" id="editContactInfo" rows="3"></textarea>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label for="editServiceStatus" class="form-label">–°—Ç–∞—Ç—É—Å</label>
                                <select class="form-select" id="editServiceStatus">
                                    <option value="active">–ê–∫—Ç–∏–≤–Ω—ã–π</option>
                                    <option value="inactive">–ù–µ–∞–∫—Ç–∏–≤–Ω—ã–π</option>
                                </select>
                            </div>
                        </div>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">–û—Ç–º–µ–Ω–∞</button>
                <button type="button" class="btn btn-primary" onclick="submitEditService()">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button>
            </div>
        </div>
    </div>
</div>

<!-- –ú–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ –¥–æ–±–∞–≤–ª–µ–Ω–∏—è —Ä–∞—Å—Ö–æ–¥–∞ -->
<div class="modal fade" id="addExpenseModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">–î–æ–±–∞–≤–∏—Ç—å —Ä–∞—Å—Ö–æ–¥</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <form id="addExpenseForm">
                    <input type="hidden" id="expenseServiceId">
                    
                    <div class="mb-3">
                        <label for="expenseAmount" class="form-label">–°—É–º–º–∞</label>
                        <input type="number" class="form-control" id="expenseAmount" step="0.01" required>
                    </div>
                    
                    <div class="mb-3">
                        <label for="expenseType" class="form-label">–¢–∏–ø —Ä–∞—Å—Ö–æ–¥–∞</label>
                        <select class="form-select" id="expenseType" required>
                            <option value="subscription">–ü–æ–¥–ø–∏—Å–∫–∞</option>
                            <option value="usage">–ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ</option>
                            <option value="one_time">–†–∞–∑–æ–≤—ã–π –ø–ª–∞—Ç–µ–∂</option>
                        </select>
                    </div>
                    
                    <div class="mb-3">
                        <label for="expenseDescription" class="form-label">–û–ø–∏—Å–∞–Ω–∏–µ</label>
                        <textarea class="form-control" id="expenseDescription" rows="3"></textarea>
                    </div>
                    
                    <div class="row">
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label for="expenseDate" class="form-label">–î–∞—Ç–∞ —Ä–∞—Å—Ö–æ–¥–∞</label>
                                <input type="date" class="form-control" id="expenseDate" required>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label for="expenseProject" class="form-label">–ü—Ä–æ–µ–∫—Ç (–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ)</label>
                                <select class="form-select" id="expenseProject">
                                    <option value="">–û–±—â–∏–π —Ä–∞—Å—Ö–æ–¥</option>
                                    <!-- –ó–∞–≥—Ä—É–∂–∞—é—Ç—Å—è —á–µ—Ä–µ–∑ JavaScript -->
                                </select>
                            </div>
                        </div>
                    </div>
                    
                    <div class="mb-3">
                        <label for="invoiceUrl" class="form-label">–°—Å—ã–ª–∫–∞ –Ω–∞ —Å—á—ë—Ç</label>
                        <input type="url" class="form-control" id="invoiceUrl">
                    </div>
                    
                    <div class="form-check">
                        <input class="form-check-input" type="checkbox" id="isRecurring">
                        <label class="form-check-label" for="isRecurring">
                            –ü–æ–≤—Ç–æ—Ä—è—é—â–∏–π—Å—è —Ä–∞—Å—Ö–æ–¥
                        </label>
                    </div>
                    
                    <div class="mb-3 d-none" id="recurringPeriodGroup">
                        <label for="recurringPeriod" class="form-label">–ü–µ—Ä–∏–æ–¥ –ø–æ–≤—Ç–æ—Ä–µ–Ω–∏—è</label>
                        <select class="form-select" id="recurringPeriod">
                            <option value="monthly">–ï–∂–µ–º–µ—Å—è—á–Ω–æ</option>
                            <option value="yearly">–ï–∂–µ–≥–æ–¥–Ω–æ</option>
                        </select>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">–û—Ç–º–µ–Ω–∞</button>
                <button type="button" class="btn btn-primary" onclick="submitAddExpense()">–î–æ–±–∞–≤–∏—Ç—å —Ä–∞—Å—Ö–æ–¥</button>
            </div>
        </div>
    </div>
</div>

{% endblock %}

{% block scripts %}
<script>
// –ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è
const username = 'admin';
const password = 'qwerty123';

let allServices = [];
let filteredServices = [];

// –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è
document.addEventListener('DOMContentLoaded', function() {
    loadServices();
    loadProjects(); // –î–ª—è –≤—ã–ø–∞–¥–∞—é—â–µ–≥–æ —Å–ø–∏—Å–∫–∞ –≤ —Ä–∞—Å—Ö–æ–¥–∞—Ö
});

// –ó–∞–≥—Ä—É–∑–∫–∞ —Å–µ—Ä–≤–∏—Å–æ–≤
async function loadServices() {
    try {
        const response = await fetch('/admin/api/services', {
            headers: {
                'Authorization': 'Basic ' + btoa(`${username}:${password}`)
            }
        });
        
        const data = await response.json();
        
        if (data.success) {
            allServices = data.data;
            filteredServices = [...allServices];
            updateServicesDisplay();
            updateStatistics();
        } else {
            showNotification('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ —Å–µ—Ä–≤–∏—Å–æ–≤: ' + data.error, 'error');
        }
    } catch (error) {
        console.error('Error loading services:', error);
        showNotification('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ —Å–µ—Ä–≤–∏—Å–æ–≤', 'error');
    }
}

// –ó–∞–≥—Ä—É–∑–∫–∞ –ø—Ä–æ–µ–∫—Ç–æ–≤ –¥–ª—è –≤—ã–ø–∞–¥–∞—é—â–µ–≥–æ —Å–ø–∏—Å–∫–∞
async function loadProjects() {
    try {
        const response = await fetch('/admin/api/projects', {
            headers: {
                'Authorization': 'Basic ' + btoa(`${username}:${password}`)
            }
        });
        
        const data = await response.json();
        
        if (data.success) {
            const projectSelect = document.getElementById('expenseProject');
            projectSelect.innerHTML = '<option value="">–û–±—â–∏–π —Ä–∞—Å—Ö–æ–¥</option>';
            
            data.projects.forEach(project => {
                const option = document.createElement('option');
                option.value = project.id;
                option.textContent = `#${project.id} - ${project.title}`;
                projectSelect.appendChild(option);
            });
        }
    } catch (error) {
        console.error('Error loading projects:', error);
    }
}

// –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è —Å–µ—Ä–≤–∏—Å–æ–≤
function updateServicesDisplay() {
    const tbody = document.getElementById('servicesTableBody');
    tbody.innerHTML = '';
    
    if (filteredServices.length === 0) {
        tbody.innerHTML = '<tr><td colspan="7" class="text-center">–°–µ—Ä–≤–∏—Å—ã –Ω–µ –Ω–∞–π–¥–µ–Ω—ã</td></tr>';
        return;
    }
    
    filteredServices.forEach(service => {
        const row = document.createElement('tr');
        row.innerHTML = `
            <td>
                <div class="fw-bold">${service.name}</div>
                <small class="text-muted">${service.description || '–ù–µ—Ç –æ–ø–∏—Å–∞–Ω–∏—è'}</small>
            </td>
            <td>
                <span class="badge bg-primary">${getServiceTypeLabel(service.provider_type)}</span>
            </td>
            <td>${getPricingModelLabel(service.pricing_model)}</td>
            <td>
                <span class="fw-bold">${service.monthly_cost || 0}‚ÇΩ</span>
            </td>
            <td>
                <span class="badge ${service.status === 'active' ? 'bg-success' : 'bg-secondary'}">
                    ${service.status === 'active' ? '–ê–∫—Ç–∏–≤–Ω—ã–π' : '–ù–µ–∞–∫—Ç–∏–≤–Ω—ã–π'}
                </span>
            </td>
            <td>
                <small>${service.last_expense ? new Date(service.last_expense).toLocaleDateString('ru-RU') : '–ù–µ—Ç –ø–ª–∞—Ç–µ–∂–µ–π'}</small>
            </td>
            <td>
                <div class="btn-group btn-group-sm">
                    <button class="btn btn-outline-primary" onclick="viewService(${service.id})" title="–ü—Ä–æ—Å–º–æ—Ç—Ä">
                        <i class="fas fa-eye"></i>
                    </button>
                    <button class="btn btn-outline-info" onclick="editService(${service.id})" title="–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å">
                        <i class="fas fa-edit"></i>
                    </button>
                    <button class="btn btn-outline-success" onclick="addExpense(${service.id})" title="–î–æ–±–∞–≤–∏—Ç—å —Ä–∞—Å—Ö–æ–¥">
                        <i class="fas fa-plus"></i>
                    </button>
                    <button class="btn btn-outline-danger" onclick="deleteService(${service.id})" title="–£–¥–∞–ª–∏—Ç—å">
                        <i class="fas fa-trash"></i>
                    </button>
                </div>
            </td>
        `;
        tbody.appendChild(row);
    });
    
    document.getElementById('servicesCount').textContent = `–ü–æ–∫–∞–∑–∞–Ω–æ: ${filteredServices.length}`;
}

// –ü–æ–ª—É—á–µ–Ω–∏–µ –º–µ—Ç–æ–∫ —Ç–∏–ø–æ–≤ —Å–µ—Ä–≤–∏—Å–æ–≤
function getServiceTypeLabel(type) {
    const labels = {
        'ai': '–ò–ò-—Å–µ—Ä–≤–∏—Å—ã',
        'hosting': '–•–æ—Å—Ç–∏–Ω–≥',
        'payment': '–ü–ª–∞—Ç–µ–∂–∏',
        'analytics': '–ê–Ω–∞–ª–∏—Ç–∏–∫–∞',
        'storage': '–•—Ä–∞–Ω–∏–ª–∏—â–µ',
        'email': 'Email',
        'sms': 'SMS',
        'cdn': 'CDN',
        'monitoring': '–ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥',
        'other': '–î—Ä—É–≥–æ–µ'
    };
    return labels[type] || type;
}

// –ü–æ–ª—É—á–µ–Ω–∏–µ –º–µ—Ç–æ–∫ –º–æ–¥–µ–ª–µ–π —Ü–µ–Ω–æ–æ–±—Ä–∞–∑–æ–≤–∞–Ω–∏—è
function getPricingModelLabel(model) {
    const labels = {
        'monthly': '–ï–∂–µ–º–µ—Å—è—á–Ω–æ',
        'yearly': '–ï–∂–µ–≥–æ–¥–Ω–æ',
        'usage': '–ü–æ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—é',
        'per_request': '–ó–∞ –∑–∞–ø—Ä–æ—Å',
        'one_time': '–†–∞–∑–æ–≤—ã–π',
        'custom': '–ò–Ω–¥–∏–≤–∏–¥—É–∞–ª—å–Ω–∞—è'
    };
    return labels[model] || model;
}

// –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏
function updateStatistics() {
    const total = allServices.length;
    const active = allServices.filter(s => s.status === 'active').length;
    const monthlyExpenses = allServices.reduce((sum, s) => sum + (s.monthly_cost || 0), 0);
    const yearlyExpenses = allServices.reduce((sum, s) => sum + (s.yearly_cost || 0), 0);
    
    document.getElementById('totalServices').textContent = total;
    document.getElementById('activeServices').textContent = active;
    document.getElementById('monthlyExpenses').textContent = monthlyExpenses + '‚ÇΩ';
    document.getElementById('yearlyExpenses').textContent = yearlyExpenses + '‚ÇΩ';
}

// –§–∏–ª—å—Ç—Ä–∞—Ü–∏—è —Å–µ—Ä–≤–∏—Å–æ–≤
function filterServices() {
    const search = document.getElementById('searchInput').value.toLowerCase();
    const type = document.getElementById('typeFilter').value;
    const status = document.getElementById('statusFilter').value;
    
    filteredServices = allServices.filter(service => {
        const matchesSearch = !search || 
            service.name.toLowerCase().includes(search) ||
            (service.description && service.description.toLowerCase().includes(search));
        
        const matchesType = !type || service.provider_type === type;
        const matchesStatus = !status || service.status === status;
        
        return matchesSearch && matchesType && matchesStatus;
    });
    
    updateServicesDisplay();
}

// –°–æ—Ä—Ç–∏—Ä–æ–≤–∫–∞ —Å–µ—Ä–≤–∏—Å–æ–≤
function sortServices() {
    const sortBy = document.getElementById('sortBy').value;
    
    filteredServices.sort((a, b) => {
        if (sortBy === 'name') {
            return a.name.localeCompare(b.name);
        } else if (sortBy === 'cost') {
            return (b.monthly_cost || 0) - (a.monthly_cost || 0);
        } else if (sortBy === 'created_at') {
            return new Date(b.created_at) - new Date(a.created_at);
        }
        return 0;
    });
    
    updateServicesDisplay();
}

// –û—á–∏—Å—Ç–∫–∞ —Ñ–∏–ª—å—Ç—Ä–æ–≤
function clearFilters() {
    document.getElementById('searchInput').value = '';
    document.getElementById('typeFilter').value = '';
    document.getElementById('statusFilter').value = '';
    filteredServices = [...allServices];
    updateServicesDisplay();
}

// –ü–æ–∫–∞–∑–∞—Ç—å –º–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ –¥–æ–±–∞–≤–ª–µ–Ω–∏—è —Å–µ—Ä–≤–∏—Å–∞
function showAddServiceModal() {
    document.getElementById('addServiceForm').reset();
    const modal = new bootstrap.Modal(document.getElementById('addServiceModal'));
    modal.show();
}

// –î–æ–±–∞–≤–∏—Ç—å —Å–µ—Ä–≤–∏—Å
async function submitAddService() {
    const formData = {
        name: document.getElementById('serviceName').value,
        provider_type: document.getElementById('serviceType').value,
        description: document.getElementById('serviceDescription').value,
        website: document.getElementById('serviceWebsite').value,
        pricing_model: document.getElementById('pricingModel').value,
        contact_info: {}
    };
    
    try {
        const contactInfoText = document.getElementById('contactInfo').value;
        if (contactInfoText.trim()) {
            formData.contact_info = JSON.parse(contactInfoText);
        }
    } catch (error) {
        showNotification('–û—à–∏–±–∫–∞ –≤ —Ñ–æ—Ä–º–∞—Ç–µ JSON –∫–æ–Ω—Ç–∞–∫—Ç–Ω–æ–π –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏', 'error');
        return;
    }
    
    try {
        const response = await fetch('/admin/api/services', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'Authorization': 'Basic ' + btoa(`${username}:${password}`)
            },
            body: JSON.stringify(formData)
        });
        
        const data = await response.json();
        
        if (data.success) {
            showNotification('–°–µ—Ä–≤–∏—Å —É—Å–ø–µ—à–Ω–æ –¥–æ–±–∞–≤–ª–µ–Ω', 'success');
            const modal = bootstrap.Modal.getInstance(document.getElementById('addServiceModal'));
            modal.hide();
            loadServices();
        } else {
            showNotification('–û—à–∏–±–∫–∞: ' + data.error, 'error');
        }
    } catch (error) {
        console.error('Error adding service:', error);
        showNotification('–û—à–∏–±–∫–∞ –ø—Ä–∏ –¥–æ–±–∞–≤–ª–µ–Ω–∏–∏ —Å–µ—Ä–≤–∏—Å–∞', 'error');
    }
}

// –†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å —Å–µ—Ä–≤–∏—Å
function editService(serviceId) {
    const service = allServices.find(s => s.id === serviceId);
    if (!service) return;
    
    document.getElementById('editServiceId').value = service.id;
    document.getElementById('editServiceName').value = service.name;
    document.getElementById('editServiceType').value = service.provider_type;
    document.getElementById('editServiceDescription').value = service.description || '';
    document.getElementById('editServiceWebsite').value = service.website || '';
    document.getElementById('editPricingModel').value = service.pricing_model || 'monthly';
    document.getElementById('editContactInfo').value = JSON.stringify(service.contact_info || {}, null, 2);
    document.getElementById('editServiceStatus').value = service.status;
    
    const modal = new bootstrap.Modal(document.getElementById('editServiceModal'));
    modal.show();
}

// –°–æ—Ö—Ä–∞–Ω–∏—Ç—å –∏–∑–º–µ–Ω–µ–Ω–∏—è —Å–µ—Ä–≤–∏—Å–∞
async function submitEditService() {
    const serviceId = document.getElementById('editServiceId').value;
    const formData = {
        name: document.getElementById('editServiceName').value,
        provider_type: document.getElementById('editServiceType').value,
        description: document.getElementById('editServiceDescription').value,
        website: document.getElementById('editServiceWebsite').value,
        pricing_model: document.getElementById('editPricingModel').value,
        status: document.getElementById('editServiceStatus').value,
        contact_info: {}
    };
    
    try {
        const contactInfoText = document.getElementById('editContactInfo').value;
        if (contactInfoText.trim()) {
            formData.contact_info = JSON.parse(contactInfoText);
        }
    } catch (error) {
        showNotification('–û—à–∏–±–∫–∞ –≤ —Ñ–æ—Ä–º–∞—Ç–µ JSON –∫–æ–Ω—Ç–∞–∫—Ç–Ω–æ–π –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏', 'error');
        return;
    }
    
    try {
        const response = await fetch(`/admin/api/services/${serviceId}`, {
            method: 'PUT',
            headers: {
                'Content-Type': 'application/json',
                'Authorization': 'Basic ' + btoa(`${username}:${password}`)
            },
            body: JSON.stringify(formData)
        });
        
        const data = await response.json();
        
        if (data.success) {
            showNotification('–°–µ—Ä–≤–∏—Å —É—Å–ø–µ—à–Ω–æ –æ–±–Ω–æ–≤–ª–µ–Ω', 'success');
            const modal = bootstrap.Modal.getInstance(document.getElementById('editServiceModal'));
            modal.hide();
            loadServices();
        } else {
            showNotification('–û—à–∏–±–∫–∞: ' + data.error, 'error');
        }
    } catch (error) {
        console.error('Error updating service:', error);
        showNotification('–û—à–∏–±–∫–∞ –ø—Ä–∏ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–∏ —Å–µ—Ä–≤–∏—Å–∞', 'error');
    }
}

// –î–æ–±–∞–≤–∏—Ç—å —Ä–∞—Å—Ö–æ–¥
function addExpense(serviceId) {
    document.getElementById('expenseServiceId').value = serviceId;
    document.getElementById('addExpenseForm').reset();
    document.getElementById('expenseDate').value = new Date().toISOString().split('T')[0];
    
    const modal = new bootstrap.Modal(document.getElementById('addExpenseModal'));
    modal.show();
}

// –ü–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏–µ –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è –ø–æ–≤—Ç–æ—Ä—è—é—â–µ–≥–æ—Å—è —Ä–∞—Å—Ö–æ–¥–∞
document.getElementById('isRecurring').addEventListener('change', function() {
    const recurringGroup = document.getElementById('recurringPeriodGroup');
    if (this.checked) {
        recurringGroup.classList.remove('d-none');
    } else {
        recurringGroup.classList.add('d-none');
    }
});

// –°–æ—Ö—Ä–∞–Ω–∏—Ç—å —Ä–∞—Å—Ö–æ–¥
async function submitAddExpense() {
    const formData = {
        service_provider_id: parseInt(document.getElementById('expenseServiceId').value),
        amount: parseFloat(document.getElementById('expenseAmount').value),
        expense_type: document.getElementById('expenseType').value,
        description: document.getElementById('expenseDescription').value,
        expense_date: document.getElementById('expenseDate').value,
        project_id: document.getElementById('expenseProject').value || null,
        invoice_url: document.getElementById('invoiceUrl').value || null,
        is_recurring: document.getElementById('isRecurring').checked,
        recurring_period: document.getElementById('isRecurring').checked ? 
            document.getElementById('recurringPeriod').value : null
    };
    
    try {
        const response = await fetch('/admin/api/services/expenses', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'Authorization': 'Basic ' + btoa(`${username}:${password}`)
            },
            body: JSON.stringify(formData)
        });
        
        const data = await response.json();
        
        if (data.success) {
            showNotification('–†–∞—Å—Ö–æ–¥ —É—Å–ø–µ—à–Ω–æ –¥–æ–±–∞–≤–ª–µ–Ω', 'success');
            const modal = bootstrap.Modal.getInstance(document.getElementById('addExpenseModal'));
            modal.hide();
            loadServices(); // –û–±–Ω–æ–≤–ª—è–µ–º —Å–ø–∏—Å–æ–∫ –¥–ª—è –∞–∫—Ç—É–∞–ª–∏–∑–∞—Ü–∏–∏ —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏
        } else {
            showNotification('–û—à–∏–±–∫–∞: ' + data.error, 'error');
        }
    } catch (error) {
        console.error('Error adding expense:', error);
        showNotification('–û—à–∏–±–∫–∞ –ø—Ä–∏ –¥–æ–±–∞–≤–ª–µ–Ω–∏–∏ —Ä–∞—Å—Ö–æ–¥–∞', 'error');
    }
}

// –£–¥–∞–ª–∏—Ç—å —Å–µ—Ä–≤–∏—Å
async function deleteService(serviceId) {
    if (!confirm('–í—ã —É–≤–µ—Ä–µ–Ω—ã, —á—Ç–æ —Ö–æ—Ç–∏—Ç–µ —É–¥–∞–ª–∏—Ç—å —ç—Ç–æ—Ç —Å–µ—Ä–≤–∏—Å?')) {
        return;
    }
    
    try {
        const response = await fetch(`/admin/api/services/${serviceId}`, {
            method: 'DELETE',
            headers: {
                'Authorization': 'Basic ' + btoa(`${username}:${password}`)
            }
        });
        
        const data = await response.json();
        
        if (data.success) {
            showNotification('–°–µ—Ä–≤–∏—Å —É–¥–∞–ª–µ–Ω', 'success');
            loadServices();
        } else {
            showNotification('–û—à–∏–±–∫–∞: ' + data.error, 'error');
        }
    } catch (error) {
        console.error('Error deleting service:', error);
        showNotification('–û—à–∏–±–∫–∞ –ø—Ä–∏ —É–¥–∞–ª–µ–Ω–∏–∏ —Å–µ—Ä–≤–∏—Å–∞', 'error');
    }
}

// –ü—Ä–æ—Å–º–æ—Ç—Ä —Å–µ—Ä–≤–∏—Å–∞
function viewService(serviceId) {
    const service = allServices.find(s => s.id === serviceId);
    if (!service) return;
    
    alert(`–°–µ—Ä–≤–∏—Å: ${service.name}\n–¢–∏–ø: ${getServiceTypeLabel(service.provider_type)}\n–û–ø–∏—Å–∞–Ω–∏–µ: ${service.description || '–ù–µ—Ç –æ–ø–∏—Å–∞–Ω–∏—è'}\n–°—Ç–∞—Ç—É—Å: ${service.status}`);
}

// –û–±–Ω–æ–≤–∏—Ç—å —Å–ø–∏—Å–æ–∫
function refreshServices() {
    loadServices();
}

// –≠–∫—Å–ø–æ—Ä—Ç —Å–µ—Ä–≤–∏—Å–æ–≤
function exportServices() {
    const dataStr = JSON.stringify(allServices, null, 2);
    const dataBlob = new Blob([dataStr], {type: 'application/json'});
    
    const link = document.createElement('a');
    link.href = URL.createObjectURL(dataBlob);
    link.download = `services_export_${new Date().toISOString().split('T')[0]}.json`;
    link.click();
    
    showNotification('–≠–∫—Å–ø–æ—Ä—Ç –≤—ã–ø–æ–ª–Ω–µ–Ω', 'success');
}

// –£–≤–µ–¥–æ–º–ª–µ–Ω–∏—è
function showNotification(message, type = 'info') {
    // –ú–æ–∂–Ω–æ —Ä–µ–∞–ª–∏–∑–æ–≤–∞—Ç—å –∫—Ä–∞—Å–∏–≤—ã–µ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è
    console.log(`${type.toUpperCase()}: ${message}`);
    alert(message);
}
</script>
{% endblock %}
