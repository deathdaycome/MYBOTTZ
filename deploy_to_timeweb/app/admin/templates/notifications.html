{% extends "base.html" %}

{% block title %}–¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π - –ê–¥–º–∏–Ω-–ø–∞–Ω–µ–ª—å{% endblock %}

{% block page_title %}üß™ –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π{% endblock %}

{% block content %}
<div class="container-fluid">
    <div class="row">
        <div class="col-md-8">
            <div class="card">
                <div class="card-header">
                    <h5><i class="fas fa-bell me-2"></i>–¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ —Å–∏—Å—Ç–µ–º—ã —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π</h5>
                </div>
                <div class="card-body">
                    <div class="row">
                        <div class="col-md-6">
                            <h6>–£–≤–µ–¥–æ–º–ª–µ–Ω–∏—è –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä—É</h6>
                            <div class="mb-3">
                                <button class="btn btn-info btn-sm w-100" onclick="testAdminNotification()">
                                    <i class="fas fa-paper-plane me-1"></i> –¢–µ—Å—Ç–æ–≤–æ–µ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ
                                </button>
                            </div>
                            <div class="mb-3">
                                <button class="btn btn-warning btn-sm w-100" onclick="testErrorNotification()">
                                    <i class="fas fa-exclamation-triangle me-1"></i> –¢–µ—Å—Ç–æ–≤–∞—è –æ—à–∏–±–∫–∞
                                </button>
                            </div>
                            <div class="mb-3">
                                <button class="btn btn-success btn-sm w-100" onclick="testDailyReport()">
                                    <i class="fas fa-chart-line me-1"></i> –ï–∂–µ–¥–Ω–µ–≤–Ω—ã–π –æ—Ç—á–µ—Ç
                                </button>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <h6>–£–≤–µ–¥–æ–º–ª–µ–Ω–∏—è –∫–ª–∏–µ–Ω—Ç–∞–º</h6>
                            <div class="mb-3">
                                <label class="form-label">–í—ã–±–µ—Ä–∏—Ç–µ –ø—Ä–æ–µ–∫—Ç:</label>
                                <select class="form-select" id="projectSelect">
                                    <option value="">–ó–∞–≥—Ä—É–∑–∫–∞...</option>
                                </select>
                            </div>
                            <div class="mb-3">
                                <label class="form-label">–ù–æ–≤—ã–π —Å—Ç–∞—Ç—É—Å:</label>
                                <select class="form-select" id="statusSelect">
                                    <option value="new">üÜï –ù–æ–≤—ã–π</option>
                                    <option value="review">üëÄ –ù–∞ —Ä–∞—Å—Å–º–æ—Ç—Ä–µ–Ω–∏–∏</option>
                                    <option value="accepted">‚úÖ –ü—Ä–∏–Ω—è—Ç</option>
                                    <option value="in_progress">üîÑ –í —Ä–∞–±–æ—Ç–µ</option>
                                    <option value="testing">üß™ –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ</option>
                                    <option value="completed">üéâ –ó–∞–≤–µ—Ä—à–µ–Ω</option>
                                    <option value="cancelled">‚ùå –û—Ç–º–µ–Ω–µ–Ω</option>
                                </select>
                            </div>
                            <div class="mb-3">
                                <button class="btn btn-primary btn-sm w-100" onclick="testStatusNotification()">
                                    <i class="fas fa-sync-alt me-1"></i> –¢–µ—Å—Ç–∏—Ä–æ–≤–∞—Ç—å —Å–º–µ–Ω—É —Å—Ç–∞—Ç—É—Å–∞
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        <div class="col-md-4">
            <div class="card">
                <div class="card-header">
                    <h5><i class="fas fa-cog me-2"></i>–ù–∞—Å—Ç—Ä–æ–π–∫–∏ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π</h5>
                </div>
                <div class="card-body">
                    <div class="mb-3">
                        <label class="form-label">–ê–¥–º–∏–Ω —á–∞—Ç ID:</label>
                        <input type="text" class="form-control" id="adminChatId" readonly>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">–°—Ç–∞—Ç—É—Å –±–æ—Ç–∞:</label>
                        <div id="botStatus" class="alert alert-info">
                            <i class="fas fa-spinner fa-spin me-1"></i> –ü—Ä–æ–≤–µ—Ä–∫–∞...
                        </div>
                    </div>
                    <div class="mb-3">
                        <button class="btn btn-secondary btn-sm w-100" onclick="checkBotStatus()">
                            <i class="fas fa-sync me-1"></i> –ü—Ä–æ–≤–µ—Ä–∏—Ç—å —Å—Ç–∞—Ç—É—Å
                        </button>
                    </div>
                </div>
            </div>
            
            <div class="card mt-3">
                <div class="card-header">
                    <h5><i class="fas fa-history me-2"></i>–õ–æ–≥ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π</h5>
                </div>
                <div class="card-body">
                    <div id="notificationLog" style="height: 300px; overflow-y: auto;">
                        <p class="text-muted">–õ–æ–≥–∏ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π –±—É–¥—É—Ç –æ—Ç–æ–±—Ä–∞–∂–∞—Ç—å—Å—è –∑–¥–µ—Å—å...</p>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
    // –ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è –∞—É—Ç–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏–∏
    const username = 'admin';
    const password = 'qwerty123';
    
    let projects = [];
    
    // –ó–∞–≥—Ä—É–∑–∫–∞ –¥–∞–Ω–Ω—ã—Ö –ø—Ä–∏ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏–∏
    document.addEventListener('DOMContentLoaded', function() {
        loadProjects();
        loadSettings();
        checkBotStatus();
    });
    
    function addLog(message, type = 'info') {
        const logDiv = document.getElementById('notificationLog');
        const timestamp = new Date().toLocaleString('ru-RU');
        const alertClass = type === 'success' ? 'alert-success' : 
                          type === 'error' ? 'alert-danger' : 'alert-info';
        
        const logEntry = document.createElement('div');
        logEntry.className = `alert ${alertClass} p-2 mb-2`;
        logEntry.innerHTML = `
            <small class="text-muted">${timestamp}</small><br>
            ${message}
        `;
        
        logDiv.insertBefore(logEntry, logDiv.firstChild);
        
        // –£–¥–∞–ª—è–µ–º —Å—Ç–∞—Ä—ã–µ –∑–∞–ø–∏—Å–∏ (–æ—Å—Ç–∞–≤–ª—è–µ–º —Ç–æ–ª—å–∫–æ –ø–æ—Å–ª–µ–¥–Ω–∏–µ 10)
        const entries = logDiv.querySelectorAll('.alert');
        if (entries.length > 10) {
            entries[entries.length - 1].remove();
        }
    }
    
    async function loadProjects() {
        try {
            const response = await fetch('/admin/api/projects/', {
                headers: {
                    'Authorization': 'Basic ' + btoa(`${username}:${password}`)
                }
            });
            
            if (response.ok) {
                const data = await response.json();
                projects = data.projects || [];
                
                const select = document.getElementById('projectSelect');
                select.innerHTML = '<option value="">–í—ã–±–µ—Ä–∏—Ç–µ –ø—Ä–æ–µ–∫—Ç...</option>';
                
                projects.forEach(project => {
                    const option = document.createElement('option');
                    option.value = project.id;
                    option.textContent = `#${project.id} - ${project.title}`;
                    select.appendChild(option);
                });
            }
        } catch (error) {
            console.error('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –ø—Ä–æ–µ–∫—Ç–æ–≤:', error);
            addLog('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –ø—Ä–æ–µ–∫—Ç–æ–≤', 'error');
        }
    }
    
    async function loadSettings() {
        // –ó–¥–µ—Å—å –º–æ–∂–Ω–æ –∑–∞–≥—Ä—É–∑–∏—Ç—å –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ –∏–∑ API
        document.getElementById('adminChatId').value = '–ó–∞–≥—Ä—É–∂–∞–µ—Ç—Å—è...';
    }
    
    async function testAdminNotification() {
        addLog('–û—Ç–ø—Ä–∞–≤–∫–∞ —Ç–µ—Å—Ç–æ–≤–æ–≥–æ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä—É...', 'info');
        
        try {
            const response = await fetch('/api/notifications/test-admin', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'Authorization': 'Basic ' + btoa(`${username}:${password}`)
                },
                body: JSON.stringify({
                    message: 'üß™ –¢–µ—Å—Ç–æ–≤–æ–µ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ –∏–∑ –∞–¥–º–∏–Ω-–ø–∞–Ω–µ–ª–∏'
                })
            });
            
            const data = await response.json();
            
            if (data.success) {
                addLog('‚úÖ –¢–µ—Å—Ç–æ–≤–æ–µ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä—É –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–æ', 'success');
            } else {
                addLog(`‚ùå –û—à–∏–±–∫–∞: ${data.message}`, 'error');
            }
        } catch (error) {
            console.error('–û—à–∏–±–∫–∞:', error);
            addLog('‚ùå –û—à–∏–±–∫–∞ –æ—Ç–ø—Ä–∞–≤–∫–∏ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è', 'error');
        }
    }
    
    async function testErrorNotification() {
        addLog('–û—Ç–ø—Ä–∞–≤–∫–∞ —Ç–µ—Å—Ç–æ–≤–æ–≥–æ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è –æ–± –æ—à–∏–±–∫–µ...', 'info');
        
        try {
            const response = await fetch('/api/notifications/test-error', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'Authorization': 'Basic ' + btoa(`${username}:${password}`)
                },
                body: JSON.stringify({
                    error: '–¢–µ—Å—Ç–æ–≤–∞—è –æ—à–∏–±–∫–∞ –∏–∑ –∞–¥–º–∏–Ω-–ø–∞–Ω–µ–ª–∏',
                    context: {
                        source: 'admin-panel',
                        timestamp: new Date().toISOString()
                    }
                })
            });
            
            const data = await response.json();
            
            if (data.success) {
                addLog('‚úÖ –£–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ –æ–± –æ—à–∏–±–∫–µ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–æ', 'success');
            } else {
                addLog(`‚ùå –û—à–∏–±–∫–∞: ${data.message}`, 'error');
            }
        } catch (error) {
            console.error('–û—à–∏–±–∫–∞:', error);
            addLog('‚ùå –û—à–∏–±–∫–∞ –æ—Ç–ø—Ä–∞–≤–∫–∏ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è', 'error');
        }
    }
    
    async function testDailyReport() {
        addLog('–û—Ç–ø—Ä–∞–≤–∫–∞ –µ–∂–µ–¥–Ω–µ–≤–Ω–æ–≥–æ –æ—Ç—á–µ—Ç–∞...', 'info');
        
        try {
            const response = await fetch('/api/notifications/daily-report', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'Authorization': 'Basic ' + btoa(`${username}:${password}`)
                }
            });
            
            const data = await response.json();
            
            if (data.success) {
                addLog('‚úÖ –ï–∂–µ–¥–Ω–µ–≤–Ω—ã–π –æ—Ç—á–µ—Ç –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω', 'success');
            } else {
                addLog(`‚ùå –û—à–∏–±–∫–∞: ${data.message}`, 'error');
            }
        } catch (error) {
            console.error('–û—à–∏–±–∫–∞:', error);
            addLog('‚ùå –û—à–∏–±–∫–∞ –æ—Ç–ø—Ä–∞–≤–∫–∏ –æ—Ç—á–µ—Ç–∞', 'error');
        }
    }
    
    async function testStatusNotification() {
        const projectId = document.getElementById('projectSelect').value;
        const newStatus = document.getElementById('statusSelect').value;
        
        if (!projectId) {
            addLog('‚ùå –í—ã–±–µ—Ä–∏—Ç–µ –ø—Ä–æ–µ–∫—Ç', 'error');
            return;
        }
        
        const project = projects.find(p => p.id == projectId);
        if (!project) {
            addLog('‚ùå –ü—Ä–æ–µ–∫—Ç –Ω–µ –Ω–∞–π–¥–µ–Ω', 'error');
            return;
        }
        
        addLog(`–¢–µ—Å—Ç–∏—Ä—É–µ–º —Å–º–µ–Ω—É —Å—Ç–∞—Ç—É—Å–∞ –ø—Ä–æ–µ–∫—Ç–∞ #${projectId} –Ω–∞ "${newStatus}"...`, 'info');
        
        try {
            const response = await fetch(`/admin/api/projects/${projectId}/status`, {
                method: 'PUT',
                headers: {
                    'Content-Type': 'application/json',
                    'Authorization': 'Basic ' + btoa(`${username}:${password}`)
                },
                body: JSON.stringify({
                    status: newStatus,
                    comment: '–¢–µ—Å—Ç–æ–≤–æ–µ –∏–∑–º–µ–Ω–µ–Ω–∏–µ —Å—Ç–∞—Ç—É—Å–∞ –∏–∑ –∞–¥–º–∏–Ω-–ø–∞–Ω–µ–ª–∏'
                })
            });
            
            const data = await response.json();
            
            if (data.success) {
                addLog(`‚úÖ –°—Ç–∞—Ç—É—Å –ø—Ä–æ–µ–∫—Ç–∞ #${projectId} –∏–∑–º–µ–Ω–µ–Ω –Ω–∞ "${newStatus}"`, 'success');
                addLog('üì§ –£–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ –∫–ª–∏–µ–Ω—Ç—É –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–æ', 'success');
                
                // –û–±–Ω–æ–≤–ª—è–µ–º –¥–∞–Ω–Ω—ã–µ –ø—Ä–æ–µ–∫—Ç–∞
                project.status = newStatus;
            } else {
                addLog(`‚ùå –û—à–∏–±–∫–∞: ${data.message}`, 'error');
            }
        } catch (error) {
            console.error('–û—à–∏–±–∫–∞:', error);
            addLog('‚ùå –û—à–∏–±–∫–∞ –∏–∑–º–µ–Ω–µ–Ω–∏—è —Å—Ç–∞—Ç—É—Å–∞', 'error');
        }
    }
    
    async function checkBotStatus() {
        const statusDiv = document.getElementById('botStatus');
        statusDiv.innerHTML = '<i class="fas fa-spinner fa-spin me-1"></i> –ü—Ä–æ–≤–µ—Ä–∫–∞...';
        statusDiv.className = 'alert alert-info';
        
        try {
            const response = await fetch('/api/notifications/bot-status', {
                headers: {
                    'Authorization': 'Basic ' + btoa(`${username}:${password}`)
                }
            });
            
            const data = await response.json();
            
            if (data.success) {
                statusDiv.innerHTML = '<i class="fas fa-check-circle me-1"></i> –ë–æ—Ç —Ä–∞–±–æ—Ç–∞–µ—Ç';
                statusDiv.className = 'alert alert-success';
                
                if (data.bot_info) {
                    statusDiv.innerHTML += `<br><small>@${data.bot_info.username}</small>`;
                }
            } else {
                statusDiv.innerHTML = '<i class="fas fa-times-circle me-1"></i> –ë–æ—Ç –Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω';
                statusDiv.className = 'alert alert-danger';
            }
        } catch (error) {
            console.error('–û—à–∏–±–∫–∞:', error);
            statusDiv.innerHTML = '<i class="fas fa-exclamation-triangle me-1"></i> –û—à–∏–±–∫–∞ –ø—Ä–æ–≤–µ—Ä–∫–∏';
            statusDiv.className = 'alert alert-warning';
        }
    }
    
    // –§—É–Ω–∫—Ü–∏—è –¥–ª—è –ø–æ–∫–∞–∑–∞ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π
    function showNotification(message, type = 'info') {
        // –ò—Å–ø–æ–ª—å–∑—É–µ–º —Å—É—â–µ—Å—Ç–≤—É—é—â—É—é —Å–∏—Å—Ç–µ–º—É —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π
        const alertClass = type === 'success' ? 'alert-success' : 
                          type === 'error' ? 'alert-danger' : 'alert-info';
        
        const notification = document.createElement('div');
        notification.className = `alert ${alertClass} alert-dismissible fade show position-fixed`;
        notification.style.cssText = 'top: 20px; right: 20px; z-index: 1050; min-width: 300px;';
        notification.innerHTML = `
            ${message}
            <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
        `;
        
        document.body.appendChild(notification);
        
        // –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ —Å–∫—Ä—ã–≤–∞–µ–º —á–µ—Ä–µ–∑ 5 —Å–µ–∫—É–Ω–¥
        setTimeout(() => {
            notification.remove();
        }, 5000);
    }
</script>
{% endblock %}
