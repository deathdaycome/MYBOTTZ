{% extends "base.html" %}

{% block title %}–ê–Ω–∞–ª–∏—Ç–∏–∫–∞ - –ê–¥–º–∏–Ω-–ø–∞–Ω–µ–ª—å{% endblock %}

{% block page_title %}üìà –ê–Ω–∞–ª–∏—Ç–∏–∫–∞ –∏ –æ—Ç—á–µ—Ç—ã{% endblock %}

{% block header_actions %}
<div class="btn-group">
    <button class="btn btn-primary btn-custom" onclick="refreshAnalytics()">
        <i class="fas fa-sync-alt me-1"></i> –û–±–Ω–æ–≤–∏—Ç—å
    </button>
    <button class="btn btn-success btn-custom" onclick="exportReport()">
        <i class="fas fa-download me-1"></i> –≠–∫—Å–ø–æ—Ä—Ç –æ—Ç—á–µ—Ç–∞
    </button>
    <button class="btn btn-info btn-custom" onclick="scheduledReport()">
        <i class="fas fa-clock me-1"></i> –û—Ç—á–µ—Ç –ø–æ —Ä–∞—Å–ø–∏—Å–∞–Ω–∏—é
    </button>
</div>
{% endblock %}

{% block content %}
<!-- Time Period Selector -->
<div class="card mb-4">
    <div class="card-body">
        <div class="row align-items-center">
            <div class="col-md-6">
                <h5 class="mb-0">–ü–µ—Ä–∏–æ–¥ –∞–Ω–∞–ª–∏–∑–∞</h5>
                <small class="text-muted">–í—ã–±–µ—Ä–∏—Ç–µ –ø–µ—Ä–∏–æ–¥ –¥–ª—è –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏</small>
            </div>
            <div class="col-md-6">
                <div class="btn-group w-100" role="group">
                    <input type="radio" class="btn-check" name="period" id="period7" value="7" checked>
                    <label class="btn btn-outline-primary" for="period7">7 –¥–Ω–µ–π</label>
                    
                    <input type="radio" class="btn-check" name="period" id="period30" value="30">
                    <label class="btn btn-outline-primary" for="period30">30 –¥–Ω–µ–π</label>
                    
                    <input type="radio" class="btn-check" name="period" id="period90" value="90">
                    <label class="btn btn-outline-primary" for="period90">90 –¥–Ω–µ–π</label>
                    
                    <input type="radio" class="btn-check" name="period" id="periodAll" value="365">
                    <label class="btn btn-outline-primary" for="periodAll">–ì–æ–¥</label>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Key Metrics -->
<div class="row mb-4">
    <div class="col-xl-3 col-md-6 mb-3">
        <div class="stat-card primary">
            <div class="d-flex align-items-center">
                <i class="fas fa-users fa-3x me-3"></i>
                <div class="flex-grow-1">
                    <div class="h3 mb-1">{{ report.user_statistics.total_users or 0 }}</div>
                    <div class="text-white-75">–í—Å–µ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π</div>
                    <small class="text-white-50">
                        +{{ report.user_statistics.new_users or 0 }} –∑–∞ –ø–µ—Ä–∏–æ–¥
                    </small>
                </div>
            </div>
        </div>
    </div>
    
    <div class="col-xl-3 col-md-6 mb-3">
        <div class="stat-card success">
            <div class="d-flex align-items-center">
                <i class="fas fa-chart-line fa-3x me-3"></i>
                <div class="flex-grow-1">
                    <div class="h3 mb-1">{{ "%.1f"|format(report.conversion_funnel.overall_conversion or 0) }}%</div>
                    <div class="text-white-75">–û–±—â–∞—è –∫–æ–Ω–≤–µ—Ä—Å–∏—è</div>
                    <small class="text-white-50">
                        –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏ ‚Üí –ö–ª–∏–µ–Ω—Ç—ã
                    </small>
                </div>
            </div>
        </div>
    </div>
    
    <div class="col-xl-3 col-md-6 mb-3">
        <div class="stat-card info">
            <div class="d-flex align-items-center">
                <i class="fas fa-ruble-sign fa-3x me-3"></i>
                <div class="flex-grow-1">
                    <div class="h3 mb-1">{{ "{:,.0f}"|format(report.financial_report.total_revenue or 0) }}</div>
                    <div class="text-white-75">–î–æ—Ö–æ–¥ (‚ÇΩ)</div>
                    <small class="text-white-50">
                        –°—Ä–µ–¥–Ω–∏–π —á–µ–∫: {{ "{:,.0f}"|format(report.financial_report.avg_check or 0) }}‚ÇΩ
                    </small>
                </div>
            </div>
        </div>
    </div>
    
    <div class="col-xl-3 col-md-6 mb-3">
        <div class="stat-card warning">
            <div class="d-flex align-items-center">
                <i class="fas fa-star fa-3x me-3"></i>
                <div class="flex-grow-1">
                    <div class="h3 mb-1">{{ "%.1f"|format(report.consultant_statistics.avg_rating or 0) }}</div>
                    <div class="text-white-75">–°—Ä–µ–¥–Ω—è—è –æ—Ü–µ–Ω–∫–∞</div>
                    <small class="text-white-50">
                        AI –∫–æ–Ω—Å—É–ª—å—Ç–∞–Ω—Ç
                    </small>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Charts Row 1 -->
<div class="row mb-4">
    <div class="col-lg-8">
        <div class="card">
            <div class="card-header d-flex justify-content-between align-items-center">
                <h5 class="card-title mb-0">
                    <i class="fas fa-chart-area me-2"></i>
                    –î–∏–Ω–∞–º–∏–∫–∞ —Ä–æ—Å—Ç–∞
                </h5>
                <div class="btn-group btn-group-sm">
                    <button class="btn btn-outline-primary active" onclick="switchChart('users')">–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏</button>
                    <button class="btn btn-outline-primary" onclick="switchChart('projects')">–ü—Ä–æ–µ–∫—Ç—ã</button>
                    <button class="btn btn-outline-primary" onclick="switchChart('revenue')">–î–æ—Ö–æ–¥—ã</button>
                </div>
            </div>
            <div class="card-body">
                <div class="chart-container">
                    <canvas id="growthChart"></canvas>
                </div>
            </div>
        </div>
    </div>
    
    <div class="col-lg-4">
        <div class="card">
            <div class="card-header">
                <h5 class="card-title mb-0">
                    <i class="fas fa-funnel-dollar me-2"></i>
                    –í–æ—Ä–æ–Ω–∫–∞ –∫–æ–Ω–≤–µ—Ä—Å–∏–∏
                </h5>
            </div>
                   <div class="card-body">
                       <div class="conversion-funnel">
                           <div class="funnel-stage" data-stage="1">
                               <div class="stage-bar" style="width: 100%;">
                                   <span class="stage-label">–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏</span>
                                   <span class="stage-value">{{ report.conversion_funnel.total_users or 0 }}</span>
                               </div>
                           </div>
                           <div class="funnel-stage" data-stage="2">
                               <div class="stage-bar" style="width: {{ report.conversion_funnel.project_creation_rate|default(0) }}%;">
                                   <span class="stage-label">–°–æ–∑–¥–∞–ª–∏ –ø—Ä–æ–µ–∫—Ç—ã</span>
                                   <span class="stage-value">{{ report.conversion_funnel.users_with_projects or 0 }}</span>
                               </div>
                           </div>
                           <div class="funnel-stage" data-stage="3">
                               <div class="stage-bar" style="width: {{ report.conversion_funnel.project_acceptance_rate|default(0) }}%;">
                                   <span class="stage-label">–ü—Ä–∏–Ω—è–ª–∏ –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏–µ</span>
                                   <span class="stage-value">{{ report.conversion_funnel.users_with_accepted_projects or 0 }}</span>
                               </div>
                           </div>
                           <div class="funnel-stage" data-stage="4">
                               <div class="stage-bar" style="width: {{ report.conversion_funnel.project_completion_rate|default(0) }}%;">
                                   <span class="stage-label">–ó–∞–≤–µ—Ä—à–∏–ª–∏ –ø—Ä–æ–µ–∫—Ç—ã</span>
                                   <span class="stage-value">{{ report.conversion_funnel.users_with_completed_projects or 0 }}</span>
                               </div>
                           </div>
                       </div>
                   </div>
                </div>
            </div>
        </div>


<!-- Charts Row 2 -->
<div class="row mb-4">
    <div class="col-lg-6">
        <div class="card">
            <div class="card-header">
                <h5 class="card-title mb-0">
                    <i class="fas fa-chart-pie me-2"></i>
                    –°—Ç–∞—Ç—É—Å—ã –ø—Ä–æ–µ–∫—Ç–æ–≤
                </h5>
            </div>
            <div class="card-body">
                <div class="chart-container">
                    <canvas id="projectStatusChart"></canvas>
                </div>
            </div>
        </div>
    </div>
    
    <div class="col-lg-6">
        <div class="card">
            <div class="card-header">
                <h5 class="card-title mb-0">
                    <i class="fas fa-layer-group me-2"></i>
                    –°–ª–æ–∂–Ω–æ—Å—Ç—å –ø—Ä–æ–µ–∫—Ç–æ–≤
                </h5>
            </div>
            <div class="card-body">
                <div class="chart-container">
                    <canvas id="complexityChart"></canvas>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Performance Metrics -->
<div class="row mb-4">
    <div class="col-lg-6">
        <div class="card">
            <div class="card-header">
                <h5 class="card-title mb-0">
                    <i class="fas fa-tachometer-alt me-2"></i>
                    –ú–µ—Ç—Ä–∏–∫–∏ –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç–∏
                </h5>
            </div>
            <div class="card-body">
                <div class="row text-center">
                    <div class="col-6 mb-3">
                        <div class="metric-item">
                            <div class="metric-value">{{ "%.1f"|format(report.performance_metrics.avg_response_time or 0) }}—Å</div>
                            <div class="metric-label">–í—Ä–µ–º—è –æ—Ç–≤–µ—Ç–∞ AI</div>
                        </div>
                    </div>
                    <div class="col-6 mb-3">
                        <div class="metric-item">
                            <div class="metric-value">{{ "%.1f"|format(report.performance_metrics.avg_acceptance_time or 0) }}—á</div>
                            <div class="metric-label">–î–æ –ø—Ä–∏–Ω—è—Ç–∏—è –∑–∞—è–≤–∫–∏</div>
                        </div>
                    </div>
                    <div class="col-6 mb-3">
                        <div class="metric-item">
                            <div class="metric-value">{{ "%.1f"|format(report.performance_metrics.avg_development_time or 0) }}—á</div>
                            <div class="metric-label">–í—Ä–µ–º—è —Ä–∞–∑—Ä–∞–±–æ—Ç–∫–∏</div>
                        </div>
                    </div>
                    <div class="col-6 mb-3">
                        <div class="metric-item">
                            <div class="metric-value">{{ "%.1f"|format(report.performance_metrics.time_estimation_accuracy or 0) }}%</div>
                            <div class="metric-label">–¢–æ—á–Ω–æ—Å—Ç—å –æ—Ü–µ–Ω–æ–∫</div>
                        </div>
                    </div>
                </div>
                
                <div class="progress-metrics mt-3" style="
                    --quality-width: {{ report.consultant_statistics.avg_rating * 20 or 0 }}%;
                    --conversion-width: {{ report.conversion_funnel.overall_conversion or 0 }}%;
                    --retention-width: {{ report.engagement_metrics.retention_rate or 0 }}%;
                ">
                    <div class="mb-2">
                        <div class="d-flex justify-content-between">
                            <span>–ö–∞—á–µ—Å—Ç–≤–æ –æ—Ç–≤–µ—Ç–æ–≤ AI</span>
                            <span>{{ "%.1f"|format(report.consultant_statistics.avg_rating * 20 or 0) }}%</span>
                        </div>
                        <div class="progress">
                            <div class="progress-bar bg-success" style="width: var(--quality-width)"></div>
                        </div>
                    </div>
                    <div class="mb-2">
                        <div class="d-flex justify-content-between">
                            <span>–ö–æ–Ω–≤–µ—Ä—Å–∏—è –≤ –∫–ª–∏–µ–Ω—Ç–æ–≤</span>
                            <span>{{ "%.1f"|format(report.conversion_funnel.overall_conversion or 0) }}%</span>
                        </div>
                        <div class="progress">
                            <div class="progress-bar bg-primary" style="width: var(--conversion-width)"></div>
                        </div>
                    </div>
                    <div>
                        <div class="d-flex justify-content-between">
                            <span>–£–¥–µ—Ä–∂–∞–Ω–∏–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π</span>
                            <span>{{ "%.1f"|format(report.engagement_metrics.retention_rate or 0) }}%</span>
                        </div>
                        <div class="progress">
                            <div class="progress-bar bg-info" style="width: var(--retention-width)"></div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <div class="col-lg-6">
        <div class="card">
            <div class="card-header">
                <h5 class="card-title mb-0">
                    <i class="fas fa-chart-bar me-2"></i>
                    –¢–æ–ø –º–µ—Ç—Ä–∏–∫–∏
                </h5>
            </div>
            <div class="card-body">
                <div class="metric-comparison">
                    <div class="metric-row">
                        <div class="metric-label">–ê–∫—Ç–∏–≤–Ω—ã–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏ (DAU)</div>
                        <div class="metric-bar">
                            <div class="bar-fill" style="width: 75%"></div>
                            <span class="metric-number">{{ report.engagement_metrics.daily_active_users or 0 }}</span>
                        </div>
                    </div>
                    
                    <div class="metric-row">
                        <div class="metric-label">–ù–æ–≤—ã–µ –ø—Ä–æ–µ–∫—Ç—ã –∑–∞ –ø–µ—Ä–∏–æ–¥</div>
                        <div class="metric-bar">
                            <div class="bar-fill" style="width: 60%"></div>
                            <span class="metric-number">{{ report.project_statistics.new_projects or 0 }}</span>
                        </div>
                    </div>
                    
                    <div class="metric-row">
                        <div class="metric-label">–ó–∞–≤–µ—Ä—à–µ–Ω–Ω—ã–µ –ø—Ä–æ–µ–∫—Ç—ã</div>
                        <div class="metric-bar">
                            <div class="bar-fill" style="width: 45%"></div>
                            <span class="metric-number">{{ report.project_statistics.completed_projects or 0 }}</span>
                        </div>
                    </div>
                    
                    <div class="metric-row">
                        <div class="metric-label">–ö–æ–Ω—Å—É–ª—å—Ç–∞—Ü–∏–π –ø—Ä–æ–≤–µ–¥–µ–Ω–æ</div>
                        <div class="metric-bar">
                            <div class="bar-fill" style="width: 85%"></div>
                            <span class="metric-number">{{ report.consultant_statistics.new_sessions or 0 }}</span>
                        </div>
                    </div>
                    
                    <div class="metric-row">
                        <div class="metric-label">–°—Ä–µ–¥–Ω–∏–π –¥–æ—Ö–æ–¥ —Å –∫–ª–∏–µ–Ω—Ç–∞</div>
                        <div class="metric-bar">
                            <div class="bar-fill" style="width: 70%"></div>
                            <span class="metric-number">{{ "{:,.0f}"|format(report.financial_report.avg_check or 0) }}‚ÇΩ</span>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Detailed Tables -->
<div class="row">
    <div class="col-lg-6">
        <div class="card">
            <div class="card-header">
                <h5 class="card-title mb-0">
                    <i class="fas fa-trophy me-2"></i>
                    –¢–æ–ø –∫–ª–∏–µ–Ω—Ç—ã –ø–æ –¥–æ—Ö–æ–¥—É
                </h5>
            </div>
            <div class="card-body">
                <div class="table-responsive">
                    <table class="table table-sm">
                        <thead>
                            <tr>
                                <th>–ö–ª–∏–µ–Ω—Ç</th>
                                <th>–ü—Ä–æ–µ–∫—Ç—ã</th>
                                <th>–î–æ—Ö–æ–¥</th>
                            </tr>
                        </thead>
                        <tbody id="topClientsTable">
                            <!-- Will be populated by JavaScript -->
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>
    
    <div class="col-lg-6">
        <div class="card">
            <div class="card-header">
                <h5 class="card-title mb-0">
                    <i class="fas fa-question-circle me-2"></i>
                    –ü–æ–ø—É–ª—è—Ä–Ω—ã–µ –≤–æ–ø—Ä–æ—Å—ã –∫–æ–Ω—Å—É–ª—å—Ç–∞–Ω—Ç—É
                </h5>
            </div>
            <div class="card-body">
                <div class="topic-list">
                    {% if report.consultant_statistics.popular_topics %}
                    {% for topic, count in report.consultant_statistics.popular_topics.items() %}
                    <div class="topic-item">
                        <div class="d-flex justify-content-between align-items-center">
                            <span class="topic-name">{{ topic }}</span>
                            <span class="badge bg-primary">{{ count }}</span>
                        </div>
                        <div class="topic-bar">
                            <div class="topic-fill" style="width: {{ (count / (report.consultant_statistics.popular_topics.values()|max)) * 100 }}%"></div>
                        </div>
                    </div>
                    {% endfor %}
                    {% else %}
                    <p class="text-muted text-center">–ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö –æ –∫–æ–Ω—Å—É–ª—å—Ç–∞—Ü–∏—è—Ö</p>
                    {% endif %}
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block styles %}
<style>
/* Conversion Funnel Styles */
.conversion-funnel {
    padding: 20px 0;
}

.funnel-stage {
    position: relative;
    margin-bottom: 15px;
}

.stage-bar {
    background: linear-gradient(90deg, #667eea 0%, #764ba2 100%);
    border-radius: 8px;
    padding: 12px 15px;
    color: white;
    position: relative;
    display: flex;
    justify-content: space-between;
    align-items: center;
    min-height: 45px;
    transition: all 0.3s ease;
}

.stage-bar:hover {
    transform: translateX(5px);
    box-shadow: 0 4px 12px rgba(102, 126, 234, 0.3);
}

.stage-label {
    font-weight: 500;
    font-size: 14px;
}

.stage-value {
    font-weight: 700;
    font-size: 16px;
    background: rgba(255, 255, 255, 0.2);
    padding: 4px 8px;
    border-radius: 4px;
}

/* Metric Items */
.metric-item {
    text-align: center;
    padding: 15px;
    border-radius: 8px;
    background: #f8f9fa;
    transition: all 0.3s ease;
}

.metric-item:hover {
    background: #e9ecef;
    transform: translateY(-2px);
}

.metric-value {
    font-size: 2rem;
    font-weight: 700;
    color: #495057;
    margin-bottom: 5px;
}

.metric-label {
    font-size: 0.875rem;
    color: #6c757d;
    font-weight: 500;
}

/* Progress Metrics */
.progress-metrics .progress {
    height: 8px;
    border-radius: 4px;
    background-color: #e9ecef;
}

.progress-metrics .progress-bar {
    border-radius: 4px;
    transition: width 0.6s ease;
}

/* Metric Comparison */
.metric-comparison {
    margin-bottom: 15px;
}

.metric-row {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 15px;
    padding: 10px 0;
    border-bottom: 1px solid #e9ecef;
}

.metric-row:last-child {
    border-bottom: none;
}

.metric-label {
    font-size: 14px;
    color: #495057;
    font-weight: 500;
    flex: 1;
}

.metric-bar {
    position: relative;
    width: 120px;
    height: 25px;
    background: #e9ecef;
    border-radius: 12px;
    overflow: hidden;
    margin: 0 15px;
}

.bar-fill {
    height: 100%;
    background: linear-gradient(90deg, #28a745, #20c997);
    border-radius: 12px;
    transition: width 0.6s ease;
}

.metric-number {
    font-weight: 600;
    color: #495057;
    min-width: 50px;
    text-align: right;
}

/* Topic List */
.topic-list {
    margin-bottom: 15px;
}

.topic-item {
    margin-bottom: 15px;
    padding: 10px 0;
    border-bottom: 1px solid #e9ecef;
}

.topic-item:last-child {
    border-bottom: none;
}

.topic-name {
    font-size: 14px;
    color: #495057;
    font-weight: 500;
}

.topic-bar {
    margin-top: 5px;
    height: 6px;
    background: #e9ecef;
    border-radius: 3px;
    overflow: hidden;
}

.topic-fill {
    height: 100%;
    background: linear-gradient(90deg, #007bff, #6610f2);
    border-radius: 3px;
    transition: width 0.6s ease;
}

/* Chart Container */
.chart-container {
    position: relative;
    height: 300px;
    margin: 10px 0;
}

/* Responsive Design */
@media (max-width: 768px) {
    .metric-row {
        flex-direction: column;
        align-items: flex-start;
    }
    
    .metric-bar {
        width: 100%;
        margin: 10px 0;
    }
    
    .metric-number {
        align-self: flex-end;
    }
    
    .stage-bar {
        flex-direction: column;
        text-align: center;
    }
    
    .stage-value {
        margin-top: 5px;
    }
}

/* Animation Classes */
.fade-in {
    animation: fadeIn 0.5s ease-in;
}

@keyframes fadeIn {
    from { opacity: 0; transform: translateY(20px); }
    to { opacity: 1; transform: translateY(0); }
}

.loading {
    opacity: 0.6;
    pointer-events: none;
}

.loading::after {
    content: '';
    position: absolute;
    top: 50%;
    left: 50%;
    width: 20px;
    height: 20px;
    margin: -10px 0 0 -10px;
    border: 2px solid #f3f3f3;
    border-top: 2px solid #007bff;
    border-radius: 50%;
    animation: spin 1s linear infinite;
}

@keyframes spin {
    0% { transform: rotate(0deg); }
    100% { transform: rotate(360deg); }
}
</style>
{% endblock %}

{% block scripts %}
<script>
    let currentChart = 'users';
    let currentPeriod = 7;
    let reportData = JSON.parse('{{ report|tojson|escapejs }}');

    // Initialize charts when page loads
    document.addEventListener('DOMContentLoaded', function() {
        initGrowthChart();
        initProjectStatusChart();
        initComplexityChart();
        loadTopClients();
        
        // Add event listeners for period selection
        document.querySelectorAll('input[name="period"]').forEach(radio => {
            radio.addEventListener('change', function() {
                currentPeriod = parseInt(this.value);
                refreshAnalytics();
            });
        });
    });

    // Growth Chart
    function initGrowthChart() {
        const ctx = document.getElementById('growthChart').getContext('2d');
        window.growthChart = new Chart(ctx, {
            type: 'line',
            data: {
                labels: generateDateLabels(currentPeriod),
                datasets: [{
                    label: '–ù–æ–≤—ã–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏',
                    data: generateSampleData(currentPeriod, 'users'),
                    borderColor: '#667eea',
                    backgroundColor: 'rgba(102, 126, 234, 0.1)',
                    tension: 0.4,
                    fill: true
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    legend: {
                        position: 'top',
                    }
                },
                scales: {
                    y: {
                        beginAtZero: true
                    }
                }
            }
        });
    }

    // Project Status Chart
    function initProjectStatusChart() {
        const ctx = document.getElementById('projectStatusChart').getContext('2d');
        const statusData = reportData.project_statistics?.status_distribution || {};
        
        new Chart(ctx, {
            type: 'doughnut',
            data: {
                labels: ['–ù–æ–≤—ã–µ', '–†–∞—Å—Å–º–æ—Ç—Ä–µ–Ω–∏–µ', '–ü—Ä–∏–Ω—è—Ç—ã–µ', '–í —Ä–∞–±–æ—Ç–µ', '–¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ', '–ó–∞–≤–µ—Ä—à–µ–Ω–Ω—ã–µ', '–û—Ç–º–µ–Ω–µ–Ω–Ω—ã–µ'],
                datasets: [{
                    data: [
                        statusData.new || 0,
                        statusData.review || 0,
                        statusData.accepted || 0,
                        statusData.in_progress || 0,
                        statusData.testing || 0,
                        statusData.completed || 0,
                        statusData.cancelled || 0
                    ],
                    backgroundColor: [
                        '#17a2b8',
                        '#ffc107',
                        '#28a745',
                        '#007bff',
                        '#6f42c1',
                        '#20c997',
                        '#dc3545'
                    ],
                    borderWidth: 0
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    legend: {
                        position: 'bottom',
                    }
                }
            }
        });
    }

    // Complexity Chart
    function initComplexityChart() {
        const ctx = document.getElementById('complexityChart').getContext('2d');
        const complexityData = reportData.project_statistics?.complexity_distribution || {};
        
        new Chart(ctx, {
            type: 'bar',
            data: {
                labels: ['–ü—Ä–æ—Å—Ç—ã–µ', '–°—Ä–µ–¥–Ω–∏–µ', '–°–ª–æ–∂–Ω—ã–µ', '–ü—Ä–µ–º–∏—É–º'],
                datasets: [{
                    label: '–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ –ø—Ä–æ–µ–∫—Ç–æ–≤',
                    data: [
                        complexityData.simple || 0,
                        complexityData.medium || 0,
                        complexityData.complex || 0,
                        complexityData.premium || 0
                    ],
                    backgroundColor: [
                        '#28a745',
                        '#ffc107',
                        '#fd7e14',
                        '#dc3545'
                    ],
                    borderRadius: 8
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    legend: {
                        display: false
                    }
                },
                scales: {
                    y: {
                        beginAtZero: true
                    }
                }
            }
        });
    }

    // Switch chart data
    function switchChart(type) {
        currentChart = type;
        
        // Update button states
        document.querySelectorAll('.btn-group button').forEach(btn => {
            btn.classList.remove('active');
        });
        event.target.classList.add('active');
        
        // Update chart data
        let newData, newLabel;
        switch(type) {
            case 'users':
                newData = generateSampleData(currentPeriod, 'users');
                newLabel = '–ù–æ–≤—ã–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏';
                break;
            case 'projects':
                newData = generateSampleData(currentPeriod, 'projects');
                newLabel = '–ù–æ–≤—ã–µ –ø—Ä–æ–µ–∫—Ç—ã';
                break;
            case 'revenue':
                newData = generateSampleData(currentPeriod, 'revenue');
                newLabel = '–î–æ—Ö–æ–¥ (‚ÇΩ)';
                break;
        }
        
        window.growthChart.data.datasets[0].data = newData;
        window.growthChart.data.datasets[0].label = newLabel;
        window.growthChart.data.labels = generateDateLabels(currentPeriod);
        window.growthChart.update();
    }

    // Generate date labels for charts
    function generateDateLabels(days) {
        const labels = [];
        const today = new Date();
        
        for (let i = days - 1; i >= 0; i--) {
            const date = new Date(today);
            date.setDate(today.getDate() - i);
            
            if (days <= 7) {
                labels.push(date.toLocaleDateString('ru-RU', { weekday: 'short' }));
            } else if (days <= 30) {
                labels.push(date.toLocaleDateString('ru-RU', { day: 'numeric', month: 'short' }));
            } else {
                labels.push(date.toLocaleDateString('ru-RU', { month: 'short', year: '2-digit' }));
            }
        }
        
        return labels;
    }

    // Generate sample data for charts
    function generateSampleData(days, type) {
        const data = [];
        const baseValue = type === 'revenue' ? 50000 : type === 'projects' ? 5 : 15;
        
        for (let i = 0; i < days; i++) {
            let value = baseValue + Math.random() * baseValue * 0.5;
            
            // Add some trend
            if (type === 'users') {
                value += i * 0.3; // Slight growth trend
            } else if (type === 'revenue') {
                value += i * 500; // Revenue growth
            }
            
            data.push(Math.round(value));
        }
        
        return data;
    }

    // Load top clients table
    function loadTopClients() {
        const tableBody = document.getElementById('topClientsTable');
        
        // Sample data - in real app this would come from API
        const topClients = [
            { name: '@user123', projects: 3, revenue: 150000 },
            { name: '@company_bot', projects: 2, revenue: 120000 },
            { name: '@startup_xyz', projects: 1, revenue: 80000 },
            { name: '@ecommerce_pro', projects: 2, revenue: 75000 },
            { name: '@crypto_trader', projects: 1, revenue: 60000 }
        ];
        
        tableBody.innerHTML = '';
        topClients.forEach((client, index) => {
            const row = document.createElement('tr');
            row.innerHTML = `
                <td>
                    <div class="d-flex align-items-center">
                        <span class="badge bg-primary me-2">${index + 1}</span>
                        ${client.name}
                    </div>
                </td>
                <td>
                    <span class="badge bg-info">${client.projects}</span>
                </td>
                <td>
                    <strong>${client.revenue.toLocaleString('ru-RU')}‚ÇΩ</strong>
                </td>
            `;
            tableBody.appendChild(row);
        });
    }

    // Refresh analytics data
    function refreshAnalytics() {
        const cards = document.querySelectorAll('.card');
        cards.forEach(card => card.classList.add('loading'));
        
        // Show loading animation
        setTimeout(() => {
            // Simulate API call
            fetch(`/admin/api/analytics?period=${currentPeriod}`)
                .then(response => response.json())
                .then(data => {
                    // Update reportData
                    reportData = data;
                    
                    // Refresh charts
                    window.growthChart.data.labels = generateDateLabels(currentPeriod);
                    window.growthChart.data.datasets[0].data = generateSampleData(currentPeriod, currentChart);
                    window.growthChart.update();
                    
                    // Refresh other components
                    loadTopClients();
                    
                    // Update metrics
                    updateMetrics(data);
                    
                    cards.forEach(card => card.classList.remove('loading'));
                    
                    // Show success message
                    showNotification('–î–∞–Ω–Ω—ã–µ –æ–±–Ω–æ–≤–ª–µ–Ω—ã', 'success');
                })
                .catch(error => {
                    console.error('Error refreshing analytics:', error);
                    cards.forEach(card => card.classList.remove('loading'));
                    showNotification('–û—à–∏–±–∫–∞ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è –¥–∞–Ω–Ω—ã—Ö', 'error');
                });
        }, 1000);
    }

    // Export report
    function exportReport() {
        const exportButton = event.target;
        const originalText = exportButton.innerHTML;
        
        exportButton.innerHTML = '<i class="fas fa-spinner fa-spin me-1"></i> –≠–∫—Å–ø–æ—Ä—Ç...';
        exportButton.disabled = true;
        
        // Create export data
        const exportData = {
            period: currentPeriod,
            generated_at: new Date().toISOString(),
            metrics: reportData,
            charts: {
                growth: window.growthChart.data,
                status: document.getElementById('projectStatusChart')?._chart?.data,
                complexity: document.getElementById('complexityChart')?._chart?.data
            }
        };
        
        // Generate CSV content
        let csvContent = "data:text/csv;charset=utf-8,";
        csvContent += "–ú–µ—Ç—Ä–∏–∫–∞,–ó–Ω–∞—á–µ–Ω–∏–µ\n";
        csvContent += `–í—Å–µ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π,${reportData.user_statistics?.total_users || 0}\n`;
        csvContent += `–ù–æ–≤—ã–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏,${reportData.user_statistics?.new_users || 0}\n`;
        csvContent += `–û–±—â–∞—è –∫–æ–Ω–≤–µ—Ä—Å–∏—è,${reportData.conversion_funnel?.overall_conversion || 0}%\n`;
        csvContent += `–û–±—â–∏–π –¥–æ—Ö–æ–¥,${reportData.financial_report?.total_revenue || 0}‚ÇΩ\n`;
        csvContent += `–°—Ä–µ–¥–Ω–∏–π —á–µ–∫,${reportData.financial_report?.avg_check || 0}‚ÇΩ\n`;
        csvContent += `–°—Ä–µ–¥–Ω—è—è –æ—Ü–µ–Ω–∫–∞ AI,${reportData.consultant_statistics?.avg_rating || 0}\n`;
        
        // Create and download file
        const encodedUri = encodeURI(csvContent);
        const link = document.createElement("a");
        link.setAttribute("href", encodedUri);
        link.setAttribute("download", `analytics_report_${currentPeriod}days_${new Date().toISOString().split('T')[0]}.csv`);
        document.body.appendChild(link);
        link.click();
        document.body.removeChild(link);
        
        setTimeout(() => {
            exportButton.innerHTML = originalText;
            exportButton.disabled = false;
            showNotification('–û—Ç—á–µ—Ç —ç–∫—Å–ø–æ—Ä—Ç–∏—Ä–æ–≤–∞–Ω', 'success');
        }, 1500);
    }

    // Scheduled report modal
    function scheduledReport() {
        const modalHTML = `
            <div class="modal fade" id="scheduledReportModal" tabindex="-1">
                <div class="modal-dialog">
                    <div class="modal-content">
                        <div class="modal-header">
                            <h5 class="modal-title">
                                <i class="fas fa-clock me-2"></i>
                                –ù–∞—Å—Ç—Ä–æ–π–∫–∞ –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏—Ö –æ—Ç—á–µ—Ç–æ–≤
                            </h5>
                            <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                        </div>
                        <div class="modal-body">
                            <form id="scheduledReportForm">
                                <div class="mb-3">
                                    <label class="form-label">–ß–∞—Å—Ç–æ—Ç–∞ –æ—Ç–ø—Ä–∞–≤–∫–∏</label>
                                    <select class="form-select" name="frequency">
                                        <option value="daily">–ï–∂–µ–¥–Ω–µ–≤–Ω–æ</option>
                                        <option value="weekly" selected>–ï–∂–µ–Ω–µ–¥–µ–ª—å–Ω–æ</option>
                                        <option value="monthly">–ï–∂–µ–º–µ—Å—è—á–Ω–æ</option>
                                    </select>
                                </div>
                                <div class="mb-3">
                                    <label class="form-label">Email –¥–ª—è –æ—Ç–ø—Ä–∞–≤–∫–∏</label>
                                    <input type="email" class="form-control" name="email" 
                                           placeholder="admin@example.com" required>
                                </div>
                                <div class="mb-3">
                                    <label class="form-label">–í—Ä–µ–º—è –æ—Ç–ø—Ä–∞–≤–∫–∏</label>
                                    <input type="time" class="form-control" name="time" value="09:00">
                                </div>
                                <div class="form-check">
                                    <input class="form-check-input" type="checkbox" name="includeCharts" checked>
                                    <label class="form-check-label">
                                        –í–∫–ª—é—á–∞—Ç—å –≥—Ä–∞—Ñ–∏–∫–∏ –≤ –æ—Ç—á–µ—Ç
                                    </label>
                                </div>
                            </form>
                        </div>
                        <div class="modal-footer">
                            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
                                –û—Ç–º–µ–Ω–∞
                            </button>
                            <button type="button" class="btn btn-primary" onclick="saveScheduledReport()">
                                <i class="fas fa-save me-1"></i>
                                –°–æ—Ö—Ä–∞–Ω–∏—Ç—å –Ω–∞—Å—Ç—Ä–æ–π–∫–∏
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        `;
        
        // Remove existing modal if any
        const existingModal = document.getElementById('scheduledReportModal');
        if (existingModal) {
            existingModal.remove();
        }
        
        // Add modal to page
        document.body.insertAdjacentHTML('beforeend', modalHTML);
        
        // Show modal
        const modal = new bootstrap.Modal(document.getElementById('scheduledReportModal'));
        modal.show();
    }

    // Save scheduled report settings
    function saveScheduledReport() {
        const form = document.getElementById('scheduledReportForm');
        const formData = new FormData(form);
        
        const settings = {
            frequency: formData.get('frequency'),
            email: formData.get('email'),
            time: formData.get('time'),
            includeCharts: formData.has('includeCharts')
        };
        
        // Simulate API call
        fetch('/admin/api/scheduled-reports', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify(settings)
        })
        .then(response => response.json())
        .then(data => {
            showNotification('–ù–∞—Å—Ç—Ä–æ–π–∫–∏ –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏—Ö –æ—Ç—á–µ—Ç–æ–≤ —Å–æ—Ö—Ä–∞–Ω–µ–Ω—ã', 'success');
            bootstrap.Modal.getInstance(document.getElementById('scheduledReportModal')).hide();
        })
        .catch(error => {
            console.error('Error saving scheduled report:', error);
            showNotification('–û—à–∏–±–∫–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è –Ω–∞—Å—Ç—Ä–æ–µ–∫', 'error');
        });
    }

    // Update metrics in cards
    function updateMetrics(data) {
        // Update stat cards
        const statCards = document.querySelectorAll('.stat-card');
        statCards.forEach(card => {
            card.classList.add('fade-in');
        });
        
        // Update progress bars
        const progressBars = document.querySelectorAll('.progress-bar');
        progressBars.forEach(bar => {
            const width = bar.style.width;
            bar.style.width = '0%';
            setTimeout(() => {
                bar.style.width = width;
            }, 100);
        });
        
        // Update metric bars
        const metricBars = document.querySelectorAll('.bar-fill');
        metricBars.forEach(bar => {
            const width = bar.style.width;
            bar.style.width = '0%';
            setTimeout(() => {
                bar.style.width = width;
            }, 200);
        });
    }

    // Show notification
    function showNotification(message, type = 'info') {
        const notification = document.createElement('div');
        notification.className = `alert alert-${type === 'error' ? 'danger' : type} alert-dismissible fade show position-fixed`;
        notification.style.cssText = 'top: 20px; right: 20px; z-index: 9999; min-width: 300px;';
        notification.innerHTML = `
            ${message}
            <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
        `;
        
        document.body.appendChild(notification);
        
        // Auto remove after 3 seconds
        setTimeout(() => {
            if (notification.parentNode) {
                notification.remove();
            }
        }, 3000);
    }

    // Real-time updates (WebSocket simulation)
    function initRealTimeUpdates() {
        setInterval(() => {
            // Simulate real-time data updates
            const dau = document.querySelector('.metric-number');
            if (dau) {
                const currentValue = parseInt(dau.textContent);
                const newValue = currentValue + Math.floor(Math.random() * 3);
                dau.textContent = newValue;
            }
        }, 30000); // Update every 30 seconds
    }

    // Initialize real-time updates
    setTimeout(initRealTimeUpdates, 5000);

    // Handle window resize for charts
    window.addEventListener('resize', function() {
        if (window.growthChart) {
            window.growthChart.resize();
        }
    });

    // Keyboard shortcuts
    document.addEventListener('keydown', function(e) {
        if (e.ctrlKey || e.metaKey) {
            switch(e.key) {
                case 'r':
                    e.preventDefault();
                    refreshAnalytics();
                    break;
                case 'e':
                    e.preventDefault();
                    exportReport();
                    break;
                case 's':
                    e.preventDefault();
                    scheduledReport();
                    break;
            }
        }
    });
</script>
{% endblock %}