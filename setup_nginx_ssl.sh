#!/bin/bash

echo "üîß –£—Å—Ç–∞–Ω–æ–≤–∫–∞ –∏ –Ω–∞—Å—Ç—Ä–æ–π–∫–∞ Nginx —Å SSL —Å–µ—Ä—Ç–∏—Ñ–∏–∫–∞—Ç–æ–º..."

# –û–±–Ω–æ–≤–ª—è–µ–º —Å–∏—Å—Ç–µ–º—É
echo "üì¶ –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ —Å–∏—Å—Ç–µ–º—ã..."
apt update

# –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º nginx
echo "üì¶ –£—Å—Ç–∞–Ω–æ–≤–∫–∞ Nginx..."
apt install -y nginx

# –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º certbot
echo "üì¶ –£—Å—Ç–∞–Ω–æ–≤–∫–∞ Certbot..."
apt install -y certbot python3-certbot-nginx

# –û—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º nginx –Ω–∞ –≤—Ä–µ–º—è –ø–æ–ª—É—á–µ–Ω–∏—è —Å–µ—Ä—Ç–∏—Ñ–∏–∫–∞—Ç–∞
echo "‚è∏Ô∏è –û—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º Nginx..."
systemctl stop nginx

# –°–æ–∑–¥–∞–µ–º –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏—é –¥–ª—è certbot
mkdir -p /var/www/certbot

# –ü–æ–ª—É—á–∞–µ–º SSL —Å–µ—Ä—Ç–∏—Ñ–∏–∫–∞—Ç
echo "üîê –ü–æ–ª—É—á–µ–Ω–∏–µ SSL —Å–µ—Ä—Ç–∏—Ñ–∏–∫–∞—Ç–∞ –æ—Ç Let's Encrypt..."
certbot certonly --standalone \
    -d nikolaevcodev.ru \
    -d www.nikolaevcodev.ru \
    --non-interactive \
    --agree-tos \
    --email noldor123@yandex.ru \
    --preferred-challenges http

# –ö–æ–ø–∏—Ä—É–µ–º –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—é nginx
echo "üìù –ö–æ–ø–∏—Ä–æ–≤–∞–Ω–∏–µ –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏ Nginx..."
cp /root/bot_business_card/nginx.conf /etc/nginx/sites-available/nikolaevcodev.ru

# –£–¥–∞–ª—è–µ–º –¥–µ—Ñ–æ–ª—Ç–Ω—É—é –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—é
rm -f /etc/nginx/sites-enabled/default

# –°–æ–∑–¥–∞–µ–º —Å–∏–º–≤–æ–ª–∏—á–µ—Å–∫—É—é —Å—Å—ã–ª–∫—É
ln -sf /etc/nginx/sites-available/nikolaevcodev.ru /etc/nginx/sites-enabled/

# –ü—Ä–æ–≤–µ—Ä—è–µ–º –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—é
echo "‚úÖ –ü—Ä–æ–≤–µ—Ä–∫–∞ –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏ Nginx..."
nginx -t

# –ó–∞–ø—É—Å–∫–∞–µ–º nginx
echo "üöÄ –ó–∞–ø—É—Å–∫ Nginx..."
systemctl start nginx
systemctl enable nginx

# –ù–∞—Å—Ç—Ä–∞–∏–≤–∞–µ–º –∞–≤—Ç–æ–æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ —Å–µ—Ä—Ç–∏—Ñ–∏–∫–∞—Ç–∞
echo "üîÑ –ù–∞—Å—Ç—Ä–æ–π–∫–∞ –∞–≤—Ç–æ–æ–±–Ω–æ–≤–ª–µ–Ω–∏—è —Å–µ—Ä—Ç–∏—Ñ–∏–∫–∞—Ç–∞..."
(crontab -l 2>/dev/null; echo "0 3 * * * certbot renew --quiet && systemctl reload nginx") | crontab -

echo "‚úÖ Nginx —Å SSL —É—Å–ø–µ—à–Ω–æ –Ω–∞—Å—Ç—Ä–æ–µ–Ω!"
echo "üåê –í–∞—à —Å–∞–π—Ç –¥–æ—Å—Ç—É–ø–µ–Ω –ø–æ –∞–¥—Ä–µ—Å—É: https://nikolaevcodev.ru"
echo ""
echo "üìã –ü–æ–ª–µ–∑–Ω—ã–µ –∫–æ–º–∞–Ω–¥—ã:"
echo "  - –ü—Ä–æ–≤–µ—Ä–∏—Ç—å —Å—Ç–∞—Ç—É—Å Nginx: systemctl status nginx"
echo "  - –ü–µ—Ä–µ–∑–∞–ø—É—Å—Ç–∏—Ç—å Nginx: systemctl restart nginx"
echo "  - –ü—Ä–æ–≤–µ—Ä–∏—Ç—å —Å–µ—Ä—Ç–∏—Ñ–∏–∫–∞—Ç: certbot certificates"
echo "  - –û–±–Ω–æ–≤–∏—Ç—å —Å–µ—Ä—Ç–∏—Ñ–∏–∫–∞—Ç –≤—Ä—É—á–Ω—É—é: certbot renew"
