#!/bin/bash

# –ö–û–ú–ê–ù–î–´ –î–õ–Ø –†–£–ß–ù–û–ì–û –û–ë–ù–û–í–õ–ï–ù–ò–Ø –ù–ê –°–ï–†–í–ï–†–ï
# –í—ã–ø–æ–ª–Ω–∏—Ç–µ —ç—Ç–∏ –∫–æ–º–∞–Ω–¥—ã –ø–æ –ø–æ—Ä—è–¥–∫—É –Ω–∞ —Å–µ—Ä–≤–µ—Ä–µ

echo "üîÑ –†–£–ß–ù–û–ï –û–ë–ù–û–í–õ–ï–ù–ò–ï –ö–û–î–ê –ù–ê –°–ï–†–í–ï–†–ï"
echo "=================================="

# 1. –ü–æ–¥–∫–ª—é—á–∞–µ–º—Å—è –∫ —Å–µ—Ä–≤–µ—Ä—É
ssh -p 22 root@147.45.215.199

# 2. –ü–µ—Ä–µ—Ö–æ–¥–∏–º –≤ –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏—é –ø—Ä–æ–µ–∫—Ç–∞
cd /var/www/bot_business_card

# 3. –ü—Ä–æ–≤–µ—Ä—è–µ–º —Ç–µ–∫—É—â–µ–µ —Å–æ—Å—Ç–æ—è–Ω–∏–µ
echo "üìç –¢–µ–∫—É—â–∏–π –∫–æ–º–º–∏—Ç:"
git log -1 --oneline

# 4. –ê–≥—Ä–µ—Å—Å–∏–≤–Ω–∞—è –æ—á–∏—Å—Ç–∫–∞
echo "üßπ –û—á–∏—â–∞–µ–º –ª–æ–∫–∞–ª—å–Ω—ã–µ –∏–∑–º–µ–Ω–µ–Ω–∏—è..."
git stash
git reset --hard HEAD
git clean -fd

# 5. –ü—Ä–∏–Ω—É–¥–∏—Ç–µ–ª—å–Ω–æ–µ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ
echo "üì• –ü–æ–ª—É—á–∞–µ–º –ø–æ—Å–ª–µ–¥–Ω–∏–µ –∏–∑–º–µ–Ω–µ–Ω–∏—è..."
git fetch --all
git reset --hard origin/main

# 6. –ü—Ä–æ–≤–µ—Ä—è–µ–º –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ
echo "‚úÖ –ù–æ–≤—ã–π –∫–æ–º–º–∏—Ç:"
git log -1 --oneline

# 7. –ü—Ä–æ–≤–µ—Ä—è–µ–º —Ñ–∞–π–ª
echo "üîç –ü—Ä–æ–≤–µ—Ä—è–µ–º —Ñ–∞–π–ª avito_messenger.html:"
grep -n "v2.0" app/admin/templates/avito_messenger.html || echo "‚ùå –§–∞–π–ª –Ω–µ –Ω–∞–π–¥–µ–Ω"

# 8. –ï—Å–ª–∏ —Ñ–∞–π–ª –≤—Å–µ –µ—â–µ —Å—Ç–∞—Ä—ã–π - –ø—Ä—è–º–∞—è –∑–∞–º–µ–Ω–∞
if ! grep -q "v2.0" app/admin/templates/avito_messenger.html; then
    echo "‚ùå –§–∞–π–ª —Å—Ç–∞—Ä—ã–π, –∑–∞–º–µ–Ω—è–µ–º –ø—Ä–∏–Ω—É–¥–∏—Ç–µ–ª—å–Ω–æ..."
    
    # –°–æ–∑–¥–∞–µ–º —ç–∫—Å—Ç—Ä–µ–Ω–Ω—É—é –≤–µ—Ä—Å–∏—é
    cat > app/admin/templates/avito_messenger.html << 'EOF'
{% extends "base.html" %}
{% block title %}–ê–≤–∏—Ç–æ –ú–µ—Å—Å–µ–Ω–¥–∂–µ—Ä - –ê–¥–º–∏–Ω –ø–∞–Ω–µ–ª—å{% endblock %}
{% block content %}
<!-- üö® –≠–ö–°–¢–†–ï–ù–ù–ê–Ø –ó–ê–ú–ï–ù–ê: –§–ê–ô–õ –ó–ê–ú–ï–ù–Å–ù –í–†–£–ß–ù–£–Æ -->
<div class="alert alert-danger border-3 border-danger mb-4 text-center" style="background: linear-gradient(45deg, #ff4757, #ff6b6b); font-size: 24px; padding: 30px;">
    <h1>üö® –≠–ö–°–¢–†–ï–ù–ù–ê–Ø –ó–ê–ú–ï–ù–ê üö®</h1>
    <h2>–§–ê–ô–õ –ó–ê–ú–ï–ù–Å–ù –í–†–£–ß–ù–£–Æ - –î–ï–ü–õ–û–ô –†–ê–ë–û–¢–ê–ï–¢!</h2>
    <div class="form-check form-switch d-inline-block mt-3">
        <input class="form-check-input" type="checkbox" id="manualToggle" style="transform: scale(3);">
        <label class="form-check-label text-white fw-bold fs-3 ms-3" for="manualToggle">
            ü§ñ AI –ê–í–¢–û–û–¢–í–ï–¢–´ (–†–£–ß–ù–ê–Ø –ó–ê–ú–ï–ù–ê)
        </label>
    </div>
</div>
<script>
document.getElementById('manualToggle').onchange = function() {
    alert('üéâ –ü–ï–†–ï–ö–õ–Æ–ß–ê–¢–ï–õ–¨ –†–ê–ë–û–¢–ê–ï–¢! –°–æ—Å—Ç–æ—è–Ω–∏–µ: ' + (this.checked ? '–í–ö–õ–Æ–ß–ï–ù' : '–í–´–ö–õ–Æ–ß–ï–ù'));
}
alert('üö® –†–£–ß–ù–ê–Ø –ó–ê–ú–ï–ù–ê –£–°–ü–ï–®–ù–ê! –ü–µ—Ä–µ–∫–ª—é—á–∞—Ç–µ–ª—å –≥–æ—Ç–æ–≤ –∫ —Ä–∞–±–æ—Ç–µ!');
</script>
{% endblock %}
EOF
    
    echo "‚úÖ –§–∞–π–ª –∑–∞–º–µ–Ω—ë–Ω —ç–∫—Å—Ç—Ä–µ–Ω–Ω–æ–π –≤–µ—Ä—Å–∏–µ–π"
fi

# 9. –ü–µ—Ä–µ–∑–∞–ø—É—Å–∫–∞–µ–º PM2
echo "üîÑ –ü–µ—Ä–µ–∑–∞–ø—É—Å–∫–∞–µ–º PM2..."
pm2 restart bot-business-card

# 10. –û—á–∏—â–∞–µ–º –∫—ç—à
echo "üßπ –û—á–∏—â–∞–µ–º Python –∫—ç—à..."
find . -name "*.pyc" -delete
find . -name "__pycache__" -type d -exec rm -rf {} + 2>/dev/null || true

echo "‚úÖ –†–£–ß–ù–û–ï –û–ë–ù–û–í–õ–ï–ù–ò–ï –ó–ê–í–ï–†–®–ï–ù–û!"
echo "–ü—Ä–æ–≤–µ—Ä—å—Ç–µ —Å–∞–π—Ç: http://147.45.215.199:8001/admin/avito/"