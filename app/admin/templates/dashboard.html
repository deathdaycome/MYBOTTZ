{% extends "base.html" %}

{% block title %}–î–∞—à–±–æ—Ä–¥ - –ê–¥–º–∏–Ω-–ø–∞–Ω–µ–ª—å{% endblock %}

{% block page_title %}üìä –î–∞—à–±–æ—Ä–¥{% endblock %}

{% block content %}
<!-- Financial Metrics Row -->
<div class="row mb-4" id="financialMetrics">
    <div class="col-md-3">
        <div class="metric-card gradient-green">
            <div class="metric-icon">
                <i class="fas fa-arrow-up"></i>
            </div>
            <div class="metric-content">
                <h4 id="monthlyIncome">0 ‚ÇΩ</h4>
                <p>–î–æ—Ö–æ–¥ –∑–∞ –º–µ—Å—è—Ü</p>
                <small class="metric-change positive" id="incomeChange">+0%</small>
            </div>
        </div>
    </div>
    <div class="col-md-3">
        <div class="metric-card gradient-red">
            <div class="metric-icon">
                <i class="fas fa-arrow-down"></i>
            </div>
            <div class="metric-content">
                <h4 id="monthlyExpense">0 ‚ÇΩ</h4>
                <p>–†–∞—Å—Ö–æ–¥—ã –∑–∞ –º–µ—Å—è—Ü</p>
                <small class="metric-change negative" id="expenseChange">-0%</small>
            </div>
        </div>
    </div>
    <div class="col-md-3">
        <div class="metric-card gradient-blue">
            <div class="metric-icon">
                <i class="fas fa-chart-line"></i>
            </div>
            <div class="metric-content">
                <h4 id="monthlyProfit">0 ‚ÇΩ</h4>
                <p>–ü—Ä–∏–±—ã–ª—å –∑–∞ –º–µ—Å—è—Ü</p>
                <small class="metric-change" id="profitChange">0%</small>
            </div>
        </div>
    </div>
    <div class="col-md-3">
        <div class="metric-card gradient-purple">
            <div class="metric-icon">
                <i class="fas fa-percentage"></i>
            </div>
            <div class="metric-content">
                <h4 id="profitMargin">0%</h4>
                <p>–†–µ–Ω—Ç–∞–±–µ–ª—å–Ω–æ—Å—Ç—å</p>
                <small id="marginTrend">–¶–µ–ª–µ–≤–∞—è: 30%</small>
            </div>
        </div>
    </div>
</div>

<!-- Quick Transaction Widget (—Ç–æ–ª—å–∫–æ –¥–ª—è owner –∏ admin) -->
{% if user_role in ['owner', 'admin'] %}
<div class="row mb-4">
    <div class="col-lg-12">
        <div class="card bg-light">
            <div class="card-header bg-primary text-white">
                <h5 class="card-title mb-0">
                    <i class="fas fa-plus-circle me-2"></i>
                    –ë—ã—Å—Ç—Ä–æ–µ –¥–æ–±–∞–≤–ª–µ–Ω–∏–µ —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–∏
                </h5>
            </div>
            <div class="card-body">
                <form id="quickTransactionForm" class="row g-3">
                    <div class="col-md-2">
                        <label class="form-label">–¢–∏–ø</label>
                        <div class="btn-group w-100" role="group">
                            <input type="radio" class="btn-check" name="transType" id="typeIncome" value="income" checked>
                            <label class="btn btn-outline-success" for="typeIncome">
                                <i class="fas fa-arrow-up"></i> –î–æ—Ö–æ–¥
                            </label>
                            <input type="radio" class="btn-check" name="transType" id="typeExpense" value="expense">
                            <label class="btn btn-outline-danger" for="typeExpense">
                                <i class="fas fa-arrow-down"></i> –†–∞—Å—Ö–æ–¥
                            </label>
                        </div>
                    </div>
                    <div class="col-md-2">
                        <label for="quickAmount" class="form-label">–°—É–º–º–∞</label>
                        <div class="input-group">
                            <input type="number" class="form-control" id="quickAmount" placeholder="0" required>
                            <span class="input-group-text">‚ÇΩ</span>
                        </div>
                    </div>
                    <div class="col-md-2">
                        <label for="quickCategory" class="form-label">–ö–∞—Ç–µ–≥–æ—Ä–∏—è</label>
                        <select class="form-select" id="quickCategory" required>
                            <option value="">–í—ã–±–µ—Ä–∏—Ç–µ...</option>
                        </select>
                    </div>
                    <div class="col-md-2">
                        <label for="quickAccount" class="form-label">–°—á–µ—Ç</label>
                        <select class="form-select" id="quickAccount" required>
                            <option value="cash">üíµ –ù–∞–ª–∏—á–Ω—ã–µ</option>
                            <option value="card" selected>üí≥ –ö–∞—Ä—Ç–∞</option>
                            <option value="bank">üè¶ –†/—Å—á–µ—Ç</option>
                        </select>
                    </div>
                    <div class="col-md-3">
                        <label for="quickDescription" class="form-label">–û–ø–∏—Å–∞–Ω–∏–µ</label>
                        <input type="text" class="form-control" id="quickDescription" placeholder="–ó–∞ —á—Ç–æ..." required>
                    </div>
                    <div class="col-md-1">
                        <label class="form-label">&nbsp;</label>
                        <button type="submit" class="btn btn-primary w-100">
                            <i class="fas fa-save"></i> –î–æ–±–∞–≤–∏—Ç—å
                        </button>
                    </div>
                </form>
                <div id="quickTransactionAlert" class="alert mt-3 d-none"></div>
            </div>
        </div>
    </div>
</div>
{% endif %}

<!-- Statistics Cards -->
<div class="row mb-4">
    <div class="col-xl-3 col-md-6 mb-3">
        <div class="stat-card primary">
            <div class="d-flex align-items-center">
                <div class="me-3">
                    <i class="fas fa-users fa-3x"></i>
                </div>
                <div class="flex-grow-1">
                    <div class="h3 mb-1">{{ stats.user_stats.total_users or 0 }}</div>
                    <div class="text-white-75">–í—Å–µ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π</div>
                    <small class="text-white-50">
                        +{{ stats.user_stats.new_users or 0 }} –∑–∞ –Ω–µ–¥–µ–ª—é
                    </small>
                </div>
            </div>
        </div>
    </div>
    
    <div class="col-xl-3 col-md-6 mb-3">
        <div class="stat-card success">
            <div class="d-flex align-items-center">
                <div class="me-3">
                    <i class="fas fa-project-diagram fa-3x"></i>
                </div>
                <div class="flex-grow-1">
                    <div class="h3 mb-1">{{ stats.project_stats.total_projects or 0 }}</div>
                    <div class="text-white-75">–í—Å–µ–≥–æ –ø—Ä–æ–µ–∫—Ç–æ–≤</div>
                    <small class="text-white-50">
                        {{ stats.project_stats.completion_rate or 0 }}% –∑–∞–≤–µ—Ä—à–µ–Ω–æ
                    </small>
                </div>
            </div>
        </div>
    </div>
    
    <div class="col-xl-3 col-md-6 mb-3">
        <div class="stat-card info">
            <div class="d-flex align-items-center">
                <div class="me-3">
                    <i class="fas fa-robot fa-3x"></i>
                </div>
                <div class="flex-grow-1">
                    <div class="h3 mb-1">{{ stats.consultant_stats.total_sessions or 0 }}</div>
                    <div class="text-white-75">–ö–æ–Ω—Å—É–ª—å—Ç–∞—Ü–∏–π</div>
                    <small class="text-white-50">
                        ‚≠ê {{ (stats.consultant_stats.avg_rating or 0)|round(1) }}/5.0
                    </small>
                </div>
            </div>
        </div>
    </div>
    
    <div class="col-xl-3 col-md-6 mb-3">
        <div class="stat-card warning">
            <div class="d-flex align-items-center">
                <div class="me-3">
                    <i class="fas fa-ruble-sign fa-3x"></i>
                </div>
                <div class="flex-grow-1">
                    <div class="h3 mb-1">{{ (stats.financial_stats.total_revenue or 0)|round|int }}</div>
                    <div class="text-white-75">–î–æ—Ö–æ–¥ (‚ÇΩ)</div>
                    <small class="text-white-50">
                        –°—Ä–µ–¥–Ω–∏–π —á–µ–∫: {{ (stats.financial_stats.avg_check or 0)|round|int }}‚ÇΩ
                    </small>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Charts Row -->
<div class="row mb-4">
    <div class="col-lg-8">
        <div class="card">
            <div class="card-header">
                <h5 class="card-title mb-0">
                    <i class="fas fa-chart-line me-2"></i>
                    –î–∏–Ω–∞–º–∏–∫–∞ –ø—Ä–æ–µ–∫—Ç–æ–≤
                </h5>
            </div>
            <div class="card-body">
                <div class="chart-container">
                    <canvas id="projectsChart"></canvas>
                </div>
            </div>
        </div>
    </div>
    
    <div class="col-lg-4">
        <div class="card">
            <div class="card-header">
                <h5 class="card-title mb-0">
                    <i class="fas fa-chart-pie me-2"></i>
                    –°—Ç–∞—Ç—É—Å—ã –ø—Ä–æ–µ–∫—Ç–æ–≤
                </h5>
            </div>
            <div class="card-body">
                <div class="chart-container">
                    <canvas id="statusChart"></canvas>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Recent Activity -->
<div class="row">
    <div class="col-lg-8">
        <div class="card">
            <div class="card-header d-flex justify-content-between align-items-center">
                <h5 class="card-title mb-0">
                    <i class="fas fa-clock me-2"></i>
                    –ü–æ—Å–ª–µ–¥–Ω–∏–µ –ø—Ä–æ–µ–∫—Ç—ã
                </h5>
                <a href="/admin/projects" class="btn btn-outline-primary btn-sm">–í—Å–µ –ø—Ä–æ–µ–∫—Ç—ã</a>
            </div>
            <div class="card-body">
                {% if recent_projects %}
                <div class="table-responsive">
                    <table class="table table-hover">
                        <thead>
                            <tr>
                                <th>ID</th>
                                <th>–ù–∞–∑–≤–∞–Ω–∏–µ</th>
                                <th>–ö–ª–∏–µ–Ω—Ç</th>
                                <th>–°—Ç–∞—Ç—É—Å</th>
                                <th>–°—Ç–æ–∏–º–æ—Å—Ç—å</th>
                                <th>–î–∞—Ç–∞</th>
                                <th>–î–µ–π—Å—Ç–≤–∏—è</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for project in recent_projects %}
                            <tr>
                                <td>
                                    <span class="badge bg-secondary">#{{ project.id }}</span>
                                </td>
                                <td>
                                    <div class="fw-bold">{{ project.title[:30] }}{% if project.title|length > 30 %}...{% endif %}</div>
                                    <small class="text-muted">{{ project.complexity }}</small>
                                </td>
                                <td>
                                    <div class="d-flex align-items-center">
                                        <div class="user-avatar me-2">
                                            {{ (project.user.first_name or 'U')[0] }}
                                        </div>
                                        <div>
                                            <div class="fw-medium">{{ project.user.first_name or '–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–æ' }}</div>
                                            <small class="text-muted">@{{ project.user.username or '–Ω–µ—Ç' }}</small>
                                        </div>
                                    </div>
                                </td>
                                <td>
                                    <span class="badge status-{{ project.status }}">
                                        {{ project.status }}
                                    </span>
                                </td>
                                <td>
                                    <span class="fw-bold">{{ (project.estimated_cost or 0)|round|int }}‚ÇΩ</span>
                                </td>
                                <td>
                                    <span class="text-muted">{{ project.created_at[:16] if project.created_at else '–ù/–î' }}</span>
                                </td>
                                <td>
                                    <div class="btn-group btn-group-sm">
                                        <button class="btn btn-outline-primary" onclick="viewProject('{{ project.id }}')">
                                            <i class="fas fa-eye"></i>
                                        </button>
                                        <button class="btn btn-outline-success" onclick="updateProjectStatus('{{ project.id }}')">
                                            <i class="fas fa-edit"></i>
                                        </button>
                                    </div>
                                </td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
                {% else %}
                <div class="text-center py-4">
                    <i class="fas fa-inbox fa-3x text-muted mb-3"></i>
                    <p class="text-muted">–ù–µ—Ç –ø—Ä–æ–µ–∫—Ç–æ–≤</p>
                </div>
                {% endif %}
            </div>
        </div>
    </div>
    
    <div class="col-lg-4">
        <div class="card">
            <div class="card-header d-flex justify-content-between align-items-center">
                <h5 class="card-title mb-0">
                    <i class="fas fa-user-plus me-2"></i>
                    –ù–æ–≤—ã–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏
                </h5>
                <a href="/users" class="btn btn-outline-primary btn-sm">–í—Å–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏</a>
            </div>
            <div class="card-body">
                {% if recent_users %}
                <div class="list-group list-group-flush">
                    {% for user in recent_users %}
                    <div class="list-group-item border-0 px-0">
                        <div class="d-flex align-items-center">
                            <div class="user-avatar me-3">
                                {{ (user.first_name or 'U')[0] }}
                            </div>
                            <div class="flex-grow-1">
                                <div class="fw-bold">{{ user.first_name or '–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–æ' }}</div>
                                <small class="text-muted">@{{ user.username or '–Ω–µ—Ç' }}</small>
                                <div class="small text-muted">
                                    {{ user.registration_date[:16] if user.registration_date else '–ù/–î' }}
                                </div>
                            </div>
                            <div>
                                {% if user.projects %}
                                <span class="badge bg-success">{{ user.projects|length }} –ø—Ä–æ–µ–∫—Ç–æ–≤</span>
                                {% else %}
                                <span class="badge bg-secondary">–ù–æ–≤—ã–π</span>
                                {% endif %}
                            </div>
                        </div>
                    </div>
                    {% endfor %}
                </div>
                {% else %}
                <div class="text-center py-4">
                    <i class="fas fa-users fa-3x text-muted mb-3"></i>
                    <p class="text-muted">–ù–µ—Ç –Ω–æ–≤—ã—Ö –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π</p>
                </div>
                {% endif %}
            </div>
        </div>

        <!-- Quick Actions -->
        <div class="card mt-3">
            <div class="card-header">
                <h5 class="card-title mb-0">
                    <i class="fas fa-lightning-bolt me-2"></i>
                    –ë—ã—Å—Ç—Ä—ã–µ –¥–µ–π—Å—Ç–≤–∏—è
                </h5>
            </div>
            <div class="card-body">
                <div class="d-grid gap-2">
                    <button class="btn btn-primary btn-custom" onclick="sendDailyReport()">
                        <i class="fas fa-file-alt me-2"></i>
                        –û—Ç–ø—Ä–∞–≤–∏—Ç—å –æ—Ç—á–µ—Ç
                    </button>
                    <button class="btn btn-success btn-custom" onclick="broadcastMessage()">
                        <i class="fas fa-bullhorn me-2"></i>
                        –†–∞—Å—Å—ã–ª–∫–∞
                    </button>
                    <button class="btn btn-info btn-custom" onclick="exportData()">
                        <i class="fas fa-download me-2"></i>
                        –≠–∫—Å–ø–æ—Ä—Ç –¥–∞–Ω–Ω—ã—Ö
                    </button>
                    <button class="btn btn-warning btn-custom" onclick="clearCache()">
                        <i class="fas fa-broom me-2"></i>
                        –û—á–∏—Å—Ç–∏—Ç—å –∫—ç—à
                    </button>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Project Status Update Modal -->
<div class="modal fade" id="statusModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">–ò–∑–º–µ–Ω–∏—Ç—å —Å—Ç–∞—Ç—É—Å –ø—Ä–æ–µ–∫—Ç–∞</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <form id="statusForm">
                    <input type="hidden" id="projectId" name="project_id">
                    <div class="mb-3">
                        <label for="newStatus" class="form-label">–ù–æ–≤—ã–π —Å—Ç–∞—Ç—É—Å:</label>
                        <select class="form-select" id="newStatus" name="status" required>
                            <option value="new">–ù–æ–≤—ã–π</option>
                            <option value="review">–ù–∞ —Ä–∞—Å—Å–º–æ—Ç—Ä–µ–Ω–∏–∏</option>
                            <option value="accepted">–ü—Ä–∏–Ω—è—Ç</option>
                            <option value="in_progress">–í —Ä–∞–±–æ—Ç–µ</option>
                            <option value="testing">–¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ</option>
                            <option value="completed">–ó–∞–≤–µ—Ä—à–µ–Ω</option>
                            <option value="cancelled">–û—Ç–º–µ–Ω–µ–Ω</option>
                        </select>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">–û—Ç–º–µ–Ω–∞</button>
                <button type="button" class="btn btn-primary" onclick="saveProjectStatus()">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
    // Initialize Charts
    document.addEventListener('DOMContentLoaded', function() {
        initProjectsChart();
        initStatusChart();
        loadFinancialMetrics();
        initQuickTransaction();
    });

    // Load financial metrics
    async function loadFinancialMetrics() {
        try {
            const response = await fetch('/admin/reports/dashboard-metrics', {
                headers: {
                    'Authorization': 'Basic ' + btoa('admin:qwerty123')
                }
            });
            
            const data = await response.json();
            if (data.success && data.metrics) {
                const metrics = data.metrics;
                
                // Update income
                document.getElementById('monthlyIncome').textContent = formatCurrency(metrics.current_month.income);
                const incomeChangeEl = document.getElementById('incomeChange');
                const incomeChange = metrics.changes.income_change;
                incomeChangeEl.textContent = `${incomeChange >= 0 ? '+' : ''}${incomeChange.toFixed(1)}%`;
                incomeChangeEl.className = `metric-change ${incomeChange >= 0 ? 'positive' : 'negative'}`;
                
                // Update expense
                document.getElementById('monthlyExpense').textContent = formatCurrency(metrics.current_month.expense);
                const expenseChangeEl = document.getElementById('expenseChange');
                const expenseChange = metrics.changes.expense_change;
                expenseChangeEl.textContent = `${expenseChange >= 0 ? '+' : ''}${expenseChange.toFixed(1)}%`;
                
                // Update profit
                document.getElementById('monthlyProfit').textContent = formatCurrency(metrics.current_month.profit);
                const profitChangeEl = document.getElementById('profitChange');
                const profitChange = metrics.changes.profit_change;
                profitChangeEl.textContent = formatCurrency(profitChange);
                profitChangeEl.className = `metric-change ${profitChange >= 0 ? 'positive' : 'negative'}`;
                
                // Update profit margin
                document.getElementById('profitMargin').textContent = `${metrics.current_month.profit_margin.toFixed(1)}%`;
                const marginTrend = document.getElementById('marginTrend');
                if (metrics.current_month.profit_margin >= 30) {
                    marginTrend.textContent = '–û—Ç–ª–∏—á–Ω–æ!';
                    marginTrend.style.color = 'rgba(255,255,255,0.8)';
                } else if (metrics.current_month.profit_margin >= 20) {
                    marginTrend.textContent = '–•–æ—Ä–æ—à–æ';
                    marginTrend.style.color = 'rgba(255,255,255,0.8)';
                } else {
                    marginTrend.textContent = '–¢—Ä–µ–±—É–µ—Ç –≤–Ω–∏–º–∞–Ω–∏—è';
                    marginTrend.style.color = 'rgba(255,255,255,0.8)';
                }
            }
        } catch (error) {
            console.error('Error loading financial metrics:', error);
        }
    }

    function formatCurrency(amount) {
        return new Intl.NumberFormat('ru-RU', {
            style: 'currency',
            currency: 'RUB',
            minimumFractionDigits: 0,
            maximumFractionDigits: 0
        }).format(amount);
    }

    function initProjectsChart() {
        const ctx = document.getElementById('projectsChart').getContext('2d');
        new Chart(ctx, {
            type: 'line',
            data: {
                labels: ['–ü–Ω', '–í—Ç', '–°—Ä', '–ß—Ç', '–ü—Ç', '–°–±', '–í—Å'],
                datasets: [{
                    label: '–ù–æ–≤—ã–µ –ø—Ä–æ–µ–∫—Ç—ã',
                    data: [2, 4, 3, 5, 7, 3, 4],
                    borderColor: '#667eea',
                    backgroundColor: 'rgba(102, 126, 234, 0.1)',
                    tension: 0.4,
                    fill: true
                }, {
                    label: '–ó–∞–≤–µ—Ä—à–µ–Ω–Ω—ã–µ',
                    data: [1, 2, 2, 3, 4, 2, 3],
                    borderColor: '#56ab2f',
                    backgroundColor: 'rgba(86, 171, 47, 0.1)',
                    tension: 0.4,
                    fill: true
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    legend: {
                        position: 'top',
                    }
                },
                scales: {
                    y: {
                        beginAtZero: true
                    }
                }
            }
        });
    }

    function initStatusChart() {
        const ctx = document.getElementById('statusChart').getContext('2d');
        
        // Get data from template variables
        const newVal = parseInt('{{ stats.project_stats.status_distribution.new or 0 }}', 10);
        const inProgressVal = parseInt('{{ stats.project_stats.status_distribution.in_progress or 0 }}', 10) 
            + parseInt('{{ stats.project_stats.status_distribution.accepted or 0 }}', 10);
        const completedVal = parseInt('{{ stats.project_stats.status_distribution.completed or 0 }}', 10);
        const cancelledVal = parseInt('{{ stats.project_stats.status_distribution.cancelled or 0 }}', 10);

        const statusData = [
            newVal,
            inProgressVal,
            completedVal,
            cancelledVal
        ];
        
        new Chart(ctx, {
            type: 'doughnut',
            data: {
                labels: ['–ù–æ–≤—ã–µ', '–í —Ä–∞–±–æ—Ç–µ', '–ó–∞–≤–µ—Ä—à–µ–Ω—ã', '–û—Ç–º–µ–Ω–µ–Ω—ã'],
                datasets: [{
                    data: statusData,
                    backgroundColor: [
                        '#17a2b8',
                        '#007bff', 
                        '#28a745',
                        '#dc3545'
                    ],
                    borderWidth: 0
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    legend: {
                        position: 'bottom',
                    }
                }
            }
        });
    }

    // Quick Actions
    async function sendDailyReport() {
        try {
            showNotification('–û—Ç–ø—Ä–∞–≤–ª—è–µ–º –æ—Ç—á–µ—Ç...', 'info');
            const response = await makeRequest('/api/reports/daily', { method: 'POST' });
            if (response.success) {
                showNotification('–û—Ç—á–µ—Ç –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω!', 'success');
            } else {
                showNotification('–û—à–∏–±–∫–∞ –æ—Ç–ø—Ä–∞–≤–∫–∏ –æ—Ç—á–µ—Ç–∞', 'danger');
            }
        } catch (error) {
            showNotification('–û—à–∏–±–∫–∞ –æ—Ç–ø—Ä–∞–≤–∫–∏ –æ—Ç—á–µ—Ç–∞', 'danger');
        }
    }

    async function clearCache() {
        try {
            showNotification('–û—á–∏—â–∞–µ–º –∫—ç—à...', 'info');
            const response = await makeRequest('/api/cache/clear', { method: 'POST' });
            if (response.success) {
                showNotification('–ö—ç—à –æ—á–∏—â–µ–Ω!', 'success');
                setTimeout(() => location.reload(), 1000);
            } else {
                showNotification('–û—à–∏–±–∫–∞ –æ—á–∏—Å—Ç–∫–∏ –∫—ç—à–∞', 'danger');
            }
        } catch (error) {
            showNotification('–û—à–∏–±–∫–∞ –æ—á–∏—Å—Ç–∫–∏ –∫—ç—à–∞', 'danger');
        }
    }

    function broadcastMessage() {
        // Implement broadcast functionality
        showNotification('–§—É–Ω–∫—Ü–∏—è –≤ —Ä–∞–∑—Ä–∞–±–æ—Ç–∫–µ', 'info');
    }

    async function exportData() {
        try {
            showNotification('–≠–∫—Å–ø–æ—Ä—Ç–∏—Ä—É–µ–º –¥–∞–Ω–Ω—ã–µ...', 'info');
            const response = await fetch('/api/export/projects');
            const data = await response.json();
            
            if (data.success) {
                const blob = new Blob([JSON.stringify(data.data, null, 2)], { type: 'application/json' });
                const url = window.URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = `projects_export_${new Date().toISOString().split('T')[0]}.json`;
                a.click();
                window.URL.revokeObjectURL(url);
                showNotification('–î–∞–Ω–Ω—ã–µ —ç–∫—Å–ø–æ—Ä—Ç–∏—Ä–æ–≤–∞–Ω—ã!', 'success');
            } else {
                showNotification('–û—à–∏–±–∫–∞ —ç–∫—Å–ø–æ—Ä—Ç–∞ –¥–∞–Ω–Ω—ã—Ö', 'danger');
            }
        } catch (error) {
            showNotification('–û—à–∏–±–∫–∞ —ç–∫—Å–ø–æ—Ä—Ç–∞ –¥–∞–Ω–Ω—ã—Ö', 'danger');
        }
    }

    // Project Management
    function viewProject(projectId) {
        window.location.href = `/admin/projects/${projectId}/detail`;
    }

    function updateProjectStatus(projectId) {
        document.getElementById('projectId').value = projectId;
        const modal = new bootstrap.Modal(document.getElementById('statusModal'));
        modal.show();
    }

    async function saveProjectStatus() {
        const form = document.getElementById('statusForm');
        const formData = new FormData(form);
        
        try {
            const response = await makeRequest(`/api/project/${formData.get('project_id')}/status`, {
                method: 'POST',
                body: formData
            });
            
            if (response.success) {
                showNotification('–°—Ç–∞—Ç—É—Å –æ–±–Ω–æ–≤–ª–µ–Ω!', 'success');
                const modal = bootstrap.Modal.getInstance(document.getElementById('statusModal'));
                modal.hide();
                setTimeout(() => location.reload(), 1000);
            } else {
                showNotification('–û—à–∏–±–∫–∞ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è —Å—Ç–∞—Ç—É—Å–∞', 'danger');
            }
        } catch (error) {
            showNotification('–û—à–∏–±–∫–∞ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è —Å—Ç–∞—Ç—É—Å–∞', 'danger');
        }
    }

    // Auto-refresh every 5 minutes
    setInterval(() => {
        location.reload();
    }, 5 * 60 * 1000);

    // Quick Transaction Functions
    async function initQuickTransaction() {
        // Load categories based on transaction type
        const typeRadios = document.querySelectorAll('input[name="transType"]');
        typeRadios.forEach(radio => {
            radio.addEventListener('change', loadCategories);
        });
        
        // Load initial categories
        loadCategories();
        
        // Handle form submission
        document.getElementById('quickTransactionForm').addEventListener('submit', handleQuickTransaction);
    }

    async function loadCategories() {
        const type = document.querySelector('input[name="transType"]:checked').value;
        const categorySelect = document.getElementById('quickCategory');
        
        try {
            const response = await fetch(`/admin/finance/categories?type=${type}`, {
                headers: {
                    'Authorization': 'Basic ' + btoa('{{ username }}:{{ password }}')
                }
            });
            
            const data = await response.json();
            if (data.success) {
                categorySelect.innerHTML = '<option value="">–í—ã–±–µ—Ä–∏—Ç–µ...</option>';
                data.data.forEach(category => {
                    const option = document.createElement('option');
                    option.value = category.id;
                    option.textContent = category.name;
                    categorySelect.appendChild(option);
                });
            }
        } catch (error) {
            console.error('Error loading categories:', error);
        }
    }

    async function handleQuickTransaction(e) {
        e.preventDefault();
        
        const formData = {
            type: document.querySelector('input[name="transType"]:checked').value,
            amount: parseFloat(document.getElementById('quickAmount').value),
            category_id: parseInt(document.getElementById('quickCategory').value),
            account: document.getElementById('quickAccount').value,
            description: document.getElementById('quickDescription').value,
            date: new Date().toISOString()
        };
        
        try {
            const response = await fetch('/admin/finance/transactions', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'Authorization': 'Basic ' + btoa('{{ username }}:{{ password }}')
                },
                body: JSON.stringify(formData)
            });
            
            const data = await response.json();
            const alertDiv = document.getElementById('quickTransactionAlert');
            
            if (data.success) {
                alertDiv.className = 'alert alert-success mt-3';
                alertDiv.innerHTML = `<i class="fas fa-check-circle me-2"></i>–¢—Ä–∞–Ω–∑–∞–∫—Ü–∏—è –¥–æ–±–∞–≤–ª–µ–Ω–∞ —É—Å–ø–µ—à–Ω–æ!`;
                alertDiv.classList.remove('d-none');
                
                // Reset form
                document.getElementById('quickTransactionForm').reset();
                document.getElementById('typeIncome').checked = true;
                loadCategories();
                
                // Reload financial metrics
                loadFinancialMetrics();
                
                // Hide alert after 3 seconds
                setTimeout(() => {
                    alertDiv.classList.add('d-none');
                }, 3000);
            } else {
                alertDiv.className = 'alert alert-danger mt-3';
                alertDiv.innerHTML = `<i class="fas fa-exclamation-circle me-2"></i>${data.error || '–û—à–∏–±–∫–∞ –¥–æ–±–∞–≤–ª–µ–Ω–∏—è —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–∏'}`;
                alertDiv.classList.remove('d-none');
            }
        } catch (error) {
            const alertDiv = document.getElementById('quickTransactionAlert');
            alertDiv.className = 'alert alert-danger mt-3';
            alertDiv.innerHTML = `<i class="fas fa-exclamation-circle me-2"></i>–û—à–∏–±–∫–∞: ${error.message}`;
            alertDiv.classList.remove('d-none');
        }
    }
</script>
{% endblock %}