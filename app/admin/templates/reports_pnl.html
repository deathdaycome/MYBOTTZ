{% extends "base.html" %}

{% block title %}–û—Ç—á–µ—Ç P&L - BotDev Admin{% endblock %}

{% block page_title %}
<h4>üìä –û—Ç—á–µ—Ç –æ –ø—Ä–∏–±—ã–ª—è—Ö –∏ —É–±—ã—Ç–∫–∞—Ö (P&L)</h4>
{% endblock %}

{% block extra_css %}
<style>
/* –°—Ç–∏–ª–∏ –¥–ª—è –æ—Ç—á–µ—Ç–∞ P&L */
.pnl-header {
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    color: white;
    padding: 2rem;
    border-radius: 12px;
    margin-bottom: 2rem;
}

.pnl-summary {
    display: flex;
    justify-content: space-around;
    align-items: center;
}

.pnl-metric {
    text-align: center;
}

.pnl-metric h2 {
    font-size: 2.5rem;
    margin: 0;
    font-weight: bold;
}

.pnl-metric p {
    margin: 0;
    opacity: 0.9;
    font-size: 0.9rem;
}

.period-selector {
    background: white;
    padding: 1rem;
    border-radius: 8px;
    margin-bottom: 2rem;
    box-shadow: 0 2px 8px rgba(0,0,0,0.1);
}

.period-tabs {
    display: flex;
    gap: 1rem;
    margin-bottom: 1rem;
}

.period-tab {
    padding: 0.5rem 1rem;
    border: 2px solid #e0e0e0;
    background: white;
    border-radius: 8px;
    cursor: pointer;
    transition: all 0.3s;
}

.period-tab.active {
    background: #667eea;
    color: white;
    border-color: #667eea;
}

.pnl-table {
    background: white;
    border-radius: 12px;
    overflow: hidden;
    box-shadow: 0 2px 12px rgba(0,0,0,0.08);
    margin-bottom: 2rem;
}

.pnl-table table {
    width: 100%;
    border-collapse: collapse;
}

.pnl-table th {
    background: #f5f5f5;
    padding: 1rem;
    text-align: left;
    font-weight: 600;
    border-bottom: 2px solid #e0e0e0;
}

.pnl-table td {
    padding: 0.75rem 1rem;
    border-bottom: 1px solid #f0f0f0;
}

.category-header {
    background: #fafafa;
    font-weight: 600;
    color: #333;
}

.subcategory-row td:first-child {
    padding-left: 2rem;
    color: #666;
}

.total-row {
    background: #f8f8f8;
    font-weight: bold;
    border-top: 2px solid #e0e0e0;
}

.total-row.profit {
    background: linear-gradient(135deg, #84fab0 0%, #8fd3f4 100%);
    color: #2e7d32;
}

.total-row.loss {
    background: linear-gradient(135deg, #ffeaa7 0%, #fdcb6e 100%);
    color: #d32f2f;
}

.amount-positive {
    color: #2e7d32;
    font-weight: 500;
}

.amount-negative {
    color: #d32f2f;
    font-weight: 500;
}

.percentage {
    color: #666;
    font-size: 0.85rem;
}

.chart-container {
    background: white;
    padding: 1.5rem;
    border-radius: 12px;
    box-shadow: 0 2px 12px rgba(0,0,0,0.08);
    margin-bottom: 2rem;
}

.comparison-card {
    background: white;
    padding: 1.5rem;
    border-radius: 12px;
    box-shadow: 0 2px 8px rgba(0,0,0,0.08);
    margin-bottom: 1rem;
}

.comparison-metric {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 0.5rem;
}

.metric-bar {
    flex: 1;
    height: 8px;
    background: #e0e0e0;
    border-radius: 4px;
    margin: 0 1rem;
    overflow: hidden;
}

.metric-fill {
    height: 100%;
    background: linear-gradient(90deg, #667eea 0%, #764ba2 100%);
    transition: width 0.5s;
}

.export-buttons {
    display: flex;
    gap: 1rem;
    justify-content: flex-end;
    margin-bottom: 1rem;
}
</style>
{% endblock %}

{% block content %}
<!-- –ó–∞–≥–æ–ª–æ–≤–æ–∫ —Å –æ—Å–Ω–æ–≤–Ω—ã–º–∏ –º–µ—Ç—Ä–∏–∫–∞–º–∏ -->
<div class="pnl-header">
    <div class="pnl-summary">
        <div class="pnl-metric">
            <h2 id="totalRevenue">0 ‚ÇΩ</h2>
            <p>–û–±—â–∏–π –¥–æ—Ö–æ–¥</p>
        </div>
        <div class="pnl-metric">
            <h2 id="totalExpenses">0 ‚ÇΩ</h2>
            <p>–û–±—â–∏–µ —Ä–∞—Å—Ö–æ–¥—ã</p>
        </div>
        <div class="pnl-metric">
            <h2 id="netProfit">0 ‚ÇΩ</h2>
            <p>–ß–∏—Å—Ç–∞—è –ø—Ä–∏–±—ã–ª—å</p>
        </div>
        <div class="pnl-metric">
            <h2 id="profitMargin">0%</h2>
            <p>–†–µ–Ω—Ç–∞–±–µ–ª—å–Ω–æ—Å—Ç—å</p>
        </div>
    </div>
</div>

<!-- –í—ã–±–æ—Ä –ø–µ—Ä–∏–æ–¥–∞ -->
<div class="period-selector">
    <div class="period-tabs">
        <button class="period-tab active" onclick="loadPnL('month')">–¢–µ–∫—É—â–∏–π –º–µ—Å—è—Ü</button>
        <button class="period-tab" onclick="loadPnL('quarter')">–ö–≤–∞—Ä—Ç–∞–ª</button>
        <button class="period-tab" onclick="loadPnL('year')">–ì–æ–¥</button>
        <button class="period-tab" onclick="showCustomPeriod()">–ü—Ä–æ–∏–∑–≤–æ–ª—å–Ω—ã–π –ø–µ—Ä–∏–æ–¥</button>
    </div>
    
    <div id="customPeriod" style="display: none;">
        <div class="row mt-3">
            <div class="col-md-4">
                <label>–° –¥–∞—Ç—ã:</label>
                <input type="date" class="form-control" id="startDate">
            </div>
            <div class="col-md-4">
                <label>–ü–æ –¥–∞—Ç—É:</label>
                <input type="date" class="form-control" id="endDate">
            </div>
            <div class="col-md-4">
                <label>&nbsp;</label>
                <button class="btn btn-primary w-100" onclick="loadCustomPnL()">–ü–æ–∫–∞–∑–∞—Ç—å</button>
            </div>
        </div>
    </div>
</div>

<!-- –ö–Ω–æ–ø–∫–∏ —ç–∫—Å–ø–æ—Ä—Ç–∞ -->
<div class="export-buttons">
    <button class="btn btn-outline-success" onclick="exportToExcel()">
        <i class="fas fa-file-excel"></i> –≠–∫—Å–ø–æ—Ä—Ç –≤ Excel
    </button>
    <button class="btn btn-outline-danger" onclick="exportToPDF()">
        <i class="fas fa-file-pdf"></i> –≠–∫—Å–ø–æ—Ä—Ç –≤ PDF
    </button>
    <button class="btn btn-outline-primary" onclick="printReport()">
        <i class="fas fa-print"></i> –ü–µ—á–∞—Ç—å
    </button>
</div>

<!-- –¢–∞–±–ª–∏—Ü–∞ –¥–æ—Ö–æ–¥–æ–≤ -->
<div class="pnl-table">
    <table>
        <thead>
            <tr>
                <th colspan="3">–î–û–•–û–î–´</th>
            </tr>
            <tr>
                <th>–ö–∞—Ç–µ–≥–æ—Ä–∏—è</th>
                <th>–°—É–º–º–∞</th>
                <th>% –æ—Ç –æ–±—â–µ–≥–æ</th>
            </tr>
        </thead>
        <tbody id="revenueTable">
            <!-- –ó–∞–ø–æ–ª–Ω—è–µ—Ç—Å—è –¥–∏–Ω–∞–º–∏—á–µ—Å–∫–∏ -->
        </tbody>
        <tfoot>
            <tr class="total-row">
                <td>–ò–¢–û–ì–û –î–û–•–û–î–´</td>
                <td id="totalRevenueRow">0 ‚ÇΩ</td>
                <td>100%</td>
            </tr>
        </tfoot>
    </table>
</div>

<!-- –¢–∞–±–ª–∏—Ü–∞ —Ä–∞—Å—Ö–æ–¥–æ–≤ -->
<div class="pnl-table">
    <table>
        <thead>
            <tr>
                <th colspan="3">–†–ê–°–•–û–î–´</th>
            </tr>
            <tr>
                <th>–ö–∞—Ç–µ–≥–æ—Ä–∏—è</th>
                <th>–°—É–º–º–∞</th>
                <th>% –æ—Ç –æ–±—â–µ–≥–æ</th>
            </tr>
        </thead>
        <tbody id="expenseTable">
            <!-- –ó–∞–ø–æ–ª–Ω—è–µ—Ç—Å—è –¥–∏–Ω–∞–º–∏—á–µ—Å–∫–∏ -->
        </tbody>
        <tfoot>
            <tr class="total-row">
                <td>–ò–¢–û–ì–û –†–ê–°–•–û–î–´</td>
                <td id="totalExpenseRow">0 ‚ÇΩ</td>
                <td>100%</td>
            </tr>
        </tfoot>
    </table>
</div>

<!-- –ò—Ç–æ–≥–æ–≤–∞—è –ø—Ä–∏–±—ã–ª—å -->
<div class="pnl-table">
    <table>
        <tbody>
            <tr class="total-row profit" id="profitRow">
                <td style="width: 50%;">–ß–ò–°–¢–ê–Ø –ü–†–ò–ë–´–õ–¨</td>
                <td id="netProfitRow">0 ‚ÇΩ</td>
                <td id="profitMarginRow">0%</td>
            </tr>
        </tbody>
    </table>
</div>

<!-- –ì—Ä–∞—Ñ–∏–∫–∏ -->
<div class="row">
    <div class="col-md-6">
        <div class="chart-container">
            <h5>–î–∏–Ω–∞–º–∏–∫–∞ –¥–æ—Ö–æ–¥–æ–≤ –∏ —Ä–∞—Å—Ö–æ–¥–æ–≤</h5>
            <canvas id="trendChart"></canvas>
        </div>
    </div>
    <div class="col-md-6">
        <div class="chart-container">
            <h5>–°—Ç—Ä—É–∫—Ç—É—Ä–∞ —Ä–∞—Å—Ö–æ–¥–æ–≤</h5>
            <canvas id="expenseChart"></canvas>
        </div>
    </div>
</div>

<!-- –°—Ä–∞–≤–Ω–µ–Ω–∏–µ —Å –ø—Ä–µ–¥—ã–¥—É—â–∏–º –ø–µ—Ä–∏–æ–¥–æ–º -->
<div class="row">
    <div class="col-md-12">
        <h5 class="mb-3">–°—Ä–∞–≤–Ω–µ–Ω–∏–µ —Å –ø—Ä–µ–¥—ã–¥—É—â–∏–º –ø–µ—Ä–∏–æ–¥–æ–º</h5>
    </div>
    <div class="col-md-4">
        <div class="comparison-card">
            <h6>–î–æ—Ö–æ–¥—ã</h6>
            <div class="comparison-metric">
                <span>–¢–µ–∫—É—â–∏–π</span>
                <div class="metric-bar">
                    <div class="metric-fill" id="currentRevenueBar" style="width: 0%"></div>
                </div>
                <span id="currentRevenue">0 ‚ÇΩ</span>
            </div>
            <div class="comparison-metric">
                <span>–ü—Ä–æ—à–ª—ã–π</span>
                <div class="metric-bar">
                    <div class="metric-fill" style="width: 60%; background: #ccc;"></div>
                </div>
                <span id="previousRevenue">0 ‚ÇΩ</span>
            </div>
            <div class="mt-2 text-center">
                <span id="revenueChange" class="badge bg-success">+0%</span>
            </div>
        </div>
    </div>
    <div class="col-md-4">
        <div class="comparison-card">
            <h6>–†–∞—Å—Ö–æ–¥—ã</h6>
            <div class="comparison-metric">
                <span>–¢–µ–∫—É—â–∏–π</span>
                <div class="metric-bar">
                    <div class="metric-fill" id="currentExpenseBar" style="width: 0%"></div>
                </div>
                <span id="currentExpense">0 ‚ÇΩ</span>
            </div>
            <div class="comparison-metric">
                <span>–ü—Ä–æ—à–ª—ã–π</span>
                <div class="metric-bar">
                    <div class="metric-fill" style="width: 40%; background: #ccc;"></div>
                </div>
                <span id="previousExpense">0 ‚ÇΩ</span>
            </div>
            <div class="mt-2 text-center">
                <span id="expenseChange" class="badge bg-danger">+0%</span>
            </div>
        </div>
    </div>
    <div class="col-md-4">
        <div class="comparison-card">
            <h6>–ü—Ä–∏–±—ã–ª—å</h6>
            <div class="comparison-metric">
                <span>–¢–µ–∫—É—â–∏–π</span>
                <div class="metric-bar">
                    <div class="metric-fill" id="currentProfitBar" style="width: 0%"></div>
                </div>
                <span id="currentProfit">0 ‚ÇΩ</span>
            </div>
            <div class="comparison-metric">
                <span>–ü—Ä–æ—à–ª—ã–π</span>
                <div class="metric-bar">
                    <div class="metric-fill" style="width: 50%; background: #ccc;"></div>
                </div>
                <span id="previousProfit">0 ‚ÇΩ</span>
            </div>
            <div class="mt-2 text-center">
                <span id="profitChange" class="badge bg-info">+0%</span>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
let currentPeriod = 'month';
let trendChart = null;
let expenseChart = null;

// –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ —Å—Ç—Ä–∞–Ω–∏—Ü—ã
document.addEventListener('DOMContentLoaded', function() {
    loadPnL('month');
    initCharts();
});

// –ó–∞–≥—Ä—É–∑–∫–∞ –¥–∞–Ω–Ω—ã—Ö P&L
async function loadPnL(period) {
    currentPeriod = period;
    
    // –ü–æ–¥—Å–≤–µ—Ç–∫–∞ –∞–∫—Ç–∏–≤–Ω–æ–π –≤–∫–ª–∞–¥–∫–∏
    document.querySelectorAll('.period-tab').forEach(tab => {
        tab.classList.remove('active');
    });
    event.target.classList.add('active');
    
    try {
        const response = await fetch(`/admin/reports/pnl?period=${period}`, {
            headers: {
                'Authorization': 'Basic ' + btoa('{{ username }}:{{ password }}')
            }
        });
        
        const data = await response.json();
        if (data.success) {
            updatePnLDisplay(data.data);
        }
    } catch (error) {
        console.error('Error loading P&L data:', error);
    }
}

// –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è P&L
function updatePnLDisplay(data) {
    // –û–±–Ω–æ–≤–ª—è–µ–º –∑–∞–≥–æ–ª–æ–≤–æ–∫
    document.getElementById('totalRevenue').textContent = formatCurrency(data.total_revenue);
    document.getElementById('totalExpenses').textContent = formatCurrency(data.total_expenses);
    document.getElementById('netProfit').textContent = formatCurrency(data.net_profit);
    document.getElementById('profitMargin').textContent = data.profit_margin.toFixed(1) + '%';
    
    // –û–±–Ω–æ–≤–ª—è–µ–º —Ç–∞–±–ª–∏—Ü—É –¥–æ—Ö–æ–¥–æ–≤
    const revenueTable = document.getElementById('revenueTable');
    revenueTable.innerHTML = '';
    
    data.revenue_by_category.forEach(category => {
        const row = document.createElement('tr');
        const percentage = ((category.amount / data.total_revenue) * 100).toFixed(1);
        row.innerHTML = `
            <td>${category.name}</td>
            <td class="amount-positive">${formatCurrency(category.amount)}</td>
            <td class="percentage">${percentage}%</td>
        `;
        revenueTable.appendChild(row);
    });
    
    document.getElementById('totalRevenueRow').textContent = formatCurrency(data.total_revenue);
    
    // –û–±–Ω–æ–≤–ª—è–µ–º —Ç–∞–±–ª–∏—Ü—É —Ä–∞—Å—Ö–æ–¥–æ–≤
    const expenseTable = document.getElementById('expenseTable');
    expenseTable.innerHTML = '';
    
    data.expenses_by_category.forEach(category => {
        const row = document.createElement('tr');
        const percentage = ((category.amount / data.total_expenses) * 100).toFixed(1);
        row.innerHTML = `
            <td>${category.name}</td>
            <td class="amount-negative">${formatCurrency(category.amount)}</td>
            <td class="percentage">${percentage}%</td>
        `;
        expenseTable.appendChild(row);
    });
    
    document.getElementById('totalExpenseRow').textContent = formatCurrency(data.total_expenses);
    
    // –û–±–Ω–æ–≤–ª—è–µ–º –∏—Ç–æ–≥–æ–≤—É—é –ø—Ä–∏–±—ã–ª—å
    document.getElementById('netProfitRow').textContent = formatCurrency(data.net_profit);
    document.getElementById('profitMarginRow').textContent = data.profit_margin.toFixed(1) + '%';
    
    // –ú–µ–Ω—è–µ–º —Ü–≤–µ—Ç –≤ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ –æ—Ç –ø—Ä–∏–±—ã–ª–∏/—É–±—ã—Ç–∫–∞
    const profitRow = document.getElementById('profitRow');
    if (data.net_profit >= 0) {
        profitRow.className = 'total-row profit';
    } else {
        profitRow.className = 'total-row loss';
    }
    
    // –û–±–Ω–æ–≤–ª—è–µ–º –≥—Ä–∞—Ñ–∏–∫–∏
    updateCharts(data);
    
    // –û–±–Ω–æ–≤–ª—è–µ–º —Å—Ä–∞–≤–Ω–µ–Ω–∏–µ
    updateComparison(data);
}

// –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –≥—Ä–∞—Ñ–∏–∫–æ–≤
function initCharts() {
    // –ì—Ä–∞—Ñ–∏–∫ –¥–∏–Ω–∞–º–∏–∫–∏
    const trendCtx = document.getElementById('trendChart').getContext('2d');
    trendChart = new Chart(trendCtx, {
        type: 'line',
        data: {
            labels: [],
            datasets: [{
                label: '–î–æ—Ö–æ–¥—ã',
                data: [],
                borderColor: '#4caf50',
                backgroundColor: 'rgba(76, 175, 80, 0.1)',
                tension: 0.4
            }, {
                label: '–†–∞—Å—Ö–æ–¥—ã',
                data: [],
                borderColor: '#f44336',
                backgroundColor: 'rgba(244, 67, 54, 0.1)',
                tension: 0.4
            }]
        },
        options: {
            responsive: true,
            plugins: {
                legend: {
                    position: 'bottom'
                }
            },
            scales: {
                y: {
                    beginAtZero: true,
                    ticks: {
                        callback: function(value) {
                            return formatCurrency(value);
                        }
                    }
                }
            }
        }
    });
    
    // –ì—Ä–∞—Ñ–∏–∫ —Å—Ç—Ä—É–∫—Ç—É—Ä—ã —Ä–∞—Å—Ö–æ–¥–æ–≤
    const expenseCtx = document.getElementById('expenseChart').getContext('2d');
    expenseChart = new Chart(expenseCtx, {
        type: 'doughnut',
        data: {
            labels: [],
            datasets: [{
                data: [],
                backgroundColor: [
                    '#FF6384',
                    '#36A2EB',
                    '#FFCE56',
                    '#4BC0C0',
                    '#9966FF',
                    '#FF9F40'
                ]
            }]
        },
        options: {
            responsive: true,
            plugins: {
                legend: {
                    position: 'right'
                }
            }
        }
    });
}

// –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –≥—Ä–∞—Ñ–∏–∫–æ–≤
function updateCharts(data) {
    // –û–±–Ω–æ–≤–ª—è–µ–º –≥—Ä–∞—Ñ–∏–∫ –¥–∏–Ω–∞–º–∏–∫–∏
    if (data.trend_data) {
        trendChart.data.labels = data.trend_data.labels;
        trendChart.data.datasets[0].data = data.trend_data.revenue;
        trendChart.data.datasets[1].data = data.trend_data.expenses;
        trendChart.update();
    }
    
    // –û–±–Ω–æ–≤–ª—è–µ–º –≥—Ä–∞—Ñ–∏–∫ —Ä–∞—Å—Ö–æ–¥–æ–≤
    if (data.expenses_by_category) {
        expenseChart.data.labels = data.expenses_by_category.map(c => c.name);
        expenseChart.data.datasets[0].data = data.expenses_by_category.map(c => c.amount);
        expenseChart.update();
    }
}

// –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ —Å—Ä–∞–≤–Ω–µ–Ω–∏—è
function updateComparison(data) {
    if (data.comparison) {
        // –î–æ—Ö–æ–¥—ã
        document.getElementById('currentRevenue').textContent = formatCurrency(data.total_revenue);
        document.getElementById('previousRevenue').textContent = formatCurrency(data.comparison.previous_revenue);
        document.getElementById('currentRevenueBar').style.width = '100%';
        
        const revenueChangePercent = ((data.total_revenue - data.comparison.previous_revenue) / data.comparison.previous_revenue * 100).toFixed(1);
        const revenueChangeBadge = document.getElementById('revenueChange');
        revenueChangeBadge.textContent = `${revenueChangePercent > 0 ? '+' : ''}${revenueChangePercent}%`;
        revenueChangeBadge.className = `badge bg-${revenueChangePercent >= 0 ? 'success' : 'danger'}`;
        
        // –†–∞—Å—Ö–æ–¥—ã
        document.getElementById('currentExpense').textContent = formatCurrency(data.total_expenses);
        document.getElementById('previousExpense').textContent = formatCurrency(data.comparison.previous_expenses);
        document.getElementById('currentExpenseBar').style.width = '100%';
        
        const expenseChangePercent = ((data.total_expenses - data.comparison.previous_expenses) / data.comparison.previous_expenses * 100).toFixed(1);
        const expenseChangeBadge = document.getElementById('expenseChange');
        expenseChangeBadge.textContent = `${expenseChangePercent > 0 ? '+' : ''}${expenseChangePercent}%`;
        expenseChangeBadge.className = `badge bg-${expenseChangePercent <= 0 ? 'success' : 'danger'}`;
        
        // –ü—Ä–∏–±—ã–ª—å
        document.getElementById('currentProfit').textContent = formatCurrency(data.net_profit);
        document.getElementById('previousProfit').textContent = formatCurrency(data.comparison.previous_profit);
        document.getElementById('currentProfitBar').style.width = '100%';
        
        const profitChangePercent = ((data.net_profit - data.comparison.previous_profit) / Math.abs(data.comparison.previous_profit) * 100).toFixed(1);
        const profitChangeBadge = document.getElementById('profitChange');
        profitChangeBadge.textContent = `${profitChangePercent > 0 ? '+' : ''}${profitChangePercent}%`;
        profitChangeBadge.className = `badge bg-${profitChangePercent >= 0 ? 'success' : 'danger'}`;
    }
}

// –ü–æ–∫–∞–∑–∞—Ç—å –≤—ã–±–æ—Ä –ø—Ä–æ–∏–∑–≤–æ–ª—å–Ω–æ–≥–æ –ø–µ—Ä–∏–æ–¥–∞
function showCustomPeriod() {
    const customPeriod = document.getElementById('customPeriod');
    customPeriod.style.display = customPeriod.style.display === 'none' ? 'block' : 'none';
}

// –ó–∞–≥—Ä—É–∑–∫–∞ P&L –∑–∞ –ø—Ä–æ–∏–∑–≤–æ–ª—å–Ω—ã–π –ø–µ—Ä–∏–æ–¥
async function loadCustomPnL() {
    const startDate = document.getElementById('startDate').value;
    const endDate = document.getElementById('endDate').value;
    
    if (!startDate || !endDate) {
        alert('–í—ã–±–µ—Ä–∏—Ç–µ –Ω–∞—á–∞–ª—å–Ω—É—é –∏ –∫–æ–Ω–µ—á–Ω—É—é –¥–∞—Ç—É');
        return;
    }
    
    try {
        const response = await fetch(`/admin/reports/pnl?start_date=${startDate}&end_date=${endDate}`, {
            headers: {
                'Authorization': 'Basic ' + btoa('{{ username }}:{{ password }}')
            }
        });
        
        const data = await response.json();
        if (data.success) {
            updatePnLDisplay(data.data);
        }
    } catch (error) {
        console.error('Error loading custom P&L data:', error);
    }
}

// –≠–∫—Å–ø–æ—Ä—Ç –≤ Excel
async function exportToExcel() {
    try {
        const response = await fetch(`/admin/reports/pnl/export?format=excel&period=${currentPeriod}`, {
            headers: {
                'Authorization': 'Basic ' + btoa('{{ username }}:{{ password }}')
            }
        });
        
        const blob = await response.blob();
        const url = window.URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = `PnL_Report_${new Date().toISOString().split('T')[0]}.xlsx`;
        a.click();
    } catch (error) {
        console.error('Error exporting to Excel:', error);
    }
}

// –≠–∫—Å–ø–æ—Ä—Ç –≤ PDF
async function exportToPDF() {
    window.print();
}

// –ü–µ—á–∞—Ç—å –æ—Ç—á–µ—Ç–∞
function printReport() {
    window.print();
}

// –§–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –≤–∞–ª—é—Ç—ã
function formatCurrency(amount) {
    return new Intl.NumberFormat('ru-RU', {
        style: 'currency',
        currency: 'RUB',
        minimumFractionDigits: 0
    }).format(amount);
}
</script>
{% endblock %}