{% extends "base.html" %}

{% block title %}Управление пользователями{% endblock %}

{% block page_title %}Управление пользователями{% endblock %}

{% block extra_css %}
<style>
    .user-card {
        background: white;
        border-radius: 12px;
        padding: 1.5rem;
        margin-bottom: 1rem;
        box-shadow: 0 2px 4px rgba(0, 0, 0, 0.05);
        transition: all 0.3s ease;
    }
    
    .user-card:hover {
        box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
        transform: translateY(-2px);
    }
    
    .user-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 1rem;
    }
    
    .user-info {
        flex: 1;
    }
    
    .user-name {
        font-size: 1.2rem;
        font-weight: 600;
        color: #1a1a1a;
        margin-bottom: 0.25rem;
    }
    
    .user-username {
        color: #6c757d;
        font-size: 0.9rem;
    }
    
    .user-role {
        padding: 0.25rem 0.75rem;
        border-radius: 20px;
        font-size: 0.85rem;
        font-weight: 500;
    }
    
    .role-owner {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: white;
    }
    
    .role-executor {
        background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
        color: white;
    }
    
    .user-stats {
        display: flex;
        gap: 2rem;
        margin-top: 1rem;
        padding-top: 1rem;
        border-top: 1px solid #e9ecef;
    }
    
    .stat-item {
        display: flex;
        flex-direction: column;
    }
    
    .stat-value {
        font-size: 1.5rem;
        font-weight: 700;
        color: #495057;
    }
    
    .stat-label {
        font-size: 0.85rem;
        color: #6c757d;
        text-transform: uppercase;
        letter-spacing: 0.5px;
    }
    
    .user-actions {
        display: flex;
        gap: 0.5rem;
        margin-top: 1rem;
    }
    
    .user-status {
        display: inline-flex;
        align-items: center;
        gap: 0.25rem;
        padding: 0.25rem 0.5rem;
        border-radius: 6px;
        font-size: 0.85rem;
    }
    
    .status-active {
        background: #d4edda;
        color: #155724;
    }
    
    .status-inactive {
        background: #f8d7da;
        color: #721c24;
    }
    
    .add-user-btn {
        position: fixed;
        bottom: 2rem;
        right: 2rem;
        width: 60px;
        height: 60px;
        border-radius: 50%;
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: white;
        border: none;
        box-shadow: 0 4px 12px rgba(102, 126, 234, 0.4);
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 1.5rem;
        cursor: pointer;
        transition: all 0.3s ease;
    }
    
    .add-user-btn:hover {
        transform: scale(1.1);
        box-shadow: 0 6px 20px rgba(102, 126, 234, 0.6);
    }
    
    .search-bar {
        background: white;
        border-radius: 12px;
        padding: 1rem;
        margin-bottom: 1.5rem;
        box-shadow: 0 2px 4px rgba(0, 0, 0, 0.05);
    }
    
    .search-input {
        width: 100%;
        padding: 0.75rem;
        border: 1px solid #e9ecef;
        border-radius: 8px;
        font-size: 1rem;
    }
    
    .search-input:focus {
        outline: none;
        border-color: #667eea;
        box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
    }
    
    .no-users {
        text-align: center;
        padding: 3rem;
        color: #6c757d;
    }
    
    .no-users i {
        font-size: 4rem;
        color: #dee2e6;
        margin-bottom: 1rem;
    }
</style>
{% endblock %}

{% block header_actions %}
<button class="btn btn-primary" onclick="openAddUserModal()">
    <i class="fas fa-user-plus me-2"></i>Добавить пользователя
</button>
{% endblock %}

{% block content %}
<div class="container-fluid">
    <!-- Поиск -->
    <div class="search-bar">
        <input type="text" class="search-input" id="userSearch" placeholder="Поиск по имени или username..." onkeyup="filterUsers()">
    </div>
    
    <!-- Список пользователей -->
    <div id="usersList">
        {% if users %}
            {% for user in users %}
            <div class="user-card" data-username="{{ user.username }}" data-name="{{ user.first_name }} {{ user.last_name }}">
                <div class="user-header">
                    <div class="user-info">
                        <div class="user-name">
                            {{ user.first_name }} {{ user.last_name }}
                            {% if user.is_active %}
                                <span class="user-status status-active">
                                    <i class="fas fa-check-circle"></i> Активен
                                </span>
                            {% else %}
                                <span class="user-status status-inactive">
                                    <i class="fas fa-times-circle"></i> Неактивен
                                </span>
                            {% endif %}
                        </div>
                        <div class="user-username">@{{ user.username }}</div>
                        {% if user.email %}
                        <div class="text-muted small mt-1">
                            <i class="fas fa-envelope"></i> {{ user.email }}
                        </div>
                        {% endif %}
                    </div>
                    <div>
                        <span class="user-role role-{{ user.role }}">
                            {% if user.role == 'owner' %}
                                <i class="fas fa-crown"></i> Владелец
                            {% else %}
                                <i class="fas fa-user"></i> Исполнитель
                            {% endif %}
                        </span>
                    </div>
                </div>
                
                <div class="user-stats">
                    <div class="stat-item">
                        <div class="stat-value">{{ user.tasks_count|default(0) }}</div>
                        <div class="stat-label">Всего задач</div>
                    </div>
                    <div class="stat-item">
                        <div class="stat-value">{{ user.active_tasks|default(0) }}</div>
                        <div class="stat-label">Активных</div>
                    </div>
                    <div class="stat-item">
                        <div class="stat-value">{{ user.created_at[:10] }}</div>
                        <div class="stat-label">Регистрация</div>
                    </div>
                </div>
                
                <div class="user-actions">
                    <button class="btn btn-sm btn-outline-primary" onclick="editUser({{ user.id }})">
                        <i class="fas fa-edit"></i> Редактировать
                    </button>
                    {% if user_role == 'owner' %}
                    <button class="btn btn-sm btn-outline-info" onclick="viewPassword({{ user.id }}, '{{ user.username }}')">
                        <i class="fas fa-eye"></i> Показать пароль
                    </button>
                    {% endif %}
                    <button class="btn btn-sm btn-outline-success" onclick="changePassword({{ user.id }}, '{{ user.role }}')">
                        <i class="fas fa-key"></i> Сменить пароль
                    </button>
                    {% if user.role != 'owner' %}
                    <button class="btn btn-sm btn-outline-warning" onclick="toggleUserStatus({{ user.id }}, {{ user.is_active|lower }})">
                        {% if user.is_active %}
                            <i class="fas fa-user-slash"></i> Деактивировать
                        {% else %}
                            <i class="fas fa-user-check"></i> Активировать
                        {% endif %}
                    </button>
                    <button class="btn btn-sm btn-outline-danger" onclick="deleteUser({{ user.id }})">
                        <i class="fas fa-trash"></i> Удалить
                    </button>
                    {% endif %}
                </div>
            </div>
            {% endfor %}
        {% else %}
            <div class="no-users">
                <i class="fas fa-users"></i>
                <h3>Пользователей пока нет</h3>
                <p>Добавьте первого пользователя для начала работы</p>
            </div>
        {% endif %}
    </div>
</div>

<!-- Модальное окно добавления пользователя -->
<div class="modal fade" id="addUserModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Добавить пользователя</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <form id="addUserForm">
                    <div class="mb-3">
                        <label for="username" class="form-label">Username *</label>
                        <input type="text" class="form-control" id="username" required>
                    </div>
                    <div class="mb-3">
                        <label for="password" class="form-label">Пароль *</label>
                        <input type="password" class="form-control" id="password" required>
                    </div>
                    <div class="row">
                        <div class="col-md-6 mb-3">
                            <label for="firstName" class="form-label">Имя *</label>
                            <input type="text" class="form-control" id="firstName" required>
                        </div>
                        <div class="col-md-6 mb-3">
                            <label for="lastName" class="form-label">Фамилия</label>
                            <input type="text" class="form-control" id="lastName">
                        </div>
                    </div>
                    <div class="mb-3">
                        <label for="email" class="form-label">Email</label>
                        <input type="email" class="form-control" id="email">
                    </div>
                    <div class="mb-3">
                        <label for="role" class="form-label">Роль</label>
                        <select class="form-select" id="role">
                            <option value="executor">Исполнитель</option>
                            <option value="owner">Владелец</option>
                        </select>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Отмена</button>
                <button type="button" class="btn btn-primary" onclick="saveUser()">
                    <i class="fas fa-save me-2"></i>Сохранить
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Модальное окно смены пароля -->
<div class="modal fade" id="changePasswordModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Смена пароля</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <form id="changePasswordForm">
                    <input type="hidden" id="changePasswordUserId">
                    <input type="hidden" id="changePasswordUserRole">
                    <div class="mb-3">
                        <label for="newPassword" class="form-label">Новый пароль *</label>
                        <div class="input-group">
                            <input type="password" class="form-control" id="newPassword" required>
                            <button class="btn btn-outline-secondary" type="button" onclick="togglePasswordVisibility('newPassword')">
                                <i class="fas fa-eye" id="newPasswordToggle"></i>
                            </button>
                        </div>
                    </div>
                    <div class="mb-3">
                        <label for="confirmPassword" class="form-label">Подтвердите пароль *</label>
                        <div class="input-group">
                            <input type="password" class="form-control" id="confirmPassword" required>
                            <button class="btn btn-outline-secondary" type="button" onclick="togglePasswordVisibility('confirmPassword')">
                                <i class="fas fa-eye" id="confirmPasswordToggle"></i>
                            </button>
                        </div>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Отмена</button>
                <button type="button" class="btn btn-primary" onclick="saveNewPassword()">
                    <i class="fas fa-key me-2"></i>Изменить пароль
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Модальное окно просмотра пароля -->
<div class="modal fade" id="viewPasswordModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Пароль пользователя</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <div class="alert alert-info">
                    <i class="fas fa-info-circle me-2"></i>
                    Пароль пользователя <strong id="passwordUsername"></strong>
                </div>
                <div class="input-group mb-3">
                    <input type="password" class="form-control" id="viewPasswordField" readonly>
                    <button class="btn btn-outline-secondary" type="button" onclick="togglePasswordVisibility('viewPasswordField')">
                        <i class="fas fa-eye" id="viewPasswordFieldToggle"></i>
                    </button>
                    <button class="btn btn-outline-primary" type="button" onclick="copyPassword()">
                        <i class="fas fa-copy"></i>
                    </button>
                </div>
                <small class="text-muted">
                    <i class="fas fa-shield-alt me-1"></i>
                    Пароль хранится в зашифрованном виде. Здесь показан временный пароль.
                </small>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Закрыть</button>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
    function filterUsers() {
        const searchValue = document.getElementById('userSearch').value.toLowerCase();
        const userCards = document.querySelectorAll('.user-card');
        
        userCards.forEach(card => {
            const username = card.dataset.username.toLowerCase();
            const name = card.dataset.name.toLowerCase();
            
            if (username.includes(searchValue) || name.includes(searchValue)) {
                card.style.display = 'block';
            } else {
                card.style.display = 'none';
            }
        });
    }
    
    function openAddUserModal() {
        const modal = new bootstrap.Modal(document.getElementById('addUserModal'));
        modal.show();
    }
    
    async function saveUser() {
        const userData = {
            username: document.getElementById('username').value,
            password: document.getElementById('password').value,
            first_name: document.getElementById('firstName').value,
            last_name: document.getElementById('lastName').value,
            email: document.getElementById('email').value,
            role: document.getElementById('role').value
        };
        
        try {
            const response = await fetch('/admin/api/users/create', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify(userData),
                credentials: 'include'
            });
            
            if (response.ok) {
                showNotification('Пользователь успешно создан', 'success');
                setTimeout(() => location.reload(), 1000);
            } else {
                const error = await response.json();
                showNotification(error.detail || 'Ошибка создания пользователя', 'danger');
            }
        } catch (error) {
            console.error('Ошибка:', error);
            showNotification('Ошибка создания пользователя', 'danger');
        }
    }
    
    function changePassword(userId, userRole) {
        // Проверяем права доступа
        const currentUserRole = '{{ user_role }}';
        const currentUserId = {{ current_user.id | default(0) }};
        
        // Исполнители могут менять только свой пароль
        if (currentUserRole === 'executor' && userId !== currentUserId) {
            showNotification('Вы можете изменить только свой пароль', 'warning');
            return;
        }
        
        document.getElementById('changePasswordUserId').value = userId;
        document.getElementById('changePasswordUserRole').value = userRole;
        const modal = new bootstrap.Modal(document.getElementById('changePasswordModal'));
        modal.show();
    }
    
    function togglePasswordVisibility(fieldId) {
        const field = document.getElementById(fieldId);
        const toggle = document.getElementById(fieldId + 'Toggle');
        
        if (field.type === 'password') {
            field.type = 'text';
            toggle.classList.remove('fa-eye');
            toggle.classList.add('fa-eye-slash');
        } else {
            field.type = 'password';
            toggle.classList.remove('fa-eye-slash');
            toggle.classList.add('fa-eye');
        }
    }
    
    async function viewPassword(userId, username) {
        // Только админ может просматривать пароли
        if ('{{ user_role }}' !== 'owner') {
            showNotification('У вас нет прав для просмотра паролей', 'warning');
            return;
        }
        
        try {
            const response = await fetch(`/admin/api/users/${userId}/password/view`, {
                method: 'GET',
                credentials: 'include'
            });
            
            if (response.ok) {
                const data = await response.json();
                document.getElementById('passwordUsername').textContent = username;
                document.getElementById('viewPasswordField').value = data.password || 'Установлен при регистрации';
                const modal = new bootstrap.Modal(document.getElementById('viewPasswordModal'));
                modal.show();
            } else {
                showNotification('Не удалось получить пароль', 'danger');
            }
        } catch (error) {
            console.error('Ошибка:', error);
            showNotification('Ошибка при получении пароля', 'danger');
        }
    }
    
    function copyPassword() {
        const passwordField = document.getElementById('viewPasswordField');
        passwordField.select();
        document.execCommand('copy');
        showNotification('Пароль скопирован в буфер обмена', 'success');
    }
    
    async function saveNewPassword() {
        const userId = document.getElementById('changePasswordUserId').value;
        const newPassword = document.getElementById('newPassword').value;
        const confirmPassword = document.getElementById('confirmPassword').value;
        
        // Проверяем права доступа еще раз
        const currentUserRole = '{{ user_role }}';
        const currentUserId = {{ current_user.id | default(0) }};
        
        if (currentUserRole === 'executor' && parseInt(userId) !== currentUserId) {
            showNotification('Вы можете изменить только свой пароль', 'warning');
            return;
        }
        
        if (newPassword !== confirmPassword) {
            showNotification('Пароли не совпадают', 'warning');
            return;
        }
        
        if (newPassword.length < 6) {
            showNotification('Пароль должен содержать минимум 6 символов', 'warning');
            return;
        }
        
        try {
            const response = await fetch(`/admin/api/users/${userId}/password`, {
                method: 'PUT',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({ password: newPassword }),
                credentials: 'include'
            });
            
            if (response.ok) {
                showNotification('Пароль успешно изменен', 'success');
                bootstrap.Modal.getInstance(document.getElementById('changePasswordModal')).hide();
                document.getElementById('changePasswordForm').reset();
            } else {
                const error = await response.json();
                showNotification(error.detail || 'Ошибка изменения пароля', 'danger');
            }
        } catch (error) {
            console.error('Ошибка:', error);
            showNotification('Ошибка изменения пароля', 'danger');
        }
    }
    
    async function toggleUserStatus(userId, currentStatus) {
        const newStatus = !currentStatus;
        
        try {
            const response = await fetch(`/admin/api/users/${userId}/status`, {
                method: 'PUT',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({ is_active: newStatus }),
                credentials: 'include'
            });
            
            if (response.ok) {
                showNotification(newStatus ? 'Пользователь активирован' : 'Пользователь деактивирован', 'success');
                setTimeout(() => location.reload(), 1000);
            } else {
                const error = await response.json();
                showNotification(error.detail || 'Ошибка изменения статуса', 'danger');
            }
        } catch (error) {
            console.error('Ошибка:', error);
            showNotification('Ошибка изменения статуса', 'danger');
        }
    }
    
    async function deleteUser(userId) {
        if (!confirm('Вы уверены, что хотите удалить этого пользователя?')) {
            return;
        }
        
        try {
            const response = await fetch(`/admin/api/users/${userId}`, {
                method: 'DELETE',
                credentials: 'include'
            });
            
            if (response.ok) {
                showNotification('Пользователь удален', 'success');
                setTimeout(() => location.reload(), 1000);
            } else {
                const error = await response.json();
                showNotification(error.detail || 'Ошибка удаления пользователя', 'danger');
            }
        } catch (error) {
            console.error('Ошибка:', error);
            showNotification('Ошибка удаления пользователя', 'danger');
        }
    }
    
    function editUser(userId) {
        // TODO: Implement edit user functionality
        showNotification('Функция редактирования в разработке', 'info');
    }
</script>
{% endblock %}