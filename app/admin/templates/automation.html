{% extends "base.html" %}

{% block title %}Автоматизация - Админ панель{% endblock %}

{% block page_title %}
<h4>Автоматизация и уведомления</h4>
{% endblock %}

{% block extra_css %}
<style>
.automation-card {
    background: white;
    border-radius: 12px;
    padding: 1.5rem;
    box-shadow: 0 2px 12px rgba(0,0,0,0.08);
    margin-bottom: 1.5rem;
}

.scheduler-status {
    display: inline-flex;
    align-items: center;
    padding: 0.5rem 1rem;
    border-radius: 20px;
    font-weight: 500;
}

.scheduler-running {
    background: linear-gradient(135deg, #28a745, #1e7e34);
    color: white;
}

.scheduler-stopped {
    background: linear-gradient(135deg, #dc3545, #c82333);
    color: white;
}

.task-item {
    background: #f8f9fa;
    border-radius: 8px;
    padding: 1rem;
    margin-bottom: 0.5rem;
    border-left: 4px solid #007bff;
}

.stat-box {
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    color: white;
    border-radius: 10px;
    padding: 1.5rem;
    text-align: center;
}

.stat-value {
    font-size: 2rem;
    font-weight: bold;
}

.stat-label {
    font-size: 0.9rem;
    opacity: 0.9;
}

.action-button {
    margin: 0.25rem;
}

.log-container {
    background: #f8f9fa;
    border-radius: 8px;
    padding: 1rem;
    max-height: 400px;
    overflow-y: auto;
}

.log-entry {
    padding: 0.5rem;
    border-bottom: 1px solid #dee2e6;
    font-family: monospace;
    font-size: 0.9rem;
}

.log-entry.error {
    color: #dc3545;
}

.log-entry.warning {
    color: #fd7e14;
}

.log-entry.success {
    color: #28a745;
}
</style>
{% endblock %}

{% block content %}
<!-- Статус планировщика -->
<div class="automation-card">
    <div class="d-flex justify-content-between align-items-center mb-3">
        <h5><i class="fas fa-clock me-2"></i>Планировщик задач</h5>
        <div id="schedulerStatus">
            <span class="scheduler-status {{ 'scheduler-running' if scheduler_running else 'scheduler-stopped' }}">
                <i class="fas fa-{{ 'play' if scheduler_running else 'stop' }}-circle me-2"></i>
                {{ 'Работает' if scheduler_running else 'Остановлен' }}
            </span>
        </div>
    </div>
    
    <div class="row">
        <div class="col-md-6">
            <h6>Расписание задач:</h6>
            <div class="task-item">
                <div class="d-flex justify-content-between">
                    <span><i class="fas fa-sun me-2"></i>Ежедневные проверки</span>
                    <span class="text-muted">09:00</span>
                </div>
            </div>
            <div class="task-item">
                <div class="d-flex justify-content-between">
                    <span><i class="fas fa-clock me-2"></i>Проверка просроченных</span>
                    <span class="text-muted">Каждые 4 часа</span>
                </div>
            </div>
            <div class="task-item">
                <div class="d-flex justify-content-between">
                    <span><i class="fas fa-dollar-sign me-2"></i>Финансовый статус</span>
                    <span class="text-muted">18:00</span>
                </div>
            </div>
            <div class="task-item">
                <div class="d-flex justify-content-between">
                    <span><i class="fas fa-chart-bar me-2"></i>Еженедельный отчет</span>
                    <span class="text-muted">Пн 10:00</span>
                </div>
            </div>
        </div>
        
        <div class="col-md-6">
            <h6>Управление:</h6>
            <div class="d-grid gap-2">
                <button class="btn btn-success" onclick="toggleScheduler()" id="schedulerToggle">
                    <i class="fas fa-{{ 'stop' if scheduler_running else 'play' }} me-2"></i>
                    {{ 'Остановить' if scheduler_running else 'Запустить' }} планировщик
                </button>
                <button class="btn btn-primary" onclick="runTask('daily_checks')">
                    <i class="fas fa-play-circle me-2"></i>Запустить ежедневные проверки
                </button>
                <button class="btn btn-info" onclick="runTask('financial_status')">
                    <i class="fas fa-money-check-alt me-2"></i>Проверить финансы
                </button>
                <button class="btn btn-warning" onclick="runTask('weekly_report')">
                    <i class="fas fa-file-alt me-2"></i>Сгенерировать отчет
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Статистика автоматизации -->
<div class="automation-card">
    <h5 class="mb-3"><i class="fas fa-chart-line me-2"></i>Статистика автоматизации</h5>
    <div class="row" id="automationStats">
        <div class="col-md-3">
            <div class="stat-box">
                <div class="stat-value" id="totalProjects">0</div>
                <div class="stat-label">Всего проектов</div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="stat-box" style="background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);">
                <div class="stat-value" id="overdueCount">0</div>
                <div class="stat-label">Просроченных</div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="stat-box" style="background: linear-gradient(135deg, #fa709a 0%, #fee140 100%);">
                <div class="stat-value" id="unpaidCount">0</div>
                <div class="stat-label">Неоплаченных</div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="stat-box" style="background: linear-gradient(135deg, #30cfd0 0%, #330867 100%);">
                <div class="stat-value" id="executorDebt">0</div>
                <div class="stat-label">Долги исполнителям</div>
            </div>
        </div>
    </div>
    
    <div class="row mt-3">
        <div class="col-md-6">
            <div class="alert alert-info">
                <i class="fas fa-info-circle me-2"></i>
                <strong>Ожидается от клиентов:</strong> 
                <span id="totalUnpaidClients">0 ₽</span>
            </div>
        </div>
        <div class="col-md-6">
            <div class="alert alert-warning">
                <i class="fas fa-exclamation-triangle me-2"></i>
                <strong>К выплате исполнителям:</strong> 
                <span id="totalUnpaidExecutors">0 ₽</span>
            </div>
        </div>
    </div>
</div>

<!-- Ручные проверки -->
<div class="automation-card">
    <h5 class="mb-3"><i class="fas fa-hand-pointer me-2"></i>Ручные проверки</h5>
    <div class="row">
        <div class="col-md-4">
            <button class="btn btn-outline-danger w-100" onclick="checkOverdue()">
                <i class="fas fa-exclamation-triangle me-2"></i>
                Проверить просроченные
            </button>
        </div>
        <div class="col-md-4">
            <button class="btn btn-outline-warning w-100" onclick="checkUnpaid()">
                <i class="fas fa-dollar-sign me-2"></i>
                Проверить неоплаченные
            </button>
        </div>
        <div class="col-md-4">
            <button class="btn btn-outline-info w-100" onclick="sendTestNotification()">
                <i class="fas fa-paper-plane me-2"></i>
                Тестовое уведомление
            </button>
        </div>
    </div>
</div>

<!-- Лог событий -->
<div class="automation-card">
    <h5 class="mb-3"><i class="fas fa-list-alt me-2"></i>Последние события</h5>
    <div class="log-container" id="eventLog">
        <div class="text-muted text-center">Нет событий</div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
const username = 'admin';
const password = 'qwerty123';
let schedulerRunning = {{ 'true' if scheduler_running else 'false' }};

// Функция добавления события в лог
function addLogEntry(message, type = 'info') {
    const logContainer = document.getElementById('eventLog');
    if (logContainer.querySelector('.text-muted')) {
        logContainer.innerHTML = '';
    }
    
    const entry = document.createElement('div');
    entry.className = `log-entry ${type}`;
    entry.innerHTML = `[${new Date().toLocaleTimeString()}] ${message}`;
    
    logContainer.insertBefore(entry, logContainer.firstChild);
    
    // Ограничиваем количество записей
    while (logContainer.children.length > 50) {
        logContainer.removeChild(logContainer.lastChild);
    }
}

// Функция загрузки статистики
async function loadStats() {
    try {
        const response = await fetch('/admin/api/automation/summary', {
            headers: {
                'Authorization': 'Basic ' + btoa(`${username}:${password}`)
            }
        });
        
        const data = await response.json();
        if (data.success) {
            document.getElementById('totalProjects').textContent = data.summary.total_projects || 0;
            document.getElementById('overdueCount').textContent = data.summary.overdue_count || 0;
            document.getElementById('unpaidCount').textContent = data.summary.unpaid_projects_count || 0;
            document.getElementById('executorDebt').textContent = data.summary.unpaid_executors_count || 0;
            
            document.getElementById('totalUnpaidClients').textContent = 
                formatCurrency(data.summary.total_unpaid_clients || 0);
            document.getElementById('totalUnpaidExecutors').textContent = 
                formatCurrency(data.summary.total_unpaid_executors || 0);
            
            schedulerRunning = data.scheduler_running;
            updateSchedulerUI();
            
            addLogEntry('Статистика обновлена', 'success');
        }
    } catch (error) {
        addLogEntry('Ошибка загрузки статистики: ' + error.message, 'error');
    }
}

// Функция переключения планировщика
async function toggleScheduler() {
    const action = schedulerRunning ? 'stop' : 'start';
    
    try {
        const response = await fetch(`/admin/api/automation/scheduler/${action}`, {
            method: 'POST',
            headers: {
                'Authorization': 'Basic ' + btoa(`${username}:${password}`)
            }
        });
        
        const data = await response.json();
        if (data.success) {
            schedulerRunning = !schedulerRunning;
            updateSchedulerUI();
            addLogEntry(data.message, 'success');
        }
    } catch (error) {
        addLogEntry('Ошибка управления планировщиком: ' + error.message, 'error');
    }
}

// Обновление UI планировщика
function updateSchedulerUI() {
    const statusEl = document.getElementById('schedulerStatus');
    const toggleBtn = document.getElementById('schedulerToggle');
    
    if (schedulerRunning) {
        statusEl.innerHTML = `
            <span class="scheduler-status scheduler-running">
                <i class="fas fa-play-circle me-2"></i>Работает
            </span>
        `;
        toggleBtn.innerHTML = '<i class="fas fa-stop me-2"></i>Остановить планировщик';
        toggleBtn.className = 'btn btn-danger';
    } else {
        statusEl.innerHTML = `
            <span class="scheduler-status scheduler-stopped">
                <i class="fas fa-stop-circle me-2"></i>Остановлен
            </span>
        `;
        toggleBtn.innerHTML = '<i class="fas fa-play me-2"></i>Запустить планировщик';
        toggleBtn.className = 'btn btn-success';
    }
}

// Запуск задачи
async function runTask(taskName) {
    try {
        const response = await fetch('/admin/api/automation/scheduler/run-task', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'Authorization': 'Basic ' + btoa(`${username}:${password}`)
            },
            body: JSON.stringify({ task_name: taskName })
        });
        
        const data = await response.json();
        if (data.success) {
            addLogEntry(data.message, 'success');
            setTimeout(loadStats, 2000); // Обновляем статистику через 2 секунды
        } else {
            addLogEntry(data.message, 'warning');
        }
    } catch (error) {
        addLogEntry('Ошибка запуска задачи: ' + error.message, 'error');
    }
}

// Проверка просроченных проектов
async function checkOverdue() {
    try {
        const response = await fetch('/admin/api/automation/check-overdue', {
            method: 'POST',
            headers: {
                'Authorization': 'Basic ' + btoa(`${username}:${password}`)
            }
        });
        
        const data = await response.json();
        if (data.success) {
            addLogEntry(data.message, 'success');
            
            if (data.projects.length > 0) {
                data.projects.forEach(project => {
                    addLogEntry(`Проект #${project.id} "${project.title}" помечен как просроченный`, 'warning');
                });
            }
            
            loadStats();
        }
    } catch (error) {
        addLogEntry('Ошибка проверки просроченных: ' + error.message, 'error');
    }
}

// Проверка неоплаченных
async function checkUnpaid() {
    try {
        const response = await fetch('/admin/api/automation/check-unpaid', {
            method: 'POST',
            headers: {
                'Authorization': 'Basic ' + btoa(`${username}:${password}`)
            }
        });
        
        const data = await response.json();
        if (data.success) {
            let message = '';
            
            if (data.unpaid_projects.length > 0) {
                message += `Неоплаченных проектов: ${data.unpaid_projects.length}. `;
                data.unpaid_projects.forEach(project => {
                    addLogEntry(
                        `Проект #${project.id} "${project.title}" - остаток ${formatCurrency(project.remaining)}`,
                        'warning'
                    );
                });
            }
            
            if (data.unpaid_executors.length > 0) {
                message += `Долгов исполнителям: ${data.unpaid_executors.length}.`;
                data.unpaid_executors.forEach(item => {
                    addLogEntry(
                        `Исполнитель "${item.executor_name}" - остаток ${formatCurrency(item.remaining)}`,
                        'warning'
                    );
                });
            }
            
            if (message) {
                addLogEntry(message, 'info');
            } else {
                addLogEntry('Неоплаченных проектов и долгов не найдено', 'success');
            }
            
            loadStats();
        }
    } catch (error) {
        addLogEntry('Ошибка проверки неоплаченных: ' + error.message, 'error');
    }
}

// Отправка тестового уведомления
async function sendTestNotification() {
    const message = prompt('Введите текст уведомления:');
    if (!message) return;
    
    try {
        const response = await fetch('/admin/api/automation/send-notification', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'Authorization': 'Basic ' + btoa(`${username}:${password}`)
            },
            body: JSON.stringify({ message: message })
        });
        
        const data = await response.json();
        if (data.success) {
            addLogEntry('Уведомление отправлено успешно', 'success');
        } else {
            addLogEntry('Не удалось отправить уведомление', 'error');
        }
    } catch (error) {
        addLogEntry('Ошибка отправки уведомления: ' + error.message, 'error');
    }
}

// Форматирование валюты
function formatCurrency(amount) {
    return new Intl.NumberFormat('ru-RU', {
        style: 'currency',
        currency: 'RUB',
        minimumFractionDigits: 0,
        maximumFractionDigits: 0
    }).format(amount);
}

// Загрузка при старте
document.addEventListener('DOMContentLoaded', () => {
    loadStats();
    
    // Автообновление каждые 30 секунд
    setInterval(loadStats, 30000);
});
</script>
{% endblock %}