{% extends "base.html" %}

{% block title %}Планировщик задач{% endblock %}

{% block page_title %}
Планировщик задач
{% endblock %}

{% block extra_css %}
<style>
    .executors-container {
        display: flex;
        gap: 1.5rem;
        overflow-x: auto;
        padding: 1rem 0;
        min-height: 600px;
    }
    
    .executor-column {
        flex: 0 0 400px;
        background: white;
        border-radius: 16px;
        box-shadow: 0 4px 6px rgba(0, 0, 0, 0.07);
        display: flex;
        flex-direction: column;
    }
    
    .executor-header {
        padding: 1.25rem;
        border-bottom: 2px solid #e2e8f0;
        background: linear-gradient(135deg, #f8fafc, #f1f5f9);
        border-radius: 16px 16px 0 0;
        display: flex;
        justify-content: space-between;
        align-items: center;
    }
    
    .executor-info {
        display: flex;
        align-items: center;
        gap: 0.75rem;
    }
    
    .executor-avatar {
        width: 40px;
        height: 40px;
        border-radius: 50%;
        background: linear-gradient(135deg, #6366f1, #8b5cf6);
        display: flex;
        align-items: center;
        justify-content: center;
        color: white;
        font-weight: 600;
        font-size: 1.1rem;
    }
    
    .executor-name {
        font-weight: 600;
        font-size: 1.1rem;
        color: #1e293b;
    }
    
    .executor-stats {
        display: flex;
        gap: 0.5rem;
    }
    
    .stat-badge {
        padding: 0.25rem 0.5rem;
        border-radius: 6px;
        font-size: 0.875rem;
        font-weight: 500;
    }
    
    .stat-badge.total {
        background: #e0e7ff;
        color: #4338ca;
    }
    
    .stat-badge.active {
        background: #fef3c7;
        color: #d97706;
    }
    
    .executor-actions {
        display: flex;
        gap: 0.5rem;
    }
    
    .executor-action-btn {
        padding: 0.5rem;
        border: none;
        background: transparent;
        color: #64748b;
        cursor: pointer;
        border-radius: 6px;
        transition: all 0.2s;
    }
    
    .executor-action-btn:hover {
        background: #f1f5f9;
        color: #334155;
    }
    
    .executor-action-btn.delete:hover {
        background: #fee2e2;
        color: #dc2626;
    }
    
    .kanban-sections {
        padding: 1rem;
        flex: 1;
        overflow-y: auto;
        max-height: calc(100vh - 350px);
    }
    
    .kanban-section {
        margin-bottom: 1.5rem;
    }
    
    .section-header {
        display: flex;
        align-items: center;
        gap: 0.5rem;
        margin-bottom: 0.75rem;
        padding: 0.5rem;
        background: #f8fafc;
        border-radius: 8px;
    }
    
    .section-title {
        font-weight: 600;
        font-size: 0.95rem;
        color: #475569;
        flex: 1;
    }
    
    .section-count {
        background: #6366f1;
        color: white;
        padding: 0.125rem 0.375rem;
        border-radius: 4px;
        font-size: 0.75rem;
    }
    
    .tasks-list {
        min-height: 100px;
        border: 2px dashed transparent;
        border-radius: 8px;
        padding: 0.5rem;
        transition: all 0.3s;
    }
    
    .tasks-list.drag-over {
        background: rgba(99, 102, 241, 0.05);
        border-color: #6366f1;
    }
    
    .task-card {
        background: white;
        border: 1px solid #e2e8f0;
        border-radius: 10px;
        padding: 0.75rem;
        margin-bottom: 0.5rem;
        cursor: grab;
        transition: all 0.3s ease;
        position: relative;
    }
    
    .task-card.dragging {
        opacity: 0.5;
        cursor: grabbing;
        transform: rotate(2deg);
    }
    
    .task-card:hover {
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.08);
        transform: translateY(-1px);
    }
    
    .task-card.priority-urgent {
        border-left: 3px solid #dc2626;
    }
    
    .task-card.priority-high {
        border-left: 3px solid #f59e0b;
    }
    
    .task-card.priority-normal {
        border-left: 3px solid #3b82f6;
    }
    
    .task-card.priority-low {
        border-left: 3px solid #6b7280;
    }
    
    .task-title {
        font-weight: 600;
        color: #1e293b;
        font-size: 0.9rem;
        margin-bottom: 0.25rem;
    }
    
    .task-meta {
        display: flex;
        gap: 0.5rem;
        align-items: center;
        margin-top: 0.5rem;
    }
    
    .task-badge {
        padding: 0.125rem 0.375rem;
        border-radius: 4px;
        font-size: 0.7rem;
        font-weight: 500;
    }
    
    .badge-priority-urgent {
        background: #fee2e2;
        color: #dc2626;
    }
    
    .badge-priority-high {
        background: #fef3c7;
        color: #d97706;
    }
    
    .badge-priority-normal {
        background: #dbeafe;
        color: #2563eb;
    }
    
    .badge-priority-low {
        background: #f3f4f6;
        color: #6b7280;
    }
    
    .badge-deadline {
        background: #fce7f3;
        color: #be185d;
    }
    
    .empty-section {
        padding: 2rem;
        text-align: center;
        color: #94a3b8;
        font-size: 0.875rem;
    }
    
    .add-executor-column {
        flex: 0 0 300px;
        border: 2px dashed #cbd5e1;
        border-radius: 16px;
        display: flex;
        align-items: center;
        justify-content: center;
        cursor: pointer;
        transition: all 0.3s;
        min-height: 400px;
    }
    
    .add-executor-column:hover {
        border-color: #6366f1;
        background: #f8fafc;
    }
    
    .add-executor-content {
        text-align: center;
        color: #64748b;
    }
    
    .add-executor-icon {
        font-size: 2rem;
        margin-bottom: 0.5rem;
        color: #94a3b8;
    }
    
    /* Модальное окно управления исполнителями */
    .executors-manager {
        max-height: 60vh;
        overflow-y: auto;
    }
    
    .executor-item {
        display: flex;
        align-items: center;
        justify-content: space-between;
        padding: 1rem;
        border: 1px solid #e2e8f0;
        border-radius: 8px;
        margin-bottom: 0.75rem;
        background: white;
    }
    
    .executor-item:hover {
        background: #f8fafc;
    }
    
    .executor-details {
        display: flex;
        align-items: center;
        gap: 1rem;
    }
    
    .executor-item-avatar {
        width: 48px;
        height: 48px;
        border-radius: 50%;
        background: linear-gradient(135deg, #6366f1, #8b5cf6);
        display: flex;
        align-items: center;
        justify-content: center;
        color: white;
        font-weight: 600;
        font-size: 1.2rem;
    }
    
    .executor-item-info h5 {
        margin: 0;
        font-weight: 600;
        color: #1e293b;
    }
    
    .executor-item-info p {
        margin: 0;
        color: #64748b;
        font-size: 0.875rem;
    }
    
    .executor-item-actions {
        display: flex;
        gap: 0.5rem;
    }
</style>
{% endblock %}

{% block header_actions %}
<button class="btn btn-primary" onclick="showExecutorsManager()">
    <i class="fas fa-users me-2"></i>Управление исполнителями
</button>
<button class="btn btn-success" onclick="openCreateTaskModal()">
    <i class="fas fa-plus me-2"></i>Создать задачу
</button>
<button class="btn btn-outline-primary" onclick="location.reload()">
    <i class="fas fa-sync-alt me-1"></i>Обновить
</button>
{% endblock %}

{% block content %}
<!-- Контейнер с колонками исполнителей -->
<div class="executors-container" id="executorsContainer">
    <!-- Колонки исполнителей будут добавлены динамически -->
    
    <!-- Кнопка добавления исполнителя -->
    <div class="add-executor-column" onclick="showAddExecutorModal()">
        <div class="add-executor-content">
            <i class="fas fa-user-plus add-executor-icon"></i>
            <p>Добавить исполнителя</p>
        </div>
    </div>
</div>

<!-- Модальное окно управления исполнителями -->
<div class="modal fade" id="executorsManagerModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Управление исполнителями</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <div class="executors-manager" id="executorsManagerList">
                    <!-- Список исполнителей будет загружен динамически -->
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Закрыть</button>
            </div>
        </div>
    </div>
</div>

<!-- Модальное окно создания задачи -->
<div class="modal fade" id="createTaskModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Создать новую задачу</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <form id="createTaskForm">
                    <div class="mb-3">
                        <label for="taskTitle" class="form-label">Название задачи *</label>
                        <input type="text" class="form-control" id="taskTitle" required>
                    </div>
                    
                    <div class="mb-3">
                        <label for="taskDescription" class="form-label">Описание</label>
                        <textarea class="form-control" id="taskDescription" rows="3"></textarea>
                    </div>
                    
                    <div class="row">
                        <div class="col-md-6 mb-3">
                            <label for="taskPriority" class="form-label">Приоритет</label>
                            <select class="form-select" id="taskPriority">
                                <option value="low">Низкий</option>
                                <option value="normal" selected>Обычный</option>
                                <option value="high">Высокий</option>
                                <option value="urgent">Срочный</option>
                            </select>
                        </div>
                        
                        <div class="col-md-6 mb-3">
                            <label for="taskDeadline" class="form-label">Дедлайн</label>
                            <input type="datetime-local" class="form-control" id="taskDeadline">
                        </div>
                    </div>
                    
                    <div class="mb-3">
                        <label for="taskAssignee" class="form-label">Назначить исполнителю</label>
                        <select class="form-select" id="taskAssignee">
                            <option value="">Выберите исполнителя</option>
                            <!-- Заполняется динамически -->
                        </select>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Отмена</button>
                <button type="button" class="btn btn-primary" onclick="createTask()">
                    <i class="fas fa-plus me-2"></i>Создать
                </button>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
    let executors = [];
    let tasks = [];
    let draggedTask = null;
    let draggedFromExecutor = null;
    
    // Инициализация при загрузке страницы
    document.addEventListener('DOMContentLoaded', function() {
        loadExecutorsAndTasks();
        
        // Автообновление каждые 30 секунд
        setInterval(loadExecutorsAndTasks, 30000);
    });
    
    // Загрузка исполнителей и задач
    async function loadExecutorsAndTasks() {
        try {
            // Загружаем список исполнителей
            const executorsResponse = await fetch('/admin/tasks/api/users/executors', {
                credentials: 'include'
            });
            
            if (executorsResponse.ok) {
                executors = await executorsResponse.json();
                
                // Загружаем задачи для каждого исполнителя
                await loadAllTasks();
                
                // Отрисовываем интерфейс
                renderExecutorColumns();
            }
        } catch (error) {
            console.error('Ошибка загрузки данных:', error);
            showNotification('Ошибка загрузки данных', 'danger');
        }
    }
    
    // Загрузка всех задач
    async function loadAllTasks() {
        try {
            const response = await fetch('/admin/tasks/api/tasks', {
                credentials: 'include'
            });
            
            if (response.ok) {
                const data = await response.json();
                tasks = data.tasks || [];
            }
        } catch (error) {
            console.error('Ошибка загрузки задач:', error);
        }
    }
    
    // Отрисовка колонок исполнителей
    function renderExecutorColumns() {
        const container = document.getElementById('executorsContainer');
        
        // Сохраняем кнопку добавления
        const addButton = container.querySelector('.add-executor-column');
        
        // Очищаем контейнер
        container.innerHTML = '';
        
        // Создаем колонку для каждого исполнителя
        executors.forEach(executor => {
            const column = createExecutorColumn(executor);
            container.appendChild(column);
        });
        
        // Возвращаем кнопку добавления
        if (addButton) {
            container.appendChild(addButton);
        }
    }
    
    // Создание колонки исполнителя
    function createExecutorColumn(executor) {
        const column = document.createElement('div');
        column.className = 'executor-column';
        column.dataset.executorId = executor.id;
        
        // Фильтруем задачи для этого исполнителя
        const executorTasks = tasks.filter(t => t.assigned_to_id === executor.id);
        const pendingTasks = executorTasks.filter(t => t.status === 'pending');
        const inProgressTasks = executorTasks.filter(t => t.status === 'in_progress');
        const completedTasks = executorTasks.filter(t => t.status === 'completed');
        
        // Получаем инициалы
        const initials = executor.name.split(' ').map(n => n[0]).join('').toUpperCase();
        
        column.innerHTML = `
            <div class="executor-header">
                <div class="executor-info">
                    <div class="executor-avatar">${initials}</div>
                    <div>
                        <div class="executor-name">${executor.name}</div>
                        <div class="executor-stats">
                            <span class="stat-badge total">${executorTasks.length} задач</span>
                            <span class="stat-badge active">${pendingTasks.length + inProgressTasks.length} активных</span>
                        </div>
                    </div>
                </div>
                <div class="executor-actions">
                    <button class="executor-action-btn delete" onclick="confirmDeleteExecutor(${executor.id}, '${executor.name}')" title="Удалить исполнителя">
                        <i class="fas fa-trash"></i>
                    </button>
                </div>
            </div>
            
            <div class="kanban-sections">
                <!-- Секция "Ожидают" -->
                <div class="kanban-section">
                    <div class="section-header">
                        <span class="section-title">
                            <i class="fas fa-clock"></i> Ожидают
                        </span>
                        <span class="section-count">${pendingTasks.length}</span>
                    </div>
                    <div class="tasks-list" data-status="pending" data-executor="${executor.id}">
                        ${pendingTasks.map(task => createTaskCard(task)).join('')}
                    </div>
                </div>
                
                <!-- Секция "В работе" -->
                <div class="kanban-section">
                    <div class="section-header">
                        <span class="section-title">
                            <i class="fas fa-spinner"></i> В работе
                        </span>
                        <span class="section-count">${inProgressTasks.length}</span>
                    </div>
                    <div class="tasks-list" data-status="in_progress" data-executor="${executor.id}">
                        ${inProgressTasks.map(task => createTaskCard(task)).join('')}
                    </div>
                </div>
                
                <!-- Секция "Выполнено" -->
                <div class="kanban-section">
                    <div class="section-header">
                        <span class="section-title">
                            <i class="fas fa-check-circle"></i> Выполнено
                        </span>
                        <span class="section-count">${completedTasks.length}</span>
                    </div>
                    <div class="tasks-list" data-status="completed" data-executor="${executor.id}">
                        ${completedTasks.map(task => createTaskCard(task)).join('')}
                    </div>
                </div>
            </div>
        `;
        
        // Настраиваем drag and drop для списков задач
        column.querySelectorAll('.tasks-list').forEach(list => {
            list.addEventListener('dragover', handleDragOver);
            list.addEventListener('drop', handleDrop);
            list.addEventListener('dragleave', handleDragLeave);
        });
        
        // Настраиваем drag для карточек задач
        column.querySelectorAll('.task-card').forEach(card => {
            card.addEventListener('dragstart', handleDragStart);
            card.addEventListener('dragend', handleDragEnd);
        });
        
        return column;
    }
    
    // Создание карточки задачи
    function createTaskCard(task) {
        const priorityLabel = getPriorityLabel(task.priority);
        const deadlineStr = task.deadline ? formatDeadline(task.deadline) : '';
        
        return `
            <div class="task-card priority-${task.priority}" draggable="true" data-task-id="${task.id}">
                <div class="task-title">${task.title}</div>
                <div class="task-meta">
                    <span class="task-badge badge-priority-${task.priority}">${priorityLabel}</span>
                    ${deadlineStr ? `<span class="task-badge badge-deadline"><i class="fas fa-clock"></i> ${deadlineStr}</span>` : ''}
                </div>
            </div>
        `;
    }
    
    // Обработчики drag and drop
    function handleDragStart(e) {
        draggedTask = this;
        draggedFromExecutor = this.closest('.executor-column').dataset.executorId;
        this.classList.add('dragging');
        e.dataTransfer.effectAllowed = 'move';
    }
    
    function handleDragEnd(e) {
        this.classList.remove('dragging');
        document.querySelectorAll('.tasks-list').forEach(list => {
            list.classList.remove('drag-over');
        });
    }
    
    function handleDragOver(e) {
        if (e.preventDefault) {
            e.preventDefault();
        }
        e.dataTransfer.dropEffect = 'move';
        this.classList.add('drag-over');
        return false;
    }
    
    function handleDragLeave(e) {
        this.classList.remove('drag-over');
    }
    
    async function handleDrop(e) {
        if (e.stopPropagation) {
            e.stopPropagation();
        }
        
        this.classList.remove('drag-over');
        
        if (draggedTask && draggedTask !== this) {
            const newStatus = this.dataset.status;
            const newExecutorId = this.dataset.executor;
            const taskId = draggedTask.dataset.taskId;
            
            // Если меняется исполнитель
            if (newExecutorId !== draggedFromExecutor) {
                await reassignTask(taskId, newExecutorId);
            }
            
            // Если меняется статус
            const oldStatus = draggedTask.closest('.tasks-list').dataset.status;
            if (newStatus !== oldStatus) {
                await updateTaskStatus(taskId, newStatus);
            }
            
            // Перезагружаем данные
            await loadExecutorsAndTasks();
        }
        
        return false;
    }
    
    // Переназначение задачи
    async function reassignTask(taskId, newExecutorId) {
        try {
            const response = await fetch(`/admin/tasks/api/tasks/${taskId}/reassign`, {
                method: 'PUT',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({ assigned_to_id: parseInt(newExecutorId) }),
                credentials: 'include'
            });
            
            const data = await response.json();
            
            if (data.success) {
                showNotification(data.message, 'success');
            } else {
                showNotification(data.error || 'Ошибка переназначения задачи', 'danger');
            }
        } catch (error) {
            console.error('Ошибка:', error);
            showNotification('Ошибка переназначения задачи', 'danger');
        }
    }
    
    // Обновление статуса задачи
    async function updateTaskStatus(taskId, status) {
        try {
            const response = await fetch(`/admin/tasks/api/tasks/${taskId}/status`, {
                method: 'PUT',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({ status }),
                credentials: 'include'
            });
            
            if (response.ok) {
                showNotification('Статус задачи обновлен', 'success');
            }
        } catch (error) {
            console.error('Ошибка:', error);
        }
    }
    
    // Показать менеджер исполнителей
    async function showExecutorsManager() {
        const modal = new bootstrap.Modal(document.getElementById('executorsManagerModal'));
        
        // Загружаем список исполнителей
        const listContainer = document.getElementById('executorsManagerList');
        listContainer.innerHTML = '<div class="text-center"><i class="fas fa-spinner fa-spin"></i> Загрузка...</div>';
        
        try {
            const response = await fetch('/admin/tasks/api/employees', {
                credentials: 'include'
            });
            
            if (response.ok) {
                const data = await response.json();
                
                if (data.success && data.employees) {
                    listContainer.innerHTML = '';
                    
                    data.employees.forEach(emp => {
                        const initials = `${emp.first_name[0]}${emp.last_name ? emp.last_name[0] : ''}`.toUpperCase();
                        
                        const item = document.createElement('div');
                        item.className = 'executor-item';
                        item.innerHTML = `
                            <div class="executor-details">
                                <div class="executor-item-avatar">${initials}</div>
                                <div class="executor-item-info">
                                    <h5>${emp.first_name} ${emp.last_name || ''}</h5>
                                    <p>@${emp.username} • ${emp.tasks_count} задач (${emp.active_tasks} активных)</p>
                                </div>
                            </div>
                            <div class="executor-item-actions">
                                <button class="btn btn-sm btn-outline-danger" onclick="confirmDeleteExecutor(${emp.id}, '${emp.first_name} ${emp.last_name || ''}')">
                                    <i class="fas fa-trash"></i> Удалить
                                </button>
                            </div>
                        `;
                        listContainer.appendChild(item);
                    });
                    
                    if (data.employees.length === 0) {
                        listContainer.innerHTML = '<div class="text-center text-muted">Нет исполнителей</div>';
                    }
                } else {
                    listContainer.innerHTML = '<div class="text-center text-danger">Ошибка загрузки списка исполнителей</div>';
                }
            }
        } catch (error) {
            console.error('Ошибка:', error);
            listContainer.innerHTML = '<div class="text-center text-danger">Ошибка загрузки</div>';
        }
        
        modal.show();
    }
    
    // Подтверждение удаления исполнителя
    async function confirmDeleteExecutor(executorId, executorName) {
        if (!confirm(`Удалить исполнителя "${executorName}"?\n\nВыберите действие:\n- OK: Удалить исполнителя и все его задачи\n- Отмена: Отменить удаление`)) {
            return;
        }
        
        // Спрашиваем, нужно ли переназначить задачи
        const reassign = confirm('Переназначить задачи этого исполнителя другому?\n\nOK - выбрать нового исполнителя\nОтмена - удалить все задачи');
        
        let reassignToId = null;
        
        if (reassign) {
            // Показываем список исполнителей для выбора
            const availableExecutors = executors.filter(e => e.id !== executorId);
            
            if (availableExecutors.length === 0) {
                alert('Нет других исполнителей для переназначения задач');
                return;
            }
            
            const executorsList = availableExecutors.map((e, i) => `${i + 1}. ${e.name}`).join('\n');
            const choice = prompt(`Выберите исполнителя для переназначения задач (введите номер):\n\n${executorsList}`);
            
            if (choice) {
                const index = parseInt(choice) - 1;
                if (index >= 0 && index < availableExecutors.length) {
                    reassignToId = availableExecutors[index].id;
                }
            }
        }
        
        // Удаляем исполнителя
        await deleteExecutor(executorId, reassignToId);
    }
    
    // Удаление исполнителя
    async function deleteExecutor(executorId, reassignToId) {
        try {
            const url = reassignToId 
                ? `/admin/tasks/api/users/executor/${executorId}?reassign_to_id=${reassignToId}`
                : `/admin/tasks/api/users/executor/${executorId}`;
            
            const response = await fetch(url, {
                method: 'DELETE',
                credentials: 'include'
            });
            
            const data = await response.json();
            
            if (data.success) {
                showNotification(data.message, 'success');
                // Перезагружаем данные
                await loadExecutorsAndTasks();
                // Закрываем модальное окно если оно открыто
                const modal = bootstrap.Modal.getInstance(document.getElementById('executorsManagerModal'));
                if (modal) {
                    modal.hide();
                }
            } else {
                showNotification(data.error || 'Ошибка удаления исполнителя', 'danger');
            }
        } catch (error) {
            console.error('Ошибка:', error);
            showNotification('Ошибка удаления исполнителя', 'danger');
        }
    }
    
    // Открытие модального окна создания задачи
    function openCreateTaskModal() {
        const modal = new bootstrap.Modal(document.getElementById('createTaskModal'));
        
        // Заполняем список исполнителей
        const select = document.getElementById('taskAssignee');
        select.innerHTML = '<option value="">Выберите исполнителя</option>';
        
        executors.forEach(executor => {
            const option = document.createElement('option');
            option.value = executor.id;
            option.textContent = executor.name;
            select.appendChild(option);
        });
        
        modal.show();
    }
    
    // Создание задачи
    async function createTask() {
        const title = document.getElementById('taskTitle').value.trim();
        const description = document.getElementById('taskDescription').value.trim();
        const priority = document.getElementById('taskPriority').value;
        const deadline = document.getElementById('taskDeadline').value;
        const assigneeId = document.getElementById('taskAssignee').value;
        
        if (!title) {
            showNotification('Введите название задачи', 'warning');
            return;
        }
        
        try {
            const response = await fetch('/admin/tasks/api/tasks', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({
                    title,
                    description,
                    priority,
                    deadline,
                    assigned_to_id: assigneeId ? parseInt(assigneeId) : null
                }),
                credentials: 'include'
            });
            
            const data = await response.json();
            
            if (data.success) {
                showNotification('Задача создана', 'success');
                
                // Закрываем модальное окно
                const modal = bootstrap.Modal.getInstance(document.getElementById('createTaskModal'));
                modal.hide();
                
                // Очищаем форму
                document.getElementById('createTaskForm').reset();
                
                // Перезагружаем данные
                await loadExecutorsAndTasks();
            } else {
                showNotification(data.error || 'Ошибка создания задачи', 'danger');
            }
        } catch (error) {
            console.error('Ошибка:', error);
            showNotification('Ошибка создания задачи', 'danger');
        }
    }
    
    // Вспомогательные функции
    function getPriorityLabel(priority) {
        const labels = {
            'urgent': 'Срочный',
            'high': 'Высокий',
            'normal': 'Обычный',
            'low': 'Низкий'
        };
        return labels[priority] || priority;
    }
    
    function formatDeadline(deadline) {
        const date = new Date(deadline);
        const now = new Date();
        const diff = date - now;
        
        if (diff < 0) {
            return 'Просрочено';
        }
        
        const days = Math.floor(diff / (1000 * 60 * 60 * 24));
        const hours = Math.floor((diff % (1000 * 60 * 60 * 24)) / (1000 * 60 * 60));
        
        if (days > 0) {
            return `${days}д ${hours}ч`;
        } else if (hours > 0) {
            return `${hours}ч`;
        } else {
            const minutes = Math.floor((diff % (1000 * 60 * 60)) / (1000 * 60));
            return `${minutes}м`;
        }
    }
    
    function showNotification(message, type = 'info') {
        // Создаем элемент уведомления
        const notification = document.createElement('div');
        notification.className = `alert alert-${type} alert-dismissible fade show position-fixed top-0 end-0 m-3`;
        notification.style.zIndex = '9999';
        notification.innerHTML = `
            ${message}
            <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
        `;
        
        document.body.appendChild(notification);
        
        // Автоматически удаляем через 5 секунд
        setTimeout(() => {
            notification.remove();
        }, 5000);
    }
</script>
{% endblock %}