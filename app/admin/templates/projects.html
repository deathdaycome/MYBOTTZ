{% extends "base.html" %}

{% block title %}–ü—Ä–æ–µ–∫—Ç—ã - –ê–¥–º–∏–Ω-–ø–∞–Ω–µ–ª—å{% endblock %}

{% block page_title %}üìã –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –ø—Ä–æ–µ–∫—Ç–∞–º–∏{% endblock %}

{% block extra_css %}
<style>
.timeline {
    position: relative;
    max-height: 300px;
    overflow-y: auto;
    padding: 0;
}

.timeline-item {
    position: relative;
    padding-left: 30px;
    margin-bottom: 20px;
    border-left: 2px solid #e2e8f0;
}

.timeline-item:before {
    content: '';
    position: absolute;
    left: -6px;
    top: 5px;
    width: 10px;
    height: 10px;
    border-radius: 50%;
    background: var(--primary-color);
    border: 2px solid #fff;
    box-shadow: 0 0 0 2px #e2e8f0;
}

.timeline-item:last-child {
    border-left: 2px solid transparent;
    margin-bottom: 0;
}

.timeline-date {
    font-size: 0.8rem;
    color: #64748b;
    margin-bottom: 5px;
}

.timeline-content {
    background: #f8fafc;
    padding: 10px;
    border-radius: 8px;
    border: 1px solid #e2e8f0;
}

.timeline-content strong {
    color: var(--primary-color);
}

.status-new { background-color: #0d6efd !important; color: #ffffff !important; border: 1px solid #0d6efd !important; }
.status-review { background-color: #fd7e14 !important; color: #ffffff !important; border: 1px solid #fd7e14 !important; }
.status-accepted { background-color: #198754 !important; color: #ffffff !important; border: 1px solid #198754 !important; }
.status-in_progress { background-color: #0dcaf0 !important; color: #000000 !important; border: 1px solid #0dcaf0 !important; }
.status-testing { background-color: #6f42c1 !important; color: #ffffff !important; border: 1px solid #6f42c1 !important; }
.status-completed { background-color: #20c997 !important; color: #ffffff !important; border: 1px solid #20c997 !important; }
.status-cancelled { background-color: #dc3545 !important; color: #ffffff !important; border: 1px solid #dc3545 !important; }
.status-on_hold { background-color: #6c757d !important; color: #ffffff !important; border: 1px solid #6c757d !important; }

/* –°—Ç–∞—Ç—É—Å—ã –¥–ª—è –∫–∞—Å—Ç–æ–º–Ω—ã—Ö —Å—Ç–∞—Ç—É—Å–æ–≤ */
.status-custom { background-color: #e91e63 !important; color: #ffffff !important; border: 1px solid #e91e63 !important; }

/* –û–±—â–∏–µ —Å—Ç–∏–ª–∏ –¥–ª—è –≤—Å–µ—Ö —Å—Ç–∞—Ç—É—Å–æ–≤ */
.badge[class*="status-"] {
    font-weight: 500 !important;
    padding: 0.5em 0.75em !important;
    border-radius: 0.375rem !important;
    font-size: 0.875rem !important;
    text-shadow: none !important;
    opacity: 1 !important;
}

/* –ü–µ—Ä–µ–æ–ø—Ä–µ–¥–µ–ª—è–µ–º Bootstrap —Å—Ç–∏–ª–∏ –¥–ª—è –±–æ–ª—å—à–µ–π –∫–æ–Ω—Ç—Ä–∞—Å—Ç–Ω–æ—Å—Ç–∏ */
.badge {
    background-color: inherit !important;
    color: inherit !important;
}

/* –°—Ç–∏–ª–∏ –¥–ª—è –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–∞ —Å —Ç–µ—Ö–Ω–∏—á–µ—Å–∫–∏–º –∑–∞–¥–∞–Ω–∏–µ–º */
.description-container {
    transition: all 0.3s ease;
}

.description-container:hover {
    border-color: #007bff !important;
}

.description-container::-webkit-scrollbar {
    width: 8px;
}

.description-container::-webkit-scrollbar-track {
    background: #f1f1f1;
    border-radius: 4px;
}

.description-container::-webkit-scrollbar-thumb {
    background: #c1c1c1;
    border-radius: 4px;
}

.description-container::-webkit-scrollbar-thumb:hover {
    background: #a8a8a8;
}

/* –°—Ç–∏–ª–∏ –¥–ª—è –∫–Ω–æ–ø–∫–∏ –æ—á–∏—Å—Ç–∏—Ç—å —Ñ–∏–ª—å—Ç—Ä—ã */
.btn.w-100.d-flex {
    min-height: 38px;
    white-space: nowrap;
}

.btn.w-100.d-flex span {
    text-align: center;
    flex-grow: 1;
}
</style>
{% endblock %}

{% block header_actions %}
<div class="btn-group">
    <button class="btn btn-primary btn-custom" onclick="showCreateProjectModal()">
        <i class="fas fa-plus me-1"></i> –°–æ–∑–¥–∞—Ç—å –ø—Ä–æ–µ–∫—Ç
    </button>
    <button class="btn btn-secondary btn-custom" onclick="refreshProjects()">
        <i class="fas fa-sync-alt me-1"></i> –û–±–Ω–æ–≤–∏—Ç—å
    </button>
    <button class="btn btn-success btn-custom" onclick="exportProjects()">
        <i class="fas fa-download me-1"></i> –≠–∫—Å–ø–æ—Ä—Ç
    </button>
</div>
{% endblock %}

{% block content %}
<!-- Filters and Search -->
<div class="card mb-4">
    <div class="card-body">
        <div class="row">
            <div class="col-md-4">
                <div class="input-group">
                    <input type="text" class="form-control" id="searchInput" placeholder="–ü–æ–∏—Å–∫ –ø–æ –Ω–∞–∑–≤–∞–Ω–∏—é –∏–ª–∏ –∫–ª–∏–µ–Ω—Ç—É..." onkeyup="searchProjects()">
                    <button class="btn btn-outline-secondary" onclick="searchProjects()">
                        <i class="fas fa-search"></i>
                    </button>
                </div>
            </div>
            <div class="col-md-2">
                <select class="form-select" id="statusFilter" onchange="filterProjects()">
                    <option value="">–í—Å–µ —Å—Ç–∞—Ç—É—Å—ã</option>
                    <option value="new">–ù–æ–≤—ã–µ</option>
                    <option value="review">–ù–∞ —Ä–∞—Å—Å–º–æ—Ç—Ä–µ–Ω–∏–∏</option>
                    <option value="accepted">–ü—Ä–∏–Ω—è—Ç—ã–µ</option>
                    <option value="in_progress">–í —Ä–∞–±–æ—Ç–µ</option>
                    <option value="testing">–¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ</option>
                    <option value="completed">–ó–∞–≤–µ—Ä—à–µ–Ω–Ω—ã–µ</option>
                    <option value="cancelled">–û—Ç–º–µ–Ω–µ–Ω–Ω—ã–µ</option>
                </select>
            </div>
            <div class="col-md-2">
                <select class="form-select" id="complexityFilter" onchange="filterProjects()">
                    <option value="">–í—Å–µ —Å–ª–æ–∂–Ω–æ—Å—Ç–∏</option>
                    <option value="simple">–ü—Ä–æ—Å—Ç—ã–µ</option>
                    <option value="medium">–°—Ä–µ–¥–Ω–∏–µ</option>
                    <option value="complex">–°–ª–æ–∂–Ω—ã–µ</option>
                    <option value="premium">–ü—Ä–µ–º–∏—É–º</option>
                </select>
            </div>
            <div class="col-md-2">
                <select class="form-select" id="sortBy" onchange="sortProjects()">
                    <option value="created_at">–ü–æ –¥–∞—Ç–µ —Å–æ–∑–¥–∞–Ω–∏—è</option>
                    <option value="updated_at">–ü–æ –¥–∞—Ç–µ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è</option>
                    <option value="estimated_cost">–ü–æ —Å—Ç–æ–∏–º–æ—Å—Ç–∏</option>
                    <option value="title">–ü–æ –Ω–∞–∑–≤–∞–Ω–∏—é</option>
                </select>
            </div>
            <div class="col-md-2">
                <button class="btn btn-outline-danger w-100 d-flex align-items-center justify-content-center" onclick="clearFilters()">
                    <i class="fas fa-times me-1"></i>
                    <span>–û—á–∏—Å—Ç–∏—Ç—å</span>
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Statistics Cards -->
<div class="row mb-4">
    <div class="col-md-3">
        <div class="stat-card primary">
            <div class="d-flex align-items-center">
                <i class="fas fa-project-diagram fa-2x me-3"></i>
                <div>
                    <div class="h4 mb-0" id="totalProjects">{{ projects|length }}</div>
                    <small>–í—Å–µ–≥–æ –ø—Ä–æ–µ–∫—Ç–æ–≤</small>
                </div>
            </div>
        </div>
    </div>
    <div class="col-md-3">
        <div class="stat-card info">
            <div class="d-flex align-items-center">
                <i class="fas fa-hourglass-half fa-2x me-3"></i>
                <div>
                    <div class="h4 mb-0" id="activeProjects">
                        {{ projects|selectattr("status", "in", ["new", "review", "accepted", "in_progress", "testing"])|list|length }}
                    </div>
                    <small>–ê–∫—Ç–∏–≤–Ω—ã–µ</small>
                </div>
            </div>
        </div>
    </div>
    <div class="col-md-3">
        <div class="stat-card success">
            <div class="d-flex align-items-center">
                <i class="fas fa-check-circle fa-2x me-3"></i>
                <div>
                    <div class="h4 mb-0" id="completedProjects">
                        {{ projects|selectattr("status", "equalto", "completed")|list|length }}
                    </div>
                    <small>–ó–∞–≤–µ—Ä—à–µ–Ω–Ω—ã–µ</small>
                </div>
            </div>
        </div>
    </div>
    <div class="col-md-3">
        <div class="stat-card warning">
            <div class="d-flex align-items-center">
                <i class="fas fa-ruble-sign fa-2x me-3"></i>
                <div>
                    <div class="h4 mb-0" id="totalRevenue">
                        {{ (projects|sum(attribute="estimated_cost"))|round|int }}‚ÇΩ
                    </div>
                    <small>–û–±—â–∞—è —Å—Ç–æ–∏–º–æ—Å—Ç—å</small>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Projects Table -->
<div class="card">
    <div class="card-header d-flex justify-content-between align-items-center">
        <h5 class="card-title mb-0">–°–ø–∏—Å–æ–∫ –ø—Ä–æ–µ–∫—Ç–æ–≤</h5>
        <div class="d-flex align-items-center">
            <span class="me-3 text-muted" id="projectsCount">–ü–æ–∫–∞–∑–∞–Ω–æ: {{ projects|length }}</span>
            <div class="btn-group btn-group-sm">
                <button class="btn btn-outline-secondary" onclick="changeView('table')" id="tableView">
                    <i class="fas fa-table"></i>
                </button>
                <button class="btn btn-outline-secondary" onclick="changeView('cards')" id="cardsView">
                    <i class="fas fa-th-large"></i>
                </button>
            </div>
        </div>
    </div>
    <div class="card-body p-0">
        <!-- Table View -->
        <div id="tableViewContainer">
            <div class="table-responsive">
                <table class="table table-hover mb-0" id="projectsTable">
                    <thead class="table-dark">
                        <tr>
                            <th>ID</th>
                            <th>–ù–∞–∑–≤–∞–Ω–∏–µ</th>
                            <th>–ö–ª–∏–µ–Ω—Ç</th>
                            <th>–°—Ç–∞—Ç—É—Å</th>
                            <th>–°–ª–æ–∂–Ω–æ—Å—Ç—å</th>
                            <th>–°—Ç–æ–∏–º–æ—Å—Ç—å</th>
                            <th>–î–∞—Ç–∞ —Å–æ–∑–¥–∞–Ω–∏—è</th>
                            <th>–î–µ–π—Å—Ç–≤–∏—è</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for project in projects %}
                        <tr data-project-id="{{ project.id }}" data-status="{{ project.status }}" data-complexity="{{ project.complexity }}">
                            <td>
                                <span class="badge bg-secondary">#{{ project.id }}</span>
                            </td>
                            <td>
                                <div class="fw-bold text-truncate" style="max-width: 200px;" title="{{ project.title }}">
                                    {{ project.title }}
                                </div>
                                <small class="text-muted">{{ project.project_type or '–ù–µ —É–∫–∞–∑–∞–Ω–æ' }}</small>
                            </td>
                            <td>
                                <div class="d-flex align-items-center">
                                    <div class="user-avatar me-2">
                                        {{ (project.user.first_name or 'U')[0] if project.user else 'U' }}
                                    </div>
                                    <div>
                                        <div class="fw-medium">{{ project.user.first_name or '–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–æ' if project.user else '–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–æ' }}</div>
                                        <small class="text-muted">@{{ project.user.username or '–Ω–µ—Ç' if project.user else '–Ω–µ—Ç' }}</small>
                                    </div>
                                </div>
                            </td>
                            <td>
                                <div class="d-flex align-items-center">
                                    <div class="me-2">
                                        <span class="badge status-{{ project.status }}">
                                            {% if project.status == 'new' %}üÜï –ù–æ–≤—ã–π
                                            {% elif project.status == 'review' %}üëÄ –†–∞—Å—Å–º–æ—Ç—Ä–µ–Ω–∏–µ
                                            {% elif project.status == 'accepted' %}‚úÖ –ü—Ä–∏–Ω—è—Ç
                                            {% elif project.status == 'in_progress' %}üîÑ –í —Ä–∞–±–æ—Ç–µ
                                            {% elif project.status == 'testing' %}üß™ –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ
                                            {% elif project.status == 'completed' %}üéâ –ó–∞–≤–µ—Ä—à–µ–Ω
                                            {% elif project.status == 'cancelled' %}‚ùå –û—Ç–º–µ–Ω–µ–Ω
                                            {% elif project.status == 'on_hold' %}‚è∏Ô∏è –ü—Ä–∏–æ—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω
                                            {% else %}{{ project.status }}{% endif %}
                                        </span>
                                    </div>
                                    <button class="btn btn-outline-primary btn-sm" onclick="showStatusChangeDialog({{ project.id }}, '{{ project.status }}')" title="–ò–∑–º–µ–Ω–∏—Ç—å —Å—Ç–∞—Ç—É—Å">
                                        <i class="fas fa-edit"></i>
                                    </button>
                                </div>
                                <div class="progress mt-1" style="height: 4px;">
                                    <div class="progress-bar" role="progressbar" style="width: {{ calculate_progress(project.status) }}%" data-project-id="{{ project.id }}">
                                    </div>
                                </div>
                            </td>
                            <td>
                                <span class="badge complexity-{{ project.complexity }}">
                                    {% if project.complexity == 'simple' %}üü¢ –ü—Ä–æ—Å—Ç–æ–π
                                    {% elif project.complexity == 'medium' %}üü° –°—Ä–µ–¥–Ω–∏–π
                                    {% elif project.complexity == 'complex' %}üü† –°–ª–æ–∂–Ω—ã–π
                                    {% elif project.complexity == 'premium' %}üî¥ –ü—Ä–µ–º–∏—É–º
                                    {% else %}{{ project.complexity }}{% endif %}
                                </span>
                                                    </td>
                        <td>
                            <div class="fw-bold">{{ (project.estimated_cost or 0)|round|int }}‚ÇΩ</div>
                            {% if project.final_cost and project.final_cost != project.estimated_cost %}
                            <small class="text-success">–§–∏–Ω–∞–ª: {{ (project.final_cost)|round|int }}‚ÇΩ</small>
                            {% endif %}
                        </td>
                        <td>
                            <div>{{ project.created_at[:10] if project.created_at else '–ù/–î' }}</div>
                            <small class="text-muted">{{ project.created_at[11:16] if project.created_at else '' }}</small>
                        </td>
                        <td>
                            <div class="btn-group btn-group-sm">
                                <button class="btn btn-outline-primary" onclick="viewProject({{ project.id }})" title="–ü—Ä–æ—Å–º–æ—Ç—Ä">
                                    <i class="fas fa-eye"></i>
                                </button>
                                <button class="btn btn-outline-info" onclick="openEditModal({{ project.id }})" title="–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å">
                                    <i class="fas fa-edit"></i>
                                </button>
                                <button class="btn btn-outline-secondary" onclick="showFilesModal({{ project.id }})" title="–§–∞–π–ª—ã">
                                    <i class="fas fa-file"></i>
                                </button>
                                {% if project.user and project.user.telegram_id %}
                                <button class="btn btn-outline-success" onclick="contactClient({{ project.user.telegram_id }})" title="–°–≤—è–∑–∞—Ç—å—Å—è">
                                    <i class="fas fa-comment"></i>
                                </button>
                                {% else %}
                                <button class="btn btn-outline-secondary" disabled title="Telegram ID –æ—Ç—Å—É—Ç—Å—Ç–≤—É–µ—Ç">
                                    <i class="fas fa-comment"></i>
                                </button>
                                {% endif %}
                                <button class="btn btn-outline-danger" onclick="confirmDeleteProject({{ project.id }}, '{{ project.title }}')" title="–£–¥–∞–ª–∏—Ç—å –ø—Ä–æ–µ–∫—Ç">
                                    <i class="fas fa-trash"></i>
                                </button>
                            </div>
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
    </div>

    <!-- Cards View -->
    <div id="cardsViewContainer" class="d-none">
        <div class="row p-3" id="projectsCards">
            {% for project in projects %}
            <div class="col-md-6 col-lg-4 mb-4 project-card" data-project-id="{{ project.id }}" data-status="{{ project.status }}" data-complexity="{{ project.complexity }}" data-title="{{ project.title.lower() }}" data-client="{{ (project.user.first_name or '').lower() }}">
                <div class="card h-100 shadow-sm project-card-item">
                    <div class="card-header d-flex justify-content-between align-items-center">
                        <h6 class="mb-0 text-truncate" title="{{ project.title }}">{{ project.title }}</h6>
                        <span class="badge bg-secondary">#{{ project.id }}</span>
                    </div>
                    <div class="card-body">
                        <div class="d-flex align-items-center mb-3">
                            <div class="user-avatar me-2">
                                {{ (project.user.first_name or 'U')[0] if project.user else 'U' }}
                            </div>
                            <div>
                                <div class="fw-medium">{{ project.user.first_name or '–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–æ' if project.user else '–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–æ' }}</div>
                                <small class="text-muted">@{{ project.user.username or '–Ω–µ—Ç' if project.user else '–Ω–µ—Ç' }}</small>
                            </div>
                        </div>

                        <div class="d-flex justify-content-between align-items-center mb-2">
                            <span class="badge status-{{ project.status }}">
                                {% if project.status == 'new' %}üÜï –ù–æ–≤—ã–π
                                {% elif project.status == 'review' %}üëÄ –†–∞—Å—Å–º–æ—Ç—Ä–µ–Ω–∏–µ
                                {% elif project.status == 'accepted' %}‚úÖ –ü—Ä–∏–Ω—è—Ç
                                {% elif project.status == 'in_progress' %}üîÑ –í —Ä–∞–±–æ—Ç–µ
                                {% elif project.status == 'testing' %}üß™ –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ
                                {% elif project.status == 'completed' %}üéâ –ó–∞–≤–µ—Ä—à–µ–Ω
                                {% elif project.status == 'cancelled' %}‚ùå –û—Ç–º–µ–Ω–µ–Ω
                                {% elif project.status == 'on_hold' %}‚è∏Ô∏è –ü—Ä–∏–æ—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω
                                {% else %}{{ project.status }}{% endif %}
                            </span>
                            <span class="badge complexity-{{ project.complexity }}">
                                {% if project.complexity == 'simple' %}üü¢ –ü—Ä–æ—Å—Ç–æ–π
                                {% elif project.complexity == 'medium' %}üü° –°—Ä–µ–¥–Ω–∏–π
                                {% elif project.complexity == 'complex' %}üü† –°–ª–æ–∂–Ω—ã–π
                                {% elif project.complexity == 'premium' %}üî¥ –ü—Ä–µ–º–∏—É–º
                                {% else %}{{ project.complexity }}{% endif %}
                            </span>
                        </div>

                        <div class="progress mb-3" style="height: 6px;">
                            <div class="progress-bar" role="progressbar" style="width: {{ calculate_progress(project.status) }}%;" aria-valuenow="{{ calculate_progress(project.status) }}" aria-valuemin="0" aria-valuemax="100"></div>
                        </div>

                        <p class="card-text text-muted small description-preview">{{ project.description if project.description else '–ù–µ—Ç –æ–ø–∏—Å–∞–Ω–∏—è' }}</p>

                        <div class="d-flex justify-content-between">
                            <div class="fw-bold">{{ (project.estimated_cost or 0)|round|int }}‚ÇΩ</div>
                            <small class="text-muted">{{ project.created_at[:10] if project.created_at else '–ù/–î' }}</small>
                        </div>
                    </div>
                    <div class="card-footer bg-light d-flex justify-content-end">
                        <div class="btn-group btn-group-sm">
                            <button class="btn btn-outline-primary" onclick="viewProject({{ project.id }})" title="–ü—Ä–æ—Å–º–æ—Ç—Ä">
                                <i class="fas fa-eye"></i>
                            </button>
                            <button class="btn btn-outline-info" onclick="openEditModal({{ project.id }})" title="–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å">
                                <i class="fas fa-edit"></i>
                            </button>
                            <button class="btn btn-outline-secondary" onclick="showFilesModal({{ project.id }})" title="–§–∞–π–ª—ã">
                                <i class="fas fa-folder-open"></i>
                            </button>
                            {% if project.user and project.user.telegram_id %}
                            <button class="btn btn-outline-success" onclick="contactClient({{ project.user.telegram_id }})" title="–°–≤—è–∑–∞—Ç—å—Å—è">
                                <i class="fas fa-comment"></i>
                            </button>
                            {% else %}
                            <button class="btn btn-outline-secondary" disabled title="Telegram ID –æ—Ç—Å—É—Ç—Å—Ç–≤—É–µ—Ç">
                                <i class="fas fa-comment"></i>
                            </button>
                            {% endif %}
                        </div>
                    </div>
                </div>
            </div>
            {% endfor %}
        </div>
    </div>
</div>

<!-- Project Details Modal -->
<div class="modal fade" id="projectModal" tabindex="-1">
    <div class="modal-dialog modal-xl">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">–î–µ—Ç–∞–ª–∏ –ø—Ä–æ–µ–∫—Ç–∞</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body" id="projectModalBody">
                <!-- Content will be loaded here -->
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">–ó–∞–∫—Ä—ã—Ç—å</button>
                <button type="button" class="btn btn-primary" onclick="editCurrentProject()">–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å</button>
            </div>
        </div>
    </div>
</div>

<!-- Edit Project Modal -->
<div class="modal fade" id="editProjectModal" tabindex="-1" aria-labelledby="editProjectModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="editProjectModalLabel">–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –ø—Ä–æ–µ–∫—Ç–∞</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <form id="editProjectForm">
                    <input type="hidden" id="editProjectId">
                    <div class="mb-3">
                        <label for="editProjectTitle" class="form-label">–ù–∞–∑–≤–∞–Ω–∏–µ –ø—Ä–æ–µ–∫—Ç–∞</label>
                        <input type="text" class="form-control" id="editProjectTitle" required>
                    </div>
                    <div class="mb-3">
                        <label for="editProjectDescription" class="form-label">–û–ø–∏—Å–∞–Ω–∏–µ</label>
                        <textarea class="form-control" id="editProjectDescription" rows="4"></textarea>
                    </div>
                    <div class="row">
                        <div class="col-md-6 mb-3">
                            <label for="editProjectStatus" class="form-label">–°—Ç–∞—Ç—É—Å</label>
                            <select class="form-select" id="editProjectStatus">
                                <option value="new">–ù–æ–≤—ã–π</option>
                                <option value="review">–ù–∞ —Ä–∞—Å—Å–º–æ—Ç—Ä–µ–Ω–∏–∏</option>
                                <option value="accepted">–ü—Ä–∏–Ω—è—Ç</option>
                                <option value="in_progress">–í —Ä–∞–±–æ—Ç–µ</option>
                                <option value="testing">–¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ</option>
                                <option value="completed">–ó–∞–≤–µ—Ä—à–µ–Ω</option>
                                <option value="cancelled">–û—Ç–º–µ–Ω–µ–Ω</option>
                                <option value="on_hold">–ü—Ä–∏–æ—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω</option>
                            </select>
                        </div>
                        <div class="col-md-6 mb-3">
                            <label for="editProjectComplexity" class="form-label">–°–ª–æ–∂–Ω–æ—Å—Ç—å</label>
                            <select class="form-select" id="editProjectComplexity">
                                <option value="simple">–ü—Ä–æ—Å—Ç–æ–π</option>
                                <option value="medium">–°—Ä–µ–¥–Ω–∏–π</option>
                                <option value="complex">–°–ª–æ–∂–Ω—ã–π</option>
                                <option value="premium">–ü—Ä–µ–º–∏—É–º</option>
                            </select>
                        </div>
                    </div>
                    <div class="row">
                        <div class="col-md-6 mb-3">
                            <label for="editProjectEstimatedCost" class="form-label">–û—Ä–∏–µ–Ω—Ç–∏—Ä–æ–≤–æ—á–Ω–∞—è —Å—Ç–æ–∏–º–æ—Å—Ç—å (‚ÇΩ)</label>
                            <input type="number" class="form-control" id="editProjectEstimatedCost" min="0">
                        </div>
                        <div class="col-md-6 mb-3">
                            <label for="editProjectFinalCost" class="form-label">–§–∏–Ω–∞–ª—å–Ω–∞—è —Å—Ç–æ–∏–º–æ—Å—Ç—å (‚ÇΩ)</label>
                            <input type="number" class="form-control" id="editProjectFinalCost" min="0">
                        </div>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">–û—Ç–º–µ–Ω–∞</button>
                <button type="button" class="btn btn-primary" onclick="submitProjectEdit()">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å –∏–∑–º–µ–Ω–µ–Ω–∏—è</button>
            </div>
        </div>
    </div>
</div>

<!-- –ú–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ –¥–ª—è —Å–º–µ–Ω—ã —Å—Ç–∞—Ç—É—Å–∞ –ø—Ä–æ–µ–∫—Ç–∞ -->
<div class="modal fade" id="changeStatusModal" tabindex="-1" aria-labelledby="changeStatusModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="changeStatusModalLabel">–°–º–µ–Ω–∞ —Å—Ç–∞—Ç—É—Å–∞ –ø—Ä–æ–µ–∫—Ç–∞</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <input type="hidden" id="changeStatusProjectId" />
                
                <div class="mb-3">
                    <label class="form-label">–¢–µ–∫—É—â–∏–π —Å—Ç–∞—Ç—É—Å:</label>
                    <div id="changeStatusCurrentStatus" class="fw-bold text-primary"></div>
                </div>
                
                <div class="mb-3">
                    <label for="changeStatusNewStatus" class="form-label">–ù–æ–≤—ã–π —Å—Ç–∞—Ç—É—Å:</label>
                    <select class="form-select" id="changeStatusNewStatus" onchange="updateSelectedStatusName()">
                        <option value="">–í—ã–±–µ—Ä–∏—Ç–µ —Å—Ç–∞—Ç—É—Å...</option>
                    </select>
                    <div class="form-check mt-2">
                        <input class="form-check-input" type="checkbox" id="useCustomStatus" onchange="toggleCustomStatus()">
                        <label class="form-check-label" for="useCustomStatus">
                            –°–æ–∑–¥–∞—Ç—å –Ω–æ–≤—ã–π —Å—Ç–∞—Ç—É—Å
                        </label>
                    </div>
                </div>
                
                <div class="mb-3 d-none" id="customStatusGroup">
                    <label for="customStatusName" class="form-label">–ù–∞–∑–≤–∞–Ω–∏–µ –Ω–æ–≤–æ–≥–æ —Å—Ç–∞—Ç—É—Å–∞:</label>
                    <input type="text" class="form-control" id="customStatusName" placeholder="–í–≤–µ–¥–∏—Ç–µ –Ω–∞–∑–≤–∞–Ω–∏–µ —Å—Ç–∞—Ç—É—Å–∞" onkeyup="updateSelectedStatusName()">
                    <small class="form-text text-muted">–ù–æ–≤—ã–π —Å—Ç–∞—Ç—É—Å –±—É–¥–µ—Ç –¥–æ–±–∞–≤–ª–µ–Ω –≤ —Å–∏—Å—Ç–µ–º—É</small>
                </div>
                
                <div class="mb-3">
                    <label for="changeStatusComment" class="form-label">–ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π (–Ω–µ–æ–±—è–∑–∞—Ç–µ–ª—å–Ω–æ):</label>
                    <textarea class="form-control" id="changeStatusComment" rows="3" placeholder="–î–æ–±–∞–≤—å—Ç–µ –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π –∫ –∏–∑–º–µ–Ω–µ–Ω–∏—é —Å—Ç–∞—Ç—É—Å–∞..."></textarea>
                </div>
                
                <div class="alert alert-info">
                    <i class="fas fa-info-circle me-2"></i>
                    –í—ã —É–≤–µ—Ä–µ–Ω—ã, —á—Ç–æ —Ö–æ—Ç–∏—Ç–µ —Å–º–µ–Ω–∏—Ç—å —Å—Ç–∞—Ç—É—Å –ø—Ä–æ–µ–∫—Ç–∞ –Ω–∞ "<span id="selectedStatusName">–ø—Ä–∏–æ—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω</span>"?
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">–û—Ç–º–µ–Ω–∞</button>
                <button type="button" class="btn btn-primary" onclick="confirmStatusChange()">–ü–æ–¥—Ç–≤–µ—Ä–¥–∏—Ç—å</button>
            </div>
        </div>
    </div>
</div>

<!-- –ú–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏—è —É–¥–∞–ª–µ–Ω–∏—è –ø—Ä–æ–µ–∫—Ç–∞ -->
<div class="modal fade" id="deleteProjectModal" tabindex="-1" aria-labelledby="deleteProjectModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="deleteProjectModalLabel">–ü–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏–µ —É–¥–∞–ª–µ–Ω–∏—è</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <input type="hidden" id="deleteProjectId" />
                
                <div class="alert alert-danger">
                    <i class="fas fa-exclamation-triangle me-2"></i>
                    <strong>–í–Ω–∏–º–∞–Ω–∏–µ!</strong> –≠—Ç–æ –¥–µ–π—Å—Ç–≤–∏–µ –Ω–µ–æ–±—Ä–∞—Ç–∏–º–æ.
                </div>
                
                <p>–í—ã —É–≤–µ—Ä–µ–Ω—ã, —á—Ç–æ —Ö–æ—Ç–∏—Ç–µ —É–¥–∞–ª–∏—Ç—å –ø—Ä–æ–µ–∫—Ç <strong id="deleteProjectTitle"></strong>?</p>
                
                <p class="text-muted">
                    <small>–ü—Ä–∏ —É–¥–∞–ª–µ–Ω–∏–∏ –ø—Ä–æ–µ–∫—Ç–∞ –±—É–¥—É—Ç —É–¥–∞–ª–µ–Ω—ã –≤—Å–µ —Å–≤—è–∑–∞–Ω–Ω—ã–µ —Ñ–∞–π–ª—ã –∏ –¥–∞–Ω–Ω—ã–µ. –ó–∞–∫–∞–∑—á–∏–∫ –ø–æ–ª—É—á–∏—Ç —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ –æ–± —É–¥–∞–ª–µ–Ω–∏–∏.</small>
                </p>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">–û—Ç–º–µ–Ω–∞</button>
                <button type="button" class="btn btn-danger" onclick="deleteProject()">
                    <i class="fas fa-trash me-2"></i>–£–¥–∞–ª–∏—Ç—å –ø—Ä–æ–µ–∫—Ç
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Create Project Modal -->
<div class="modal fade" id="createProjectModal" tabindex="-1" aria-labelledby="createProjectModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="createProjectModalLabel">
                    <i class="fas fa-plus me-2"></i>–°–æ–∑–¥–∞—Ç—å –Ω–æ–≤—ã–π –ø—Ä–æ–µ–∫—Ç
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <form id="createProjectForm">
                    <div class="row">
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label for="createProjectTitle" class="form-label">–ù–∞–∑–≤–∞–Ω–∏–µ –ø—Ä–æ–µ–∫—Ç–∞ *</label>
                                <input type="text" class="form-control" id="createProjectTitle" required>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label for="createProjectType" class="form-label">–¢–∏–ø –ø—Ä–æ–µ–∫—Ç–∞</label>
                                <select class="form-select" id="createProjectType">
                                    <option value="website">–í–µ–±-—Å–∞–π—Ç</option>
                                    <option value="bot">Telegram-–±–æ—Ç</option>
                                    <option value="app">–ú–æ–±–∏–ª—å–Ω–æ–µ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ</option>
                                    <option value="other">–î—Ä—É–≥–æ–µ</option>
                                </select>
                            </div>
                        </div>
                    </div>
                    
                    <div class="mb-3">
                        <label for="createProjectDescription" class="form-label">–û–ø–∏—Å–∞–Ω–∏–µ –ø—Ä–æ–µ–∫—Ç–∞ *</label>
                        <textarea class="form-control" id="createProjectDescription" rows="3" required></textarea>
                    </div>
                    
                    <div class="row">
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label for="createClientName" class="form-label">–ò–º—è –∫–ª–∏–µ–Ω—Ç–∞</label>
                                <input type="text" class="form-control" id="createClientName">
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label for="createClientTelegramId" class="form-label">Telegram ID –∫–ª–∏–µ–Ω—Ç–∞</label>
                                <input type="text" class="form-control" id="createClientTelegramId" placeholder="–ù–∞–ø—Ä–∏–º–µ—Ä: 123456789">
                            </div>
                        </div>
                    </div>
                    
                    <div class="row">
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label for="createClientPhone" class="form-label">–¢–µ–ª–µ—Ñ–æ–Ω –∫–ª–∏–µ–Ω—Ç–∞</label>
                                <input type="text" class="form-control" id="createClientPhone" placeholder="+7 (999) 123-45-67">
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label for="createProjectComplexity" class="form-label">–°–ª–æ–∂–Ω–æ—Å—Ç—å</label>
                                <select class="form-select" id="createProjectComplexity">
                                    <option value="simple">–ü—Ä–æ—Å—Ç–æ–π</option>
                                    <option value="medium" selected>–°—Ä–µ–¥–Ω–∏–π</option>
                                    <option value="complex">–°–ª–æ–∂–Ω—ã–π</option>
                                </select>
                            </div>
                        </div>
                    </div>
                    
                    <div class="row">
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label for="createProjectPriority" class="form-label">–ü—Ä–∏–æ—Ä–∏—Ç–µ—Ç</label>
                                <select class="form-select" id="createProjectPriority">
                                    <option value="low">–ù–∏–∑–∫–∏–π</option>
                                    <option value="medium" selected>–°—Ä–µ–¥–Ω–∏–π</option>
                                    <option value="high">–í—ã—Å–æ–∫–∏–π</option>
                                    <option value="urgent">–°—Ä–æ—á–Ω—ã–π</option>
                                </select>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label for="createProjectStatus" class="form-label">–°—Ç–∞—Ç—É—Å</label>
                                <select class="form-select" id="createProjectStatus">
                                    <option value="new" selected>–ù–æ–≤—ã–π</option>
                                    <option value="review">–ù–∞ —Ä–∞—Å—Å–º–æ—Ç—Ä–µ–Ω–∏–∏</option>
                                    <option value="accepted">–ü—Ä–∏–Ω—è—Ç</option>
                                </select>
                            </div>
                        </div>
                    </div>
                    
                    <div class="row">
                        <div class="col-md-4">
                            <div class="mb-3">
                                <label for="createEstimatedCost" class="form-label">–°—Ç–æ–∏–º–æ—Å—Ç—å (—Ä—É–±.)</label>
                                <input type="number" class="form-control" id="createEstimatedCost" min="0" step="1000">
                            </div>
                        </div>
                        <div class="col-md-4">
                            <div class="mb-3">
                                <label for="createExecutorCost" class="form-label">–°—Ç–æ–∏–º–æ—Å—Ç—å –¥–ª—è –∏—Å–ø–æ–ª–Ω–∏—Ç–µ–ª—è (—Ä—É–±.)</label>
                                <input type="number" class="form-control" id="createExecutorCost" min="0" step="500">
                            </div>
                        </div>
                        <div class="col-md-4">
                            <div class="mb-3">
                                <label for="createEstimatedHours" class="form-label">–ß–∞—Å—ã (–ø—Ä–æ–≥–Ω–æ–∑)</label>
                                <input type="number" class="form-control" id="createEstimatedHours" min="1" step="1">
                            </div>
                        </div>
                    </div>
                    
                    <div class="mb-3">
                        <label for="createProjectDeadline" class="form-label">–î–µ–¥–ª–∞–π–Ω</label>
                        <input type="datetime-local" class="form-control" id="createProjectDeadline">
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">–û—Ç–º–µ–Ω–∞</button>
                <button type="button" class="btn btn-primary" onclick="createProject()">
                    <i class="fas fa-plus me-1"></i>–°–æ–∑–¥–∞—Ç—å –ø—Ä–æ–µ–∫—Ç
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Project Files Modal -->
<div class="modal fade" id="projectFilesModal" tabindex="-1" aria-labelledby="projectFilesModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="projectFilesModalLabel">
                    <i class="fas fa-file me-2"></i>–§–∞–π–ª—ã –ø—Ä–æ–µ–∫—Ç–∞
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <div id="projectFilesContent">
                    <div class="text-center p-4">
                        <div class="spinner-border text-primary" role="status">
                            <span class="visually-hidden">–ó–∞–≥—Ä—É–∑–∫–∞...</span>
                        </div>
                        <p class="mt-2">–ó–∞–≥—Ä—É–∑–∫–∞ —Ñ–∞–π–ª–æ–≤ –ø—Ä–æ–µ–∫—Ç–∞...</p>
                    </div>
                </div>
                
                <div class="mt-4 border-top pt-3">
                    <h5><i class="fas fa-upload me-2"></i>–ó–∞–≥—Ä—É–∑–∏—Ç—å –Ω–æ–≤—ã–π —Ñ–∞–π–ª</h5>
                    <form id="uploadProjectFileForm" enctype="multipart/form-data">
                        <input type="hidden" id="uploadProjectId" name="project_id">
                        <div class="mb-3">
                            <label for="projectFileUpload" class="form-label">–í—ã–±–µ—Ä–∏—Ç–µ —Ñ–∞–π–ª</label>
                            <input class="form-control" type="file" id="projectFileUpload" name="file">
                        </div>
                        <div class="mb-3">
                            <label for="projectFileDescription" class="form-label">–û–ø–∏—Å–∞–Ω–∏–µ —Ñ–∞–π–ª–∞</label>
                            <input type="text" class="form-control" id="projectFileDescription" name="description" placeholder="–û–ø–∏—à–∏—Ç–µ —Å–æ–¥–µ—Ä–∂–∏–º–æ–µ —Ñ–∞–π–ª–∞">
                        </div>
                        <div class="d-grid">
                            <button type="button" class="btn btn-primary" onclick="uploadProjectFile()">
                                <i class="fas fa-upload me-1"></i>–ó–∞–≥—Ä—É–∑–∏—Ç—å —Ñ–∞–π–ª
                            </button>
                        </div>
                    </form>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">–ó–∞–∫—Ä—ã—Ç—å</button>
            </div>
        </div>
    </div>
</div>

{% endblock %}

{% block scripts %}
<script>
    // –ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è –∞—É—Ç–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏–∏

    let currentProjectId = null;
    const username = 'admin';
    const password = 'qwerty123';

    let currentView = 'table';
    let allProjects = {{ projects|tojson|safe }};
    let filteredProjects = [...allProjects];
    let projectStatuses = []; // –ú–∞—Å—Å–∏–≤ –¥–ª—è —Ö—Ä–∞–Ω–µ–Ω–∏—è —Å—Ç–∞—Ç—É—Å–æ–≤ –ø—Ä–æ–µ–∫—Ç–æ–≤

    // View Management
    function changeView(view) {
        currentView = view;
        
        if (view === 'table') {
            document.getElementById('tableViewContainer').style.display = 'block';
            document.getElementById('cardsViewContainer').style.display = 'none';
            document.getElementById('tableView').classList.add('active');
            document.getElementById('cardsView').classList.remove('active');
        } else {
            document.getElementById('tableViewContainer').style.display = 'none';
            document.getElementById('cardsViewContainer').style.display = 'block';
            document.getElementById('tableView').classList.remove('active');
            document.getElementById('cardsView').classList.add('active');
        }
    }

    // Search and Filter
    function searchProjects() {
        const searchInput = document.getElementById('searchInput');
        const statusFilter = document.getElementById('statusFilter');
        const complexityFilter = document.getElementById('complexityFilter');
        
        if (!searchInput || !statusFilter || !complexityFilter) {
            console.error('–≠–ª–µ–º–µ–Ω—Ç—ã —Ñ–∏–ª—å—Ç—Ä–æ–≤ –Ω–µ –Ω–∞–π–¥–µ–Ω—ã');
            return;
        }
        
        const searchTerm = searchInput.value.toLowerCase();
        const statusFilterValue = statusFilter.value;
        const complexityFilterValue = complexityFilter.value;

        filteredProjects = allProjects.filter(project => {
            const matchesSearch = !searchTerm || 
                project.title.toLowerCase().includes(searchTerm) ||
                (project.user && project.user.first_name && project.user.first_name.toLowerCase().includes(searchTerm));
            
            const matchesStatus = !statusFilterValue || project.status === statusFilterValue;
            const matchesComplexity = !complexityFilterValue || project.complexity === complexityFilterValue;

            return matchesSearch && matchesStatus && matchesComplexity;
        });

        updateProjectsDisplay();
    }

    function filterProjects() {
        searchProjects(); // Reuse search logic
    }

    function clearFilters() {
        const searchInput = document.getElementById('searchInput');
        const statusFilter = document.getElementById('statusFilter');
        const complexityFilter = document.getElementById('complexityFilter');
        
        if (searchInput) searchInput.value = '';
        if (statusFilter) statusFilter.value = '';
        if (complexityFilter) complexityFilter.value = '';
        
        filteredProjects = [...allProjects];
        updateProjectsDisplay();
    }

    function sortProjects() {
        const sortByElement = document.getElementById('sortBy');
        if (!sortByElement) {
            console.error('–≠–ª–µ–º–µ–Ω—Ç sortBy –Ω–µ –Ω–∞–π–¥–µ–Ω');
            return;
        }
        
        const sortBy = sortByElement.value;
        
        filteredProjects.sort((a, b) => {
            if (sortBy === 'created_at' || sortBy === 'updated_at') {
                return new Date(b[sortBy]) - new Date(a[sortBy]);
            } else if (sortBy === 'estimated_cost') {
                return (b.estimated_cost || 0) - (a.estimated_cost || 0);
            } else if (sortBy === 'title') {
                return a.title.localeCompare(b.title);
            }
            return 0;
        });

        updateProjectsDisplay();
    }

    function updateProjectsDisplay() {
        const projectsCount = document.getElementById('projectsCount');
        if (projectsCount) {
            projectsCount.textContent = `–ü–æ–∫–∞–∑–∞–Ω–æ: ${filteredProjects.length}`;
        }
        
        if (currentView === 'table') {
            updateTableView();
        } else {
            updateCardsView();
        }
    }

    function updateTableView() {
        // Hide all rows first
        const rows = document.querySelectorAll('#projectsTable tbody tr');
        rows.forEach(row => row.style.display = 'none');

        // Show filtered rows
        filteredProjects.forEach(project => {
            const row = document.querySelector(`tr[data-project-id="${project.id}"]`);
            if (row) {
                row.style.display = '';
            }
        });
    }

    function updateCardsView() {
        // Hide all cards first
        const cards = document.querySelectorAll('#projectsCards .project-card');
        cards.forEach(card => card.style.display = 'none');

        // Show filtered cards
        filteredProjects.forEach(project => {
            const card = document.querySelector(`.project-card[data-project-id="${project.id}"]`);
            if (card) {
                card.style.display = '';
            }
        });
    }

    function showNotification(message, type = 'info') {
        // –°–æ–∑–¥–∞–µ–º –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä –¥–ª—è —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π, –µ—Å–ª–∏ –µ–≥–æ –Ω–µ—Ç
        let notificationContainer = document.getElementById('notification-container');
        if (!notificationContainer) {
            notificationContainer = document.createElement('div');
            notificationContainer.id = 'notification-container';
            notificationContainer.style.cssText = `
                position: fixed;
                top: 20px;
                right: 20px;
                z-index: 9999;
                max-width: 400px;
            `;
            document.body.appendChild(notificationContainer);
        }
        
        // –°–æ–∑–¥–∞–µ–º —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ
        const notification = document.createElement('div');
        notification.className = `alert alert-${type} alert-dismissible fade show`;
        notification.style.cssText = `
            margin-bottom: 10px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        `;
        
        const iconMap = {
            'success': 'fas fa-check-circle',
            'danger': 'fas fa-exclamation-circle',
            'warning': 'fas fa-exclamation-triangle',
            'info': 'fas fa-info-circle'
        };
        
        notification.innerHTML = `
            <i class="${iconMap[type] || iconMap.info} me-2"></i>
            ${message}
            <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
        `;
        
        notificationContainer.appendChild(notification);
        
        // –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–µ —É–¥–∞–ª–µ–Ω–∏–µ —á–µ—Ä–µ–∑ 5 —Å–µ–∫—É–Ω–¥
        setTimeout(() => {
            if (notification.parentNode) {
                notification.classList.remove('show');
                setTimeout(() => {
                    if (notification.parentNode) {
                        notification.parentNode.removeChild(notification);
                    }
                }, 150);
            }
        }, 5000);
    }

    // Project Management
    async function updateStatus(projectId, newStatus, comment = '') {
        try {
            const response = await fetch(`/admin/api/projects/${projectId}/status`, {
                method: 'PUT',
                headers: {
                    'Content-Type': 'application/json',
                    'Authorization': 'Basic ' + btoa(`${username}:${password}`)
                },
                body: JSON.stringify({ status: newStatus, comment })
            });
            
            const data = await response.json();
            
            if (data.success) {
                showNotification('–°—Ç–∞—Ç—É—Å –ø—Ä–æ–µ–∫—Ç–∞ —É—Å–ø–µ—à–Ω–æ –æ–±–Ω–æ–≤–ª–µ–Ω!', 'success');
                // –û–±–Ω–æ–≤–ª—è–µ–º —Å—Ç–∞—Ç—É—Å –≤ UI
                updateStatusInUI(projectId, newStatus);
                // –û–±–Ω–æ–≤–ª—è–µ–º –ø—Ä–æ–≥—Ä–µ—Å—Å-–±–∞—Ä
                updateProgressBar(projectId, newStatus);
            } else {
                showNotification(data.message || '–û—à–∏–±–∫–∞ –ø—Ä–∏ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–∏ —Å—Ç–∞—Ç—É—Å–∞ –ø—Ä–æ–µ–∫—Ç–∞.', 'danger');
            }
        } catch (error) {
            showNotification('–ö—Ä–∏—Ç–∏—á–µ—Å–∫–∞—è –æ—à–∏–±–∫–∞ –ø—Ä–∏ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–∏ —Å—Ç–∞—Ç—É—Å–∞: ' + error.message, 'danger');
        }
    }
    
    document.addEventListener('DOMContentLoaded', () => {
        // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è —Ñ–∏–ª—å—Ç—Ä–æ–≤
        initializeFilters();
        changeView(currentView);
        sortProjects();
        loadProjectStatuses();
    });
    
    // –§—É–Ω–∫—Ü–∏—è –¥–ª—è –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏–∏ —Ñ–∏–ª—å—Ç—Ä–æ–≤
    function initializeFilters() {
        // –£–±–µ–∂–¥–∞–µ–º—Å—è, —á—Ç–æ –≤—Å–µ —ç–ª–µ–º–µ–Ω—Ç—ã —Å—É—â–µ—Å—Ç–≤—É—é—Ç
        const searchInput = document.getElementById('searchInput');
        const statusFilter = document.getElementById('statusFilter');
        const complexityFilter = document.getElementById('complexityFilter');
        const sortBy = document.getElementById('sortBy');
        
        if (!searchInput || !statusFilter || !complexityFilter || !sortBy) {
            console.error('–ù–µ–∫–æ—Ç–æ—Ä—ã–µ —ç–ª–µ–º–µ–Ω—Ç—ã —Ñ–∏–ª—å—Ç—Ä–æ–≤ –Ω–µ –Ω–∞–π–¥–µ–Ω—ã');
            return;
        }
        
        // –ó–∞–ø–æ–ª–Ω—è–µ–º —Ñ–∏–ª—å—Ç—Ä—ã –æ–ø—Ü–∏—è–º–∏, –µ—Å–ª–∏ –æ–Ω–∏ –ø—É—Å—Ç—ã–µ
        if (statusFilter.children.length <= 1) {
            const statusOptions = [
                { value: '', text: '–í—Å–µ —Å—Ç–∞—Ç—É—Å—ã' },
                { value: 'new', text: '–ù–æ–≤—ã–µ' },
                { value: 'review', text: '–ù–∞ —Ä–∞—Å—Å–º–æ—Ç—Ä–µ–Ω–∏–∏' },
                { value: 'accepted', text: '–ü—Ä–∏–Ω—è—Ç—ã–µ' },
                { value: 'in_progress', text: '–í —Ä–∞–±–æ—Ç–µ' },
                { value: 'testing', text: '–¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ' },
                { value: 'completed', text: '–ó–∞–≤–µ—Ä—à–µ–Ω–Ω—ã–µ' },
                { value: 'cancelled', text: '–û—Ç–º–µ–Ω–µ–Ω–Ω—ã–µ' },
                { value: 'on_hold', text: '–ü—Ä–∏–æ—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–Ω—ã–µ' }
            ];
            
            statusOptions.forEach(option => {
                if (!statusFilter.querySelector(`option[value="${option.value}"]`)) {
                    const opt = document.createElement('option');
                    opt.value = option.value;
                    opt.textContent = option.text;
                    statusFilter.appendChild(opt);
                }
            });
        }
        
        if (complexityFilter.children.length <= 1) {
            const complexityOptions = [
                { value: '', text: '–í—Å–µ —Å–ª–æ–∂–Ω–æ—Å—Ç–∏' },
                { value: 'simple', text: '–ü—Ä–æ—Å—Ç—ã–µ' },
                { value: 'medium', text: '–°—Ä–µ–¥–Ω–∏–µ' },
                { value: 'complex', text: '–°–ª–æ–∂–Ω—ã–µ' },
                { value: 'premium', text: '–ü—Ä–µ–º–∏—É–º' }
            ];
            
            complexityOptions.forEach(option => {
                if (!complexityFilter.querySelector(`option[value="${option.value}"]`)) {
                    const opt = document.createElement('option');
                    opt.value = option.value;
                    opt.textContent = option.text;
                    complexityFilter.appendChild(opt);
                }
            });
        }
        
        if (sortBy.children.length <= 1) {
            const sortOptions = [
                { value: 'created_at', text: '–ü–æ –¥–∞—Ç–µ —Å–æ–∑–¥–∞–Ω–∏—è' },
                { value: 'updated_at', text: '–ü–æ –¥–∞—Ç–µ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è' },
                { value: 'estimated_cost', text: '–ü–æ —Å—Ç–æ–∏–º–æ—Å—Ç–∏' },
                { value: 'title', text: '–ü–æ –Ω–∞–∑–≤–∞–Ω–∏—é' }
            ];
            
            sortOptions.forEach(option => {
                if (!sortBy.querySelector(`option[value="${option.value}"]`)) {
                    const opt = document.createElement('option');
                    opt.value = option.value;
                    opt.textContent = option.text;
                    sortBy.appendChild(opt);
                }
            });
        }
    }

    // –§—É–Ω–∫—Ü–∏—è –¥–ª—è –∑–∞–≥—Ä—É–∑–∫–∏ —Å—Ç–∞—Ç—É—Å–æ–≤ –ø—Ä–æ–µ–∫—Ç–æ–≤
    async function loadProjectStatuses() {
        try {
            const response = await fetch('/admin/api/project-statuses/', {
                headers: {
                    'Authorization': 'Basic ' + btoa(`${username}:${password}`)
                }
            });
            
            if (response.ok) {
                const data = await response.json();
                if (data.success) {
                    projectStatuses = data.data;
                    applyCustomStatusStyles();
                }
            }
        } catch (error) {
            console.error('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ —Å—Ç–∞—Ç—É—Å–æ–≤:', error);
        }
    }

    // –§—É–Ω–∫—Ü–∏—è –¥–ª—è —Å–æ–∑–¥–∞–Ω–∏—è CSS –∫–ª–∞—Å—Å–∞ –∏–∑ –Ω–∞–∑–≤–∞–Ω–∏—è —Å—Ç–∞—Ç—É—Å–∞
    function createStatusClass(statusName) {
        return 'status-' + statusName.toLowerCase()
            .replace(/\s+/g, '_')
            .replace(/[^\w_]/g, '')
            .replace(/_+/g, '_');
    }

    // –§—É–Ω–∫—Ü–∏—è –¥–ª—è –ø—Ä–∏–º–µ–Ω–µ–Ω–∏—è —Å—Ç–∏–ª–µ–π –∫ –∫–∞—Å—Ç–æ–º–Ω—ã–º —Å—Ç–∞—Ç—É—Å–∞–º
    function applyCustomStatusStyles() {
        // –°–æ–∑–¥–∞–µ–º —Å—Ç–∏–ª–∏ –¥–ª—è –∫–∞–∂–¥–æ–≥–æ —Å—Ç–∞—Ç—É—Å–∞ –Ω–∞ –æ—Å–Ω–æ–≤–µ –µ–≥–æ —Ü–≤–µ—Ç–∞
        const style = document.createElement('style');
        let css = '';
        
        projectStatuses.forEach(status => {
            const className = createStatusClass(status.name);
            const color = status.color || '#6c757d';
            
            css += `
                .${className} {
                    background-color: ${color} !important;
                    color: #ffffff !important;
                    border: 1px solid ${color} !important;
                    font-weight: 500 !important;
                    padding: 0.5em 0.75em !important;
                    border-radius: 0.375rem !important;
                    font-size: 0.875rem !important;
                    display: inline-flex !important;
                    align-items: center !important;
                    gap: 0.25rem !important;
                    transition: all 0.2s ease !important;
                    text-shadow: none !important;
                    opacity: 1 !important;
                }
                
                .${className}:hover {
                    transform: translateY(-1px) !important;
                    box-shadow: 0 2px 4px rgba(0,0,0,0.1) !important;
                    filter: brightness(1.1) !important;
                }
            `;
        });
        
        style.textContent = css;
        document.head.appendChild(style);
        
        // –û–±–Ω–æ–≤–ª—è–µ–º –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏–µ —Å—Ç–∞—Ç—É—Å–æ–≤ –Ω–∞ —Å—Ç—Ä–∞–Ω–∏—Ü–µ
        updateStatusDisplay();
    }

    // –§—É–Ω–∫—Ü–∏—è –¥–ª—è –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è —Å—Ç–∞—Ç—É—Å–æ–≤
    function updateStatusDisplay() {
        // –ù–∞—Ö–æ–¥–∏–º –≤—Å–µ —ç–ª–µ–º–µ–Ω—Ç—ã —Å–æ —Å—Ç–∞—Ç—É—Å–∞–º–∏ –∏ –æ–±–Ω–æ–≤–ª—è–µ–º –∏—Ö –∫–ª–∞—Å—Å—ã
        const statusBadges = document.querySelectorAll('.badge[class*="status-"]');
        
        statusBadges.forEach(badge => {
            const statusText = badge.textContent.trim();
            
            // –ù–∞—Ö–æ–¥–∏–º —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤—É—é—â–∏–π —Å—Ç–∞—Ç—É—Å –≤ –Ω–∞—à–µ–º —Å–ø–∏—Å–∫–µ
            const matchingStatus = projectStatuses.find(status => 
                statusText.includes(status.name) || 
                badge.classList.contains(`status-${status.id}`)
            );
            
            if (matchingStatus) {
                // –£–¥–∞–ª—è–µ–º —Å—Ç–∞—Ä—ã–µ –∫–ª–∞—Å—Å—ã —Å—Ç–∞—Ç—É—Å–æ–≤
                badge.className = badge.className.replace(/\bstatus-[^\s]*/g, '');
                
                // –î–æ–±–∞–≤–ª—è–µ–º –Ω–æ–≤—ã–π –∫–ª–∞—Å—Å
                const newClass = createStatusClass(matchingStatus.name);
                badge.classList.add('badge', newClass);
            }
        });
    }

    // –§—É–Ω–∫—Ü–∏—è –¥–ª—è –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è –¥–∏–∞–ª–æ–≥–∞ —Å–º–µ–Ω—ã —Å—Ç–∞—Ç—É—Å–∞
    function showStatusChangeDialog(projectId, currentStatus) {
        document.getElementById('changeStatusProjectId').value = projectId;
        document.getElementById('changeStatusCurrentStatus').textContent = getStatusName(currentStatus);
        
        // –ó–∞–ø–æ–ª–Ω—è–µ–º –≤—ã–ø–∞–¥–∞—é—â–∏–π —Å–ø–∏—Å–æ–∫ —Å—Ç–∞—Ç—É—Å–∞–º–∏
        const statusSelect = document.getElementById('changeStatusNewStatus');
        statusSelect.innerHTML = '<option value="">–í—ã–±–µ—Ä–∏—Ç–µ —Å—Ç–∞—Ç—É—Å...</option>';
        
        projectStatuses.forEach(status => {
            if (status.name.toLowerCase() !== currentStatus) {
                const option = document.createElement('option');
                option.value = status.id;
                option.textContent = status.name;
                statusSelect.appendChild(option);
            }
        });
        
        // –°–±—Ä–∞—Å—ã–≤–∞–µ–º —Å–æ—Å—Ç–æ—è–Ω–∏–µ —Ñ–æ—Ä–º—ã
        document.getElementById('changeStatusComment').value = '';
        document.getElementById('useCustomStatus').checked = false;
        document.getElementById('customStatusGroup').classList.add('d-none');
        document.getElementById('customStatusName').value = '';
        statusSelect.disabled = false;
        
        updateSelectedStatusName();
        
        // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –º–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ
        const modal = new bootstrap.Modal(document.getElementById('changeStatusModal'));
        modal.show();
    }

    // –§—É–Ω–∫—Ü–∏—è –¥–ª—è –ø–æ–ª—É—á–µ–Ω–∏—è —á–∏—Ç–∞–µ–º–æ–≥–æ –∏–º–µ–Ω–∏ —Å—Ç–∞—Ç—É—Å–∞
    function getStatusName(status) {
        const statusNames = {
            'new': 'üÜï –ù–æ–≤—ã–π',
            'review': 'üëÄ –ù–∞ —Ä–∞—Å—Å–º–æ—Ç—Ä–µ–Ω–∏–∏',
            'accepted': '‚úÖ –ü—Ä–∏–Ω—è—Ç',
            'in_progress': 'üîÑ –í —Ä–∞–±–æ—Ç–µ',
            'testing': 'üß™ –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ',
            'completed': 'üéâ –ó–∞–≤–µ—Ä—à–µ–Ω',
            'cancelled': '‚ùå –û—Ç–º–µ–Ω–µ–Ω',
            'on_hold': '‚è∏Ô∏è –ü—Ä–∏–æ—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω'
        };
        return statusNames[status] || status;
    }

    // –§—É–Ω–∫—Ü–∏—è –¥–ª—è –ø–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏—è –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è –∫–∞—Å—Ç–æ–º–Ω–æ–≥–æ —Å—Ç–∞—Ç—É—Å–∞
    function toggleCustomStatus() {
        const useCustom = document.getElementById('useCustomStatus').checked;
        const customGroup = document.getElementById('customStatusGroup');
        const statusSelect = document.getElementById('changeStatusNewStatus');
        
        if (useCustom) {
            customGroup.classList.remove('d-none');
            statusSelect.disabled = true;
            statusSelect.value = '';
        } else {
            customGroup.classList.add('d-none');
            statusSelect.disabled = false;
            document.getElementById('customStatusName').value = '';
        }
        
        updateSelectedStatusName();
    }

    // –§—É–Ω–∫—Ü–∏—è –¥–ª—è –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è –Ω–∞–∑–≤–∞–Ω–∏—è –≤—ã–±—Ä–∞–Ω–Ω–æ–≥–æ —Å—Ç–∞—Ç—É—Å–∞
    function updateSelectedStatusName() {
        const useCustom = document.getElementById('useCustomStatus').checked;
        const selectedStatusName = document.getElementById('selectedStatusName');
        
        if (useCustom) {
            const customName = document.getElementById('customStatusName').value;
            selectedStatusName.textContent = customName || '–Ω–æ–≤—ã–π —Å—Ç–∞—Ç—É—Å';
        } else {
            const statusSelect = document.getElementById('changeStatusNewStatus');
            const selectedOption = statusSelect.options[statusSelect.selectedIndex];
            
            if (selectedOption && selectedOption.value) {
                selectedStatusName.textContent = selectedOption.text;
            } else {
                selectedStatusName.textContent = '—Å—Ç–∞—Ç—É—Å';
            }
        }
    }





    function calculateProgress(status) {
        const statusProgress = {
            'new': 10,
            'review': 25,
            'accepted': 40,
            'in_progress': 60,
            'testing': 80,
            'completed': 100,
            'cancelled': 0,
            'on_hold': 50
        };
        return statusProgress[status] || 0;
    }

    async function openEditModal(projectId) {
        try {
            const response = await fetch(`/admin/api/projects/${projectId}`, {
                headers: {
                    'Authorization': 'Basic ' + btoa(`${username}:${password}`)
                }
            });
            
            const data = await response.json();
            if (data.success && data.project) {
                const project = data.project;
                
                // –ó–∞–ø–æ–ª–Ω—è–µ–º —Ñ–æ—Ä–º—É —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è
                document.getElementById('editProjectId').value = project.id;
                document.getElementById('editProjectTitle').value = project.title || '';
                document.getElementById('editProjectDescription').value = project.description || '';
                document.getElementById('editProjectStatus').value = project.status || 'new';
                document.getElementById('editProjectComplexity').value = project.complexity || 'medium';
                document.getElementById('editProjectEstimatedCost').value = project.estimated_cost || '';
                document.getElementById('editProjectFinalCost').value = project.final_cost || '';
                
                const modal = new bootstrap.Modal(document.getElementById('editProjectModal'));
                modal.show();
            } else {
                showNotification(data.message || '–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –ø—Ä–æ–µ–∫—Ç–∞', 'danger');
            }
        } catch (error) {
            console.error('–û—à–∏–±–∫–∞ –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ –ø—Ä–æ–µ–∫—Ç–∞:', error);
            showNotification('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –ø—Ä–æ–µ–∫—Ç–∞: ' + error.message, 'danger');
        }
    }

    async function submitProjectEdit() {
        const projectId = document.getElementById('editProjectId').value;
        const title = document.getElementById('editProjectTitle').value;
        const description = document.getElementById('editProjectDescription').value;
        const status = document.getElementById('editProjectStatus').value;
        const complexity = document.getElementById('editProjectComplexity').value;
        const estimatedCost = document.getElementById('editProjectEstimatedCost').value;
        const finalCost = document.getElementById('editProjectFinalCost').value;
        
        if (!title.trim()) {
            showNotification('–ù–∞–∑–≤–∞–Ω–∏–µ –ø—Ä–æ–µ–∫—Ç–∞ –æ–±—è–∑–∞—Ç–µ–ª—å–Ω–æ', 'warning');
            return;
        }
        
        try {
            const response = await fetch(`/admin/api/projects/${projectId}`, {
                method: 'PUT',
                headers: {
                    'Content-Type': 'application/json',
                    'Authorization': 'Basic ' + btoa(`${username}:${password}`)
                },
                body: JSON.stringify({
                    title: title.trim(),
                    description: description.trim(),
                    status: status,
                    complexity: complexity,
                    estimated_cost: estimatedCost ? parseFloat(estimatedCost) : null,
                    final_cost: finalCost ? parseFloat(finalCost) : null
                })
            });
            
            const data = await response.json();
            if (data.success) {
                showNotification('–ü—Ä–æ–µ–∫—Ç —É—Å–ø–µ—à–Ω–æ –æ–±–Ω–æ–≤–ª–µ–Ω!', 'success');
                
                const modal = bootstrap.Modal.getInstance(document.getElementById('editProjectModal'));
                modal.hide();
                
                // –û–±–Ω–æ–≤–ª—è–µ–º —Å—Ç—Ä–∞–Ω–∏—Ü—É
                setTimeout(() => {
                    window.location.reload();
                }, 1000);
            } else {
                showNotification(data.message || '–û—à–∏–±–∫–∞ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è –ø—Ä–æ–µ–∫—Ç–∞', 'danger');
            }
        } catch (error) {
            showNotification('–û—à–∏–±–∫–∞ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è –ø—Ä–æ–µ–∫—Ç–∞: ' + error.message, 'danger');
        }
    }

    async function contactClient(telegramId) {
        if (!telegramId) {
            showNotification('Telegram ID –∫–ª–∏–µ–Ω—Ç–∞ –Ω–µ —É–∫–∞–∑–∞–Ω', 'warning');
            return;
        }
        
        const message = prompt('–í–≤–µ–¥–∏—Ç–µ —Å–æ–æ–±—â–µ–Ω–∏–µ –¥–ª—è –∫–ª–∏–µ–Ω—Ç–∞:');
        if (!message || !message.trim()) {
            return;
        }
        
        try {
            const response = await fetch('/admin/api/send-message', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'Authorization': 'Basic ' + btoa(`${username}:${password}`)
                },
                body: JSON.stringify({
                    telegram_id: telegramId,
                    message: message.trim()
                })
            });
            
            const data = await response.json();
            if (data.success) {
                showNotification('–°–æ–æ–±—â–µ–Ω–∏–µ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–æ –∫–ª–∏–µ–Ω—Ç—É!', 'success');
            } else {
                showNotification(data.message || '–û—à–∏–±–∫–∞ –æ—Ç–ø—Ä–∞–≤–∫–∏ —Å–æ–æ–±—â–µ–Ω–∏—è', 'danger');
            }
        } catch (error) {
            showNotification('–û—à–∏–±–∫–∞ –æ—Ç–ø—Ä–∞–≤–∫–∏ —Å–æ–æ–±—â–µ–Ω–∏—è: ' + error.message, 'danger');
        }
    }

    function showCreateProjectModal() {
        // –û—á–∏—â–∞–µ–º —Ñ–æ—Ä–º—É
        document.getElementById('createProjectForm').reset();
        
        const modal = new bootstrap.Modal(document.getElementById('createProjectModal'));
        modal.show();
    }

    async function createProject() {
        const title = document.getElementById('createProjectTitle').value;
        const description = document.getElementById('createProjectDescription').value;
        const projectType = document.getElementById('createProjectType').value;
        const clientName = document.getElementById('createClientName').value;
        const clientTelegramId = document.getElementById('createClientTelegramId').value;
        const clientPhone = document.getElementById('createClientPhone').value;
        const complexity = document.getElementById('createProjectComplexity').value;
        const priority = document.getElementById('createProjectPriority').value;
        const status = document.getElementById('createProjectStatus').value;
        const estimatedCost = document.getElementById('createEstimatedCost').value;
        const executorCost = document.getElementById('createExecutorCost').value;
        const estimatedHours = document.getElementById('createEstimatedHours').value;
        const deadline = document.getElementById('createProjectDeadline').value;
        
        if (!title.trim()) {
            showNotification('–ù–∞–∑–≤–∞–Ω–∏–µ –ø—Ä–æ–µ–∫—Ç–∞ –æ–±—è–∑–∞—Ç–µ–ª—å–Ω–æ', 'warning');
            return;
        }
        
        if (!description.trim()) {
            showNotification('–û–ø–∏—Å–∞–Ω–∏–µ –ø—Ä–æ–µ–∫—Ç–∞ –æ–±—è–∑–∞—Ç–µ–ª—å–Ω–æ', 'warning');
            return;
        }
        
        try {
            const response = await fetch('/admin/api/projects/', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'Authorization': 'Basic ' + btoa(`${username}:${password}`)
                },
                body: JSON.stringify({
                    title: title.trim(),
                    description: description.trim(),
                    project_type: projectType,
                    client_name: clientName.trim(),
                    client_telegram_id: clientTelegramId.trim(),
                    client_phone: clientPhone.trim(),
                    complexity: complexity,
                    priority: priority,
                    status: status,
                    estimated_cost: estimatedCost ? parseFloat(estimatedCost) : null,
                    executor_cost: executorCost ? parseFloat(executorCost) : null,
                    estimated_hours: estimatedHours ? parseInt(estimatedHours) : null,
                    deadline: deadline || null
                })
            });
            
            const data = await response.json();
            if (data.success) {
                showNotification('–ü—Ä–æ–µ–∫—Ç —É—Å–ø–µ—à–Ω–æ —Å–æ–∑–¥–∞–Ω!', 'success');
                
                const modal = bootstrap.Modal.getInstance(document.getElementById('createProjectModal'));
                modal.hide();
                
                // –û–±–Ω–æ–≤–ª—è–µ–º —Å—Ç—Ä–∞–Ω–∏—Ü—É
                setTimeout(() => {
                    window.location.reload();
                }, 1000);
            } else {
                showNotification(data.message || '–û—à–∏–±–∫–∞ —Å–æ–∑–¥–∞–Ω–∏—è –ø—Ä–æ–µ–∫—Ç–∞', 'danger');
            }
        } catch (error) {
            showNotification('–û—à–∏–±–∫–∞ —Å–æ–∑–¥–∞–Ω–∏—è –ø—Ä–æ–µ–∫—Ç–∞: ' + error.message, 'danger');
        }
    }

    function editCurrentProject() {
        if (currentProjectId) {
            openEditModal(currentProjectId);
            
            const modal = bootstrap.Modal.getInstance(document.getElementById('projectModal'));
            if (modal) {
                modal.hide();
            }
        }
    }

    function refreshProjects() {
        window.location.reload();
    }

    async function exportProjects() {
        try {
            const response = await fetch('/admin/api/projects/export', {
                headers: {
                    'Authorization': 'Basic ' + btoa(`${username}:${password}`)
                }
            });
            
            if (response.ok) {
                const blob = await response.blob();
                const url = window.URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.style.display = 'none';
                a.href = url;
                a.download = `projects_export_${new Date().toISOString().split('T')[0]}.xlsx`;
                document.body.appendChild(a);
                a.click();
                window.URL.revokeObjectURL(url);
                showNotification('–≠–∫—Å–ø–æ—Ä—Ç –ø—Ä–æ–µ–∫—Ç–æ–≤ –∑–∞–≤–µ—Ä—à–µ–Ω!', 'success');
            } else {
                showNotification('–û—à–∏–±–∫–∞ —ç–∫—Å–ø–æ—Ä—Ç–∞ –ø—Ä–æ–µ–∫—Ç–æ–≤', 'danger');
            }
        } catch (error) {
            showNotification('–û—à–∏–±–∫–∞ —ç–∫—Å–ø–æ—Ä—Ç–∞: ' + error.message, 'danger');
        }
    }

    // –§—É–Ω–∫—Ü–∏—è –¥–ª—è –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏—è —Å–º–µ–Ω—ã —Å—Ç–∞—Ç—É—Å–∞
    async function confirmStatusChange() {
        const projectId = document.getElementById('changeStatusProjectId').value;
        const useCustom = document.getElementById('useCustomStatus').checked;
        const comment = document.getElementById('changeStatusComment').value;
        let statusId = null;
        
        if (useCustom) {
            const customName = document.getElementById('customStatusName').value.trim();
            if (!customName) {
                showNotification('–í–≤–µ–¥–∏—Ç–µ –Ω–∞–∑–≤–∞–Ω–∏–µ –Ω–æ–≤–æ–≥–æ —Å—Ç–∞—Ç—É—Å–∞', 'warning');
                return;
            }
            
            // –°–æ–∑–¥–∞–µ–º –Ω–æ–≤—ã–π —Å—Ç–∞—Ç—É—Å
            try {
                const response = await fetch('/admin/api/project-statuses/', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': 'Basic ' + btoa(`${username}:${password}`)
                    },
                    body: JSON.stringify({ name: customName })
                });
                
                const data = await response.json();
                if (data.success) {
                    statusId = data.data.id;
                    projectStatuses.push(data.data);
                } else {
                    showNotification(data.message || '–û—à–∏–±–∫–∞ —Å–æ–∑–¥–∞–Ω–∏—è —Å—Ç–∞—Ç—É—Å–∞', 'danger');
                    return;
                }
            } catch (error) {
                showNotification('–û—à–∏–±–∫–∞ —Å–æ–∑–¥–∞–Ω–∏—è —Å—Ç–∞—Ç—É—Å–∞: ' + error.message, 'danger');
                return;
            }
        } else {
            statusId = document.getElementById('changeStatusNewStatus').value;
        }
        
        if (!statusId) {
            showNotification('–í—ã–±–µ—Ä–∏—Ç–µ —Å—Ç–∞—Ç—É—Å', 'warning');
            return;
        }
        
        // –û–±–Ω–æ–≤–ª—è–µ–º —Å—Ç–∞—Ç—É—Å –ø—Ä–æ–µ–∫—Ç–∞
        try {
            const response = await fetch(`/admin/api/projects/${projectId}/status`, {
                method: 'PUT',
                headers: {
                    'Content-Type': 'application/json',
                    'Authorization': 'Basic ' + btoa(`${username}:${password}`)
                },
                body: JSON.stringify({ status_id: statusId, comment })
            });
            
            const data = await response.json();
            if (data.success) {
                showNotification('–°—Ç–∞—Ç—É—Å –ø—Ä–æ–µ–∫—Ç–∞ —É—Å–ø–µ—à–Ω–æ –∏–∑–º–µ–Ω–µ–Ω!', 'success');
                
                // –ó–∞–∫—Ä—ã–≤–∞–µ–º –º–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ
                const modal = bootstrap.Modal.getInstance(document.getElementById('changeStatusModal'));
                modal.hide();
                
                // –û–±–Ω–æ–≤–ª—è–µ–º —Å—Ç—Ä–∞–Ω–∏—Ü—É
                setTimeout(() => {
                    location.reload();
                }, 1000);
            } else {
                showNotification(data.message || '–û—à–∏–±–∫–∞ –∏–∑–º–µ–Ω–µ–Ω–∏—è —Å—Ç–∞—Ç—É—Å–∞', 'danger');
            }
        } catch (error) {
            showNotification('–û—à–∏–±–∫–∞ –∏–∑–º–µ–Ω–µ–Ω–∏—è —Å—Ç–∞—Ç—É—Å–∞: ' + error.message, 'danger');
        }
    }

    // –§—É–Ω–∫—Ü–∏—è –¥–ª—è –ø—Ä–æ—Å–º–æ—Ç—Ä–∞ –¥–µ—Ç–∞–ª–µ–π –ø—Ä–æ–µ–∫—Ç–∞
    async function viewProject(projectId) {
        try {
            const response = await fetch(`/admin/api/projects/${projectId}`, {
                headers: {
                    'Authorization': 'Basic ' + btoa(`${username}:${password}`)
                }
            });
            
            if (!response.ok) {
                throw new Error(`HTTP ${response.status}`);
            }
            
            const data = await response.json();
            
            if (data.success && data.project) {
                const project = data.project;
                currentProjectId = projectId;
                
                // –ó–∞–ø–æ–ª–Ω—è–µ–º –º–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ –¥–∞–Ω–Ω—ã–º–∏ –ø—Ä–æ–µ–∫—Ç–∞
                const modalBody = document.getElementById('projectModalBody');
                modalBody.innerHTML = `
                    <div class="row">
                        <div class="col-md-8">
                            <h4>${project.title}</h4>
                            <div class="mb-3">
                                <strong>–¢–µ—Ö–Ω–∏—á–µ—Å–∫–æ–µ –∑–∞–¥–∞–Ω–∏–µ:</strong>
                                <div class="description-container" style="max-height: 150px; overflow-y: auto; border: 1px solid #e9ecef; border-radius: 0.375rem; padding: 10px; background-color: #f8f9fa;">
                                    <div class="description-text" style="white-space: pre-wrap; font-size: 0.95rem; line-height: 1.4;">
                                        ${project.description || '–û–ø–∏—Å–∞–Ω–∏–µ –æ—Ç—Å—É—Ç—Å—Ç–≤—É–µ—Ç'}
                                    </div>
                                </div>
                            </div>
                            
                            <div class="row mt-3">
                                <div class="col-md-6">
                                    <strong>–°—Ç–∞—Ç—É—Å:</strong>
                                    <span class="badge status-${project.status} ms-2">${getStatusName(project.status)}</span>
                                </div>
                                <div class="col-md-6">
                                    <strong>–°–ª–æ–∂–Ω–æ—Å—Ç—å:</strong>
                                    <span class="badge complexity-${project.complexity} ms-2">${project.complexity}</span>
                                </div>
                            </div>
                            
                            <div class="row mt-2">
                                <div class="col-md-6">
                                    <strong>–°—Ç–æ–∏–º–æ—Å—Ç—å:</strong> ${(project.estimated_cost || 0)}‚ÇΩ
                                    ${project.final_cost && project.final_cost != project.estimated_cost ? 
                                        `<br><small class="text-success">–§–∏–Ω–∞–ª—å–Ω–∞—è: ${project.final_cost}‚ÇΩ</small>` : ''}
                                </div>
                                <div class="col-md-6">
                                    <strong>–î–∞—Ç–∞ —Å–æ–∑–¥–∞–Ω–∏—è:</strong> ${project.created_at ? new Date(project.created_at).toLocaleDateString() : '–ù/–î'}
                                    ${project.updated_at && project.updated_at != project.created_at ? 
                                        `<br><small class="text-muted">–û–±–Ω–æ–≤–ª–µ–Ω: ${new Date(project.updated_at).toLocaleDateString()}</small>` : ''}
                                </div>
                            </div>
                            
                            <div class="row mt-2">
                                <div class="col-md-6">
                                    <strong>–¢–∏–ø –ø—Ä–æ–µ–∫—Ç–∞:</strong> ${project.project_type || '–ù–µ —É–∫–∞–∑–∞–Ω'}
                                </div>
                                <div class="col-md-6">
                                    <strong>–ü—Ä–∏–æ—Ä–∏—Ç–µ—Ç:</strong> ${project.priority || '–û–±—ã—á–Ω—ã–π'}
                                </div>
                            </div>
                            
                            ${project.deadline ? `
                            <div class="row mt-2">
                                <div class="col-md-12">
                                    <strong>–î–µ–¥–ª–∞–π–Ω:</strong> <span class="text-warning">${new Date(project.deadline).toLocaleDateString()}</span>
                                </div>
                            </div>
                            ` : ''}
                            
                            ${project.estimated_hours ? `
                            <div class="row mt-2">
                                <div class="col-md-6">
                                    <strong>–ü–ª–∞–Ω–∏—Ä—É–µ–º–æ–µ –≤—Ä–µ–º—è:</strong> ${project.estimated_hours}—á
                                </div>
                                <div class="col-md-6">
                                    <strong>–ó–∞—Ç—Ä–∞—á–µ–Ω–æ –≤—Ä–µ–º–µ–Ω–∏:</strong> ${project.actual_hours || 0}—á
                                </div>
                            </div>
                            ` : ''}
                            
                            ${project.user ? `
                            <div class="mt-4">
                                <h5><i class="fas fa-user me-2"></i>–ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ –∑–∞–∫–∞–∑—á–∏–∫–µ</h5>
                                <div class="card">
                                    <div class="card-body">
                                        <div class="row">
                                            <div class="col-md-8">
                                                <div class="d-flex align-items-center mb-2">
                                                    <div class="user-avatar me-3">${(project.user.first_name || 'U')[0]}</div>
                                                    <div>
                                                        <div><strong>${project.user.first_name || '–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–æ'} ${project.user.last_name || ''}</strong></div>
                                                        <small class="text-muted">@${project.user.username || '–Ω–µ—Ç username'}</small>
                                                    </div>
                                                </div>
                                                
                                                <div class="row mt-2">
                                                    <div class="col-md-6">
                                                        <small class="text-muted">Telegram ID:</small><br>
                                                        <span class="badge bg-info">${project.user.telegram_id || '–ù–µ —É–∫–∞–∑–∞–Ω'}</span>
                                                    </div>
                                                    <div class="col-md-6">
                                                        <small class="text-muted">–¢–µ–ª–µ—Ñ–æ–Ω:</small><br>
                                                        <span>${project.user.phone || '–ù–µ —É–∫–∞–∑–∞–Ω'}</span>
                                                    </div>
                                                </div>
                                                
                                                <div class="row mt-2">
                                                    <div class="col-md-6">
                                                        <small class="text-muted">–†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è:</small><br>
                                                        <span>${project.user.created_at ? new Date(project.user.created_at).toLocaleDateString() : '–ù/–î'}</span>
                                                    </div>
                                                    <div class="col-md-6">
                                                        <small class="text-muted">–°—Ç–∞—Ç—É—Å:</small><br>
                                                        <span class="badge ${project.user.is_active ? 'bg-success' : 'bg-secondary'}">${project.user.is_active ? '–ê–∫—Ç–∏–≤–µ–Ω' : '–ù–µ–∞–∫—Ç–∏–≤–µ–Ω'}</span>
                                                    </div>
                                                </div>
                                            </div>
                                            <div class="col-md-4 text-end">
                                                ${project.user.telegram_id ? `
                                                <button class="btn btn-outline-primary btn-sm" onclick="contactClient('${project.user.telegram_id}')">
                                                    <i class="fas fa-comment me-1"></i>–ù–∞–ø–∏—Å–∞—Ç—å
                                                </button>
                                                ` : ''}
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            ` : ''}
                            
                            <!-- –¢–µ—Ö–Ω–∏—á–µ—Å–∫–∞—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è -->
                            <div class="mt-4">
                                <h5><i class="fas fa-cogs me-2"></i>–¢–µ—Ö–Ω–∏—á–µ—Å–∫–∞—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è</h5>
                                <div class="card">
                                    <div class="card-body">
                                        <div class="row">
                                            <div class="col-md-6">
                                                <h6><i class="fas fa-robot me-2"></i>Telegram Bot</h6>
                                                ${project.bot_token ? `
                                                <div class="mb-2">
                                                    <small class="text-muted">–¢–æ–∫–µ–Ω –±–æ—Ç–∞:</small><br>
                                                    <code class="text-break">${project.bot_token}</code>
                                                    <button class="btn btn-link btn-sm p-0 ms-2" onclick="copyToClipboard('${project.bot_token}')">
                                                        <i class="fas fa-copy"></i>
                                                    </button>
                                                </div>
                                                ` : '<p class="text-muted">–¢–æ–∫–µ–Ω –±–æ—Ç–∞ –Ω–µ —É–∫–∞–∑–∞–Ω</p>'}
                                            </div>
                                            <div class="col-md-6">
                                                <h6><i class="fas fa-server me-2"></i>Timeweb</h6>
                                                ${project.timeweb && project.timeweb.has_credentials ? `
                                                <div class="mb-2">
                                                    <small class="text-muted">–õ–æ–≥–∏–Ω:</small><br>
                                                    <code>${project.timeweb.login || '–ù–µ —É–∫–∞–∑–∞–Ω'}</code>
                                                    ${project.timeweb.login ? `
                                                    <button class="btn btn-link btn-sm p-0 ms-2" onclick="copyToClipboard('${project.timeweb.login}')">
                                                        <i class="fas fa-copy"></i>
                                                    </button>
                                                    ` : ''}
                                                </div>
                                                ${project.timeweb.password ? `
                                                <div class="mb-2">
                                                    <small class="text-muted">–ü–∞—Ä–æ–ª—å:</small><br>
                                                    <code>${project.timeweb.password}</code>
                                                    <button class="btn btn-link btn-sm p-0 ms-2" onclick="copyToClipboard('${project.timeweb.password}')">
                                                        <i class="fas fa-copy"></i>
                                                    </button>
                                                </div>
                                                ` : ''}
                                                ` : '<p class="text-muted">–î–∞–Ω–Ω—ã–µ Timeweb –Ω–µ —É–∫–∞–∑–∞–Ω—ã</p>'}
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <div class="col-md-4">
                            <div class="card">
                                <div class="card-header">
                                    <h6 class="mb-0">–ü—Ä–æ–≥—Ä–µ—Å—Å –ø—Ä–æ–µ–∫—Ç–∞</h6>
                                </div>
                                <div class="card-body">
                                    <div class="progress mb-2" style="height: 10px;">
                                        <div class="progress-bar" style="width: ${calculateProgress(project.status)}%"></div>
                                    </div>
                                    <small class="text-muted">${calculateProgress(project.status)}% –∑–∞–≤–µ—Ä—à–µ–Ω–æ</small>
                                </div>
                            </div>
                        </div>
                    </div>
                `;
                
                // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –º–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ
                const modal = new bootstrap.Modal(document.getElementById('projectModal'));
                modal.show();
            } else {
                console.error('–û—à–∏–±–∫–∞ API:', data);
                showNotification(data.message || '–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –ø—Ä–æ–µ–∫—Ç–∞', 'danger');
            }
        } catch (error) {
            console.error('–û—à–∏–±–∫–∞ –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ –ø—Ä–æ–µ–∫—Ç–∞:', error);
            showNotification('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –ø—Ä–æ–µ–∫—Ç–∞: ' + error.message, 'danger');
        }
    }

    // –§—É–Ω–∫—Ü–∏—è –¥–ª—è —Å–≤—è–∑–∏ —Å –∫–ª–∏–µ–Ω—Ç–æ–º




    // –§—É–Ω–∫—Ü–∏–∏ –¥–ª—è —Ä–∞–±–æ—Ç—ã —Å —Ñ–∞–π–ª–∞–º–∏ –ø—Ä–æ–µ–∫—Ç–æ–≤
    async function showFilesModal(projectId) {
        try {
            // –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º ID –ø—Ä–æ–µ–∫—Ç–∞ –¥–ª—è –∑–∞–≥—Ä—É–∑–∫–∏ —Ñ–∞–π–ª–æ–≤
            document.getElementById('uploadProjectId').value = projectId;
            
            // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –º–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ
            const modal = new bootstrap.Modal(document.getElementById('projectFilesModal'));
            modal.show();
            
            // –ó–∞–≥—Ä—É–∂–∞–µ–º —Ñ–∞–π–ª—ã –ø—Ä–æ–µ–∫—Ç–∞
            await loadProjectFiles(projectId);
        } catch (error) {
            console.error('–û—à–∏–±–∫–∞ –ø–æ–∫–∞–∑–∞ –º–æ–¥–∞–ª—å–Ω–æ–≥–æ –æ–∫–Ω–∞ —Ñ–∞–π–ª–æ–≤:', error);
            showNotification('–û—à–∏–±–∫–∞ –æ—Ç–∫—Ä—ã—Ç–∏—è —Ñ–∞–π–ª–æ–≤ –ø—Ä–æ–µ–∫—Ç–∞: ' + error.message, 'danger');
        }
    }

    async function loadProjectFiles(projectId) {
        try {
            const response = await fetch(`/admin/api/projects/${projectId}/files`, {
                headers: {
                    'Authorization': 'Basic ' + btoa(`${username}:${password}`)
                }
            });
            
            if (!response.ok) {
                throw new Error(`HTTP ${response.status}`);
            }
            
            const data = await response.json();
            
            if (data.success && data.files) {
                displayProjectFiles(data.files);
            } else {
                throw new Error(data.message || '–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ —Ñ–∞–π–ª–æ–≤');
            }
        } catch (error) {
            console.error('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ —Ñ–∞–π–ª–æ–≤:', error);
            const container = document.getElementById('projectFilesContent');
            container.innerHTML = `
                <div class="text-center p-4 text-muted">
                    <i class="fas fa-exclamation-triangle fa-2x mb-2"></i>
                    <p>–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ —Ñ–∞–π–ª–æ–≤: ${error.message}</p>
                    <button class="btn btn-outline-primary btn-sm" onclick="loadProjectFiles(${projectId})">
                        <i class="fas fa-sync-alt me-1"></i>–ü–æ–≤—Ç–æ—Ä–∏—Ç—å
                    </button>
                </div>
            `;
        }
    }

    function displayProjectFiles(files) {
        const container = document.getElementById('projectFilesContent');
        
        if (!files || files.length === 0) {
            container.innerHTML = `
                <div class="text-center p-4 text-muted">
                    <i class="fas fa-folder-open fa-2x mb-2"></i>
                    <p>–§–∞–π–ª—ã –¥–ª—è —ç—Ç–æ–≥–æ –ø—Ä–æ–µ–∫—Ç–∞ –Ω–µ –Ω–∞–π–¥–µ–Ω—ã</p>
                    <small>–ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ —Ñ–æ—Ä–º—É –Ω–∏–∂–µ –¥–ª—è –∑–∞–≥—Ä—É–∑–∫–∏ –ø–µ—Ä–≤–æ–≥–æ —Ñ–∞–π–ª–∞</small>
                </div>
            `;
            return;
        }
        
        const filesHtml = files.map(file => `
            <div class="file-item d-flex align-items-center justify-content-between p-3 border rounded mb-2">
                <div class="d-flex align-items-center">
                    <div class="file-icon me-3">
                        ${getFileIcon(file.filename)}
                    </div>
                    <div>
                        <div class="fw-medium">${file.filename}</div>
                        <small class="text-muted">
                            ${formatFileSize(file.size)} ‚Ä¢ 
                            ${file.uploaded_at ? new Date(file.uploaded_at).toLocaleDateString() : '–î–∞—Ç–∞ –Ω–µ–∏–∑–≤–µ—Å—Ç–Ω–∞'}
                        </small>
                        ${file.description ? `<div class="text-muted small mt-1">${file.description}</div>` : ''}
                    </div>
                </div>
                <div class="btn-group btn-group-sm">
                    <button class="btn btn-outline-primary" onclick="downloadFile(${file.id})" title="–°–∫–∞—á–∞—Ç—å">
                        <i class="fas fa-download"></i>
                    </button>
                    <button class="btn btn-outline-danger" onclick="deleteFile(${file.id}, '${file.filename}')" title="–£–¥–∞–ª–∏—Ç—å">
                        <i class="fas fa-trash"></i>
                    </button>
                </div>
            </div>
        `).join('');
        
        container.innerHTML = `
            <div class="files-list">
                <h6 class="mb-3">
                    <i class="fas fa-files me-2"></i>–§–∞–π–ª—ã –ø—Ä–æ–µ–∫—Ç–∞ (${files.length})
                </h6>
                ${filesHtml}
            </div>
        `;
    }

    function getFileIcon(filename) {
        const extension = filename.split('.').pop().toLowerCase();
        const iconMap = {
            'pdf': '<i class="fas fa-file-pdf text-danger"></i>',
            'doc': '<i class="fas fa-file-word text-primary"></i>',
            'docx': '<i class="fas fa-file-word text-primary"></i>',
            'xls': '<i class="fas fa-file-excel text-success"></i>',
            'xlsx': '<i class="fas fa-file-excel text-success"></i>',
            'ppt': '<i class="fas fa-file-powerpoint text-warning"></i>',
            'pptx': '<i class="fas fa-file-powerpoint text-warning"></i>',
            'jpg': '<i class="fas fa-file-image text-info"></i>',
            'jpeg': '<i class="fas fa-file-image text-info"></i>',
            'png': '<i class="fas fa-file-image text-info"></i>',
            'gif': '<i class="fas fa-file-image text-info"></i>',
            'zip': '<i class="fas fa-file-archive text-secondary"></i>',
            'rar': '<i class="fas fa-file-archive text-secondary"></i>',
            'txt': '<i class="fas fa-file-alt text-muted"></i>',
            'py': '<i class="fas fa-file-code text-warning"></i>',
            'js': '<i class="fas fa-file-code text-warning"></i>',
            'html': '<i class="fas fa-file-code text-warning"></i>',
            'css': '<i class="fas fa-file-code text-warning"></i>'
        };
        return iconMap[extension] || '<i class="fas fa-file text-muted"></i>';
    }

    function formatFileSize(bytes) {
        if (!bytes) return '0 –ë';
        const sizes = ['–ë', '–ö–ë', '–ú–ë', '–ì–ë'];
        const i = Math.floor(Math.log(bytes) / Math.log(1024));
        return Math.round(bytes / Math.pow(1024, i) * 100) / 100 + ' ' + sizes[i];
    }

    async function uploadProjectFile() {
        const projectId = document.getElementById('uploadProjectId').value;
        const fileInput = document.getElementById('projectFileUpload');
        const description = document.getElementById('projectFileDescription').value;
        
        if (!fileInput.files.length) {
            showNotification('–í—ã–±–µ—Ä–∏—Ç–µ —Ñ–∞–π–ª –¥–ª—è –∑–∞–≥—Ä—É–∑–∫–∏', 'warning');
            return;
        }
        
        const file = fileInput.files[0];
        const formData = new FormData();
        formData.append('file', file);
        formData.append('project_id', projectId);
        if (description.trim()) {
            formData.append('description', description.trim());
        }
        
        try {
            // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –ø—Ä–æ–≥—Ä–µ—Å—Å –∑–∞–≥—Ä—É–∑–∫–∏
            const uploadBtn = document.querySelector('button[onclick="uploadProjectFile()"]');
            const originalText = uploadBtn.innerHTML;
            uploadBtn.innerHTML = '<i class="fas fa-spinner fa-spin me-1"></i>–ó–∞–≥—Ä—É–∑–∫–∞...';
            uploadBtn.disabled = true;
            
            const response = await fetch('/admin/api/projects/files/upload', {
                method: 'POST',
                headers: {
                    'Authorization': 'Basic ' + btoa(`${username}:${password}`)
                },
                body: formData
            });
            
            const data = await response.json();
            
            if (data.success) {
                showNotification('–§–∞–π–ª —É—Å–ø–µ—à–Ω–æ –∑–∞–≥—Ä—É–∂–µ–Ω!', 'success');
                
                // –û—á–∏—â–∞–µ–º —Ñ–æ—Ä–º—É
                fileInput.value = '';
                document.getElementById('projectFileDescription').value = '';
                
                // –û–±–Ω–æ–≤–ª—è–µ–º —Å–ø–∏—Å–æ–∫ —Ñ–∞–π–ª–æ–≤
                await loadProjectFiles(projectId);
            } else {
                throw new Error(data.message || '–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ —Ñ–∞–π–ª–∞');
            }
        } catch (error) {
            showNotification('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ —Ñ–∞–π–ª–∞: ' + error.message, 'danger');
        } finally {
            // –í–æ—Å—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –∫–Ω–æ–ø–∫—É
            const uploadBtn = document.querySelector('button[onclick="uploadProjectFile()"]');
            uploadBtn.innerHTML = originalText;
            uploadBtn.disabled = false;
        }
    }

    async function downloadFile(fileId) {
        try {
            const response = await fetch(`/admin/api/files/${fileId}/download`, {
                headers: {
                    'Authorization': 'Basic ' + btoa(`${username}:${password}`)
                }
            });
            
            if (!response.ok) {
                throw new Error(`HTTP ${response.status}`);
            }
            
            // –ü–æ–ª—É—á–∞–µ–º –Ω–∞–∑–≤–∞–Ω–∏–µ —Ñ–∞–π–ª–∞ –∏–∑ –∑–∞–≥–æ–ª–æ–≤–∫–∞
            const contentDisposition = response.headers.get('Content-Disposition');
            let filename = 'download';
            if (contentDisposition) {
                const filenameMatch = contentDisposition.match(/filename="(.+)"/);
                if (filenameMatch) {
                    filename = filenameMatch[1];
                }
            }
            
            const blob = await response.blob();
            const url = window.URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.style.display = 'none';
            a.href = url;
            a.download = filename;
            document.body.appendChild(a);
            a.click();
            window.URL.revokeObjectURL(url);
            document.body.removeChild(a);
            
            showNotification('–§–∞–π–ª –∑–∞–≥—Ä—É–∂–µ–Ω!', 'success');
        } catch (error) {
            showNotification('–û—à–∏–±–∫–∞ —Å–∫–∞—á–∏–≤–∞–Ω–∏—è —Ñ–∞–π–ª–∞: ' + error.message, 'danger');
        }
    }

    async function deleteFile(fileId, filename) {
        if (!confirm(`–í—ã —É–≤–µ—Ä–µ–Ω—ã, —á—Ç–æ —Ö–æ—Ç–∏—Ç–µ —É–¥–∞–ª–∏—Ç—å —Ñ–∞–π–ª "${filename}"?`)) {
            return;
        }
        
        try {
            const response = await fetch(`/admin/api/files/${fileId}`, {
                method: 'DELETE',
                headers: {
                    'Authorization': 'Basic ' + btoa(`${username}:${password}`)
                }
            });
            
            const data = await response.json();
            
            if (data.success) {
                showNotification('–§–∞–π–ª —É—Å–ø–µ—à–Ω–æ —É–¥–∞–ª–µ–Ω!', 'success');
                
                // –û–±–Ω–æ–≤–ª—è–µ–º —Å–ø–∏—Å–æ–∫ —Ñ–∞–π–ª–æ–≤
                const projectId = document.getElementById('uploadProjectId').value;
                await loadProjectFiles(projectId);
            } else {
                throw new Error(data.message || '–û—à–∏–±–∫–∞ —É–¥–∞–ª–µ–Ω–∏—è —Ñ–∞–π–ª–∞');
            }
        } catch (error) {
            showNotification('–û—à–∏–±–∫–∞ —É–¥–∞–ª–µ–Ω–∏—è —Ñ–∞–π–ª–∞: ' + error.message, 'danger');
        }
    }

    // –§—É–Ω–∫—Ü–∏—è –¥–ª—è –∫–æ–ø–∏—Ä–æ–≤–∞–Ω–∏—è –≤ –±—É—Ñ–µ—Ä –æ–±–º–µ–Ω–∞
    function copyToClipboard(text) {
        navigator.clipboard.writeText(text).then(() => {
            showNotification('–°–∫–æ–ø–∏—Ä–æ–≤–∞–Ω–æ –≤ –±—É—Ñ–µ—Ä –æ–±–º–µ–Ω–∞!', 'success');
        }).catch(err => {
            // Fallback –¥–ª—è —Å—Ç–∞—Ä—ã—Ö –±—Ä–∞—É–∑–µ—Ä–æ–≤
            const textArea = document.createElement('textarea');
            textArea.value = text;
            document.body.appendChild(textArea);
            textArea.select();
            try {
                document.execCommand('copy');
                showNotification('–°–∫–æ–ø–∏—Ä–æ–≤–∞–Ω–æ –≤ –±—É—Ñ–µ—Ä –æ–±–º–µ–Ω–∞!', 'success');
            } catch (err) {
                showNotification('–û—à–∏–±–∫–∞ –∫–æ–ø–∏—Ä–æ–≤–∞–Ω–∏—è', 'danger');
            }
            document.body.removeChild(textArea);
        });
    }

    // –§—É–Ω–∫—Ü–∏–∏ –¥–ª—è —É–¥–∞–ª–µ–Ω–∏—è –ø—Ä–æ–µ–∫—Ç–∞
    function confirmDeleteProject(projectId, projectTitle) {
        document.getElementById('deleteProjectId').value = projectId;
        document.getElementById('deleteProjectTitle').textContent = projectTitle;
        
        const modal = new bootstrap.Modal(document.getElementById('deleteProjectModal'));
        modal.show();
    }

    async function deleteProject() {
        const projectId = document.getElementById('deleteProjectId').value;
        
        try {
            const response = await fetch(`/admin/api/projects/${projectId}`, {
                method: 'DELETE',
                headers: {
                    'Authorization': 'Basic ' + btoa(`${username}:${password}`)
                }
            });
            
            const data = await response.json();
            
            if (data.success) {
                showNotification('–ü—Ä–æ–µ–∫—Ç —É—Å–ø–µ—à–Ω–æ —É–¥–∞–ª–µ–Ω!', 'success');
                
                // –ó–∞–∫—Ä—ã–≤–∞–µ–º –º–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ
                const modal = bootstrap.Modal.getInstance(document.getElementById('deleteProjectModal'));
                modal.hide();
                
                // –û–±–Ω–æ–≤–ª—è–µ–º —Å–ø–∏—Å–æ–∫ –ø—Ä–æ–µ–∫—Ç–æ–≤
                setTimeout(() => {
                    location.reload();
                }, 1000);
            } else {
                throw new Error(data.message || '–û—à–∏–±–∫–∞ —É–¥–∞–ª–µ–Ω–∏—è –ø—Ä–æ–µ–∫—Ç–∞');
            }
        } catch (error) {
            showNotification('–û—à–∏–±–∫–∞ —É–¥–∞–ª–µ–Ω–∏—è –ø—Ä–æ–µ–∫—Ç–∞: ' + error.message, 'danger');
        }
    }
</script>
{% endblock %}