{% extends "base.html" %}

{% block title %}–§–∏–Ω–∞–Ω—Å—ã - –ê–¥–º–∏–Ω-–ø–∞–Ω–µ–ª—å{% endblock %}

{% block page_title %}üí∞ –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ —Ñ–∏–Ω–∞–Ω—Å–∞–º–∏{% endblock %}

{% block extra_css %}
<style>
.finance-card {
    border: none;
    border-radius: 15px;
    box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
    transition: transform 0.2s, box-shadow 0.2s;
}

.finance-card:hover {
    transform: translateY(-2px);
    box-shadow: 0 6px 12px rgba(0, 0, 0, 0.15);
}

.finance-card-income {
    background: linear-gradient(135deg, #28a745 0%, #20c997 100%);
    color: white;
}

.finance-card-expense {
    background: linear-gradient(135deg, #dc3545 0%, #fd7e14 100%);
    color: white;
}

.finance-card-profit {
    background: linear-gradient(135deg, #007bff 0%, #6610f2 100%);
    color: white;
}

.finance-card-budget {
    background: linear-gradient(135deg, #ffc107 0%, #fd7e14 100%);
    color: white;
}

.transaction-item {
    border-left: 4px solid #dee2e6;
    transition: all 0.2s;
}

.transaction-item:hover {
    background-color: #f8f9fa;
    border-left-color: #007bff;
}

.transaction-income {
    border-left-color: #28a745;
}

.transaction-expense {
    border-left-color: #dc3545;
}

.amount-income {
    color: #28a745;
    font-weight: bold;
}

.amount-expense {
    color: #dc3545;
    font-weight: bold;
}

.chart-container {
    position: relative;
    height: 300px;
    margin: 20px 0;
}

.filter-section {
    background: #f8f9fa;
    border-radius: 10px;
    padding: 20px;
    margin-bottom: 20px;
}

.category-badge {
    display: inline-block;
    padding: 0.25rem 0.5rem;
    font-size: 0.875rem;
    font-weight: 500;
    line-height: 1;
    text-align: center;
    white-space: nowrap;
    vertical-align: baseline;
    border-radius: 0.375rem;
    margin-right: 0.5rem;
}

.btn-finance {
    border-radius: 25px;
    padding: 8px 20px;
    font-weight: 500;
    transition: all 0.3s;
}

.btn-finance:hover {
    transform: translateY(-1px);
    box-shadow: 0 4px 8px rgba(0,0,0,0.2);
}

.transaction-actions {
    min-width: 80px;
}

.transaction-actions .btn {
    margin-bottom: 2px;
}
</style>
{% endblock %}

{% block header_actions %}
<div class="btn-group">
    <button class="btn btn-primary btn-finance" onclick="showAddTransactionModal()">
        <i class="fas fa-plus me-1"></i> –î–æ–±–∞–≤–∏—Ç—å —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏—é
    </button>
    <button class="btn btn-success btn-finance" onclick="showAddCategoryModal()">
        <i class="fas fa-tags me-1"></i> –ö–∞—Ç–µ–≥–æ—Ä–∏—è
    </button>
    <button class="btn btn-info btn-finance" onclick="exportFinanceData()">
        <i class="fas fa-download me-1"></i> –≠–∫—Å–ø–æ—Ä—Ç
    </button>
</div>
{% endblock %}

{% block content %}
<!-- –°–≤–æ–¥–∫–∞ -->
<div class="row mb-4">
    <div class="col-md-3">
        <div class="card finance-card finance-card-income">
            <div class="card-body text-center">
                <i class="fas fa-arrow-up fa-2x mb-2"></i>
                <h3 class="mb-0" id="totalIncome">0 ‚ÇΩ</h3>
                <p class="mb-0">–î–æ—Ö–æ–¥—ã</p>
                <small id="incomeCount">0 –æ–ø–µ—Ä–∞—Ü–∏–π</small>
            </div>
        </div>
    </div>
    <div class="col-md-3">
        <div class="card finance-card finance-card-expense">
            <div class="card-body text-center">
                <i class="fas fa-arrow-down fa-2x mb-2"></i>
                <h3 class="mb-0" id="totalExpenses">0 ‚ÇΩ</h3>
                <p class="mb-0">–†–∞—Å—Ö–æ–¥—ã</p>
                <small id="expenseCount">0 –æ–ø–µ—Ä–∞—Ü–∏–π</small>
            </div>
        </div>
    </div>
    <div class="col-md-3">
        <div class="card finance-card finance-card-profit">
            <div class="card-body text-center">
                <i class="fas fa-chart-line fa-2x mb-2"></i>
                <h3 class="mb-0" id="totalProfit">0 ‚ÇΩ</h3>
                <p class="mb-0">–ü—Ä–∏–±—ã–ª—å</p>
                <small id="profitPercent">0%</small>
            </div>
        </div>
    </div>
    <div class="col-md-3">
        <div class="card finance-card finance-card-budget">
            <div class="card-body text-center">
                <i class="fas fa-wallet fa-2x mb-2"></i>
                <h3 class="mb-0" id="budgetUsage">0%</h3>
                <p class="mb-0">–ë—é–¥–∂–µ—Ç</p>
                <small id="budgetStatus">–≤ –ø—Ä–µ–¥–µ–ª–∞—Ö –Ω–æ—Ä–º—ã</small>
            </div>
        </div>
    </div>
</div>

<!-- –§–∏–ª—å—Ç—Ä—ã -->
<div class="filter-section">
    <div class="row">
        <div class="col-md-2">
            <label class="form-label">–ü–µ—Ä–∏–æ–¥</label>
            <select class="form-select" id="periodFilter" onchange="loadFinanceData()">
                <option value="current_month">–¢–µ–∫—É—â–∏–π –º–µ—Å—è—Ü</option>
                <option value="last_month">–ü—Ä–æ—à–ª—ã–π –º–µ—Å—è—Ü</option>
                <option value="current_year">–¢–µ–∫—É—â–∏–π –≥–æ–¥</option>
                <option value="custom">–í—ã–±—Ä–∞—Ç—å –ø–µ—Ä–∏–æ–¥</option>
            </select>
        </div>
        <div class="col-md-2">
            <label class="form-label">–î–∞—Ç–∞ –æ—Ç</label>
            <input type="date" class="form-control" id="dateFrom" onchange="loadFinanceData()">
        </div>
        <div class="col-md-2">
            <label class="form-label">–î–∞—Ç–∞ –¥–æ</label>
            <input type="date" class="form-control" id="dateTo" onchange="loadFinanceData()">
        </div>
        <div class="col-md-2">
            <label class="form-label">–¢–∏–ø</label>
            <select class="form-select" id="typeFilter" onchange="loadFinanceData()">
                <option value="">–í—Å–µ</option>
                <option value="income">–î–æ—Ö–æ–¥—ã</option>
                <option value="expense">–†–∞—Å—Ö–æ–¥—ã</option>
            </select>
        </div>
        <div class="col-md-2">
            <label class="form-label">–ö–∞—Ç–µ–≥–æ—Ä–∏—è</label>
            <select class="form-select" id="categoryFilter" onchange="loadFinanceData()">
                <option value="">–í—Å–µ –∫–∞—Ç–µ–≥–æ—Ä–∏–∏</option>
            </select>
        </div>
        <div class="col-md-2">
            <label class="form-label">&nbsp;</label>
            <button class="btn btn-outline-danger w-100" onclick="clearFilters()">
                <i class="fas fa-times"></i> –û—á–∏—Å—Ç–∏—Ç—å
            </button>
        </div>
    </div>
</div>

<!-- –¢–∞–±—ã -->
<ul class="nav nav-tabs mb-4" id="financeTabs" role="tablist">
    <li class="nav-item" role="presentation">
        <button class="nav-link active" id="transactions-tab" data-bs-toggle="tab" data-bs-target="#transactions" type="button" role="tab">
            <i class="fas fa-list me-1"></i> –¢—Ä–∞–Ω–∑–∞–∫—Ü–∏–∏
        </button>
    </li>
    <li class="nav-item" role="presentation">
        <button class="nav-link" id="analytics-tab" data-bs-toggle="tab" data-bs-target="#analytics" type="button" role="tab">
            <i class="fas fa-chart-bar me-1"></i> –ê–Ω–∞–ª–∏—Ç–∏–∫–∞
        </button>
    </li>
    <li class="nav-item" role="presentation">
        <button class="nav-link" id="categories-tab" data-bs-toggle="tab" data-bs-target="#categories" type="button" role="tab">
            <i class="fas fa-tags me-1"></i> –ö–∞—Ç–µ–≥–æ—Ä–∏–∏
        </button>
    </li>
</ul>

<div class="tab-content" id="financeTabContent">
    <!-- –¢—Ä–∞–Ω–∑–∞–∫—Ü–∏–∏ -->
    <div class="tab-pane fade show active" id="transactions" role="tabpanel">
        <div class="card">
            <div class="card-header">
                <h5 class="card-title mb-0">–ü–æ—Å–ª–µ–¥–Ω–∏–µ —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–∏</h5>
            </div>
            <div class="card-body p-0">
                <div id="transactionsList" class="list-group list-group-flush">
                    <!-- –¢—Ä–∞–Ω–∑–∞–∫—Ü–∏–∏ –±—É–¥—É—Ç –∑–∞–≥—Ä—É–∂–µ–Ω—ã –∑–¥–µ—Å—å -->
                </div>
            </div>
        </div>
    </div>

    <!-- –ê–Ω–∞–ª–∏—Ç–∏–∫–∞ -->
    <div class="tab-pane fade" id="analytics" role="tabpanel">
        <div class="row">
            <div class="col-md-8">
                <div class="card">
                    <div class="card-header">
                        <h5 class="card-title mb-0">–î–∏–Ω–∞–º–∏–∫–∞ –¥–æ—Ö–æ–¥–æ–≤ –∏ —Ä–∞—Å—Ö–æ–¥–æ–≤</h5>
                    </div>
                    <div class="card-body">
                        <div class="chart-container">
                            <canvas id="monthlyChart"></canvas>
                        </div>
                    </div>
                </div>
            </div>
            <div class="col-md-4">
                <div class="card">
                    <div class="card-header">
                        <h5 class="card-title mb-0">–°—Ç—Ä—É–∫—Ç—É—Ä–∞ —Ä–∞—Å—Ö–æ–¥–æ–≤</h5>
                    </div>
                    <div class="card-body">
                        <div class="chart-container">
                            <canvas id="expenseChart"></canvas>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- –ö–∞—Ç–µ–≥–æ—Ä–∏–∏ -->
    <div class="tab-pane fade" id="categories" role="tabpanel">
        <div class="row">
            <div class="col-md-6">
                <div class="card">
                    <div class="card-header">
                        <h5 class="card-title mb-0">–ö–∞—Ç–µ–≥–æ—Ä–∏–∏ –¥–æ—Ö–æ–¥–æ–≤</h5>
                    </div>
                    <div class="card-body">
                        <div id="incomeCategoriesList">
                            <!-- –ö–∞—Ç–µ–≥–æ—Ä–∏–∏ –¥–æ—Ö–æ–¥–æ–≤ –±—É–¥—É—Ç –∑–∞–≥—Ä—É–∂–µ–Ω—ã –∑–¥–µ—Å—å -->
                        </div>
                    </div>
                </div>
            </div>
            <div class="col-md-6">
                <div class="card">
                    <div class="card-header">
                        <h5 class="card-title mb-0">–ö–∞—Ç–µ–≥–æ—Ä–∏–∏ —Ä–∞—Å—Ö–æ–¥–æ–≤</h5>
                    </div>
                    <div class="card-body">
                        <div id="expenseCategoriesList">
                            <!-- –ö–∞—Ç–µ–≥–æ—Ä–∏–∏ —Ä–∞—Å—Ö–æ–¥–æ–≤ –±—É–¥—É—Ç –∑–∞–≥—Ä—É–∂–µ–Ω—ã –∑–¥–µ—Å—å -->
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- –ú–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ –¥–æ–±–∞–≤–ª–µ–Ω–∏—è —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–∏ -->
<div class="modal fade" id="addTransactionModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">–î–æ–±–∞–≤–∏—Ç—å —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏—é</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <form id="addTransactionForm">
                    <div class="row">
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label class="form-label">–¢–∏–ø —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–∏</label>
                                <select class="form-select" id="transactionType" required onchange="updateCategoryOptions()">
                                    <option value="">–í—ã–±–µ—Ä–∏—Ç–µ —Ç–∏–ø</option>
                                    <option value="income">–î–æ—Ö–æ–¥</option>
                                    <option value="expense">–†–∞—Å—Ö–æ–¥</option>
                                </select>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label class="form-label">–°—É–º–º–∞ (‚ÇΩ)</label>
                                <input type="number" class="form-control" id="transactionAmount" required step="0.01" min="0">
                            </div>
                        </div>
                    </div>
                    <div class="row">
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label class="form-label">–ö–∞—Ç–µ–≥–æ—Ä–∏—è</label>
                                <select class="form-select" id="transactionCategory" required>
                                    <option value="">–í—ã–±–µ—Ä–∏—Ç–µ –∫–∞—Ç–µ–≥–æ—Ä–∏—é</option>
                                </select>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label class="form-label">–î–∞—Ç–∞</label>
                                <input type="datetime-local" class="form-control" id="transactionDate" required>
                            </div>
                        </div>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">–û–ø–∏—Å–∞–Ω–∏–µ</label>
                        <textarea class="form-control" id="transactionDescription" rows="3" required></textarea>
                    </div>
                    <div class="row">
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label class="form-label">–ü—Ä–æ–µ–∫—Ç (–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ)</label>
                                <select class="form-select" id="transactionProject">
                                    <option value="">–ù–µ —Å–≤—è–∑–∞–Ω–æ —Å –ø—Ä–æ–µ–∫—Ç–æ–º</option>
                                </select>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label class="form-label">–ò—Å–ø–æ–ª–Ω–∏—Ç–µ–ª—å/–ü–æ—Å—Ç–∞–≤—â–∏–∫</label>
                                <input type="text" class="form-control" id="transactionContractor" placeholder="–ò–º—è –∏—Å–ø–æ–ª–Ω–∏—Ç–µ–ª—è">
                            </div>
                        </div>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">–ó–∞–º–µ—Ç–∫–∏</label>
                        <textarea class="form-control" id="transactionNotes" rows="2"></textarea>
                    </div>
                    <div class="form-check">
                        <input class="form-check-input" type="checkbox" id="transactionRecurring">
                        <label class="form-check-label" for="transactionRecurring">
                            –ü–æ–≤—Ç–æ—Ä—è—é—â–∞—è—Å—è —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏—è
                        </label>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">–û—Ç–º–µ–Ω–∞</button>
                <button type="button" class="btn btn-primary" onclick="saveTransaction()">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button>
            </div>
        </div>
    </div>
</div>

<!-- –ú–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ –¥–æ–±–∞–≤–ª–µ–Ω–∏—è –∫–∞—Ç–µ–≥–æ—Ä–∏–∏ -->
<div class="modal fade" id="addCategoryModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">–î–æ–±–∞–≤–∏—Ç—å –∫–∞—Ç–µ–≥–æ—Ä–∏—é</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <form id="addCategoryForm">
                    <div class="mb-3">
                        <label class="form-label">–ù–∞–∑–≤–∞–Ω–∏–µ</label>
                        <input type="text" class="form-control" id="categoryName" required>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">–¢–∏–ø</label>
                        <select class="form-select" id="categoryType" required>
                            <option value="">–í—ã–±–µ—Ä–∏—Ç–µ —Ç–∏–ø</option>
                            <option value="income">–î–æ—Ö–æ–¥</option>
                            <option value="expense">–†–∞—Å—Ö–æ–¥</option>
                        </select>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">–û–ø–∏—Å–∞–Ω–∏–µ</label>
                        <textarea class="form-control" id="categoryDescription" rows="3"></textarea>
                    </div>
                    <div class="row">
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label class="form-label">–¶–≤–µ—Ç</label>
                                <input type="color" class="form-control form-control-color" id="categoryColor" value="#6c757d">
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label class="form-label">–ò–∫–æ–Ω–∫–∞</label>
                                <input type="text" class="form-control" id="categoryIcon" value="fas fa-circle" placeholder="fas fa-circle">
                            </div>
                        </div>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">–û—Ç–º–µ–Ω–∞</button>
                <button type="button" class="btn btn-primary" onclick="saveCategory()">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button>
            </div>
        </div>
    </div>
</div>

{% endblock %}

{% block scripts %}
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
    // –ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è –∞—É—Ç–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏–∏
    const username = 'admin';
    const password = 'qwerty123';
    
    // –ì–ª–æ–±–∞–ª—å–Ω—ã–µ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ
    let financeCategories = [];
    let projects = [];
    let monthlyChart = null;
    let expenseChart = null;
    
    // –ó–∞–≥—Ä—É–∑–∫–∞ –¥–∞–Ω–Ω—ã—Ö –ø—Ä–∏ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏–∏
    document.addEventListener('DOMContentLoaded', function() {
        loadFinanceCategories();
        loadProjects();
        loadFinanceData();
        setDefaultDates();
    });
    
    // –£—Å—Ç–∞–Ω–æ–≤–∫–∞ –¥–∞—Ç –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é
    function setDefaultDates() {
        const now = new Date();
        const firstDay = new Date(now.getFullYear(), now.getMonth(), 1);
        
        document.getElementById('dateFrom').value = firstDay.toISOString().split('T')[0];
        document.getElementById('dateTo').value = now.toISOString().split('T')[0];
        document.getElementById('transactionDate').value = now.toISOString().slice(0, 16);
    }
    
    // –ó–∞–≥—Ä—É–∑–∫–∞ –∫–∞—Ç–µ–≥–æ—Ä–∏–π
    async function loadFinanceCategories() {
        try {
            const response = await fetch('/admin/api/finance/categories', {
                headers: {
                    'Authorization': 'Basic ' + btoa(`${username}:${password}`)
                }
            });
            
            if (response.ok) {
                const data = await response.json();
                console.log('–ó–∞–≥—Ä—É–∂–µ–Ω–Ω—ã–µ –∫–∞—Ç–µ–≥–æ—Ä–∏–∏:', data);
                
                if (data.success && data.data) {
                    financeCategories = Array.isArray(data.data) ? data.data : [];
                } else if (Array.isArray(data)) {
                    financeCategories = data;
                } else {
                    financeCategories = [];
                }
                
                updateCategoryFilter();
                updateCategoryOptions();
                renderCategories();
            } else {
                console.error('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –∫–∞—Ç–µ–≥–æ—Ä–∏–π: HTTP', response.status);
                financeCategories = [];
            }
        } catch (error) {
            console.error('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –∫–∞—Ç–µ–≥–æ—Ä–∏–π:', error);
            financeCategories = [];
        }
    }
    
    // –ó–∞–≥—Ä—É–∑–∫–∞ –ø—Ä–æ–µ–∫—Ç–æ–≤
    async function loadProjects() {
        try {
            const response = await fetch('/admin/api/projects', {
                headers: {
                    'Authorization': 'Basic ' + btoa(`${username}:${password}`)
                }
            });
            
            if (response.ok) {
                const data = await response.json();
                console.log('–ó–∞–≥—Ä—É–∂–µ–Ω–Ω—ã–µ –ø—Ä–æ–µ–∫—Ç—ã:', data);
                
                // –ü—Ä–æ–≤–µ—Ä—è–µ–º —Ä–∞–∑–Ω—ã–µ –≤–æ–∑–º–æ–∂–Ω—ã–µ —Ñ–æ—Ä–º–∞—Ç—ã –æ—Ç–≤–µ—Ç–∞
                if (data.success && data.data) {
                    projects = Array.isArray(data.data) ? data.data : [];
                } else if (Array.isArray(data)) {
                    projects = data;
                } else {
                    projects = [];
                }
                
                updateProjectOptions();
            } else {
                console.error('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –ø—Ä–æ–µ–∫—Ç–æ–≤: HTTP', response.status);
                projects = [];
            }
        } catch (error) {
            console.error('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –ø—Ä–æ–µ–∫—Ç–æ–≤:', error);
            projects = [];
        }
    }
    
    // –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ —Å–ø–∏—Å–∫–∞ —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–π
    function updateTransactionsList(transactions) {
        console.log('–û–±–Ω–æ–≤–ª–µ–Ω–∏–µ —Å–ø–∏—Å–∫–∞ —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–π, –ø–æ–ª—É—á–µ–Ω–æ:', transactions);
        const container = document.getElementById('transactionsList');
        if (!container) {
            console.error('–ö–æ–Ω—Ç–µ–π–Ω–µ—Ä transactionsList –Ω–µ –Ω–∞–π–¥–µ–Ω');
            return;
        }
        
        if (!transactions || transactions.length === 0) {
            console.log('–ù–µ—Ç —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–π –¥–ª—è –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è');
            container.innerHTML = `
                <div class="list-group-item text-center py-4">
                    <div class="text-muted">
                        <i class="fas fa-receipt fa-2x mb-2"></i>
                        <p class="mb-0">–ù–µ—Ç —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–π</p>
                        <small>–°–æ–∑–¥–∞–π—Ç–µ –ø–µ—Ä–≤—É—é —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏—é, —á—Ç–æ–±—ã –Ω–∞—á–∞—Ç—å —É—á–µ—Ç</small>
                    </div>
                </div>
            `;
            return;
        }
        
        // –°–æ—Ä—Ç–∏—Ä—É–µ–º —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–∏ –ø–æ –¥–∞—Ç–µ (–Ω–æ–≤—ã–µ –ø–µ—Ä–≤—ã–º–∏)
        transactions.sort((a, b) => new Date(b.date || b.created_at) - new Date(a.date || a.created_at));
        
        // –ë–µ—Ä–µ–º —Ç–æ–ª—å–∫–æ –ø–æ—Å–ª–µ–¥–Ω–∏–µ 10 —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–π
        const recentTransactions = transactions.slice(0, 10);
        
        const transactionsHtml = recentTransactions.map(transaction => {
            const date = new Date(transaction.date || transaction.created_at);
            const formattedDate = date.toLocaleDateString('ru-RU', {
                day: '2-digit',
                month: '2-digit',
                year: 'numeric'
            });
            const formattedTime = date.toLocaleTimeString('ru-RU', {
                hour: '2-digit',
                minute: '2-digit'
            });
            
            const category = financeCategories.find(cat => cat.id === transaction.category_id);
            const categoryName = category ? category.name : '–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–∞—è –∫–∞—Ç–µ–≥–æ—Ä–∏—è';
            
            const amount = Math.abs(transaction.amount);
            const isIncome = transaction.type === 'income';
            
            return `
                <div class="list-group-item transaction-item ${isIncome ? 'transaction-income' : 'transaction-expense'}">
                    <div class="d-flex justify-content-between align-items-start">
                        <div class="flex-grow-1">
                            <div class="d-flex justify-content-between align-items-center mb-1">
                                <h6 class="mb-0">${transaction.description}</h6>
                                <span class="badge badge-${isIncome ? 'success' : 'danger'}">${categoryName}</span>
                            </div>
                            <p class="text-muted mb-1 small">${transaction.notes || ''}</p>
                            <small class="text-muted">
                                <i class="fas fa-calendar-alt"></i> ${formattedDate} –≤ ${formattedTime}
                                ${transaction.project_id ? `| <i class="fas fa-project-diagram"></i> –ü—Ä–æ–µ–∫—Ç #${transaction.project_id}` : ''}
                            </small>
                        </div>
                        <div class="text-right ml-3 d-flex align-items-center">
                            <div class="amount-${isIncome ? 'income' : 'expense'} h5 mb-0 me-3">
                                ${isIncome ? '+' : '-'}${amount.toLocaleString('ru-RU')} ‚ÇΩ
                            </div>
                            <div class="btn-group-vertical transaction-actions">
                                <button class="btn btn-sm btn-outline-primary" onclick="editTransaction(${transaction.id})" title="–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å">
                                    <i class="fas fa-edit"></i>
                                </button>
                                <button class="btn btn-sm btn-outline-danger" onclick="deleteTransaction(${transaction.id}, '${transaction.description}')" title="–£–¥–∞–ª–∏—Ç—å">
                                    <i class="fas fa-trash"></i>
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            `;
        }).join('');
        
        container.innerHTML = transactionsHtml;
    }
    
    // –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏
    function updateFinanceStats(transactions) {
        console.log('–û–±–Ω–æ–≤–ª–µ–Ω–∏–µ —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏ –¥–ª—è —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–π:', transactions);
        
        if (!transactions || transactions.length === 0) {
            // –û–±–Ω—É–ª—è–µ–º —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫—É
            const totalIncomeEl = document.getElementById('totalIncome');
            const totalExpensesEl = document.getElementById('totalExpenses');
            const totalProfitEl = document.getElementById('totalProfit');
            const incomeCountEl = document.getElementById('incomeCount');
            const expenseCountEl = document.getElementById('expenseCount');
            
            if (totalIncomeEl) totalIncomeEl.textContent = '0 ‚ÇΩ';
            if (totalExpensesEl) totalExpensesEl.textContent = '0 ‚ÇΩ';
            if (totalProfitEl) totalProfitEl.textContent = '0 ‚ÇΩ';
            if (incomeCountEl) incomeCountEl.textContent = '0 –æ–ø–µ—Ä–∞—Ü–∏–π';
            if (expenseCountEl) expenseCountEl.textContent = '0 –æ–ø–µ—Ä–∞—Ü–∏–π';
            return;
        }
        
        const incomeTransactions = transactions.filter(t => t.type === 'income');
        const expenseTransactions = transactions.filter(t => t.type === 'expense');
        
        const totalIncome = incomeTransactions.reduce((sum, t) => sum + Math.abs(t.amount), 0);
        const totalExpense = expenseTransactions.reduce((sum, t) => sum + Math.abs(t.amount), 0);
        const profit = totalIncome - totalExpense;
        
        console.log('–°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞:', {
            totalIncome,
            totalExpense,
            profit,
            incomeCount: incomeTransactions.length,
            expenseCount: expenseTransactions.length
        });
        
        // –û–±–Ω–æ–≤–ª—è–µ–º –∑–Ω–∞—á–µ–Ω–∏—è –≤ –∫–∞—Ä—Ç–æ—á–∫–∞—Ö
        const totalIncomeEl = document.getElementById('totalIncome');
        const totalExpensesEl = document.getElementById('totalExpenses');
        const totalProfitEl = document.getElementById('totalProfit');
        const incomeCountEl = document.getElementById('incomeCount');
        const expenseCountEl = document.getElementById('expenseCount');
        
        if (totalIncomeEl) {
            totalIncomeEl.textContent = totalIncome.toLocaleString('ru-RU') + ' ‚ÇΩ';
            console.log('–û–±–Ω–æ–≤–ª–µ–Ω –¥–æ—Ö–æ–¥:', totalIncomeEl.textContent);
        }
        if (totalExpensesEl) {
            totalExpensesEl.textContent = totalExpense.toLocaleString('ru-RU') + ' ‚ÇΩ';
            console.log('–û–±–Ω–æ–≤–ª–µ–Ω—ã —Ä–∞—Å—Ö–æ–¥—ã:', totalExpensesEl.textContent);
        }
        if (totalProfitEl) {
            totalProfitEl.textContent = profit.toLocaleString('ru-RU') + ' ‚ÇΩ';
            console.log('–û–±–Ω–æ–≤–ª–µ–Ω–∞ –ø—Ä–∏–±—ã–ª—å:', totalProfitEl.textContent);
        }
        
        // –û–±–Ω–æ–≤–ª—è–µ–º –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –æ–ø–µ—Ä–∞—Ü–∏–π
        if (incomeCountEl) {
            incomeCountEl.textContent = `${incomeTransactions.length} –æ–ø–µ—Ä–∞—Ü–∏–π`;
        }
        if (expenseCountEl) {
            expenseCountEl.textContent = `${expenseTransactions.length} –æ–ø–µ—Ä–∞—Ü–∏–π`;
        }
    }

    // ...existing code...
    
    function showNotification(message, type = 'info') {
        alert(message);
    }
    
    function showAddTransactionModal() {
        // –û—á–∏—â–∞–µ–º —Ñ–æ—Ä–º—É
        document.getElementById('addTransactionForm').reset();
        
        // –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º —Ç–µ–∫—É—â—É—é –¥–∞—Ç—É –∏ –≤—Ä–µ–º—è
        const now = new Date();
        const localDateTime = new Date(now.getTime() - now.getTimezoneOffset() * 60000).toISOString().slice(0, 16);
        document.getElementById('transactionDate').value = localDateTime;
        
        // –û–±–Ω–æ–≤–ª—è–µ–º —Å–ø–∏—Å–æ–∫ –ø—Ä–æ–µ–∫—Ç–æ–≤
        updateProjectOptions();
        
        const modal = new bootstrap.Modal(document.getElementById('addTransactionModal'));
        modal.show();
    }
    
    function showAddCategoryModal() {
        // –û—á–∏—â–∞–µ–º —Ñ–æ—Ä–º—É
        document.getElementById('addCategoryForm').reset();
        
        // –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –∑–Ω–∞—á–µ–Ω–∏—è –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é
        document.getElementById('categoryColor').value = '#6c757d';
        document.getElementById('categoryIcon').value = 'fas fa-circle';
        
        // –°–±—Ä–∞—Å—ã–≤–∞–µ–º –∑–∞–≥–æ–ª–æ–≤–æ–∫ –∏ –∫–Ω–æ–ø–∫—É –Ω–∞ —Å–ª—É—á–∞–π, –µ—Å–ª–∏ –±—ã–ª–æ —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ
        document.querySelector('#addCategoryModal .modal-title').textContent = '–î–æ–±–∞–≤–∏—Ç—å –∫–∞—Ç–µ–≥–æ—Ä–∏—é';
        const saveBtn = document.querySelector('#addCategoryModal .btn-primary');
        saveBtn.textContent = '–°–æ—Ö—Ä–∞–Ω–∏—Ç—å';
        saveBtn.onclick = saveCategory;
        
        const modal = new bootstrap.Modal(document.getElementById('addCategoryModal'));
        modal.show();
    }
    
    async function loadFinanceData() {
        console.log('–ó–∞–≥—Ä—É–∑–∫–∞ —Ñ–∏–Ω–∞–Ω—Å–æ–≤—ã—Ö –¥–∞–Ω–Ω—ã—Ö...');
        
        try {
            // –ü–æ–ª—É—á–∞–µ–º –ø–∞—Ä–∞–º–µ—Ç—Ä—ã —Ñ–∏–ª—å—Ç—Ä–∞—Ü–∏–∏
            const params = new URLSearchParams();
            
            const dateFrom = document.getElementById('dateFrom').value;
            const dateTo = document.getElementById('dateTo').value;
            const typeFilter = document.getElementById('typeFilter').value;
            const categoryFilter = document.getElementById('categoryFilter').value;
            
            if (dateFrom) params.append('date_from', dateFrom);
            if (dateTo) params.append('date_to', dateTo);
            if (typeFilter) params.append('type', typeFilter);
            if (categoryFilter) params.append('category_id', categoryFilter);
            
            // –ó–∞–≥—Ä—É–∂–∞–µ–º —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–∏
            const response = await fetch(`/admin/api/finance/transactions?${params}`, {
                headers: {
                    'Authorization': 'Basic ' + btoa(`${username}:${password}`)
                }
            });
            
            if (response.ok) {
                const data = await response.json();
                console.log('–ó–∞–≥—Ä—É–∂–µ–Ω–Ω—ã–µ —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–∏:', data);
                
                let transactions = [];
                if (data.success && data.data) {
                    transactions = Array.isArray(data.data) ? data.data : [];
                } else if (Array.isArray(data)) {
                    transactions = data;
                }
                
                console.log('–û–±—Ä–∞–±–æ—Ç–∞–Ω–Ω—ã–µ —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–∏:', transactions);
                
                // –û–±–Ω–æ–≤–ª—è–µ–º —Å–ø–∏—Å–æ–∫ —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–π
                updateTransactionsList(transactions);
                
                // –û–±–Ω–æ–≤–ª—è–µ–º —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫—É
                updateFinanceStats(transactions);
                
            } else {
                console.error('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–π: HTTP', response.status);
                updateTransactionsList([]);
            }
            
        } catch (error) {
            console.error('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ —Ñ–∏–Ω–∞–Ω—Å–æ–≤—ã—Ö –¥–∞–Ω–Ω—ã—Ö:', error);
            updateTransactionsList([]);
        }
    }
    
    function clearFilters() {
        document.getElementById('periodFilter').value = 'current_month';
        document.getElementById('typeFilter').value = '';
        document.getElementById('categoryFilter').value = '';
        setDefaultDates();
        loadFinanceData();
    }
    
    function updateCategoryFilter() {
        const filter = document.getElementById('categoryFilter');
        if (!filter) return;
        
        filter.innerHTML = '<option value="">–í—Å–µ –∫–∞—Ç–µ–≥–æ—Ä–∏–∏</option>';
        
        if (financeCategories && Array.isArray(financeCategories)) {
            financeCategories.forEach(category => {
                const option = document.createElement('option');
                option.value = category.id;
                option.textContent = category.name;
                filter.appendChild(option);
            });
        }
    }
    
    function updateCategoryOptions() {
        const typeSelect = document.getElementById('transactionType');
        const categorySelect = document.getElementById('transactionCategory');
        
        if (!typeSelect || !categorySelect) return;
        
        const type = typeSelect.value;
        categorySelect.innerHTML = '<option value="">–í—ã–±–µ—Ä–∏—Ç–µ –∫–∞—Ç–µ–≥–æ—Ä–∏—é</option>';
        
        if (type && financeCategories && Array.isArray(financeCategories)) {
            financeCategories.filter(cat => cat.type === type).forEach(category => {
                const option = document.createElement('option');
                option.value = category.id;
                option.textContent = category.name;
                categorySelect.appendChild(option);
            });
        }
    }
    
    function updateProjectOptions() {
        const select = document.getElementById('transactionProject');
        if (!select) return;
        
        select.innerHTML = '<option value="">–ù–µ —Å–≤—è–∑–∞–Ω–æ —Å –ø—Ä–æ–µ–∫—Ç–æ–º</option>';
        
        if (projects && Array.isArray(projects)) {
            projects.forEach(project => {
                const option = document.createElement('option');
                option.value = project.id;
                option.textContent = `#${project.id} - ${project.title}`;
                select.appendChild(option);
            });
        }
    }
    
    function renderCategories() {
        const incomeContainer = document.getElementById('incomeCategoriesList');
        const expenseContainer = document.getElementById('expenseCategoriesList');
        
        if (!incomeContainer || !expenseContainer) {
            console.warn('–ö–æ–Ω—Ç–µ–π–Ω–µ—Ä—ã –¥–ª—è –∫–∞—Ç–µ–≥–æ—Ä–∏–π –Ω–µ –Ω–∞–π–¥–µ–Ω—ã');
            return;
        }
        
        incomeContainer.innerHTML = '';
        expenseContainer.innerHTML = '';
        
        if (financeCategories && Array.isArray(financeCategories)) {
            financeCategories.forEach(category => {
                const categoryElement = document.createElement('div');
                categoryElement.className = 'category-item p-3 border rounded mb-2';
                categoryElement.innerHTML = `
                    <div class="d-flex justify-content-between align-items-center">
                        <div>
                            <i class="${category.icon || 'fas fa-circle'}" style="color: ${category.color || '#6c757d'}"></i>
                            <strong class="ms-2">${category.name || '–ë–µ–∑ –Ω–∞–∑–≤–∞–Ω–∏—è'}</strong>
                            <br>
                            <small class="text-muted">${category.description || '–ë–µ–∑ –æ–ø–∏—Å–∞–Ω–∏—è'}</small>
                        </div>
                        <div>
                            <button class="btn btn-sm btn-outline-primary" onclick="editCategory(${category.id})">
                                <i class="fas fa-edit"></i>
                            </button>
                        </div>
                    </div>
                `;
                
                if (category.type === 'income') {
                    incomeContainer.appendChild(categoryElement);
                } else {
                    expenseContainer.appendChild(categoryElement);
                }
            });
        }
    }
    
    async function saveTransaction() {
        console.log('–°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–∏...');
        
        // –ü–æ–ª—É—á–∞–µ–º –¥–∞–Ω–Ω—ã–µ –∏–∑ —Ñ–æ—Ä–º—ã
        const form = document.getElementById('addTransactionForm');
        const formData = {
            type: document.getElementById('transactionType').value,
            amount: parseFloat(document.getElementById('transactionAmount').value),
            category_id: parseInt(document.getElementById('transactionCategory').value),
            date: document.getElementById('transactionDate').value,
            description: document.getElementById('transactionDescription').value,
            project_id: document.getElementById('transactionProject').value || null,
            contractor_name: document.getElementById('transactionContractor').value || null,
            notes: document.getElementById('transactionNotes').value || null,
            is_recurring: document.getElementById('transactionRecurring').checked
        };
        
        // –í–∞–ª–∏–¥–∞—Ü–∏—è
        if (!formData.type) {
            alert('–í—ã–±–µ—Ä–∏—Ç–µ —Ç–∏–ø —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–∏');
            return;
        }
        if (!formData.amount || formData.amount <= 0) {
            alert('–í–≤–µ–¥–∏—Ç–µ –∫–æ—Ä—Ä–µ–∫—Ç–Ω—É—é —Å—É–º–º—É');
            return;
        }
        if (!formData.category_id) {
            alert('–í—ã–±–µ—Ä–∏—Ç–µ –∫–∞—Ç–µ–≥–æ—Ä–∏—é');
            return;
        }
        if (!formData.date) {
            alert('–í—ã–±–µ—Ä–∏—Ç–µ –¥–∞—Ç—É');
            return;
        }
        if (!formData.description) {
            alert('–í–≤–µ–¥–∏—Ç–µ –æ–ø–∏—Å–∞–Ω–∏–µ —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–∏');
            return;
        }
        
        // –ü—Ä–µ–æ–±—Ä–∞–∑—É–µ–º –¥–∞—Ç—É –≤ ISO —Ñ–æ—Ä–º–∞—Ç
        if (formData.date) {
            formData.date = new Date(formData.date).toISOString();
        }
        
        // –ü—Ä–µ–æ–±—Ä–∞–∑—É–µ–º project_id –µ—Å–ª–∏ —É–∫–∞–∑–∞–Ω
        if (formData.project_id) {
            formData.project_id = parseInt(formData.project_id);
        }
        
        try {
            console.log('–û—Ç–ø—Ä–∞–≤–∫–∞ –¥–∞–Ω–Ω—ã—Ö:', formData);
            
            const response = await fetch('/admin/api/finance/transactions', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'Authorization': 'Basic ' + btoa('admin:qwerty123')
                },
                body: JSON.stringify(formData)
            });
            
            const result = await response.json();
            console.log('–û—Ç–≤–µ—Ç —Å–µ—Ä–≤–µ—Ä–∞:', result);
            
            if (result.success) {
                console.log('–¢—Ä–∞–Ω–∑–∞–∫—Ü–∏—è —É—Å–ø–µ—à–Ω–æ —Å–æ–∑–¥–∞–Ω–∞, –æ–±–Ω–æ–≤–ª—è–µ–º –¥–∞–Ω–Ω—ã–µ...');
                alert('–¢—Ä–∞–Ω–∑–∞–∫—Ü–∏—è —É—Å–ø–µ—à–Ω–æ —Å–æ–∑–¥–∞–Ω–∞!');
                
                // –ó–∞–∫—Ä—ã–≤–∞–µ–º –º–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ
                const modal = bootstrap.Modal.getInstance(document.getElementById('addTransactionModal'));
                modal.hide();
                
                // –û—á–∏—â–∞–µ–º —Ñ–æ—Ä–º—É
                form.reset();
                
                // –û–±–Ω–æ–≤–ª—è–µ–º –¥–∞–Ω–Ω—ã–µ –±–µ–∑ –ø–µ—Ä–µ–∑–∞–≥—Ä—É–∑–∫–∏ —Å—Ç—Ä–∞–Ω–∏—Ü—ã
                await loadFinanceData();
                console.log('–î–∞–Ω–Ω—ã–µ –æ–±–Ω–æ–≤–ª–µ–Ω—ã –ø–æ—Å–ª–µ —Å–æ–∑–¥–∞–Ω–∏—è —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–∏');
                
            } else {
                console.error('–û—à–∏–±–∫–∞ –æ—Ç —Å–µ—Ä–≤–µ—Ä–∞:', result);
                alert('–û—à–∏–±–∫–∞ —Å–æ–∑–¥–∞–Ω–∏—è —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–∏: ' + (result.error || result.message || '–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–∞—è –æ—à–∏–±–∫–∞'));
            }
        } catch (error) {
            console.error('–û—à–∏–±–∫–∞:', error);
            alert('–û—à–∏–±–∫–∞ –ø—Ä–∏ —Å–æ–∑–¥–∞–Ω–∏–∏ —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–∏: ' + error.message);
        }
    }
    
    async function saveCategory() {
        console.log('–°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ –∫–∞—Ç–µ–≥–æ—Ä–∏–∏...');
        
        // –ü–æ–ª—É—á–∞–µ–º –¥–∞–Ω–Ω—ã–µ –∏–∑ —Ñ–æ—Ä–º—ã
        const form = document.getElementById('addCategoryForm');
        const formData = {
            name: document.getElementById('categoryName').value.trim(),
            type: document.getElementById('categoryType').value,
            description: document.getElementById('categoryDescription').value.trim() || null,
            color: document.getElementById('categoryColor').value,
            icon: document.getElementById('categoryIcon').value.trim()
        };
        
        // –í–∞–ª–∏–¥–∞—Ü–∏—è
        if (!formData.name) {
            alert('–í–≤–µ–¥–∏—Ç–µ –Ω–∞–∑–≤–∞–Ω–∏–µ –∫–∞—Ç–µ–≥–æ—Ä–∏–∏');
            return;
        }
        if (!formData.type) {
            alert('–í—ã–±–µ—Ä–∏—Ç–µ —Ç–∏–ø –∫–∞—Ç–µ–≥–æ—Ä–∏–∏');
            return;
        }
        if (!formData.icon) {
            formData.icon = 'fas fa-circle';
        }
        
        try {
            console.log('–û—Ç–ø—Ä–∞–≤–∫–∞ –¥–∞–Ω–Ω—ã—Ö –∫–∞—Ç–µ–≥–æ—Ä–∏–∏:', formData);
            
            const response = await fetch('/admin/api/finance/categories', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'Authorization': 'Basic ' + btoa('admin:qwerty123')
                },
                body: JSON.stringify(formData)
            });
            
            const result = await response.json();
            console.log('–û—Ç–≤–µ—Ç —Å–µ—Ä–≤–µ—Ä–∞:', result);
            
            if (result.success) {
                alert('–ö–∞—Ç–µ–≥–æ—Ä–∏—è —É—Å–ø–µ—à–Ω–æ —Å–æ–∑–¥–∞–Ω–∞!');
                
                // –ó–∞–∫—Ä—ã–≤–∞–µ–º –º–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ
                const modal = bootstrap.Modal.getInstance(document.getElementById('addCategoryModal'));
                modal.hide();
                
                // –û—á–∏—â–∞–µ–º —Ñ–æ—Ä–º—É
                form.reset();
                document.getElementById('categoryColor').value = '#6c757d';
                document.getElementById('categoryIcon').value = 'fas fa-circle';
                
                // –ü–µ—Ä–µ–∑–∞–≥—Ä—É–∂–∞–µ–º –∫–∞—Ç–µ–≥–æ—Ä–∏–∏
                await loadFinanceCategories();
            } else {
                alert('–û—à–∏–±–∫–∞ —Å–æ–∑–¥–∞–Ω–∏—è –∫–∞—Ç–µ–≥–æ—Ä–∏–∏: ' + (result.error || result.message || '–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–∞—è –æ—à–∏–±–∫–∞'));
            }
        } catch (error) {
            console.error('–û—à–∏–±–∫–∞:', error);
            alert('–û—à–∏–±–∫–∞ –ø—Ä–∏ —Å–æ–∑–¥–∞–Ω–∏–∏ –∫–∞—Ç–µ–≥–æ—Ä–∏–∏: ' + error.message);
        }
    }
    
    async function exportFinanceData() {
        console.log('–≠–∫—Å–ø–æ—Ä—Ç –¥–∞–Ω–Ω—ã—Ö...');
        
        try {
            const response = await fetch('/admin/api/finance/export', {
                method: 'GET',
                headers: {
                    'Authorization': 'Basic ' + btoa('admin:qwerty123')
                }
            });
            
            if (response.ok) {
                const blob = await response.blob();
                const url = window.URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = `finance_export_${new Date().toISOString().split('T')[0]}.xlsx`;
                document.body.appendChild(a);
                a.click();
                window.URL.revokeObjectURL(url);
                document.body.removeChild(a);
                
                alert('–î–∞–Ω–Ω—ã–µ —É—Å–ø–µ—à–Ω–æ —ç–∫—Å–ø–æ—Ä—Ç–∏—Ä–æ–≤–∞–Ω—ã!');
            } else {
                alert('–û—à–∏–±–∫–∞ –ø—Ä–∏ —ç–∫—Å–ø–æ—Ä—Ç–µ –¥–∞–Ω–Ω—ã—Ö');
            }
        } catch (error) {
            console.error('–û—à–∏–±–∫–∞ —ç–∫—Å–ø–æ—Ä—Ç–∞:', error);
            alert('–û—à–∏–±–∫–∞ –ø—Ä–∏ —ç–∫—Å–ø–æ—Ä—Ç–µ –¥–∞–Ω–Ω—ã—Ö: ' + error.message);
        }
    }
    
    function editCategory(categoryId) {
        console.log('–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –∫–∞—Ç–µ–≥–æ—Ä–∏–∏:', categoryId);
        
        // –ù–∞–π–¥–µ–º –∫–∞—Ç–µ–≥–æ—Ä–∏—é –≤ –º–∞—Å—Å–∏–≤–µ
        const category = financeCategories.find(cat => cat.id === categoryId);
        if (!category) {
            alert('–ö–∞—Ç–µ–≥–æ—Ä–∏—è –Ω–µ –Ω–∞–π–¥–µ–Ω–∞');
            return;
        }
        
        // –ó–∞–ø–æ–ª–Ω—è–µ–º —Ñ–æ—Ä–º—É –¥–∞–Ω–Ω—ã–º–∏ –∫–∞—Ç–µ–≥–æ—Ä–∏–∏
        document.getElementById('categoryName').value = category.name;
        document.getElementById('categoryType').value = category.type;
        document.getElementById('categoryDescription').value = category.description || '';
        document.getElementById('categoryColor').value = category.color || '#6c757d';
        document.getElementById('categoryIcon').value = category.icon || 'fas fa-circle';
        
        // –ò–∑–º–µ–Ω—è–µ–º –∑–∞–≥–æ–ª–æ–≤–æ–∫ –º–æ–¥–∞–ª—å–Ω–æ–≥–æ –æ–∫–Ω–∞
        document.querySelector('#addCategoryModal .modal-title').textContent = '–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å –∫–∞—Ç–µ–≥–æ—Ä–∏—é';
        
        // –ò–∑–º–µ–Ω—è–µ–º –∫–Ω–æ–ø–∫—É —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è
        const saveBtn = document.querySelector('#addCategoryModal .btn-primary');
        saveBtn.textContent = '–°–æ—Ö—Ä–∞–Ω–∏—Ç—å –∏–∑–º–µ–Ω–µ–Ω–∏—è';
        saveBtn.onclick = () => updateCategory(categoryId);
        
        // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –º–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ
        const modal = new bootstrap.Modal(document.getElementById('addCategoryModal'));
        modal.show();
    }
    
    async function updateCategory(categoryId) {
        console.log('–û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –∫–∞—Ç–µ–≥–æ—Ä–∏–∏:', categoryId);
        
        // –ü–æ–ª—É—á–∞–µ–º –¥–∞–Ω–Ω—ã–µ –∏–∑ —Ñ–æ—Ä–º—ã
        const form = document.getElementById('addCategoryForm');
        const formData = {
            name: document.getElementById('categoryName').value.trim(),
            type: document.getElementById('categoryType').value,
            description: document.getElementById('categoryDescription').value.trim() || null,
            color: document.getElementById('categoryColor').value,
            icon: document.getElementById('categoryIcon').value.trim()
        };
        
        // –í–∞–ª–∏–¥–∞—Ü–∏—è
        if (!formData.name) {
            alert('–í–≤–µ–¥–∏—Ç–µ –Ω–∞–∑–≤–∞–Ω–∏–µ –∫–∞—Ç–µ–≥–æ—Ä–∏–∏');
            return;
        }
        if (!formData.type) {
            alert('–í—ã–±–µ—Ä–∏—Ç–µ —Ç–∏–ø –∫–∞—Ç–µ–≥–æ—Ä–∏–∏');
            return;
        }
        if (!formData.icon) {
            formData.icon = 'fas fa-circle';
        }
        
        try {
            console.log('–û—Ç–ø—Ä–∞–≤–∫–∞ –¥–∞–Ω–Ω—ã—Ö –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è –∫–∞—Ç–µ–≥–æ—Ä–∏–∏:', formData);
            
            const response = await fetch(`/admin/api/finance/categories/${categoryId}`, {
                method: 'PUT',
                headers: {
                    'Content-Type': 'application/json',
                    'Authorization': 'Basic ' + btoa('admin:qwerty123')
                },
                body: JSON.stringify(formData)
            });
            
            const result = await response.json();
            console.log('–û—Ç–≤–µ—Ç —Å–µ—Ä–≤–µ—Ä–∞:', result);
            
            if (result.success) {
                alert('–ö–∞—Ç–µ–≥–æ—Ä–∏—è —É—Å–ø–µ—à–Ω–æ –æ–±–Ω–æ–≤–ª–µ–Ω–∞!');
                
                // –ó–∞–∫—Ä—ã–≤–∞–µ–º –º–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ
                const modal = bootstrap.Modal.getInstance(document.getElementById('addCategoryModal'));
                modal.hide();
                
                // –í–æ–∑–≤—Ä–∞—â–∞–µ–º –∫–Ω–æ–ø–∫—É –∫ –∏—Å—Ö–æ–¥–Ω–æ–º—É —Å–æ—Å—Ç–æ—è–Ω–∏—é
                const saveBtn = document.querySelector('#addCategoryModal .btn-primary');
                saveBtn.textContent = '–°–æ—Ö—Ä–∞–Ω–∏—Ç—å';
                saveBtn.onclick = saveCategory;
                document.querySelector('#addCategoryModal .modal-title').textContent = '–î–æ–±–∞–≤–∏—Ç—å –∫–∞—Ç–µ–≥–æ—Ä–∏—é';
                
                // –û—á–∏—â–∞–µ–º —Ñ–æ—Ä–º—É
                form.reset();
                document.getElementById('categoryColor').value = '#6c757d';
                document.getElementById('categoryIcon').value = 'fas fa-circle';
                
                // –ü–µ—Ä–µ–∑–∞–≥—Ä—É–∂–∞–µ–º –∫–∞—Ç–µ–≥–æ—Ä–∏–∏
                await loadFinanceCategories();
            } else {
                alert('–û—à–∏–±–∫–∞ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è –∫–∞—Ç–µ–≥–æ—Ä–∏–∏: ' + (result.error || result.message || '–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–∞—è –æ—à–∏–±–∫–∞'));
            }
        } catch (error) {
            console.error('–û—à–∏–±–∫–∞:', error);
            alert('–û—à–∏–±–∫–∞ –ø—Ä–∏ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–∏ –∫–∞—Ç–µ–≥–æ—Ä–∏–∏: ' + error.message);
        }
    }
    
    // –£–¥–∞–ª–µ–Ω–∏–µ —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–∏
    async function deleteTransaction(transactionId, description) {
        console.log('–£–¥–∞–ª–µ–Ω–∏–µ —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–∏:', transactionId, description);
        
        // –ü–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏–µ —É–¥–∞–ª–µ–Ω–∏—è
        if (!confirm(`–í—ã —É–≤–µ—Ä–µ–Ω—ã, —á—Ç–æ —Ö–æ—Ç–∏—Ç–µ —É–¥–∞–ª–∏—Ç—å —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏—é "${description}"?\n\n–≠—Ç–æ –¥–µ–π—Å—Ç–≤–∏–µ –Ω–µ–ª—å–∑—è –æ—Ç–º–µ–Ω–∏—Ç—å.`)) {
            return;
        }
        
        try {
            const response = await fetch(`/admin/api/finance/transactions/${transactionId}`, {
                method: 'DELETE',
                headers: {
                    'Authorization': 'Basic ' + btoa('admin:qwerty123')
                }
            });
            
            const result = await response.json();
            console.log('–û—Ç–≤–µ—Ç —Å–µ—Ä–≤–µ—Ä–∞:', result);
            
            if (result.success) {
                alert('–¢—Ä–∞–Ω–∑–∞–∫—Ü–∏—è —É—Å–ø–µ—à–Ω–æ —É–¥–∞–ª–µ–Ω–∞!');
                
                // –û–±–Ω–æ–≤–ª—è–µ–º –¥–∞–Ω–Ω—ã–µ –±–µ–∑ –ø–µ—Ä–µ–∑–∞–≥—Ä—É–∑–∫–∏ —Å—Ç—Ä–∞–Ω–∏—Ü—ã
                await loadFinanceData();
                console.log('–î–∞–Ω–Ω—ã–µ –æ–±–Ω–æ–≤–ª–µ–Ω—ã –ø–æ—Å–ª–µ —É–¥–∞–ª–µ–Ω–∏—è —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–∏');
                
            } else {
                alert('–û—à–∏–±–∫–∞ —É–¥–∞–ª–µ–Ω–∏—è —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–∏: ' + (result.error || result.message || '–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–∞—è –æ—à–∏–±–∫–∞'));
            }
        } catch (error) {
            console.error('–û—à–∏–±–∫–∞:', error);
            alert('–û—à–∏–±–∫–∞ –ø—Ä–∏ —É–¥–∞–ª–µ–Ω–∏–∏ —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–∏: ' + error.message);
        }
    }
    
    // –†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–∏
    function editTransaction(transactionId) {
        console.log('–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–∏:', transactionId);
        
        // –ù–∞–π–¥–µ–º —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏—é –≤ —Å–ø–∏—Å–∫–µ
        // –î–ª—è –ø—Ä–æ—Å—Ç–æ—Ç—ã –ø–æ–∫–∞ –ø—Ä–æ—Å—Ç–æ –ø–æ–∫–∞–∑—ã–≤–∞–µ–º alert
        alert('–§—É–Ω–∫—Ü–∏—è —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–π –±—É–¥–µ—Ç –¥–æ–±–∞–≤–ª–µ–Ω–∞ –≤ —Å–ª–µ–¥—É—é—â–µ–π –≤–µ—Ä—Å–∏–∏.\n\n–ü–æ–∫–∞ —á—Ç–æ –≤—ã –º–æ–∂–µ—Ç–µ —Å–æ–∑–¥–∞—Ç—å –Ω–æ–≤—É—é —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏—é –∏ —É–¥–∞–ª–∏—Ç—å —Å—Ç–∞—Ä—É—é.');
    }
</script>
{% endblock %}
