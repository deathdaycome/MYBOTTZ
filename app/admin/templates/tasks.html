{% extends "base.html" %}

{% block title %}–ü–ª–∞–Ω–∏—Ä–æ–≤—â–∏–∫ –∑–∞–¥–∞—á - –ê–¥–º–∏–Ω-–ø–∞–Ω–µ–ª—å{% endblock %}

{% block extra_css %}
<link rel="stylesheet" href="/admin/static/css/tasks.css">
{% endblock %}

{% block extra_head %}
<script>
// –î–æ–±–∞–≤–ª—è–µ–º –∫–ª–∞—Å—Å –∫ body –¥–ª—è —Å—Ç–∏–ª–∏–∑–∞—Ü–∏–∏ —Å—Ç—Ä–∞–Ω–∏—Ü—ã –∑–∞–¥–∞—á
document.addEventListener('DOMContentLoaded', function() {
    document.body.classList.add('tasks-page');
});
</script>
{% endblock %}

{% block content %}
<!-- –û—Ç–ª–∞–¥–∫–∞ —É–¥–∞–ª–µ–Ω–∞ - —Å—Ç–∏–ª–∏ —Ä–∞–±–æ—Ç–∞—é—Ç! -->

<div class="w-100">
    <!-- –ó–∞–≥–æ–ª–æ–≤–æ–∫ -->
    <div class="d-flex justify-content-between align-items-center mb-4">
        <div>
            <h1 class="mb-2">
                <i class="fas fa-tasks text-primary me-3"></i>
                {% if current_user.role == "owner" %}
                –ü–ª–∞–Ω–∏—Ä–æ–≤—â–∏–∫ –∑–∞–¥–∞—á
                {% else %}
                –ú–æ–∏ –∑–∞–¥–∞—á–∏
                {% endif %}
            </h1>
            <p class="text-muted">–ö–∞–Ω–±–∞–Ω-–¥–æ—Å–∫–∞ –¥–ª—è —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è –∑–∞–¥–∞—á–∞–º–∏ –∫–æ–º–∞–Ω–¥—ã</p>
        </div>
    </div>

    <!-- –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –∏ —Ñ–∏–ª—å—Ç—Ä—ã -->
    <div class="stats-container">
        <div class="stats-grid">
            <div class="stat-item">
                <div class="stat-number">{{ stats.total }}</div>
                <div class="stat-label">–í—Å–µ–≥–æ –∑–∞–¥–∞—á</div>
            </div>
            <div class="stat-item">
                <div class="stat-number">{{ stats.in_progress }}</div>
                <div class="stat-label">–í —Ä–∞–±–æ—Ç–µ</div>
            </div>
            <div class="stat-item">
                <div class="stat-number">{{ stats.completed }}</div>
                <div class="stat-label">–í—ã–ø–æ–ª–Ω–µ–Ω–æ</div>
            </div>
            <div class="stat-item">
                <div class="stat-number">{{ stats.overdue }}</div>
                <div class="stat-label">–ü—Ä–æ—Å—Ä–æ—á–µ–Ω–æ</div>
            </div>
        </div>
        
        <div class="filters-row">
            <div class="filter-group">
                <label>–°—Ç–∞—Ç—É—Å:</label>
                <select class="filter-select" id="statusFilter" onchange="filterTasks()">
                    <option value="">–í—Å–µ —Å—Ç–∞—Ç—É—Å—ã</option>
                    <option value="pending">–û–∂–∏–¥–∞–µ—Ç</option>
                    <option value="in_progress">–í —Ä–∞–±–æ—Ç–µ</option>
                    <option value="completed">–í—ã–ø–æ–ª–Ω–µ–Ω–æ</option>
                </select>
            </div>
            <div class="filter-group">
                <label>–ü—Ä–∏–æ—Ä–∏—Ç–µ—Ç:</label>
                <select class="filter-select" id="priorityFilter" onchange="filterTasks()">
                    <option value="">–í—Å–µ –ø—Ä–∏–æ—Ä–∏—Ç–µ—Ç—ã</option>
                    <option value="urgent">–°—Ä–æ—á–Ω–æ</option>
                    <option value="high">–í—ã—Å–æ–∫–∏–π</option>
                    <option value="normal">–û–±—ã—á–Ω—ã–π</option>
                    <option value="low">–ù–∏–∑–∫–∏–π</option>
                </select>
            </div>
            <div class="filter-group">
                <label>–°–æ—Ä—Ç–∏—Ä–æ–≤–∫–∞:</label>
                <select class="filter-select" id="sortFilter" onchange="sortTasks()">
                    <option value="created_desc">–ü–æ –¥–∞—Ç–µ —Å–æ–∑–¥–∞–Ω–∏—è (–Ω–æ–≤—ã–µ)</option>
                    <option value="created_asc">–ü–æ –¥–∞—Ç–µ —Å–æ–∑–¥–∞–Ω–∏—è (—Å—Ç–∞—Ä—ã–µ)</option>
                    <option value="deadline_asc">–ü–æ –¥–µ–¥–ª–∞–π–Ω—É (–±–ª–∏–∂–∞–π—à–∏–µ)</option>
                    <option value="priority">–ü–æ –ø—Ä–∏–æ—Ä–∏—Ç–µ—Ç—É</option>
                </select>
            </div>
        </div>
    </div>

    <!-- –ö–∞–Ω–±–∞–Ω –¥–æ—Å–∫–∞ -->
    <div class="kanban-board" id="kanbanBoard">
        {% if employees %}
            {% for employee in employees %}
            <div class="kanban-column" data-employee-id="{{ employee.id }}">
                <div class="column-header">
                    <div class="employee-avatar">
                        {{ employee.first_name[0] if employee.first_name else employee.username[0] }}{{ employee.last_name[0] if employee.last_name else '' }}
                    </div>
                    <div class="employee-info">
                        <h4>{{ employee.first_name }} {{ employee.last_name }}</h4>
                        <div class="employee-stats">
                            <span id="tasks-count-{{ employee.id }}">0</span> –∑–∞–¥–∞—á
                        </div>
                    </div>
                    <div class="task-count-badge" id="badge-{{ employee.id }}">0</div>
                </div>
                
                <div class="tasks-container" id="tasks-{{ employee.id }}">
                    <!-- –ó–∞–¥–∞—á–∏ –±—É–¥—É—Ç –∑–∞–≥—Ä—É–∂–µ–Ω—ã —á–µ—Ä–µ–∑ JavaScript -->
                </div>
            </div>
            {% endfor %}
        {% else %}
            <div class="empty-state">
                <i class="fas fa-users-slash fa-4x text-muted mb-3"></i>
                <h3 class="text-muted">–ù–µ—Ç —Å–æ—Ç—Ä—É–¥–Ω–∏–∫–æ–≤</h3>
                <p class="text-muted mb-4">–î–æ–±–∞–≤—å—Ç–µ —Å–æ—Ç—Ä—É–¥–Ω–∏–∫–æ–≤ –≤ —Å–∏—Å—Ç–µ–º–µ –¥–ª—è —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è –∑–∞–¥–∞—á–∞–º–∏</p>
                {% if current_user.role == "owner" %}
                <a href="/admin/contractors" class="btn btn-primary">
                    <i class="fas fa-plus me-2"></i>–î–æ–±–∞–≤–∏—Ç—å —Å–æ—Ç—Ä—É–¥–Ω–∏–∫–∞
                </a>
                {% endif %}
            </div>
        {% endif %}
    </div>
</div>

<!-- –ú–æ–±–∏–ª—å–Ω–∞—è –≤–µ—Ä—Å–∏—è –ø–ª–∞–Ω–∏—Ä–æ–≤—â–∏–∫–∞ -->
<div class="mobile-task-view" id="mobileTaskView">
    <!-- –ú–æ–±–∏–ª—å–Ω–∞—è –Ω–∞–≤–∏–≥–∞—Ü–∏—è -->
    <div class="mobile-task-nav">
        <a href="/admin/" class="mobile-nav-back">
            <i class="fas fa-arrow-left me-2"></i>
            –ù–∞–∑–∞–¥ –∫ –º–µ–Ω—é
        </a>
        <div class="mobile-nav-title">–ü–ª–∞–Ω–∏—Ä–æ–≤—â–∏–∫ –∑–∞–¥–∞—á</div>
    </div>
    
    {% if employees %}
    <!-- –°–µ–ª–µ–∫—Ç–æ—Ä –∏—Å–ø–æ–ª–Ω–∏—Ç–µ–ª–µ–π -->
    <div class="mobile-employee-selector">
        <h3>–í—ã–±–µ—Ä–∏—Ç–µ –∏—Å–ø–æ–ª–Ω–∏—Ç–µ–ª—è</h3>
        <div class="employee-tabs" id="employeeTabs">
            {% for employee in employees %}
            <div class="employee-tab" data-employee-id="{{ employee.id }}" onclick="selectMobileEmployee({{ employee.id }})">
                <div class="avatar">
                    {{ employee.first_name[0] if employee.first_name else employee.username[0] }}{{ employee.last_name[0] if employee.last_name else '' }}
                </div>
                <div class="info">
                    <div class="name">{{ employee.first_name }} {{ employee.last_name }}</div>
                    <div class="task-count">
                        <span id="mobile-task-count-{{ employee.id }}">0</span> –∑–∞–¥–∞—á
                    </div>
                </div>
            </div>
            {% endfor %}
        </div>
    </div>

    <!-- –ö–æ–Ω—Ç–µ–π–Ω–µ—Ä –∑–∞–¥–∞—á -->
    <div class="mobile-tasks-container" id="mobileTasksContainer">
        <div class="mobile-empty-state" id="mobileEmptyState">
            <i class="fas fa-clipboard-list"></i>
            <h4>–í—ã–±–µ—Ä–∏—Ç–µ –∏—Å–ø–æ–ª–Ω–∏—Ç–µ–ª—è</h4>
            <p>–í—ã–±–µ—Ä–∏—Ç–µ –∏—Å–ø–æ–ª–Ω–∏—Ç–µ–ª—è –≤—ã—à–µ, —á—Ç–æ–±—ã —É–≤–∏–¥–µ—Ç—å –µ–≥–æ –∑–∞–¥–∞—á–∏</p>
        </div>
    </div>
    {% else %}
    <div class="mobile-empty-state">
        <i class="fas fa-users-slash"></i>
        <h4>–ù–µ—Ç —Å–æ—Ç—Ä—É–¥–Ω–∏–∫–æ–≤</h4>
        <p>–î–æ–±–∞–≤—å—Ç–µ —Å–æ—Ç—Ä—É–¥–Ω–∏–∫–æ–≤ –≤ —Å–∏—Å—Ç–µ–º–µ –¥–ª—è —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è –∑–∞–¥–∞—á–∞–º–∏</p>
        {% if current_user.role == "owner" %}
        <a href="/admin/contractors" class="btn btn-primary">
            <i class="fas fa-plus me-2"></i>–î–æ–±–∞–≤–∏—Ç—å —Å–æ—Ç—Ä—É–¥–Ω–∏–∫–∞
        </a>
        {% endif %}
    </div>
    {% endif %}
</div>

<!-- –ö–Ω–æ–ø–∫–∞ —Å–æ–∑–¥–∞–Ω–∏—è –∑–∞–¥–∞—á–∏ -->
{% if current_user.role == "owner" %}
<button class="create-task-btn" data-bs-toggle="modal" data-bs-target="#createTaskModal">
    <i class="fas fa-plus"></i>
</button>
{% endif %}

<!-- –ú–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ —Å–æ–∑–¥–∞–Ω–∏—è –∑–∞–¥–∞—á–∏ -->
{% if current_user.role == "owner" %}
<div class="modal fade" id="createTaskModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">–°–æ–∑–¥–∞—Ç—å –Ω–æ–≤—É—é –∑–∞–¥–∞—á—É</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <form id="createTaskForm" method="post" action="/admin/api/tasks">
                <div class="modal-body">
                    <div class="row">
                        <div class="col-md-8 mb-3">
                            <label for="taskTitle" class="form-label fw-semibold">–ó–∞–≥–æ–ª–æ–≤–æ–∫ –∑–∞–¥–∞—á–∏ *</label>
                            <input type="text" class="form-control" id="taskTitle" name="title" required>
                        </div>
                        <div class="col-md-4 mb-3">
                            <label for="taskPriority" class="form-label fw-semibold">–ü—Ä–∏–æ—Ä–∏—Ç–µ—Ç</label>
                            <select class="form-select" id="taskPriority" name="priority">
                                <option value="normal">–û–±—ã—á–Ω—ã–π</option>
                                <option value="low">–ù–∏–∑–∫–∏–π</option>
                                <option value="high">–í—ã—Å–æ–∫–∏–π</option>
                                <option value="urgent">–°—Ä–æ—á–Ω–æ</option>
                            </select>
                        </div>
                    </div>
                    
                    <div class="mb-3">
                        <label for="taskDescription" class="form-label fw-semibold">–û–ø–∏—Å–∞–Ω–∏–µ</label>
                        <textarea class="form-control" id="taskDescription" name="description" rows="3"></textarea>
                    </div>
                    
                    <div class="row">
                        <div class="col-md-6 mb-3">
                            <label for="taskAssignee" class="form-label fw-semibold">–ù–∞–∑–Ω–∞—á–∏—Ç—å —Å–æ—Ç—Ä—É–¥–Ω–∏–∫—É *</label>
                            <select class="form-select" id="taskAssignee" name="assigned_to_id" required>
                                <option value="">–í—ã–±–µ—Ä–∏—Ç–µ —Å–æ—Ç—Ä—É–¥–Ω–∏–∫–∞</option>
                                {% for employee in employees %}
                                <option value="{{ employee.id }}">{{ employee.first_name }} {{ employee.last_name }}</option>
                                {% endfor %}
                            </select>
                        </div>
                        <div class="col-md-6 mb-3">
                            <label for="taskDeadline" class="form-label fw-semibold">–î–µ–¥–ª–∞–π–Ω</label>
                            <input type="datetime-local" class="form-control" id="taskDeadline" name="deadline">
                        </div>
                    </div>
                    
                    <div class="row">
                        <div class="col-md-6 mb-3">
                            <label for="estimatedHours" class="form-label fw-semibold">–û—Ü–µ–Ω–∫–∞ –≤—Ä–µ–º–µ–Ω–∏ (—á–∞—Å—ã)</label>
                            <input type="number" class="form-control" id="estimatedHours" name="estimated_hours" min="1" max="100">
                        </div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">–û—Ç–º–µ–Ω–∞</button>
                    <button type="submit" class="btn btn-primary">
                        <i class="fas fa-plus me-2"></i>–°–æ–∑–¥–∞—Ç—å –∑–∞–¥–∞—á—É
                    </button>
                </div>
            </form>
        </div>
    </div>
</div>
{% endif %}
{% endblock %}

{% block extra_scripts %}
<script>
// –û—Ç–ª–∞–¥–∫–∞ JavaScript –∏ —Ñ–æ—Ä–º—ã
console.log('=== –û–¢–õ–ê–î–ö–ê –°–¢–†–ê–ù–ò–¶–´ –ó–ê–î–ê–ß ===');
console.log('1. –ü—Ä–æ–≤–µ—Ä—è–µ–º –Ω–∞–ª–∏—á–∏–µ jQuery –∏ Bootstrap:');
console.log('jQuery:', typeof $ !== 'undefined' ? '–Ω–∞–π–¥–µ–Ω' : '‚ùå –ù–ï –ù–ê–ô–î–ï–ù');
console.log('Bootstrap:', typeof bootstrap !== 'undefined' ? '–Ω–∞–π–¥–µ–Ω' : '‚ùå –ù–ï –ù–ê–ô–î–ï–ù');

console.log('2. –ü—Ä–æ–≤–µ—Ä—è–µ–º —Ñ–æ—Ä–º—É —Å–æ–∑–¥–∞–Ω–∏—è –∑–∞–¥–∞—á–∏:');
let form = document.getElementById('createTaskForm');
console.log('–§–æ—Ä–º–∞ createTaskForm:', form ? '–Ω–∞–π–¥–µ–Ω–∞' : '‚ùå –ù–ï –ù–ê–ô–î–ï–ù–ê');

console.log('3. –î–æ–±–∞–≤–ª—è–µ–º –∫–ª–∞—Å—Å tasks-page –∫ body');
document.body.className = 'tasks-page';

console.log('4. –ü—Ä–æ–≤–µ—Ä—è–µ–º –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –∑–∞–¥–∞—á –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ:');
console.log('–ò—Å—Ö–æ–¥–Ω—ã–µ –∑–∞–¥–∞—á–∏:', allTasks);
console.log('–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ –∑–∞–¥–∞—á:', allTasks ? allTasks.length : '–ù–ï–¢ –î–ê–ù–ù–´–•');
</script>
<script>
// –ì–ª–æ–±–∞–ª—å–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ
let allTasks = {{ tasks | tojson }};
let currentFilter = {
    status: '',
    priority: '',
    sort: 'created_desc'
};
const currentUserRole = '{{ current_user.role }}';
console.log('üë§ –¢–µ–∫—É—â–∞—è —Ä–æ–ª—å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è:', currentUserRole);

// –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –¥–æ—Å–∫–∏
document.addEventListener('DOMContentLoaded', function() {
    loadTasksToBoard();
    updateEmployeeStats();
    initializeDragDropZones();

    // –ó–∞–ø—É—Å–∫–∞–µ–º –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ —Ç–∞–π–º–µ—Ä–æ–≤ –∫–∞–∂–¥—É—é —Å–µ–∫—É–Ω–¥—É
    setInterval(updateRunningTimers, 1000);
});

// –§—É–Ω–∫—Ü–∏—è –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è –∑–∞–ø—É—â–µ–Ω–Ω—ã—Ö —Ç–∞–π–º–µ—Ä–æ–≤
function updateRunningTimers() {
    document.querySelectorAll('.timer-display.running').forEach(timerEl => {
        const taskId = timerEl.dataset.taskId;
        const startedAt = timerEl.dataset.startedAt;
        const timeSpent = parseInt(timerEl.dataset.timeSpent) || 0;

        if (startedAt) {
            const startTime = new Date(startedAt);
            const now = new Date();
            const elapsedSeconds = Math.floor((now - startTime) / 1000);
            const totalSeconds = timeSpent + elapsedSeconds;

            const hours = Math.floor(totalSeconds / 3600);
            const minutes = Math.floor((totalSeconds % 3600) / 60);
            const seconds = totalSeconds % 60;

            timerEl.textContent = `${hours}:${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')}`;
        }
    });
}

// –ó–∞–≥—Ä—É–∑–∫–∞ –∑–∞–¥–∞—á –Ω–∞ –¥–æ—Å–∫—É
function loadTasksToBoard() {
    console.log('üîÑ –ó–∞–≥—Ä—É–∂–∞–µ–º –∑–∞–¥–∞—á–∏ –Ω–∞ –¥–æ—Å–∫—É. –í—Å–µ–≥–æ –∑–∞–¥–∞—á:', allTasks.length);
    
    // –û—á–∏—â–∞–µ–º –≤—Å–µ –∫–æ–ª–æ–Ω–∫–∏
    document.querySelectorAll('.tasks-container').forEach(container => {
        container.innerHTML = '';
    });
    
    // –§–∏–ª—å—Ç—Ä—É–µ–º –∏ —Å–æ—Ä—Ç–∏—Ä—É–µ–º –∑–∞–¥–∞—á–∏
    let filteredTasks = filterAndSortTasks(allTasks);
    console.log('üìã –ü–æ—Å–ª–µ —Ñ–∏–ª—å—Ç—Ä–∞—Ü–∏–∏ –∑–∞–¥–∞—á:', filteredTasks.length);
    
    // –ì—Ä—É–ø–ø–∏—Ä—É–µ–º –ø–æ –∏—Å–ø–æ–ª–Ω–∏—Ç–µ–ª—è–º
    let tasksByEmployee = {};
    filteredTasks.forEach(task => {
        console.log('üë§ –ó–∞–¥–∞—á–∞ –¥–ª—è —Å–æ—Ç—Ä—É–¥–Ω–∏–∫–∞ ID:', task.assigned_to_id, '–ó–∞–≥–æ–ª–æ–≤–æ–∫:', task.title);
        if (!tasksByEmployee[task.assigned_to_id]) {
            tasksByEmployee[task.assigned_to_id] = [];
        }
        tasksByEmployee[task.assigned_to_id].push(task);
    });
    
    console.log('üìä –ì—Ä—É–ø–ø–∏—Ä–æ–≤–∫–∞ –ø–æ —Å–æ—Ç—Ä—É–¥–Ω–∏–∫–∞–º:', tasksByEmployee);
    
    // –û—Ç–æ–±—Ä–∞–∂–∞–µ–º –∑–∞–¥–∞—á–∏ –≤ –∫–æ–ª–æ–Ω–∫–∞—Ö
    Object.keys(tasksByEmployee).forEach(employeeId => {
        const container = document.getElementById(`tasks-${employeeId}`);
        console.log('üì¶ –ö–æ–Ω—Ç–µ–π–Ω–µ—Ä –¥–ª—è —Å–æ—Ç—Ä—É–¥–Ω–∏–∫–∞', employeeId, ':', container);
        if (container) {
            tasksByEmployee[employeeId].forEach(task => {
                const card = createTaskCard(task);
                console.log('üè∑Ô∏è –°–æ–∑–¥–∞–Ω–∞ –∫–∞—Ä—Ç–æ—á–∫–∞ –¥–ª—è –∑–∞–¥–∞—á–∏:', task.title, card);
                container.appendChild(card);
            });
        } else {
            console.warn('‚ùå –ö–æ–Ω—Ç–µ–π–Ω–µ—Ä –Ω–µ –Ω–∞–π–¥–µ–Ω –¥–ª—è —Å–æ—Ç—Ä—É–¥–Ω–∏–∫–∞ ID:', employeeId);
        }
    });
    
    updateEmployeeStats();
}

// –°–æ–∑–¥–∞–Ω–∏–µ –∫–∞—Ä—Ç–æ—á–∫–∏ –∑–∞–¥–∞—á–∏
function createTaskCard(task) {
    const card = document.createElement('div');
    card.className = `task-card priority-${task.priority} status-${task.status}`;
    card.dataset.taskId = task.id;
    card.dataset.status = task.status;
    card.dataset.priority = task.priority;
    card.dataset.employeeId = task.assigned_to_id;
    
    // –î–æ–±–∞–≤–ª—è–µ–º drag & drop –∞—Ç—Ä–∏–±—É—Ç—ã
    card.draggable = true;
    
    // –ü—Ä–æ–≤–µ—Ä—è–µ–º –ø—Ä–æ—Å—Ä–æ—á–µ–Ω–∞ –ª–∏ –∑–∞–¥–∞—á–∞
    let isOverdue = false;
    let deadlineClass = '';
    let deadlineText = '';
    
    if (task.deadline) {
        const deadline = new Date(task.deadline);
        const now = new Date();
        const today = new Date(now.getFullYear(), now.getMonth(), now.getDate());
        const taskDay = new Date(deadline.getFullYear(), deadline.getMonth(), deadline.getDate());
        
        if (deadline < now && task.status !== 'completed') {
            isOverdue = true;
            card.classList.add('overdue');
            deadlineClass = 'overdue';
            deadlineText = '–ü—Ä–æ—Å—Ä–æ—á–µ–Ω–æ';
        } else if (taskDay.getTime() === today.getTime()) {
            deadlineClass = 'today';
            deadlineText = '–°–µ–≥–æ–¥–Ω—è';
        } else {
            deadlineText = deadline.toLocaleDateString('ru-RU');
        }
    }
    
    const statusText = {
        'pending': '–û–∂–∏–¥–∞–µ—Ç',
        'in_progress': '–í —Ä–∞–±–æ—Ç–µ',
        'completed': '–í—ã–ø–æ–ª–Ω–µ–Ω–æ',
        'cancelled': '–û—Ç–º–µ–Ω–µ–Ω–æ'
    };
    
    const priorityText = {
        'low': '–ù–∏–∑–∫–∏–π',
        'normal': '–û–±—ã—á–Ω—ã–π', 
        'high': '–í—ã—Å–æ–∫–∏–π',
        'urgent': '–°—Ä–æ—á–Ω–æ'
    };
    
    const progress = task.progress || 0;
    const timeSpent = task.time_spent_seconds || 0;
    const timerRunning = task.timer_started_at !== null;

    const hours = Math.floor(timeSpent / 3600);
    const minutes = Math.floor((timeSpent % 3600) / 60);
    const timeFormatted = `${hours}:${minutes.toString().padStart(2, '0')}`;

    console.log('üéØ –°–æ–∑–¥–∞–Ω–∏–µ –∫–∞—Ä—Ç–æ—á–∫–∏:', task.title, 'status:', task.status, 'progress:', progress, 'timeSpent:', timeSpent);

    // –î–æ–±–∞–≤–ª—è–µ–º –∫–ª–∞—Å—Å –¥–ª—è –≥—Ä–∞–¥–∏–µ–Ω—Ç–Ω–æ–π –∞–Ω–∏–º–∞—Ü–∏–∏ –≤—ã–ø–æ–ª–Ω–µ–Ω–Ω—ã—Ö –∑–∞–¥–∞—á
    if (task.status === 'completed') {
        card.classList.add('task-completed-gradient');
    }

    card.innerHTML = `
        <div class="task-title">${escapeHtml(task.title)}</div>
        ${task.description ? `<div class="task-description">${escapeHtml(task.description)}</div>` : ''}

        <div class="task-badges">
            <span class="priority-badge priority-${task.priority}">${priorityText[task.priority]}</span>
            <span class="status-badge status-${task.status}">${statusText[task.status]}</span>
        </div>

        ${task.status !== 'completed' ? `
        <div class="task-progress-container">
            <div class="task-progress-bar" onclick="openProgressModal(${task.id}, ${progress}); event.stopPropagation();">
                <div class="task-progress-fill" style="width: ${progress}%"></div>
            </div>
            <div class="task-progress-text">${progress}%</div>
        </div>

        <div class="task-timer">
            <div class="timer-display ${timerRunning ? 'running' : ''}" id="timer-${task.id}" data-task-id="${task.id}" data-time-spent="${timeSpent}" data-started-at="${task.timer_started_at || ''}">${timeFormatted}</div>
            ${!timerRunning ?
                `<button class="timer-btn timer-btn-start" onclick="startTimer(${task.id}); event.stopPropagation();">‚ñ∂ –°—Ç–∞—Ä—Ç</button>` :
                `<button class="timer-btn timer-btn-stop" onclick="stopTimer(${task.id}); event.stopPropagation();">‚ñ† –°—Ç–æ–ø</button>`
            }
        </div>

        <button class="task-complete-btn" onclick="markTaskCompleted(${task.id}); event.stopPropagation();">
            <i class="fas fa-check-circle"></i> –í—ã–ø–æ–ª–Ω–µ–Ω–∞
        </button>
        ` : `
        <div class="task-completed-info">
            <i class="fas fa-check-circle"></i> –ó–∞–¥–∞—á–∞ –≤—ã–ø–æ–ª–Ω–µ–Ω–∞
            ${task.task_metadata && task.task_metadata.marked_completed_by_employee ? `
                <div class="completed-by">–û—Ç–º–µ—á–µ–Ω–∞: ${task.task_metadata.marked_completed_by_employee.employee_name}</div>
            ` : ''}
        </div>
        ${window.userRole === 'owner' && (!task.task_metadata || !task.task_metadata.archived) ? `
            <button class="task-archive-btn" onclick="archiveTask(${task.id}); event.stopPropagation();">
                <i class="fas fa-archive"></i> –í –∞—Ä—Ö–∏–≤
            </button>
        ` : ''}
        `}

        <div class="task-meta">
            ${task.deadline ? `<span class="task-deadline ${deadlineClass}"><i class="fas fa-calendar"></i> ${deadlineText}</span>` : ''}
            ${task.comments_count > 0 ? `<span><i class="fas fa-comments"></i> ${task.comments_count}</span>` : ''}
        </div>
    `;
    
    // –î–æ–±–∞–≤–ª—è–µ–º drag & drop –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–∏
    card.addEventListener('dragstart', handleDragStart);
    card.addEventListener('dragend', handleDragEnd);
    
    // –î–æ–±–∞–≤–ª—è–µ–º –æ–±—Ä–∞–±–æ—Ç—á–∏–∫ –∫–ª–∏–∫–∞ –¥–ª—è –æ—Ç–∫—Ä—ã—Ç–∏—è –¥–µ—Ç–∞–ª—å–Ω–æ–π –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏ (—Ç–æ–ª—å–∫–æ –µ—Å–ª–∏ –Ω–µ –ø–µ—Ä–µ—Ç–∞—Å–∫–∏–≤–∞–µ–º)
    card.addEventListener('click', (e) => {
        if (!card.classList.contains('dragging')) {
            window.location.href = `/admin/tasks/${task.id}`;
        }
    });
    
    return card;
}

// –§–∏–ª—å—Ç—Ä–∞—Ü–∏—è –∏ —Å–æ—Ä—Ç–∏—Ä–æ–≤–∫–∞ –∑–∞–¥–∞—á
function filterAndSortTasks(tasks) {
    let filtered = tasks.filter(task => {
        if (currentFilter.status && task.status !== currentFilter.status) return false;
        if (currentFilter.priority && task.priority !== currentFilter.priority) return false;
        return true;
    });
    
    // –°–æ—Ä—Ç–∏—Ä–æ–≤–∫–∞
    filtered.sort((a, b) => {
        switch (currentFilter.sort) {
            case 'created_asc':
                return new Date(a.created_at) - new Date(b.created_at);
            case 'created_desc':
                return new Date(b.created_at) - new Date(a.created_at);
            case 'deadline_asc':
                if (!a.deadline) return 1;
                if (!b.deadline) return -1;
                return new Date(a.deadline) - new Date(b.deadline);
            case 'priority':
                const priorityOrder = { 'urgent': 4, 'high': 3, 'normal': 2, 'low': 1 };
                return priorityOrder[b.priority] - priorityOrder[a.priority];
            default:
                return 0;
        }
    });
    
    return filtered;
}

// –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏ –ø–æ —Å–æ—Ç—Ä—É–¥–Ω–∏–∫–∞–º
function updateEmployeeStats() {
    const employeeStats = {};
    
    // –ü–æ–¥—Å—á–∏—Ç—ã–≤–∞–µ–º –∑–∞–¥–∞—á–∏ –¥–ª—è –∫–∞–∂–¥–æ–≥–æ —Å–æ—Ç—Ä—É–¥–Ω–∏–∫–∞
    allTasks.forEach(task => {
        if (!employeeStats[task.assigned_to_id]) {
            employeeStats[task.assigned_to_id] = 0;
        }
        employeeStats[task.assigned_to_id]++;
    });
    
    // –û–±–Ω–æ–≤–ª—è–µ–º —Å—á–µ—Ç—á–∏–∫–∏ –≤ UI
    Object.keys(employeeStats).forEach(employeeId => {
        const countElement = document.getElementById(`tasks-count-${employeeId}`);
        const badgeElement = document.getElementById(`badge-${employeeId}`);
        
        if (countElement) {
            countElement.textContent = employeeStats[employeeId];
        }
        if (badgeElement) {
            badgeElement.textContent = employeeStats[employeeId];
        }
    });
}

// –û–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ —Ñ–∏–ª—å—Ç—Ä–æ–≤
function filterTasks() {
    currentFilter.status = document.getElementById('statusFilter').value;
    currentFilter.priority = document.getElementById('priorityFilter').value;
    loadTasksToBoard();
}

function sortTasks() {
    currentFilter.sort = document.getElementById('sortFilter').value;
    loadTasksToBoard();
}

// Utility —Ñ—É–Ω–∫—Ü–∏–∏
function escapeHtml(text) {
    const map = {
        '&': '&amp;',
        '<': '&lt;',
        '>': '&gt;',
        '"': '&quot;',
        "'": '&#039;'
    };
    return text.replace(/[&<>"']/g, m => map[m]);
}

// –û–±—Ä–∞–±–æ—Ç–∫–∞ —Ñ–æ—Ä–º—ã —Å–æ–∑–¥–∞–Ω–∏—è –∑–∞–¥–∞—á–∏
document.getElementById('createTaskForm')?.addEventListener('submit', async function(e) {
    console.log('üìù –§–æ—Ä–º–∞ –æ—Ç–ø—Ä–∞–≤–ª—è–µ—Ç—Å—è!');
    e.preventDefault();
    
    const formData = new FormData(this);
    
    try {
        console.log('üì§ –û—Ç–ø—Ä–∞–≤–ª—è–µ–º –¥–∞–Ω–Ω—ã–µ —Ñ–æ—Ä–º—ã...');
        const response = await fetch('/admin/api/tasks', {
            method: 'POST',
            body: formData
        });
        
        console.log('üì• –ü–æ–ª—É—á–µ–Ω –æ—Ç–≤–µ—Ç:', response.status);
        
        if (response.ok) {
            const result = await response.json();
            console.log('‚úÖ –†–µ–∑—É–ª—å—Ç–∞—Ç:', result);
            
            if (result.success) {
                // –ó–∞–∫—Ä—ã–≤–∞–µ–º –º–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ
                const modalElement = document.getElementById('createTaskModal');
                const modal = bootstrap.Modal.getInstance(modalElement) || new bootstrap.Modal(modalElement);
                modal.hide();
                
                // –û—á–∏—â–∞–µ–º —Ñ–æ—Ä–º—É
                this.reset();
                
                // –î–æ–±–∞–≤–ª—è–µ–º –Ω–æ–≤—É—é –∑–∞–¥–∞—á—É –∫ —Å–ø–∏—Å–∫—É
                allTasks.push(result.task);
                console.log('üîÑ –ü–µ—Ä–µ–∑–∞–≥—Ä—É–∂–∞–µ–º –¥–æ—Å–∫—É —Å –Ω–æ–≤–æ–π –∑–∞–¥–∞—á–µ–π');
                loadTasksToBoard();
                
                // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ
                showNotification('–ó–∞–¥–∞—á–∞ —É—Å–ø–µ—à–Ω–æ —Å–æ–∑–¥–∞–Ω–∞!', 'success');
            } else {
                showNotification('–û—à–∏–±–∫–∞ –ø—Ä–∏ —Å–æ–∑–¥–∞–Ω–∏–∏ –∑–∞–¥–∞—á–∏: ' + (result.message || '–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–∞—è –æ—à–∏–±–∫–∞'), 'error');
            }
        } else {
            const error = await response.json();
            console.error('‚ùå –û—à–∏–±–∫–∞ —Å–µ—Ä–≤–µ—Ä–∞:', error);
            showNotification('–û—à–∏–±–∫–∞ –ø—Ä–∏ —Å–æ–∑–¥–∞–Ω–∏–∏ –∑–∞–¥–∞—á–∏: ' + (error.detail || '–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–∞—è –æ—à–∏–±–∫–∞'), 'error');
        }
    } catch (error) {
        console.error('‚ùå –ö—Ä–∏—Ç–∏—á–µ—Å–∫–∞—è –æ—à–∏–±–∫–∞:', error);
        showNotification('–û—à–∏–±–∫–∞ –ø—Ä–∏ —Å–æ–∑–¥–∞–Ω–∏–∏ –∑–∞–¥–∞—á–∏', 'error');
    }
});

// –°–∏—Å—Ç–µ–º–∞ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π
function showNotification(message, type = 'info') {
    // –ü—Ä–æ—Å—Ç–∞—è —Ä–µ–∞–ª–∏–∑–∞—Ü–∏—è —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π
    const notification = document.createElement('div');
    notification.className = `alert alert-${type === 'error' ? 'danger' : type === 'success' ? 'success' : 'info'} position-fixed`;
    notification.style.cssText = 'top: 20px; right: 20px; z-index: 9999; min-width: 300px;';
    notification.textContent = message;
    
    document.body.appendChild(notification);
    
    setTimeout(() => {
        notification.remove();
    }, 3000);
}

// –ú–û–ë–ò–õ–¨–ù–ê–Ø –í–ï–†–°–ò–Ø –ü–õ–ê–ù–ò–†–û–í–©–ò–ö–ê
let selectedMobileEmployee = null;

function selectMobileEmployee(employeeId) {
    selectedMobileEmployee = employeeId;
    
    // –û–±–Ω–æ–≤–ª—è–µ–º –∞–∫—Ç–∏–≤–Ω—ã–π —Ç–∞–±
    document.querySelectorAll('.employee-tab').forEach(tab => {
        tab.classList.remove('active');
    });
    document.querySelector(`[data-employee-id="${employeeId}"]`).classList.add('active');
    
    // –ó–∞–≥—Ä—É–∂–∞–µ–º –∑–∞–¥–∞—á–∏ –¥–ª—è –≤—ã–±—Ä–∞–Ω–Ω–æ–≥–æ —Å–æ—Ç—Ä—É–¥–Ω–∏–∫–∞
    loadMobileEmployeeTasks(employeeId);
}

function loadMobileEmployeeTasks(employeeId) {
    const container = document.getElementById('mobileTasksContainer');
    const emptyState = document.getElementById('mobileEmptyState');
    
    // –§–∏–ª—å—Ç—Ä—É–µ–º –∑–∞–¥–∞—á–∏ –¥–ª—è –¥–∞–Ω–Ω–æ–≥–æ —Å–æ—Ç—Ä—É–¥–Ω–∏–∫–∞
    const employeeTasks = allTasks.filter(task => task.assigned_to_id === employeeId);
    
    if (employeeTasks.length === 0) {
        container.innerHTML = `
            <div class="mobile-empty-state">
                <i class="fas fa-tasks"></i>
                <h4>–ù–µ—Ç –∑–∞–¥–∞—á</h4>
                <p>–£ —ç—Ç–æ–≥–æ –∏—Å–ø–æ–ª–Ω–∏—Ç–µ–ª—è –ø–æ–∫–∞ –Ω–µ—Ç –Ω–∞–∑–Ω–∞—á–µ–Ω–Ω—ã—Ö –∑–∞–¥–∞—á</p>
            </div>
        `;
        return;
    }
    
    // –°–æ–∑–¥–∞–µ–º –∫–∞—Ä—Ç–æ—á–∫–∏ –∑–∞–¥–∞—á
    container.innerHTML = employeeTasks.map(task => createMobileTaskCard(task)).join('');
}

function createMobileTaskCard(task) {
    const statusClass = getStatusClass(task.status);
    const priorityClass = getPriorityClass(task.priority);
    
    const deadlineHtml = task.deadline ? 
        `<div class="mobile-task-deadline ${isOverdue(task.deadline) ? 'overdue' : ''}">
            <i class="fas fa-clock"></i>
            ${formatDeadline(task.deadline)}
        </div>` : '';
    
    return `
        <div class="mobile-task-card" data-task-id="${task.id}">
            <div class="mobile-task-header">
                <div class="mobile-task-title">${task.title}</div>
                <div class="mobile-task-status ${statusClass}">${getStatusText(task.status)}</div>
            </div>
            
            ${task.description ? `<div class="mobile-task-description">${task.description}</div>` : ''}
            
            <div class="mobile-task-meta">
                <div class="mobile-task-priority ${priorityClass}">
                    ${getPriorityText(task.priority)}
                </div>
                ${deadlineHtml}
            </div>
            
            <div class="mobile-task-actions">
                <button class="mobile-task-btn" onclick="viewMobileTask(${task.id})">
                    <i class="fas fa-eye"></i> –ü—Ä–æ—Å–º–æ—Ç—Ä
                </button>
                <button class="mobile-task-btn" onclick="editMobileTask(${task.id})">
                    <i class="fas fa-edit"></i> –ò–∑–º–µ–Ω–∏—Ç—å
                </button>
                ${task.status !== 'completed' ? 
                    `<button class="mobile-task-btn primary" onclick="completeMobileTask(${task.id})">
                        <i class="fas fa-check"></i> –ó–∞–≤–µ—Ä—à–∏—Ç—å
                    </button>` : ''
                }
            </div>
        </div>
    `;
}

function getStatusClass(status) {
    const classes = {
        'pending': 'status-pending',
        'in_progress': 'status-in_progress',
        'completed': 'status-completed'
    };
    return classes[status] || 'status-pending';
}

function getPriorityClass(priority) {
    const classes = {
        'low': 'priority-low',
        'normal': 'priority-normal',
        'high': 'priority-high',
        'urgent': 'priority-urgent'
    };
    return classes[priority] || 'priority-normal';
}

function getStatusText(status) {
    const texts = {
        'pending': '–û–∂–∏–¥–∞–µ—Ç',
        'in_progress': '–í —Ä–∞–±–æ—Ç–µ',
        'completed': '–í—ã–ø–æ–ª–Ω–µ–Ω–æ'
    };
    return texts[status] || '–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–æ';
}

function getPriorityText(priority) {
    const texts = {
        'low': '–ù–∏–∑–∫–∏–π',
        'normal': '–û–±—ã—á–Ω—ã–π',
        'high': '–í—ã—Å–æ–∫–∏–π',
        'urgent': '–°—Ä–æ—á–Ω–æ'
    };
    return texts[priority] || '–û–±—ã—á–Ω—ã–π';
}

function formatDeadline(deadline) {
    const date = new Date(deadline);
    const now = new Date();
    const diffTime = date - now;
    const diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24));
    
    if (diffDays < 0) {
        return `–ü—Ä–æ—Å—Ä–æ—á–µ–Ω–æ –Ω–∞ ${Math.abs(diffDays)} –¥–Ω.`;
    } else if (diffDays === 0) {
        return '–°–µ–≥–æ–¥–Ω—è';
    } else if (diffDays === 1) {
        return '–ó–∞–≤—Ç—Ä–∞';
    } else {
        return `–ß–µ—Ä–µ–∑ ${diffDays} –¥–Ω.`;
    }
}

function isOverdue(deadline) {
    return new Date(deadline) < new Date();
}

function viewMobileTask(taskId) {
    // –ó–¥–µ—Å—å –º–æ–∂–Ω–æ –¥–æ–±–∞–≤–∏—Ç—å –º–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ –¥–ª—è –ø—Ä–æ—Å–º–æ—Ç—Ä–∞ –∑–∞–¥–∞—á–∏
    const task = allTasks.find(t => t.id === taskId);
    if (task) {
        alert(`–ó–∞–¥–∞—á–∞: ${task.title}\n\n–û–ø–∏—Å–∞–Ω–∏–µ: ${task.description || '–ù–µ—Ç –æ–ø–∏—Å–∞–Ω–∏—è'}\n\n–°—Ç–∞—Ç—É—Å: ${getStatusText(task.status)}\n–ü—Ä–∏–æ—Ä–∏—Ç–µ—Ç: ${getPriorityText(task.priority)}`);
    }
}

function editMobileTask(taskId) {
    // –ó–¥–µ—Å—å –º–æ–∂–Ω–æ –¥–æ–±–∞–≤–∏—Ç—å —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –∑–∞–¥–∞—á–∏
    showNotification('–§—É–Ω–∫—Ü–∏—è —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è –≤ —Ä–∞–∑—Ä–∞–±–æ—Ç–∫–µ', 'info');
}

async function completeMobileTask(taskId) {
    try {
        const response = await fetch(`/admin/api/tasks/${taskId}`, {
            method: 'PUT',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({
                status: 'completed'
            })
        });
        
        if (response.ok) {
            const result = await response.json();
            if (result.success) {
                // –û–±–Ω–æ–≤–ª—è–µ–º –∑–∞–¥–∞—á—É –≤ —Å–ø–∏—Å–∫–µ
                const taskIndex = allTasks.findIndex(t => t.id === taskId);
                if (taskIndex !== -1) {
                    allTasks[taskIndex].status = 'completed';
                }
                
                // –ü–µ—Ä–µ–∑–∞–≥—Ä—É–∂–∞–µ–º –º–æ–±–∏–ª—å–Ω—ã–µ –∑–∞–¥–∞—á–∏
                if (selectedMobileEmployee) {
                    loadMobileEmployeeTasks(selectedMobileEmployee);
                }
                
                // –û–±–Ω–æ–≤–ª—è–µ–º —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫—É
                updateEmployeeStats();
                
                showNotification('–ó–∞–¥–∞—á–∞ –ø–æ–º–µ—á–µ–Ω–∞ –∫–∞–∫ –≤—ã–ø–æ–ª–Ω–µ–Ω–Ω–∞—è!', 'success');
            }
        }
    } catch (error) {
        console.error('–û—à–∏–±–∫–∞ –ø—Ä–∏ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–∏ –∑–∞–¥–∞—á–∏:', error);
        showNotification('–û—à–∏–±–∫–∞ –ø—Ä–∏ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–∏ –∑–∞–¥–∞—á–∏', 'error');
    }
}

// –û–±–Ω–æ–≤–ª—è–µ–º —Å—á–µ—Ç—á–∏–∫–∏ –∑–∞–¥–∞—á –≤ –º–æ–±–∏–ª—å–Ω–æ–π –≤–µ—Ä—Å–∏–∏
function updateMobileTaskCounts() {
    if (!allTasks) return;
    
    // –°—á–∏—Ç–∞–µ–º –∑–∞–¥–∞—á–∏ –¥–ª—è –∫–∞–∂–¥–æ–≥–æ —Å–æ—Ç—Ä—É–¥–Ω–∏–∫–∞
    const taskCounts = {};
    allTasks.forEach(task => {
        const employeeId = task.assigned_to_id;
        if (!taskCounts[employeeId]) {
            taskCounts[employeeId] = 0;
        }
        taskCounts[employeeId]++;
    });
    
    // –û–±–Ω–æ–≤–ª—è–µ–º —Å—á–µ—Ç—á–∏–∫–∏ –≤ –º–æ–±–∏–ª—å–Ω—ã—Ö —Ç–∞–±–∞—Ö
    Object.entries(taskCounts).forEach(([employeeId, count]) => {
        const countElement = document.getElementById(`mobile-task-count-${employeeId}`);
        if (countElement) {
            countElement.textContent = count;
        }
    });
}

// –î–æ–±–∞–≤–ª—è–µ–º –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ –º–æ–±–∏–ª—å–Ω—ã—Ö —Å—á–µ—Ç—á–∏–∫–æ–≤ –≤ –æ—Å–Ω–æ–≤–Ω—É—é —Ñ—É–Ω–∫—Ü–∏—é
const originalUpdateEmployeeStats = updateEmployeeStats;
updateEmployeeStats = function() {
    originalUpdateEmployeeStats();
    updateMobileTaskCounts();
};

// DRAG AND DROP FUNCTIONALITY
let draggedTask = null;
let draggedElement = null;

// –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è drag & drop –∑–æ–Ω
function initializeDragDropZones() {
    console.log('üîÑ –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä—É–µ–º drag & drop –∑–æ–Ω—ã');
    
    // –î–æ–±–∞–≤–ª—è–µ–º –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ –∫ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–∞–º –∑–∞–¥–∞—á
    document.querySelectorAll('.tasks-container').forEach(container => {
        container.addEventListener('dragover', handleDragOver);
        container.addEventListener('drop', handleDrop);
        container.addEventListener('dragenter', handleDragEnter);
        container.addEventListener('dragleave', handleDragLeave);
    });
}

// –û–±—Ä–∞–±–æ—Ç—á–∏–∫ –Ω–∞—á–∞–ª–∞ –ø–µ—Ä–µ—Ç–∞—Å–∫–∏–≤–∞–Ω–∏—è
function handleDragStart(e) {
    const taskId = this.dataset.taskId;
    const employeeId = this.dataset.employeeId;
    
    draggedTask = {
        id: taskId,
        employeeId: employeeId,
        element: this
    };
    draggedElement = this;
    
    this.classList.add('dragging');
    
    // –ù–∞—Å—Ç—Ä–∞–∏–≤–∞–µ–º –¥–∞–Ω–Ω—ã–µ –¥–ª—è –ø–µ—Ä–µ–¥–∞—á–∏
    e.dataTransfer.effectAllowed = 'move';
    e.dataTransfer.setData('text/html', this.outerHTML);
    e.dataTransfer.setData('text/plain', taskId);
    
    console.log('üè∑Ô∏è –ù–∞—á–∏–Ω–∞–µ–º –ø–µ—Ä–µ—Ç–∞—Å–∫–∏–≤–∞–Ω–∏–µ –∑–∞–¥–∞—á–∏:', taskId, '–æ—Ç –∏—Å–ø–æ–ª–Ω–∏—Ç–µ–ª—è:', employeeId);
}

// –û–±—Ä–∞–±–æ—Ç—á–∏–∫ –æ–∫–æ–Ω—á–∞–Ω–∏—è –ø–µ—Ä–µ—Ç–∞—Å–∫–∏–≤–∞–Ω–∏—è
function handleDragEnd(e) {
    this.classList.remove('dragging');
    
    // –û—á–∏—â–∞–µ–º –≤—Å–µ —Å–æ—Å—Ç–æ—è–Ω–∏—è drag-over
    document.querySelectorAll('.kanban-column').forEach(column => {
        column.classList.remove('drag-over');
    });
    
    draggedTask = null;
    draggedElement = null;
    
    console.log('üèÅ –û–∫–æ–Ω—á–∞–Ω–∏–µ –ø–µ—Ä–µ—Ç–∞—Å–∫–∏–≤–∞–Ω–∏—è');
}

// –û–±—Ä–∞–±–æ—Ç—á–∏–∫ –ø–µ—Ä–µ—Ç–∞—Å–∫–∏–≤–∞–Ω–∏—è –Ω–∞–¥ –∑–æ–Ω–æ–π
function handleDragOver(e) {
    if (e.preventDefault) {
        e.preventDefault(); // –ü–æ–∑–≤–æ–ª—è–µ—Ç drop
    }
    
    e.dataTransfer.dropEffect = 'move';
    return false;
}

// –û–±—Ä–∞–±–æ—Ç—á–∏–∫ –≤—Ö–æ–¥–∞ –≤ –∑–æ–Ω—É drop
function handleDragEnter(e) {
    if (draggedTask) {
        this.closest('.kanban-column').classList.add('drag-over');
    }
}

// –û–±—Ä–∞–±–æ—Ç—á–∏–∫ –≤—ã—Ö–æ–¥–∞ –∏–∑ –∑–æ–Ω—ã drop
function handleDragLeave(e) {
    // –ü—Ä–æ–≤–µ—Ä—è–µ–º, –¥–µ–π—Å—Ç–≤–∏—Ç–µ–ª—å–Ω–æ –ª–∏ –º—ã –ø–æ–∫–∏–Ω—É–ª–∏ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä
    if (!this.contains(e.relatedTarget)) {
        this.closest('.kanban-column').classList.remove('drag-over');
    }
}

// –û–±—Ä–∞–±–æ—Ç—á–∏–∫ drop
async function handleDrop(e) {
    if (e.stopPropagation) {
        e.stopPropagation(); // –û—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –Ω–µ–∫–æ—Ç–æ—Ä—ã–µ –±—Ä–∞—É–∑–µ—Ä—ã –æ—Ç –ø–µ—Ä–µ–Ω–∞–ø—Ä–∞–≤–ª–µ–Ω–∏—è
    }
    
    e.preventDefault();
    
    if (!draggedTask) {
        console.log('‚ö†Ô∏è –ù–µ—Ç –ø–µ—Ä–µ—Ç–∞—Å–∫–∏–≤–∞–µ–º–æ–π –∑–∞–¥–∞—á–∏');
        return false;
    }
    
    // –ü–æ–ª—É—á–∞–µ–º ID —Ü–µ–ª–µ–≤–æ–≥–æ –∏—Å–ø–æ–ª–Ω–∏—Ç–µ–ª—è –∏–∑ –∫–æ–ª–æ–Ω–∫–∏
    const targetColumn = this.closest('.kanban-column');
    if (!targetColumn) {
        console.log('‚ö†Ô∏è –ù–µ –Ω–∞–π–¥–µ–Ω–∞ —Ü–µ–ª–µ–≤–∞—è –∫–æ–ª–æ–Ω–∫–∞');
        return false;
    }
    
    const targetEmployeeId = targetColumn.dataset.employeeId;
    console.log('üì¶ Drop –≤ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä —Å–æ—Ç—Ä—É–¥–Ω–∏–∫–∞:', targetEmployeeId, '–æ—Ç –∏—Å–ø–æ–ª–Ω–∏—Ç–µ–ª—è:', draggedTask.employeeId);
    
    // –£–±–∏—Ä–∞–µ–º –≤–∏–∑—É–∞–ª—å–Ω—ã–µ —ç—Ñ—Ñ–µ–∫—Ç—ã
    targetColumn.classList.remove('drag-over');
    
    // –ü—Ä–æ–≤–µ—Ä—è–µ–º, –∏–∑–º–µ–Ω–∏–ª—Å—è –ª–∏ –∏—Å–ø–æ–ª–Ω–∏—Ç–µ–ª—å
    if (draggedTask.employeeId === targetEmployeeId) {
        console.log('‚ÑπÔ∏è –ó–∞–¥–∞—á–∞ –æ—Å—Ç–∞–ª–∞—Å—å —É —Ç–æ–≥–æ –∂–µ –∏—Å–ø–æ–ª–Ω–∏—Ç–µ–ª—è');
        return false;
    }
    
    // –ü—Ä–æ–≤–µ—Ä—è–µ–º –ø—Ä–∞–≤–∞ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
    if (currentUserRole !== 'owner') {
        console.log('‚õî –¢–æ–ª—å–∫–æ –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä –º–æ–∂–µ—Ç –ø–µ—Ä–µ–Ω–∞–∑–Ω–∞—á–∞—Ç—å –∑–∞–¥–∞—á–∏');
        showNotification('–¢–æ–ª—å–∫–æ –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä –º–æ–∂–µ—Ç –ø–µ—Ä–µ–Ω–∞–∑–Ω–∞—á–∞—Ç—å –∑–∞–¥–∞—á–∏ –º–µ–∂–¥—É –∏—Å–ø–æ–ª–Ω–∏—Ç–µ–ª—è–º–∏', 'warning');
        return false;
    }
    
    try {
        // –û—Ç–ø—Ä–∞–≤–ª—è–µ–º –∑–∞–ø—Ä–æ—Å –Ω–∞ –ø–µ—Ä–µ–Ω–∞–∑–Ω–∞—á–µ–Ω–∏–µ –∑–∞–¥–∞—á–∏ (–∏—Å–ø–æ–ª—å–∑—É–µ–º –Ω–æ–≤—ã–π endpoint)
        console.log('üì§ –û—Ç–ø—Ä–∞–≤–ª—è–µ–º –∑–∞–ø—Ä–æ—Å –Ω–∞ –ø–µ—Ä–µ–Ω–∞–∑–Ω–∞—á–µ–Ω–∏–µ –∑–∞–¥–∞—á–∏...');
        const response = await fetch(`/admin/tasks/api/tasks/${draggedTask.id}/reassign`, {
            method: 'PUT',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({
                assigned_to_id: parseInt(targetEmployeeId)
            })
        });
        
        if (response.ok) {
            const result = await response.json();
            console.log('‚úÖ –ò—Å–ø–æ–ª–Ω–∏—Ç–µ–ª—å –∏–∑–º–µ–Ω–µ–Ω:', result);
            
            if (result.success) {
                // –û–±–Ω–æ–≤–ª—è–µ–º –∑–∞–¥–∞—á—É –≤ –º–∞—Å—Å–∏–≤–µ
                const taskIndex = allTasks.findIndex(t => t.id == draggedTask.id);
                if (taskIndex !== -1) {
                    allTasks[taskIndex].assigned_to_id = parseInt(targetEmployeeId);
                }
                
                // –ü–µ—Ä–µ–º–µ—â–∞–µ–º —ç–ª–µ–º–µ–Ω—Ç –≤–∏–∑—É–∞–ª—å–Ω–æ
                if (draggedElement) {
                    // –û–±–Ω–æ–≤–ª—è–µ–º –¥–∞–Ω–Ω—ã–µ —ç–ª–µ–º–µ–Ω—Ç–∞
                    draggedElement.dataset.employeeId = targetEmployeeId;
                    
                    // –ù–∞—Ö–æ–¥–∏–º —Ü–µ–ª–µ–≤–æ–π –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä –¥–ª—è –∑–∞–¥–∞—á
                    const targetContainer = document.getElementById(`tasks-${targetEmployeeId}`);
                    if (targetContainer) {
                        targetContainer.appendChild(draggedElement);
                        console.log('‚úÖ –ó–∞–¥–∞—á–∞ –≤–∏–∑—É–∞–ª—å–Ω–æ –ø–µ—Ä–µ–º–µ—â–µ–Ω–∞ –≤ –Ω–æ–≤—É—é –∫–æ–ª–æ–Ω–∫—É');
                    } else {
                        console.log('‚ö†Ô∏è –ù–µ –Ω–∞–π–¥–µ–Ω –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä –¥–ª—è –∑–∞–¥–∞—á –∏—Å–ø–æ–ª–Ω–∏—Ç–µ–ª—è:', targetEmployeeId);
                        // –ü–µ—Ä–µ–∑–∞–≥—Ä—É–∂–∞–µ–º –¥–æ—Å–∫—É –¥–ª—è –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è
                        loadTasksToBoard();
                    }
                }
                
                // –û–±–Ω–æ–≤–ª—è–µ–º —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫—É
                updateEmployeeStats();
                
                // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º —Å–æ–æ–±—â–µ–Ω–∏–µ —Å –¥–µ—Ç–∞–ª—è–º–∏
                const employeeName = document.querySelector(`[data-employee-id="${targetEmployeeId}"] .employee-info h4`).textContent;
                showNotification(`–ó–∞–¥–∞—á–∞ –ø–µ—Ä–µ–Ω–∞–∑–Ω–∞—á–µ–Ω–∞ –Ω–∞ ${employeeName}`, 'success');
            } else {
                showNotification('–û—à–∏–±–∫–∞ –ø—Ä–∏ –∏–∑–º–µ–Ω–µ–Ω–∏–∏ –∏—Å–ø–æ–ª–Ω–∏—Ç–µ–ª—è: ' + (result.message || '–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–∞—è –æ—à–∏–±–∫–∞'), 'error');
            }
        } else {
            const error = await response.json();
            console.error('‚ùå –û—à–∏–±–∫–∞ —Å–µ—Ä–≤–µ—Ä–∞:', error);
            showNotification('–û—à–∏–±–∫–∞ –ø—Ä–∏ –∏–∑–º–µ–Ω–µ–Ω–∏–∏ –∏—Å–ø–æ–ª–Ω–∏—Ç–µ–ª—è: ' + (error.detail || '–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–∞—è –æ—à–∏–±–∫–∞'), 'error');
        }
    } catch (error) {
        console.error('‚ùå –ö—Ä–∏—Ç–∏—á–µ—Å–∫–∞—è –æ—à–∏–±–∫–∞ –ø—Ä–∏ –∏–∑–º–µ–Ω–µ–Ω–∏–∏ –∏—Å–ø–æ–ª–Ω–∏—Ç–µ–ª—è:', error);
        showNotification('–û—à–∏–±–∫–∞ –ø—Ä–∏ –∏–∑–º–µ–Ω–µ–Ω–∏–∏ –∏—Å–ø–æ–ª–Ω–∏—Ç–µ–ª—è', 'error');
    }
    
    return false;
}

// –§—É–Ω–∫—Ü–∏–∏ –¥–ª—è —Ç–∞–π–º–µ—Ä–∞
async function startTimer(taskId) {
    try {
        const response = await fetch(`/admin/api/tasks/${taskId}/timer/start`, {
            method: 'POST',
            credentials: 'include'
        });
        const data = await response.json();

        if (data.success) {
            showNotification('–¢–∞–π–º–µ—Ä –∑–∞–ø—É—â–µ–Ω', 'success');
            loadTasksToBoard();
        } else {
            showNotification(data.message, 'error');
        }
    } catch (error) {
        console.error('–û—à–∏–±–∫–∞ –∑–∞–ø—É—Å–∫–∞ —Ç–∞–π–º–µ—Ä–∞:', error);
        showNotification('–û—à–∏–±–∫–∞ –∑–∞–ø—É—Å–∫–∞ —Ç–∞–π–º–µ—Ä–∞', 'error');
    }
}

async function stopTimer(taskId) {
    try {
        const response = await fetch(`/admin/api/tasks/${taskId}/timer/stop`, {
            method: 'POST',
            credentials: 'include'
        });
        const data = await response.json();

        if (data.success) {
            showNotification(data.message, 'success');
            loadTasksToBoard();
        } else {
            showNotification(data.message, 'error');
        }
    } catch (error) {
        console.error('–û—à–∏–±–∫–∞ –æ—Å—Ç–∞–Ω–æ–≤–∫–∏ —Ç–∞–π–º–µ—Ä–∞:', error);
        showNotification('–û—à–∏–±–∫–∞ –æ—Å—Ç–∞–Ω–æ–≤–∫–∏ —Ç–∞–π–º–µ—Ä–∞', 'error');
    }
}

// –§—É–Ω–∫—Ü–∏—è –æ—Ç–º–µ—Ç–∫–∏ –∑–∞–¥–∞—á–∏ –∫–∞–∫ –≤—ã–ø–æ–ª–Ω–µ–Ω–Ω–æ–π
async function markTaskCompleted(taskId) {
    if (!confirm('–û—Ç–º–µ—Ç–∏—Ç—å –∑–∞–¥–∞—á—É –∫–∞–∫ –≤—ã–ø–æ–ª–Ω–µ–Ω–Ω—É—é? –û–Ω–∞ –±—É–¥–µ—Ç –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–∞ –Ω–∞ –ø—Ä–æ–≤–µ—Ä–∫—É –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä—É.')) {
        return;
    }

    try {
        const response = await fetch(`/admin/api/tasks/${taskId}/mark-completed`, {
            method: 'POST',
            credentials: 'include'
        });
        const data = await response.json();

        if (data.success) {
            showNotification(data.message, 'success');
            loadTasksToBoard();
        } else {
            showNotification(data.error || '–û—à–∏–±–∫–∞ –æ—Ç–º–µ—Ç–∫–∏ –∑–∞–¥–∞—á–∏', 'error');
        }
    } catch (error) {
        console.error('–û—à–∏–±–∫–∞ –æ—Ç–º–µ—Ç–∫–∏ –∑–∞–¥–∞—á–∏ –∫–∞–∫ –≤—ã–ø–æ–ª–Ω–µ–Ω–Ω–æ–π:', error);
        showNotification('–û—à–∏–±–∫–∞ –æ—Ç–º–µ—Ç–∫–∏ –∑–∞–¥–∞—á–∏ –∫–∞–∫ –≤—ã–ø–æ–ª–Ω–µ–Ω–Ω–æ–π', 'error');
    }
}

// –§—É–Ω–∫—Ü–∏—è –∞—Ä—Ö–∏–≤–∞—Ü–∏–∏ –∑–∞–¥–∞—á–∏ (—Ç–æ–ª—å–∫–æ –¥–ª—è –≤–ª–∞–¥–µ–ª—å—Ü–∞)
async function archiveTask(taskId) {
    if (!confirm('–ü–µ—Ä–µ–º–µ—Å—Ç–∏—Ç—å –∑–∞–¥–∞—á—É –≤ –∞—Ä—Ö–∏–≤? –≠—Ç–æ –ø–æ–¥—Ç–≤–µ—Ä–¥–∏—Ç –µ–µ –≤—ã–ø–æ–ª–Ω–µ–Ω–∏–µ.')) {
        return;
    }

    try {
        const response = await fetch(`/admin/api/tasks/${taskId}/archive`, {
            method: 'POST',
            credentials: 'include'
        });
        const data = await response.json();

        if (data.success) {
            showNotification(data.message, 'success');
            loadTasksToBoard();
        } else {
            showNotification(data.error || '–û—à–∏–±–∫–∞ –∞—Ä—Ö–∏–≤–∞—Ü–∏–∏ –∑–∞–¥–∞—á–∏', 'error');
        }
    } catch (error) {
        console.error('–û—à–∏–±–∫–∞ –∞—Ä—Ö–∏–≤–∞—Ü–∏–∏ –∑–∞–¥–∞—á–∏:', error);
        showNotification('–û—à–∏–±–∫–∞ –∞—Ä—Ö–∏–≤–∞—Ü–∏–∏ –∑–∞–¥–∞—á–∏', 'error');
    }
}

// === –ù–û–í–´–ô –§–£–ù–ö–¶–ò–û–ù–ê–õ: –ü–†–û–ì–†–ï–°–°-–ë–ê–† –° –ü–û–õ–ó–£–ù–ö–û–ú –ò –ó–ê–ì–†–£–ó–ö–ê –ò–ó–û–ë–†–ê–ñ–ï–ù–ò–ô ===

// –§—É–Ω–∫—Ü–∏—è –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è –ø—Ä–æ–≥—Ä–µ—Å—Å–∞ –∑–∞–¥–∞—á–∏
async function updateTaskProgress(taskId, progress) {
    try {
        const response = await fetch(`/admin/api/tasks/${taskId}/progress`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            credentials: 'include',
            body: JSON.stringify({ progress })
        });
        const data = await response.json();

        if (data.success) {
            showNotification(data.message, 'success');
            // –û–±–Ω–æ–≤–ª—è–µ–º –∑–∞–¥–∞—á—É –≤ –º–∞—Å—Å–∏–≤–µ
            const taskIndex = allTasks.findIndex(t => t.id === taskId);
            if (taskIndex !== -1) {
                allTasks[taskIndex].progress = progress;
            }
            return true;
        } else {
            showNotification(data.message, 'error');
            return false;
        }
    } catch (error) {
        console.error('–û—à–∏–±–∫–∞ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è –ø—Ä–æ–≥—Ä–µ—Å—Å–∞:', error);
        showNotification('–û—à–∏–±–∫–∞ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è –ø—Ä–æ–≥—Ä–µ—Å—Å–∞', 'error');
        return false;
    }
}

// –£–ª—É—á—à–µ–Ω–Ω–∞—è —Ñ—É–Ω–∫—Ü–∏—è –º–æ–¥–∞–ª—å–Ω–æ–≥–æ –æ–∫–Ω–∞ –¥–ª—è –∏–∑–º–µ–Ω–µ–Ω–∏—è –ø—Ä–æ–≥—Ä–µ—Å—Å–∞
function openProgressModal(taskId, currentProgress) {
    const task = allTasks.find(t => t.id === taskId);
    if (!task) return;

    // –°–æ–∑–¥–∞—ë–º –º–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ
    const modal = document.createElement('div');
    modal.className = 'modal fade';
    modal.id = 'progressModal';
    modal.innerHTML = `
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">–ò–∑–º–µ–Ω–∏—Ç—å –ø—Ä–æ–≥—Ä–µ—Å—Å: ${escapeHtml(task.title)}</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <label class="form-label fw-semibold">–ü—Ä–æ–≥—Ä–µ—Å—Å –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è: <span id="progressValue">${currentProgress}</span>%</label>
                    <input type="range" class="form-range" id="progressRange" min="0" max="100" value="${currentProgress}" step="5">
                    <div class="progress mt-3" style="height: 30px;">
                        <div class="progress-bar progress-bar-striped progress-bar-animated" id="progressPreview"
                             style="width: ${currentProgress}%" role="progressbar">${currentProgress}%</div>
                    </div>

                    <div class="mt-4">
                        <label class="form-label fw-semibold">–ü—Ä–∏–∫—Ä–µ–ø–∏—Ç—å —Å–∫—Ä–∏–Ω—à–æ—Ç—ã</label>
                        <div class="alert alert-info">
                            <i class="fas fa-info-circle"></i> –ú–æ–∂–Ω–æ –≤—Å—Ç–∞–≤–∏—Ç—å —Å–∫—Ä–∏–Ω—à–æ—Ç –∏–∑ –±—É—Ñ–µ—Ä–∞ –æ–±–º–µ–Ω–∞ (Ctrl+V)
                        </div>
                        <input type="file" class="form-control" id="progressImages" multiple accept="image/*">
                        <div id="imagePreview" class="mt-2"></div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">–û—Ç–º–µ–Ω–∞</button>
                    <button type="button" class="btn btn-primary" onclick="saveProgress(${taskId})">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button>
                </div>
            </div>
        </div>
    `;

    document.body.appendChild(modal);
    const bsModal = new bootstrap.Modal(modal);

    // –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –∑–Ω–∞—á–µ–Ω–∏—è –ø—Ä–∏ –¥–≤–∏–∂–µ–Ω–∏–∏ –ø–æ–ª–∑—É–Ω–∫–∞
    const rangeInput = modal.querySelector('#progressRange');
    const valueDisplay = modal.querySelector('#progressValue');
    const previewBar = modal.querySelector('#progressPreview');

    rangeInput.addEventListener('input', (e) => {
        const value = e.target.value;
        valueDisplay.textContent = value;
        previewBar.style.width = value + '%';
        previewBar.textContent = value + '%';
    });

    // –ó–∞–≥—Ä—É–∑–∫–∞ —Ñ–∞–π–ª–æ–≤ —á–µ—Ä–µ–∑ input
    const fileInput = modal.querySelector('#progressImages');
    const imagePreview = modal.querySelector('#imagePreview');

    fileInput.addEventListener('change', (e) => {
        displayImagePreviews(e.target.files, imagePreview);
    });

    // –û–±—Ä–∞–±–æ—Ç–∫–∞ –≤—Å—Ç–∞–≤–∫–∏ –∏–∑ –±—É—Ñ–µ—Ä–∞ (Ctrl+V)
    modal.addEventListener('paste', (e) => {
        const items = e.clipboardData.items;
        const files = [];

        for (let item of items) {
            if (item.type.indexOf('image') !== -1) {
                files.push(item.getAsFile());
            }
        }

        if (files.length > 0) {
            // –î–æ–±–∞–≤–ª—è–µ–º —Ñ–∞–π–ª—ã –∫ input
            const dt = new DataTransfer();
            // –ö–æ–ø–∏—Ä—É–µ–º —Å—É—â–µ—Å—Ç–≤—É—é—â–∏–µ —Ñ–∞–π–ª—ã
            for (let f of fileInput.files) {
                dt.items.add(f);
            }
            // –î–æ–±–∞–≤–ª—è–µ–º –Ω–æ–≤—ã–µ
            for (let f of files) {
                dt.items.add(f);
            }
            fileInput.files = dt.files;

            displayImagePreviews(fileInput.files, imagePreview);
            showNotification('–ò–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ –¥–æ–±–∞–≤–ª–µ–Ω–æ –∏–∑ –±—É—Ñ–µ—Ä–∞ –æ–±–º–µ–Ω–∞!', 'success');
        }
    });

    // –û—á–∏—Å—Ç–∫–∞ –ø—Ä–∏ –∑–∞–∫—Ä—ã—Ç–∏–∏
    modal.addEventListener('hidden.bs.modal', () => {
        modal.remove();
    });

    bsModal.show();
}

// –û—Ç–æ–±—Ä–∞–∂–µ–Ω–∏–µ –ø—Ä–µ–≤—å—é –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–π
function displayImagePreviews(files, container) {
    container.innerHTML = '';

    for (let file of files) {
        const reader = new FileReader();
        reader.onload = (e) => {
            const preview = document.createElement('div');
            preview.className = 'd-inline-block position-relative m-2';
            preview.innerHTML = `
                <img src="${e.target.result}" style="max-width: 150px; max-height: 150px; border-radius: 8px;" class="shadow-sm">
                <span class="badge bg-secondary position-absolute top-0 start-100 translate-middle">${file.name}</span>
            `;
            container.appendChild(preview);
        };
        reader.readAsDataURL(file);
    }
}

// –°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ –ø—Ä–æ–≥—Ä–µ—Å—Å–∞ —Å –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è–º–∏
async function saveProgress(taskId) {
    const modal = document.getElementById('progressModal');
    const progress = parseInt(modal.querySelector('#progressRange').value);
    const fileInput = modal.querySelector('#progressImages');

    try {
        // –°–Ω–∞—á–∞–ª–∞ –æ–±–Ω–æ–≤–ª—è–µ–º –ø—Ä–æ–≥—Ä–µ—Å—Å
        await updateTaskProgress(taskId, progress);

        // –ó–∞—Ç–µ–º –∑–∞–≥—Ä—É–∂–∞–µ–º –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è, –µ—Å–ª–∏ –µ—Å—Ç—å
        if (fileInput.files.length > 0) {
            const formData = new FormData();
            for (let file of fileInput.files) {
                formData.append('files', file);
            }

            const response = await fetch(`/admin/api/tasks/${taskId}/upload-image`, {
                method: 'POST',
                credentials: 'include',
                body: formData
            });

            const data = await response.json();
            if (data.success) {
                showNotification(`–ü—Ä–æ–≥—Ä–µ—Å—Å –æ–±–Ω–æ–≤–ª—ë–Ω –∏ –∑–∞–≥—Ä—É–∂–µ–Ω–æ ${data.files.length} —Ñ–∞–π–ª–æ–≤!`, 'success');
            } else {
                showNotification('–ü—Ä–æ–≥—Ä–µ—Å—Å –æ–±–Ω–æ–≤–ª—ë–Ω, –Ω–æ –æ—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ —Ñ–∞–π–ª–æ–≤: ' + data.error, 'warning');
            }
        }

        // –ó–∞–∫—Ä—ã–≤–∞–µ–º –º–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ
        bootstrap.Modal.getInstance(modal).hide();

        // –ü–µ—Ä–µ–∑–∞–≥—Ä—É–∂–∞–µ–º –¥–æ—Å–∫—É
        loadTasksToBoard();

    } catch (error) {
        console.error('–û—à–∏–±–∫–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è –ø—Ä–æ–≥—Ä–µ—Å—Å–∞:', error);
        showNotification('–û—à–∏–±–∫–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è', 'error');
    }
}

// –ì–ª–æ–±–∞–ª—å–Ω—ã–π –æ–±—Ä–∞–±–æ—Ç—á–∏–∫ Ctrl+V –¥–ª—è –≤—Å—Ç–∞–≤–∫–∏ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–π –≤ –∞–∫—Ç–∏–≤–Ω—É—é –∑–∞–¥–∞—á—É
let activeTaskForPaste = null;

document.addEventListener('paste', (e) => {
    // –ü—Ä–æ–≤–µ—Ä—è–µ–º, —á—Ç–æ –Ω–µ –Ω–∞—Ö–æ–¥–∏–º—Å—è –≤ input/textarea
    if (e.target.tagName === 'INPUT' || e.target.tagName === 'TEXTAREA') {
        return;
    }

    const items = e.clipboardData.items;
    const imageFiles = [];

    for (let item of items) {
        if (item.type.indexOf('image') !== -1) {
            imageFiles.push(item.getAsFile());
        }
    }

    if (imageFiles.length > 0 && activeTaskForPaste) {
        // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ –æ –≤—Å—Ç–∞–≤–∫–µ
        showNotification('–ò–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ –≤—Å—Ç–∞–≤–ª–µ–Ω–æ! –û—Ç–∫—Ä—ã–≤–∞—é –æ–∫–Ω–æ –ø—Ä–æ–≥—Ä–µ—Å—Å–∞...', 'info');

        // –û—Ç–∫—Ä—ã–≤–∞–µ–º –º–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ –ø—Ä–æ–≥—Ä–µ—Å—Å–∞
        const task = allTasks.find(t => t.id === activeTaskForPaste);
        if (task) {
            openProgressModal(task.id, task.progress || 0);
        }
    }
});

console.log('‚úÖ –§—É–Ω–∫—Ü–∏–∏ –ø—Ä–æ–≥—Ä–µ—Å—Å–∞ –∏ –∑–∞–≥—Ä—É–∑–∫–∏ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–π –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω—ã');
</script>
{% endblock %}