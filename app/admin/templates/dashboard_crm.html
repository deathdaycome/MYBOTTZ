{% extends "base.html" %}

{% block title %}CRM Дашборд - BotDev Admin{% endblock %}

{% block page_title %}
<h4><i class="fas fa-chart-line me-2"></i>CRM Дашборд</h4>
{% endblock %}

{% block extra_css %}
<style>
.metric-card {
    background: white;
    border-radius: 15px;
    padding: 1.5rem;
    box-shadow: 0 2px 12px rgba(0,0,0,0.08);
    position: relative;
    overflow: hidden;
    height: 100%;
}

.metric-card.primary {
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    color: white;
}

.metric-card.success {
    background: linear-gradient(135deg, #43e97b 0%, #38f9d7 100%);
    color: white;
}

.metric-card.warning {
    background: linear-gradient(135deg, #fa709a 0%, #fee140 100%);
    color: white;
}

.metric-card.info {
    background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%);
    color: white;
}

.metric-value {
    font-size: 2.5rem;
    font-weight: bold;
    margin-bottom: 0.5rem;
}

.metric-label {
    font-size: 0.9rem;
    opacity: 0.9;
}

.metric-change {
    font-size: 0.85rem;
    margin-top: 0.5rem;
}

.metric-change.positive {
    color: #4caf50;
}

.metric-change.negative {
    color: #f44336;
}

.metric-card.primary .metric-change,
.metric-card.success .metric-change,
.metric-card.warning .metric-change,
.metric-card.info .metric-change {
    color: rgba(255,255,255,0.8);
}

.chart-card {
    background: white;
    border-radius: 15px;
    padding: 1.5rem;
    box-shadow: 0 2px 12px rgba(0,0,0,0.08);
    margin-bottom: 1.5rem;
}

.activity-item {
    padding: 1rem;
    border-left: 3px solid #667eea;
    margin-bottom: 1rem;
    background: #f8f9fa;
    border-radius: 0 8px 8px 0;
}

.activity-item.deal {
    border-left-color: #43e97b;
}

.activity-item.project {
    border-left-color: #4facfe;
}

.activity-item.client {
    border-left-color: #fa709a;
}

.funnel-stage {
    text-align: center;
    padding: 1rem;
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    color: white;
    border-radius: 10px;
    margin-bottom: 0.5rem;
    position: relative;
}

.funnel-stage-value {
    font-size: 1.8rem;
    font-weight: bold;
}

.funnel-stage-label {
    font-size: 0.85rem;
    opacity: 0.9;
}

.table-compact {
    font-size: 0.9rem;
}

.badge-status {
    padding: 0.4rem 0.8rem;
    border-radius: 20px;
    font-weight: 500;
}
</style>
{% endblock %}

{% block content %}
<!-- Основные метрики -->
<div class="row mb-4">
    <div class="col-md-3">
        <div class="metric-card primary">
            <div class="metric-value" id="totalClients">0</div>
            <div class="metric-label">Всего клиентов</div>
            <div class="metric-change" id="clientsChange">+0 за месяц</div>
        </div>
    </div>
    <div class="col-md-3">
        <div class="metric-card success">
            <div class="metric-value" id="activeDeals">0</div>
            <div class="metric-label">Активных сделок</div>
            <div class="metric-change" id="dealsAmount">0 ₽</div>
        </div>
    </div>
    <div class="col-md-3">
        <div class="metric-card warning">
            <div class="metric-value" id="monthRevenue">0 ₽</div>
            <div class="metric-label">Выручка за месяц</div>
            <div class="metric-change positive" id="revenueChange">+0%</div>
        </div>
    </div>
    <div class="col-md-3">
        <div class="metric-card info">
            <div class="metric-value" id="activeProjects">0</div>
            <div class="metric-label">Проектов в работе</div>
            <div class="metric-change" id="projectsProgress">0% выполнено</div>
        </div>
    </div>
</div>

<!-- Воронка продаж и График доходов -->
<div class="row mb-4">
    <!-- Воронка продаж -->
    <div class="col-md-4">
        <div class="chart-card">
            <h5 class="mb-3"><i class="fas fa-funnel me-2"></i>Воронка продаж</h5>
            <div id="salesFunnel">
                <div class="funnel-stage">
                    <div class="funnel-stage-value" id="funnelLeads">0</div>
                    <div class="funnel-stage-label">Лиды</div>
                </div>
                <div class="funnel-stage" style="background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);">
                    <div class="funnel-stage-value" id="funnelQualified">0</div>
                    <div class="funnel-stage-label">Квалифицированные</div>
                </div>
                <div class="funnel-stage" style="background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%);">
                    <div class="funnel-stage-value" id="funnelProposals">0</div>
                    <div class="funnel-stage-label">Предложения</div>
                </div>
                <div class="funnel-stage" style="background: linear-gradient(135deg, #43e97b 0%, #38f9d7 100%);">
                    <div class="funnel-stage-value" id="funnelWon">0</div>
                    <div class="funnel-stage-label">Выиграно</div>
                </div>
            </div>
            <div class="text-center mt-3">
                <span class="badge bg-success">Конверсия: <span id="conversionRate">0</span>%</span>
            </div>
        </div>
    </div>
    
    <!-- График доходов -->
    <div class="col-md-8">
        <div class="chart-card">
            <h5 class="mb-3"><i class="fas fa-chart-area me-2"></i>Динамика доходов</h5>
            <canvas id="revenueChart" height="100"></canvas>
        </div>
    </div>
</div>

<!-- Таблицы и активность -->
<div class="row">
    <!-- Топ клиенты -->
    <div class="col-md-4">
        <div class="chart-card">
            <h5 class="mb-3"><i class="fas fa-trophy me-2"></i>Топ клиенты</h5>
            <div class="table-responsive">
                <table class="table table-compact">
                    <thead>
                        <tr>
                            <th>Клиент</th>
                            <th>Сделки</th>
                            <th>Сумма</th>
                        </tr>
                    </thead>
                    <tbody id="topClientsTable">
                        <tr>
                            <td colspan="3" class="text-center text-muted">Загрузка...</td>
                        </tr>
                    </tbody>
                </table>
            </div>
        </div>
    </div>
    
    <!-- Активные сделки -->
    <div class="col-md-4">
        <div class="chart-card">
            <h5 class="mb-3"><i class="fas fa-handshake me-2"></i>Активные сделки</h5>
            <div class="table-responsive">
                <table class="table table-compact">
                    <thead>
                        <tr>
                            <th>Сделка</th>
                            <th>Статус</th>
                            <th>Сумма</th>
                        </tr>
                    </thead>
                    <tbody id="activeDealsTable">
                        <tr>
                            <td colspan="3" class="text-center text-muted">Загрузка...</td>
                        </tr>
                    </tbody>
                </table>
            </div>
        </div>
    </div>
    
    <!-- Последняя активность -->
    <div class="col-md-4">
        <div class="chart-card">
            <h5 class="mb-3"><i class="fas fa-clock me-2"></i>Последняя активность</h5>
            <div id="recentActivity" style="max-height: 400px; overflow-y: auto;">
                <div class="text-center text-muted">Загрузка...</div>
            </div>
        </div>
    </div>
</div>

<!-- KPI менеджеров -->
<div class="row mt-4">
    <div class="col-md-12">
        <div class="chart-card">
            <h5 class="mb-3"><i class="fas fa-users me-2"></i>KPI менеджеров</h5>
            <div class="table-responsive">
                <table class="table">
                    <thead>
                        <tr>
                            <th>Менеджер</th>
                            <th>Лиды</th>
                            <th>Сделки</th>
                            <th>Конверсия</th>
                            <th>Выручка</th>
                            <th>Средний чек</th>
                            <th>Эффективность</th>
                        </tr>
                    </thead>
                    <tbody id="managersKpiTable">
                        <tr>
                            <td colspan="7" class="text-center text-muted">Загрузка...</td>
                        </tr>
                    </tbody>
                </table>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
const username = 'admin';
const password = 'qwerty123';
let revenueChart = null;

// Загрузка данных дашборда
async function loadDashboardData() {
    try {
        const response = await fetch('/admin/api/dashboard/crm', {
            headers: {
                'Authorization': 'Basic ' + btoa(`${username}:${password}`)
            }
        });
        
        const data = await response.json();
        if (data.success) {
            updateMetrics(data.metrics);
            updateFunnel(data.funnel);
            updateTables(data);
            updateRevenueChart(data.revenue_chart);
            updateActivity(data.recent_activities);
        }
    } catch (error) {
        console.error('Ошибка загрузки дашборда:', error);
    }
}

// Обновление метрик
function updateMetrics(metrics) {
    document.getElementById('totalClients').textContent = metrics.total_clients || 0;
    document.getElementById('clientsChange').textContent = `+${metrics.new_clients_month || 0} за месяц`;
    
    document.getElementById('activeDeals').textContent = metrics.active_deals || 0;
    document.getElementById('dealsAmount').textContent = formatCurrency(metrics.deals_amount || 0);
    
    document.getElementById('monthRevenue').textContent = formatCurrency(metrics.month_revenue || 0);
    const revenueChange = metrics.revenue_change || 0;
    document.getElementById('revenueChange').textContent = `${revenueChange > 0 ? '+' : ''}${revenueChange}%`;
    document.getElementById('revenueChange').className = `metric-change ${revenueChange >= 0 ? 'positive' : 'negative'}`;
    
    document.getElementById('activeProjects').textContent = metrics.active_projects || 0;
    document.getElementById('projectsProgress').textContent = `${metrics.projects_completion || 0}% выполнено`;
}

// Обновление воронки
function updateFunnel(funnel) {
    document.getElementById('funnelLeads').textContent = funnel.leads || 0;
    document.getElementById('funnelQualified').textContent = funnel.qualified || 0;
    document.getElementById('funnelProposals').textContent = funnel.proposals || 0;
    document.getElementById('funnelWon').textContent = funnel.won || 0;
    document.getElementById('conversionRate').textContent = funnel.conversion_rate || 0;
}

// Обновление таблиц
function updateTables(data) {
    // Топ клиенты
    const topClientsTable = document.getElementById('topClientsTable');
    if (data.top_clients && data.top_clients.length > 0) {
        topClientsTable.innerHTML = data.top_clients.map(client => `
            <tr>
                <td>${client.name}</td>
                <td>${client.deals_count}</td>
                <td>${formatCurrency(client.total_revenue)}</td>
            </tr>
        `).join('');
    } else {
        topClientsTable.innerHTML = '<tr><td colspan="3" class="text-center text-muted">Нет данных</td></tr>';
    }
    
    // Активные сделки
    const activeDealsTable = document.getElementById('activeDealsTable');
    if (data.active_deals_list && data.active_deals_list.length > 0) {
        activeDealsTable.innerHTML = data.active_deals_list.map(deal => `
            <tr>
                <td>${deal.title}</td>
                <td><span class="badge badge-status bg-${getStatusColor(deal.status)}">${deal.status_label}</span></td>
                <td>${formatCurrency(deal.amount)}</td>
            </tr>
        `).join('');
    } else {
        activeDealsTable.innerHTML = '<tr><td colspan="3" class="text-center text-muted">Нет активных сделок</td></tr>';
    }
    
    // KPI менеджеров
    const managersKpiTable = document.getElementById('managersKpiTable');
    if (data.managers_kpi && data.managers_kpi.length > 0) {
        managersKpiTable.innerHTML = data.managers_kpi.map(manager => `
            <tr>
                <td>${manager.name}</td>
                <td>${manager.leads_count}</td>
                <td>${manager.deals_count}</td>
                <td>${manager.conversion_rate}%</td>
                <td>${formatCurrency(manager.revenue)}</td>
                <td>${formatCurrency(manager.avg_deal_size)}</td>
                <td>
                    <div class="progress" style="height: 20px;">
                        <div class="progress-bar bg-success" style="width: ${manager.efficiency}%">
                            ${manager.efficiency}%
                        </div>
                    </div>
                </td>
            </tr>
        `).join('');
    } else {
        managersKpiTable.innerHTML = '<tr><td colspan="7" class="text-center text-muted">Нет данных</td></tr>';
    }
}

// Обновление графика доходов
function updateRevenueChart(chartData) {
    const ctx = document.getElementById('revenueChart').getContext('2d');
    
    if (revenueChart) {
        revenueChart.destroy();
    }
    
    revenueChart = new Chart(ctx, {
        type: 'line',
        data: {
            labels: chartData.map(d => d.month),
            datasets: [{
                label: 'Выручка',
                data: chartData.map(d => d.revenue),
                borderColor: '#667eea',
                backgroundColor: 'rgba(102, 126, 234, 0.1)',
                borderWidth: 2,
                tension: 0.3,
                fill: true
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
                legend: {
                    display: false
                },
                tooltip: {
                    callbacks: {
                        label: function(context) {
                            return 'Выручка: ' + formatCurrency(context.parsed.y);
                        }
                    }
                }
            },
            scales: {
                y: {
                    beginAtZero: true,
                    ticks: {
                        callback: function(value) {
                            return formatCurrency(value, true);
                        }
                    }
                }
            }
        }
    });
}

// Обновление активности
function updateActivity(activities) {
    const activityContainer = document.getElementById('recentActivity');
    
    if (activities && activities.length > 0) {
        activityContainer.innerHTML = activities.map(activity => {
            const typeClass = activity.type === 'deal' ? 'deal' : 
                            activity.type === 'project' ? 'project' : 'client';
            const icon = activity.type === 'deal' ? 'handshake' : 
                        activity.type === 'project' ? 'project-diagram' : 'user';
            
            return `
                <div class="activity-item ${typeClass}">
                    <div class="d-flex justify-content-between align-items-start">
                        <div>
                            <i class="fas fa-${icon} me-2"></i>
                            <strong>${activity.title}</strong>
                            ${activity.amount ? `<br><small class="text-muted">${formatCurrency(activity.amount)}</small>` : ''}
                        </div>
                        <small class="text-muted">${formatTimeAgo(activity.date)}</small>
                    </div>
                </div>
            `;
        }).join('');
    } else {
        activityContainer.innerHTML = '<div class="text-center text-muted">Нет активности</div>';
    }
}

// Вспомогательные функции
function formatCurrency(amount, short = false) {
    if (short && amount >= 1000000) {
        return (amount / 1000000).toFixed(1) + 'M ₽';
    } else if (short && amount >= 1000) {
        return (amount / 1000).toFixed(0) + 'K ₽';
    }
    return new Intl.NumberFormat('ru-RU', {
        style: 'currency',
        currency: 'RUB',
        minimumFractionDigits: 0
    }).format(amount);
}

function getStatusColor(status) {
    const colors = {
        'new': 'primary',
        'contact': 'info',
        'negotiation': 'warning',
        'contract': 'success',
        'completed': 'success',
        'lost': 'danger'
    };
    return colors[status] || 'secondary';
}

function formatTimeAgo(dateStr) {
    const date = new Date(dateStr);
    const now = new Date();
    const diff = Math.floor((now - date) / 1000); // разница в секундах
    
    if (diff < 60) return 'только что';
    if (diff < 3600) return Math.floor(diff / 60) + ' мин назад';
    if (diff < 86400) return Math.floor(diff / 3600) + ' ч назад';
    if (diff < 604800) return Math.floor(diff / 86400) + ' дн назад';
    
    return date.toLocaleDateString('ru-RU');
}

// Автообновление каждые 30 секунд
setInterval(loadDashboardData, 30000);

// Загрузка при старте
document.addEventListener('DOMContentLoaded', () => {
    loadDashboardData();
});
</script>
{% endblock %}