{% extends "base.html" %}

{% block title %}–í–æ—Ä–æ–Ω–∫–∞ –ø—Ä–æ–¥–∞–∂ - BotDev Admin{% endblock %}

{% block page_title %}
<h4>üéØ –í–æ—Ä–æ–Ω–∫–∞ –ø—Ä–æ–¥–∞–∂</h4>
{% endblock %}

{% block extra_css %}
<style>
/* –°—Ç–∏–ª–∏ –¥–ª—è –∫–∞–Ω–±–∞–Ω –¥–æ—Å–∫–∏ */
.kanban-board {
    display: flex;
    gap: 1rem;
    overflow-x: auto;
    padding: 1rem 0;
    min-height: 600px;
}

.kanban-column {
    flex: 0 0 300px;
    background: #f8f9fa;
    border-radius: 12px;
    padding: 1rem;
    max-height: 80vh;
    overflow-y: auto;
}

.kanban-header {
    padding: 0.75rem;
    border-radius: 8px;
    margin-bottom: 1rem;
    color: white;
    font-weight: bold;
    display: flex;
    justify-content: space-between;
    align-items: center;
}

.kanban-header.new { background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); }
.kanban-header.contact_made { background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%); }
.kanban-header.qualification { background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%); }
.kanban-header.proposal_sent { background: linear-gradient(135deg, #43e97b 0%, #38f9d7 100%); }
.kanban-header.negotiation { background: linear-gradient(135deg, #fa709a 0%, #fee140 100%); }
.kanban-header.won { background: linear-gradient(135deg, #30cfd0 0%, #330867 100%); }
.kanban-header.lost { background: linear-gradient(135deg, #a8edea 0%, #fed6e3 100%); color: #333; }

.lead-card {
    background: white;
    border-radius: 8px;
    padding: 1rem;
    margin-bottom: 0.75rem;
    box-shadow: 0 2px 4px rgba(0,0,0,0.1);
    cursor: move;
    transition: transform 0.2s, box-shadow 0.2s;
}

.lead-card:hover {
    transform: translateY(-2px);
    box-shadow: 0 4px 12px rgba(0,0,0,0.15);
}

.lead-card.dragging {
    opacity: 0.5;
}

.lead-title {
    font-weight: 600;
    color: #333;
    margin-bottom: 0.5rem;
    font-size: 0.95rem;
}

.lead-company {
    color: #666;
    font-size: 0.85rem;
    margin-bottom: 0.25rem;
}

.lead-source {
    display: inline-block;
    padding: 0.2rem 0.5rem;
    border-radius: 12px;
    font-size: 0.75rem;
    font-weight: 500;
    margin-bottom: 0.5rem;
}

.source-hot { background: #ffebee; color: #d32f2f; }
.source-cold { background: #e3f2fd; color: #1976d2; }

.lead-tags {
    display: flex;
    flex-wrap: wrap;
    gap: 0.25rem;
    margin-top: 0.5rem;
}

.lead-tag {
    background: #e0e0e0;
    color: #424242;
    padding: 0.15rem 0.5rem;
    border-radius: 10px;
    font-size: 0.7rem;
}

.lead-probability {
    display: flex;
    align-items: center;
    margin-top: 0.5rem;
}

.probability-bar {
    flex: 1;
    height: 4px;
    background: #e0e0e0;
    border-radius: 2px;
    overflow: hidden;
    margin-right: 0.5rem;
}

.probability-fill {
    height: 100%;
    background: linear-gradient(90deg, #f44336 0%, #ff9800 50%, #4caf50 100%);
    transition: width 0.3s;
}

.probability-text {
    font-size: 0.75rem;
    color: #666;
    min-width: 35px;
}

.lead-actions {
    display: flex;
    gap: 0.5rem;
    margin-top: 0.75rem;
}

.lead-actions button {
    flex: 1;
    padding: 0.25rem;
    font-size: 0.75rem;
    border-radius: 4px;
}

/* –ú–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ –¥–ª—è –¥–æ–±–∞–≤–ª–µ–Ω–∏—è –ª–∏–¥–∞ */
.add-lead-btn {
    position: fixed;
    bottom: 2rem;
    right: 2rem;
    width: 60px;
    height: 60px;
    border-radius: 50%;
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    color: white;
    border: none;
    font-size: 1.5rem;
    box-shadow: 0 4px 12px rgba(102, 126, 234, 0.4);
    cursor: pointer;
    transition: transform 0.2s;
}

.add-lead-btn:hover {
    transform: scale(1.1);
}

/* –§–∏–ª—å—Ç—Ä—ã */
.filters-panel {
    background: white;
    border-radius: 12px;
    padding: 1rem;
    margin-bottom: 1rem;
    box-shadow: 0 2px 8px rgba(0,0,0,0.08);
}

.filter-tabs {
    display: flex;
    gap: 1rem;
    margin-bottom: 1rem;
}

.filter-tab {
    padding: 0.5rem 1rem;
    border-radius: 20px;
    background: #f5f5f5;
    border: none;
    cursor: pointer;
    transition: all 0.2s;
}

.filter-tab.active {
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    color: white;
}

.source-filters {
    display: flex;
    gap: 0.5rem;
    flex-wrap: wrap;
}

.source-filter {
    padding: 0.3rem 0.8rem;
    border-radius: 15px;
    background: white;
    border: 1px solid #ddd;
    font-size: 0.85rem;
    cursor: pointer;
    transition: all 0.2s;
}

.source-filter.active {
    background: #667eea;
    color: white;
    border-color: #667eea;
}
</style>
{% endblock %}

{% block content %}
<!-- –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ -->
<div class="row mb-4">
    <div class="col-md-3">
        <div class="card">
            <div class="card-body">
                <h6 class="text-muted">–í—Å–µ–≥–æ –ª–∏–¥–æ–≤</h6>
                <h3 class="mb-0">{{ stats.total }}</h3>
                <small class="text-success">+{{ stats.new }} –∑–∞ –Ω–µ–¥–µ–ª—é</small>
            </div>
        </div>
    </div>
    <div class="col-md-3">
        <div class="card">
            <div class="card-body">
                <h6 class="text-muted">–í —Ä–∞–±–æ—Ç–µ</h6>
                <h3 class="mb-0">{{ stats.in_progress }}</h3>
                <small class="text-info">–ê–∫—Ç–∏–≤–Ω—ã–µ –ª–∏–¥—ã</small>
            </div>
        </div>
    </div>
    <div class="col-md-3">
        <div class="card">
            <div class="card-body">
                <h6 class="text-muted">–ö–æ–Ω–≤–µ—Ä—Å–∏—è</h6>
                <h3 class="mb-0">{{ stats.conversion_rate }}%</h3>
                <small class="text-primary">–ó–∞ –º–µ—Å—è—Ü</small>
            </div>
        </div>
    </div>
    <div class="col-md-3">
        <div class="card">
            <div class="card-body">
                <h6 class="text-muted">–í—ã–∏–≥—Ä–∞–Ω–æ/–ü—Ä–æ–∏–≥—Ä–∞–Ω–æ</h6>
                <h3 class="mb-0">{{ stats.won_month }}/{{ stats.lost_month }}</h3>
                <small class="text-muted">–ó–∞ –º–µ—Å—è—Ü</small>
            </div>
        </div>
    </div>
</div>

<!-- –§–∏–ª—å—Ç—Ä—ã -->
<div class="filters-panel">
    <div class="filter-tabs">
        <button class="filter-tab active" onclick="filterByType('all')">
            –í—Å–µ –ª–∏–¥—ã
        </button>
        <button class="filter-tab" onclick="filterByType('hot')">
            üî• –ì–æ—Ä—è—á–∏–µ
        </button>
        <button class="filter-tab" onclick="filterByType('cold')">
            ‚ùÑÔ∏è –•–æ–ª–æ–¥–Ω—ã–µ
        </button>
    </div>
    <div class="source-filters">
        <button class="source-filter" onclick="filterBySource('site')">–°–∞–π—Ç</button>
        <button class="source-filter" onclick="filterBySource('avito')">–ê–≤–∏—Ç–æ</button>
        <button class="source-filter" onclick="filterBySource('fl')">FL.ru</button>
        <button class="source-filter" onclick="filterBySource('kwork')">Kwork</button>
        <button class="source-filter" onclick="filterBySource('2gis')">2–ì–ò–°</button>
        <button class="source-filter" onclick="filterBySource('yandex')">–Ø–Ω–¥–µ–∫—Å.–ö–∞—Ä—Ç—ã</button>
        <button class="source-filter" onclick="filterBySource('direct')">–î–∏—Ä–µ–∫—Ç</button>
        <button class="source-filter" onclick="filterBySource('social')">–°–æ—Ü—Å–µ—Ç–∏</button>
    </div>
</div>

<!-- –ö–∞–Ω–±–∞–Ω –¥–æ—Å–∫–∞ -->
<div class="kanban-board" id="kanbanBoard">
    <!-- –ù–æ–≤—ã–π -->
    <div class="kanban-column" data-status="new">
        <div class="kanban-header new">
            <span>–ù–æ–≤—ã–π</span>
            <span class="badge bg-white text-dark">0</span>
        </div>
        <div class="kanban-cards" id="column-new">
            <!-- –ö–∞—Ä—Ç–æ—á–∫–∏ –ª–∏–¥–æ–≤ –±—É–¥—É—Ç –∑–¥–µ—Å—å -->
        </div>
    </div>
    
    <!-- –ü–µ—Ä–≤—ã–π –∫–æ–Ω—Ç–∞–∫—Ç -->
    <div class="kanban-column" data-status="contact_made">
        <div class="kanban-header contact_made">
            <span>–ü–µ—Ä–≤—ã–π –∫–æ–Ω—Ç–∞–∫—Ç</span>
            <span class="badge bg-white text-dark">0</span>
        </div>
        <div class="kanban-cards" id="column-contact_made">
        </div>
    </div>
    
    <!-- –ö–≤–∞–ª–∏—Ñ–∏–∫–∞—Ü–∏—è -->
    <div class="kanban-column" data-status="qualification">
        <div class="kanban-header qualification">
            <span>–ö–≤–∞–ª–∏—Ñ–∏–∫–∞—Ü–∏—è</span>
            <span class="badge bg-white text-dark">0</span>
        </div>
        <div class="kanban-cards" id="column-qualification">
        </div>
    </div>
    
    <!-- –û—Ç–ø—Ä–∞–≤–ª–µ–Ω–æ –ö–ü -->
    <div class="kanban-column" data-status="proposal_sent">
        <div class="kanban-header proposal_sent">
            <span>–û—Ç–ø—Ä–∞–≤–ª–µ–Ω–æ –ö–ü</span>
            <span class="badge bg-white text-dark">0</span>
        </div>
        <div class="kanban-cards" id="column-proposal_sent">
        </div>
    </div>
    
    <!-- –ü–µ—Ä–µ–≥–æ–≤–æ—Ä—ã -->
    <div class="kanban-column" data-status="negotiation">
        <div class="kanban-header negotiation">
            <span>–ü–µ—Ä–µ–≥–æ–≤–æ—Ä—ã</span>
            <span class="badge bg-white text-dark">0</span>
        </div>
        <div class="kanban-cards" id="column-negotiation">
        </div>
    </div>
    
    <!-- –í—ã–∏–≥—Ä–∞–Ω–æ -->
    <div class="kanban-column" data-status="won">
        <div class="kanban-header won">
            <span>‚úÖ –í—ã–∏–≥—Ä–∞–Ω–æ</span>
            <span class="badge bg-white text-dark">0</span>
        </div>
        <div class="kanban-cards" id="column-won">
        </div>
    </div>
    
    <!-- –ü—Ä–æ–∏–≥—Ä–∞–Ω–æ -->
    <div class="kanban-column" data-status="lost">
        <div class="kanban-header lost">
            <span>‚ùå –ü—Ä–æ–∏–≥—Ä–∞–Ω–æ</span>
            <span class="badge bg-white text-dark">0</span>
        </div>
        <div class="kanban-cards" id="column-lost">
        </div>
    </div>
</div>

<!-- –ö–Ω–æ–ø–∫–∞ –¥–æ–±–∞–≤–ª–µ–Ω–∏—è –ª–∏–¥–∞ -->
<button class="add-lead-btn" onclick="openAddLeadModal()">
    <i class="fas fa-plus"></i>
</button>

<!-- –ú–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ –¥–æ–±–∞–≤–ª–µ–Ω–∏—è –ª–∏–¥–∞ -->
<div class="modal fade" id="addLeadModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">–î–æ–±–∞–≤–∏—Ç—å –Ω–æ–≤—ã–π –ª–∏–¥</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <form id="addLeadForm">
                    <div class="row mb-3">
                        <div class="col-md-6">
                            <label class="form-label">–¢–∏–ø –ª–∏–¥–∞</label>
                            <select class="form-select" id="leadSourceType" onchange="toggleCompanyFields()">
                                <option value="hot">üî• –ì–æ—Ä—è—á–∏–π (–≤—Ö–æ–¥—è—â–∏–π)</option>
                                <option value="cold">‚ùÑÔ∏è –•–æ–ª–æ–¥–Ω—ã–π (–∏—Å—Ö–æ–¥—è—â–∏–π)</option>
                            </select>
                        </div>
                        <div class="col-md-6">
                            <label class="form-label">–ò—Å—Ç–æ—á–Ω–∏–∫</label>
                            <select class="form-select" id="leadSource">
                                <optgroup label="–ì–æ—Ä—è—á–∏–µ –∏—Å—Ç–æ—á–Ω–∏–∫–∏">
                                    <option value="site">–°–∞–π—Ç</option>
                                    <option value="avito">–ê–≤–∏—Ç–æ</option>
                                    <option value="fl">FL.ru</option>
                                    <option value="kwork">Kwork</option>
                                    <option value="phone">–í—Ö–æ–¥—è—â–∏–π –∑–≤–æ–Ω–æ–∫</option>
                                </optgroup>
                                <optgroup label="–•–æ–ª–æ–¥–Ω—ã–µ –∏—Å—Ç–æ—á–Ω–∏–∫–∏">
                                    <option value="2gis">2–ì–ò–°</option>
                                    <option value="yandex">–Ø–Ω–¥–µ–∫—Å.–ö–∞—Ä—Ç—ã</option>
                                    <option value="avito_companies">–ê–≤–∏—Ç–æ (–∫–æ–º–ø–∞–Ω–∏–∏)</option>
                                    <option value="social">–°–æ—Ü—Å–µ—Ç–∏</option>
                                </optgroup>
                            </select>
                        </div>
                    </div>
                    
                    <div class="row mb-3">
                        <div class="col-md-12">
                            <label class="form-label">–ù–∞–∑–≤–∞–Ω–∏–µ –ª–∏–¥–∞</label>
                            <input type="text" class="form-control" id="leadTitle" placeholder="–ù–∞–ø—Ä–∏–º–µ—Ä: –†–∞–∑—Ä–∞–±–æ—Ç–∫–∞ —Å–∞–π—Ç–∞ –¥–ª—è —Ä–µ—Å—Ç–æ—Ä–∞–Ω–∞" required>
                        </div>
                    </div>
                    
                    <!-- –ü–æ–ª—è –¥–ª—è –∫–æ–º–ø–∞–Ω–∏–∏ (–¥–ª—è —Ö–æ–ª–æ–¥–Ω—ã—Ö –ª–∏–¥–æ–≤) -->
                    <div id="companyFields" style="display: none;">
                        <h6 class="mb-3">–ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ –∫–æ–º–ø–∞–Ω–∏–∏</h6>
                        <div class="row mb-3">
                            <div class="col-md-6">
                                <label class="form-label">–ù–∞–∑–≤–∞–Ω–∏–µ –∫–æ–º–ø–∞–Ω–∏–∏</label>
                                <input type="text" class="form-control" id="companyName" placeholder="–û–û–û –†–æ–º–∞—à–∫–∞">
                            </div>
                            <div class="col-md-6">
                                <label class="form-label">–°—Ñ–µ—Ä–∞ –¥–µ—è—Ç–µ–ª—å–Ω–æ—Å—Ç–∏</label>
                                <input type="text" class="form-control" id="companySphere" placeholder="–†–µ—Å—Ç–æ—Ä–∞–Ω, –∫–∞—Ñ–µ">
                            </div>
                        </div>
                        <div class="row mb-3">
                            <div class="col-md-6">
                                <label class="form-label">–°–∞–π—Ç</label>
                                <input type="url" class="form-control" id="companyWebsite" placeholder="https://example.com">
                            </div>
                            <div class="col-md-6">
                                <label class="form-label">–†–∞–∑–º–µ—Ä –∫–æ–º–ø–∞–Ω–∏–∏</label>
                                <select class="form-select" id="companySize">
                                    <option value="">–ù–µ –∏–∑–≤–µ—Å—Ç–Ω–æ</option>
                                    <option value="1-10">1-10 —Å–æ—Ç—Ä—É–¥–Ω–∏–∫–æ–≤</option>
                                    <option value="10-50">10-50 —Å–æ—Ç—Ä—É–¥–Ω–∏–∫–æ–≤</option>
                                    <option value="50-100">50-100 —Å–æ—Ç—Ä—É–¥–Ω–∏–∫–æ–≤</option>
                                    <option value="100+">100+ —Å–æ—Ç—Ä—É–¥–Ω–∏–∫–æ–≤</option>
                                </select>
                            </div>
                        </div>
                        <div class="row mb-3">
                            <div class="col-md-12">
                                <label class="form-label">–ê–¥—Ä–µ—Å</label>
                                <input type="text" class="form-control" id="companyAddress" placeholder="–≥. –ú–æ—Å–∫–≤–∞, —É–ª. –ü—É—à–∫–∏–Ω–∞, –¥. 1">
                            </div>
                        </div>
                    </div>
                    
                    <h6 class="mb-3">–ö–æ–Ω—Ç–∞–∫—Ç–Ω–∞—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è</h6>
                    <div class="row mb-3">
                        <div class="col-md-6">
                            <label class="form-label">–ö–æ–Ω—Ç–∞–∫—Ç–Ω–æ–µ –ª–∏—Ü–æ</label>
                            <input type="text" class="form-control" id="contactName" placeholder="–ò–≤–∞–Ω –ò–≤–∞–Ω–æ–≤" required>
                        </div>
                        <div class="col-md-6">
                            <label class="form-label">–¢–µ–ª–µ—Ñ–æ–Ω</label>
                            <input type="tel" class="form-control" id="contactPhone" placeholder="+7 (999) 123-45-67">
                        </div>
                    </div>
                    
                    <div class="row mb-3">
                        <div class="col-md-6">
                            <label class="form-label">Email</label>
                            <input type="email" class="form-control" id="contactEmail" placeholder="email@example.com">
                        </div>
                        <div class="col-md-6">
                            <label class="form-label">Telegram</label>
                            <input type="text" class="form-control" id="contactTelegram" placeholder="@username">
                        </div>
                    </div>
                    
                    <div class="row mb-3">
                        <div class="col-md-6">
                            <label class="form-label">–ë—é–¥–∂–µ—Ç</label>
                            <div class="input-group">
                                <input type="number" class="form-control" id="leadBudget" placeholder="100000">
                                <span class="input-group-text">‚ÇΩ</span>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <label class="form-label">–í–µ—Ä–æ—è—Ç–Ω–æ—Å—Ç—å –∑–∞–∫—Ä—ã—Ç–∏—è</label>
                            <div class="input-group">
                                <input type="range" class="form-range" id="leadProbability" min="0" max="100" value="50" oninput="updateProbabilityLabel()">
                                <span class="input-group-text" id="probabilityLabel">50%</span>
                            </div>
                        </div>
                    </div>
                    
                    <div class="row mb-3">
                        <div class="col-md-12">
                            <label class="form-label">–û–ø–∏—Å–∞–Ω–∏–µ/–¢—Ä–µ–±–æ–≤–∞–Ω–∏—è</label>
                            <textarea class="form-control" id="leadDescription" rows="3" placeholder="–û–ø–∏—à–∏—Ç–µ –ø–æ—Ç—Ä–µ–±–Ω–æ—Å—Ç–∏ –∫–ª–∏–µ–Ω—Ç–∞..."></textarea>
                        </div>
                    </div>
                    
                    <div class="row mb-3">
                        <div class="col-md-12">
                            <label class="form-label">–¢–µ–≥–∏ (—á–µ—Ä–µ–∑ –∑–∞–ø—è—Ç—É—é)</label>
                            <input type="text" class="form-control" id="leadTags" placeholder="#—Ö–æ–ª–æ–¥–Ω—ã–π, #2–≥–∏—Å, #—Ä–µ—Å—Ç–æ—Ä–∞–Ω">
                        </div>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">–û—Ç–º–µ–Ω–∞</button>
                <button type="button" class="btn btn-primary" onclick="saveNewLead()">–î–æ–±–∞–≤–∏—Ç—å –ª–∏–¥</button>
            </div>
        </div>
    </div>
</div>

<!-- –ú–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ –ø—Ä–æ—Å–º–æ—Ç—Ä–∞ –ª–∏–¥–∞ -->
<div class="modal fade" id="viewLeadModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="viewLeadTitle">–î–µ—Ç–∞–ª–∏ –ª–∏–¥–∞</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body" id="viewLeadContent">
                <!-- –°–æ–¥–µ—Ä–∂–∏–º–æ–µ –±—É–¥–µ—Ç –∑–∞–≥—Ä—É–∂–µ–Ω–æ –¥–∏–Ω–∞–º–∏—á–µ—Å–∫–∏ -->
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">–ó–∞–∫—Ä—ã—Ç—å</button>
                <button type="button" class="btn btn-success" onclick="convertToDeal()">–ö–æ–Ω–≤–µ—Ä—Ç–∏—Ä–æ–≤–∞—Ç—å –≤ —Å–¥–µ–ª–∫—É</button>
                <button type="button" class="btn btn-primary" onclick="editLead()">–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å</button>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
// –ü–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –¥–ª—è drag & drop
let draggedElement = null;
let leads = [];
let currentFilter = 'all';
let currentSource = null;

// –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è
document.addEventListener('DOMContentLoaded', function() {
    loadLeads();
    initDragAndDrop();
});

// –ó–∞–≥—Ä—É–∑–∫–∞ –ª–∏–¥–æ–≤
async function loadLeads() {
    try {
        const response = await fetch('/admin/leads/api', {
            headers: {
                'Authorization': 'Basic ' + btoa('{{ username }}:{{ password }}')
            }
        });
        
        const data = await response.json();
        if (data.success) {
            leads = data.data;
            renderLeads();
        }
    } catch (error) {
        console.error('Error loading leads:', error);
    }
}

// –û—Ç—Ä–∏—Å–æ–≤–∫–∞ –ª–∏–¥–æ–≤
function renderLeads() {
    // –û—á–∏—â–∞–µ–º –∫–æ–ª–æ–Ω–∫–∏
    document.querySelectorAll('.kanban-cards').forEach(column => {
        column.innerHTML = '';
    });
    
    // –°—á–µ—Ç—á–∏–∫–∏ –¥–ª—è –∫–∞–∂–¥–æ–≥–æ —Å—Ç–∞—Ç—É—Å–∞
    const counters = {};
    
    // –§–∏–ª—å—Ç—Ä—É–µ–º –∏ —Ä–∞—Å–ø—Ä–µ–¥–µ–ª—è–µ–º –ª–∏–¥—ã
    leads.forEach(lead => {
        // –ü—Ä–∏–º–µ–Ω—è–µ–º —Ñ–∏–ª—å—Ç—Ä—ã
        if (currentFilter !== 'all' && lead.source_type !== currentFilter) return;
        if (currentSource && lead.source !== currentSource) return;
        
        const card = createLeadCard(lead);
        const column = document.getElementById(`column-${lead.status}`);
        if (column) {
            column.appendChild(card);
            counters[lead.status] = (counters[lead.status] || 0) + 1;
        }
    });
    
    // –û–±–Ω–æ–≤–ª—è–µ–º —Å—á–µ—Ç—á–∏–∫–∏
    document.querySelectorAll('.kanban-column').forEach(column => {
        const status = column.dataset.status;
        const badge = column.querySelector('.badge');
        if (badge) {
            badge.textContent = counters[status] || 0;
        }
    });
}

// –°–æ–∑–¥–∞–Ω–∏–µ –∫–∞—Ä—Ç–æ—á–∫–∏ –ª–∏–¥–∞
function createLeadCard(lead) {
    const card = document.createElement('div');
    card.className = 'lead-card';
    card.draggable = true;
    card.dataset.leadId = lead.id;
    card.dataset.status = lead.status;
    
    const sourceClass = lead.source_type === 'hot' ? 'source-hot' : 'source-cold';
    const sourceIcon = lead.source_type === 'hot' ? 'üî•' : '‚ùÑÔ∏è';
    
    card.innerHTML = `
        <div class="lead-title">${lead.title}</div>
        ${lead.company_name ? `<div class="lead-company">${lead.company_name}</div>` : ''}
        <div class="lead-source ${sourceClass}">${sourceIcon} ${lead.source || '–ù–µ —É–∫–∞–∑–∞–Ω'}</div>
        
        ${lead.budget ? `<div class="text-muted small">–ë—é–¥–∂–µ—Ç: ${formatCurrency(lead.budget)}</div>` : ''}
        
        <div class="lead-probability">
            <div class="probability-bar">
                <div class="probability-fill" style="width: ${lead.probability || 50}%"></div>
            </div>
            <span class="probability-text">${lead.probability || 50}%</span>
        </div>
        
        ${lead.tags && lead.tags.length ? `
            <div class="lead-tags">
                ${lead.tags.map(tag => `<span class="lead-tag">${tag}</span>`).join('')}
            </div>
        ` : ''}
        
        <div class="lead-actions">
            <button class="btn btn-sm btn-outline-primary" onclick="viewLead(${lead.id})">
                <i class="fas fa-eye"></i> –ü—Ä–æ—Å–º–æ—Ç—Ä
            </button>
            <button class="btn btn-sm btn-outline-success" onclick="callLead(${lead.id})">
                <i class="fas fa-phone"></i> –ó–≤–æ–Ω–æ–∫
            </button>
        </div>
    `;
    
    return card;
}

// Drag & Drop —Ñ—É–Ω–∫—Ü–∏–æ–Ω–∞–ª—å–Ω–æ—Å—Ç—å
function initDragAndDrop() {
    const cards = document.querySelectorAll('.lead-card');
    const columns = document.querySelectorAll('.kanban-cards');
    
    cards.forEach(card => {
        card.addEventListener('dragstart', handleDragStart);
        card.addEventListener('dragend', handleDragEnd);
    });
    
    columns.forEach(column => {
        column.addEventListener('dragover', handleDragOver);
        column.addEventListener('drop', handleDrop);
    });
}

function handleDragStart(e) {
    draggedElement = e.target;
    e.target.classList.add('dragging');
}

function handleDragEnd(e) {
    e.target.classList.remove('dragging');
}

function handleDragOver(e) {
    e.preventDefault();
}

async function handleDrop(e) {
    e.preventDefault();
    
    if (draggedElement) {
        const newStatus = e.target.closest('.kanban-column').dataset.status;
        const leadId = draggedElement.dataset.leadId;
        const oldStatus = draggedElement.dataset.status;
        
        if (newStatus !== oldStatus) {
            // –û–±–Ω–æ–≤–ª—è–µ–º —Å—Ç–∞—Ç—É—Å –Ω–∞ —Å–µ—Ä–≤–µ—Ä–µ
            await updateLeadStatus(leadId, newStatus);
            
            // –ü–µ—Ä–µ–º–µ—â–∞–µ–º —ç–ª–µ–º–µ–Ω—Ç
            e.target.closest('.kanban-cards').appendChild(draggedElement);
            draggedElement.dataset.status = newStatus;
            
            // –û–±–Ω–æ–≤–ª—è–µ–º —Å—á–µ—Ç—á–∏–∫–∏
            updateCounters();
        }
    }
}

// –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ —Å—Ç–∞—Ç—É—Å–∞ –ª–∏–¥–∞
async function updateLeadStatus(leadId, newStatus) {
    try {
        const response = await fetch(`/admin/leads/api/${leadId}/status`, {
            method: 'PUT',
            headers: {
                'Content-Type': 'application/json',
                'Authorization': 'Basic ' + btoa('{{ username }}:{{ password }}')
            },
            body: JSON.stringify({ status: newStatus })
        });
        
        const data = await response.json();
        if (!data.success) {
            console.error('Error updating lead status:', data.error);
        }
    } catch (error) {
        console.error('Error updating lead status:', error);
    }
}

// –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ —Å—á–µ—Ç—á–∏–∫–æ–≤
function updateCounters() {
    document.querySelectorAll('.kanban-column').forEach(column => {
        const count = column.querySelectorAll('.lead-card').length;
        const badge = column.querySelector('.badge');
        if (badge) {
            badge.textContent = count;
        }
    });
}

// –§–∏–ª—å—Ç—Ä–∞—Ü–∏—è
function filterByType(type) {
    currentFilter = type;
    document.querySelectorAll('.filter-tab').forEach(tab => {
        tab.classList.remove('active');
    });
    event.target.classList.add('active');
    renderLeads();
}

function filterBySource(source) {
    if (currentSource === source) {
        currentSource = null;
        event.target.classList.remove('active');
    } else {
        currentSource = source;
        document.querySelectorAll('.source-filter').forEach(filter => {
            filter.classList.remove('active');
        });
        event.target.classList.add('active');
    }
    renderLeads();
}

// –ú–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ –¥–æ–±–∞–≤–ª–µ–Ω–∏—è –ª–∏–¥–∞
function openAddLeadModal() {
    const modal = new bootstrap.Modal(document.getElementById('addLeadModal'));
    modal.show();
}

function toggleCompanyFields() {
    const sourceType = document.getElementById('leadSourceType').value;
    const companyFields = document.getElementById('companyFields');
    
    if (sourceType === 'cold') {
        companyFields.style.display = 'block';
    } else {
        companyFields.style.display = 'none';
    }
}

function updateProbabilityLabel() {
    const value = document.getElementById('leadProbability').value;
    document.getElementById('probabilityLabel').textContent = value + '%';
}

async function saveNewLead() {
    const formData = {
        title: document.getElementById('leadTitle').value,
        source_type: document.getElementById('leadSourceType').value,
        source: document.getElementById('leadSource').value,
        company_name: document.getElementById('companyName').value,
        company_sphere: document.getElementById('companySphere').value,
        company_website: document.getElementById('companyWebsite').value,
        company_address: document.getElementById('companyAddress').value,
        company_size: document.getElementById('companySize').value,
        contact_name: document.getElementById('contactName').value,
        contact_phone: document.getElementById('contactPhone').value,
        contact_email: document.getElementById('contactEmail').value,
        contact_telegram: document.getElementById('contactTelegram').value,
        budget: parseFloat(document.getElementById('leadBudget').value) || null,
        probability: parseInt(document.getElementById('leadProbability').value),
        description: document.getElementById('leadDescription').value,
        tags: document.getElementById('leadTags').value.split(',').map(tag => tag.trim()).filter(tag => tag)
    };
    
    try {
        const response = await fetch('/admin/leads/api', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'Authorization': 'Basic ' + btoa('{{ username }}:{{ password }}')
            },
            body: JSON.stringify(formData)
        });
        
        const data = await response.json();
        if (data.success) {
            // –ó–∞–∫—Ä—ã–≤–∞–µ–º –º–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ
            bootstrap.Modal.getInstance(document.getElementById('addLeadModal')).hide();
            
            // –û—á–∏—â–∞–µ–º —Ñ–æ—Ä–º—É
            document.getElementById('addLeadForm').reset();
            
            // –ü–µ—Ä–µ–∑–∞–≥—Ä—É–∂–∞–µ–º –ª–∏–¥—ã
            loadLeads();
            
            // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ
            showNotification('–õ–∏–¥ —É—Å–ø–µ—à–Ω–æ –¥–æ–±–∞–≤–ª–µ–Ω!', 'success');
        } else {
            showNotification('–û—à–∏–±–∫–∞: ' + data.error, 'danger');
        }
    } catch (error) {
        showNotification('–û—à–∏–±–∫–∞ –ø—Ä–∏ –¥–æ–±–∞–≤–ª–µ–Ω–∏–∏ –ª–∏–¥–∞', 'danger');
    }
}

// –ü—Ä–æ—Å–º–æ—Ç—Ä –ª–∏–¥–∞
async function viewLead(leadId) {
    try {
        const response = await fetch(`/admin/leads/api/${leadId}`, {
            headers: {
                'Authorization': 'Basic ' + btoa('{{ username }}:{{ password }}')
            }
        });
        
        const data = await response.json();
        if (data.success) {
            const lead = data.data;
            currentLeadId = leadId; // –°–æ—Ö—Ä–∞–Ω—è–µ–º ID —Ç–µ–∫—É—â–µ–≥–æ –ª–∏–¥–∞
            document.getElementById('viewLeadTitle').textContent = lead.title;
            
            // –§–æ—Ä–º–∏—Ä—É–µ–º —Å–æ–¥–µ—Ä–∂–∏–º–æ–µ
            let content = `
                <div class="row">
                    <div class="col-md-6">
                        <h6>–û—Å–Ω–æ–≤–Ω–∞—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è</h6>
                        <p><strong>–°—Ç–∞—Ç—É—Å:</strong> ${getStatusLabel(lead.status)}</p>
                        <p><strong>–ò—Å—Ç–æ—á–Ω–∏–∫:</strong> ${lead.source_type === 'hot' ? 'üî•' : '‚ùÑÔ∏è'} ${lead.source}</p>
                        <p><strong>–í–µ—Ä–æ—è—Ç–Ω–æ—Å—Ç—å:</strong> ${lead.probability}%</p>
                        ${lead.budget ? `<p><strong>–ë—é–¥–∂–µ—Ç:</strong> ${formatCurrency(lead.budget)}</p>` : ''}
                    </div>
                    <div class="col-md-6">
                        <h6>–ö–æ–Ω—Ç–∞–∫—Ç–Ω–∞—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è</h6>
                        <p><strong>–ö–æ–Ω—Ç–∞–∫—Ç:</strong> ${lead.contact_name || '–ù–µ —É–∫–∞–∑–∞–Ω'}</p>
                        ${lead.contact_phone ? `<p><strong>–¢–µ–ª–µ—Ñ–æ–Ω:</strong> ${lead.contact_phone}</p>` : ''}
                        ${lead.contact_email ? `<p><strong>Email:</strong> ${lead.contact_email}</p>` : ''}
                        ${lead.contact_telegram ? `<p><strong>Telegram:</strong> ${lead.contact_telegram}</p>` : ''}
                    </div>
                </div>
            `;
            
            if (lead.company_name) {
                content += `
                    <hr>
                    <h6>–ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ –∫–æ–º–ø–∞–Ω–∏–∏</h6>
                    <div class="row">
                        <div class="col-md-6">
                            <p><strong>–ù–∞–∑–≤–∞–Ω–∏–µ:</strong> ${lead.company_name}</p>
                            ${lead.company_sphere ? `<p><strong>–°—Ñ–µ—Ä–∞:</strong> ${lead.company_sphere}</p>` : ''}
                            ${lead.company_size ? `<p><strong>–†–∞–∑–º–µ—Ä:</strong> ${lead.company_size}</p>` : ''}
                        </div>
                        <div class="col-md-6">
                            ${lead.company_website ? `<p><strong>–°–∞–π—Ç:</strong> <a href="${lead.company_website}" target="_blank">${lead.company_website}</a></p>` : ''}
                            ${lead.company_address ? `<p><strong>–ê–¥—Ä–µ—Å:</strong> ${lead.company_address}</p>` : ''}
                        </div>
                    </div>
                `;
            }
            
            if (lead.description) {
                content += `
                    <hr>
                    <h6>–û–ø–∏—Å–∞–Ω–∏–µ</h6>
                    <p>${lead.description}</p>
                `;
            }
            
            if (lead.tags && lead.tags.length) {
                content += `
                    <hr>
                    <h6>–¢–µ–≥–∏</h6>
                    <div class="lead-tags">
                        ${lead.tags.map(tag => `<span class="lead-tag">${tag}</span>`).join('')}
                    </div>
                `;
            }
            
            document.getElementById('viewLeadContent').innerHTML = content;
            
            // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –º–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ
            const modal = new bootstrap.Modal(document.getElementById('viewLeadModal'));
            modal.show();
        }
    } catch (error) {
        console.error('Error viewing lead:', error);
    }
}

// –í—Å–ø–æ–º–æ–≥–∞—Ç–µ–ª—å–Ω—ã–µ —Ñ—É–Ω–∫—Ü–∏–∏
function formatCurrency(amount) {
    return new Intl.NumberFormat('ru-RU', {
        style: 'currency',
        currency: 'RUB',
        minimumFractionDigits: 0
    }).format(amount);
}

function getStatusLabel(status) {
    const labels = {
        'new': '–ù–æ–≤—ã–π',
        'contact_made': '–ü–µ—Ä–≤—ã–π –∫–æ–Ω—Ç–∞–∫—Ç',
        'qualification': '–ö–≤–∞–ª–∏—Ñ–∏–∫–∞—Ü–∏—è',
        'proposal_sent': '–û—Ç–ø—Ä–∞–≤–ª–µ–Ω–æ –ö–ü',
        'negotiation': '–ü–µ—Ä–µ–≥–æ–≤–æ—Ä—ã',
        'won': '–í—ã–∏–≥—Ä–∞–Ω–æ',
        'lost': '–ü—Ä–æ–∏–≥—Ä–∞–Ω–æ',
        'postponed': '–û—Ç–ª–æ–∂–µ–Ω–æ'
    };
    return labels[status] || status;
}

function showNotification(message, type) {
    // –ü—Ä–æ—Å—Ç–æ–µ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ (–º–æ–∂–Ω–æ –∑–∞–º–µ–Ω–∏—Ç—å –Ω–∞ –±–æ–ª–µ–µ –∫—Ä–∞—Å–∏–≤–æ–µ)
    alert(message);
}

function callLead(leadId) {
    // –ó–¥–µ—Å—å –±—É–¥–µ—Ç –ª–æ–≥–∏–∫–∞ –¥–ª—è –∑–≤–æ–Ω–∫–∞
    console.log('Call lead:', leadId);
}

let currentLeadId = null;

async function convertToDeal() {
    if (!currentLeadId) {
        showNotification('–û—à–∏–±–∫–∞: –Ω–µ –≤—ã–±—Ä–∞–Ω –ª–∏–¥ –¥–ª—è –∫–æ–Ω–≤–µ—Ä—Ç–∞—Ü–∏–∏', 'danger');
        return;
    }
    
    // –ü–æ–ª—É—á–∞–µ–º –¥–∞–Ω–Ω—ã–µ –ª–∏–¥–∞ –¥–ª—è –ø—Ä–µ–¥–∑–∞–ø–æ–ª–Ω–µ–Ω–∏—è —Ñ–æ—Ä–º—ã
    try {
        const response = await fetch(`/admin/leads/api/${currentLeadId}`, {
            headers: {
                'Authorization': 'Basic ' + btoa('{{ username }}:{{ password }}')
            }
        });
        
        const data = await response.json();
        if (data.success) {
            const lead = data.data;
            
            // –ü—Ä–µ–¥–∑–∞–ø–æ–ª–Ω—è–µ–º —Ñ–æ—Ä–º—É
            document.getElementById('dealTitle').value = lead.title || '';
            document.getElementById('dealDescription').value = lead.description || '';
            document.getElementById('dealAmount').value = lead.budget || '';
            
            // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –º–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ –∫–æ–Ω–≤–µ—Ä—Ç–∞—Ü–∏–∏
            const convertModal = new bootstrap.Modal(document.getElementById('convertToDealModal'));
            convertModal.show();
        }
    } catch (error) {
        console.error('Error loading lead data:', error);
        // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –º–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ –¥–∞–∂–µ –µ—Å–ª–∏ –Ω–µ —É–¥–∞–ª–æ—Å—å –∑–∞–≥—Ä—É–∑–∏—Ç—å –¥–∞–Ω–Ω—ã–µ
        const convertModal = new bootstrap.Modal(document.getElementById('convertToDealModal'));
        convertModal.show();
    }
}

async function executeConvertToDeal() {
    if (!currentLeadId) return;
    
    const dealData = {
        title: document.getElementById('dealTitle').value || '–°–¥–µ–ª–∫–∞ –∏–∑ –ª–∏–¥–∞',
        description: document.getElementById('dealDescription').value || '',
        amount: parseFloat(document.getElementById('dealAmount').value) || 0,
        prepayment_percent: parseFloat(document.getElementById('dealPrepayment').value) || 50,
        priority: document.getElementById('dealPriority').value || 'normal'
    };
    
    try {
        const response = await fetch(`/admin/leads/api/${currentLeadId}/convert`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'Authorization': 'Basic ' + btoa('{{ username }}:{{ password }}')
            },
            body: JSON.stringify(dealData)
        });
        
        const data = await response.json();
        if (data.success) {
            // –ó–∞–∫—Ä—ã–≤–∞–µ–º –º–æ–¥–∞–ª—å–Ω—ã–µ –æ–∫–Ω–∞
            bootstrap.Modal.getInstance(document.getElementById('convertToDealModal')).hide();
            bootstrap.Modal.getInstance(document.getElementById('viewLeadModal')).hide();
            
            // –ü–µ—Ä–µ–∑–∞–≥—Ä—É–∂–∞–µ–º –ª–∏–¥—ã
            loadLeads();
            
            showNotification(`–õ–∏–¥ —É—Å–ø–µ—à–Ω–æ –∫–æ–Ω–≤–µ—Ä—Ç–∏—Ä–æ–≤–∞–Ω –≤ —Å–¥–µ–ª–∫—É! ID —Å–¥–µ–ª–∫–∏: ${data.data.deal_id}`, 'success');
        } else {
            showNotification('–û—à–∏–±–∫–∞ –∫–æ–Ω–≤–µ—Ä—Ç–∞—Ü–∏–∏: ' + (data.message || '–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–∞—è –æ—à–∏–±–∫–∞'), 'danger');
        }
    } catch (error) {
        console.error('Convert error:', error);
        showNotification('–û—à–∏–±–∫–∞ –ø—Ä–∏ –∫–æ–Ω–≤–µ—Ä—Ç–∞—Ü–∏–∏ –ª–∏–¥–∞', 'danger');
    }
}

function editLead() {
    // –ó–¥–µ—Å—å –±—É–¥–µ—Ç –ª–æ–≥–∏–∫–∞ —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è
    console.log('Edit lead');
}
</script>

<!-- –ú–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ –∫–æ–Ω–≤–µ—Ä—Ç–∞—Ü–∏–∏ –ª–∏–¥–∞ –≤ —Å–¥–µ–ª–∫—É -->
<div class="modal fade" id="convertToDealModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">
                    <i class="fas fa-exchange-alt me-2"></i>
                    –ö–æ–Ω–≤–µ—Ä—Ç–∞—Ü–∏—è –ª–∏–¥–∞ –≤ —Å–¥–µ–ª–∫—É
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <form>
                    <div class="mb-3">
                        <label for="dealTitle" class="form-label">–ù–∞–∑–≤–∞–Ω–∏–µ —Å–¥–µ–ª–∫–∏</label>
                        <input type="text" class="form-control" id="dealTitle" placeholder="–ù–∞–∑–≤–∞–Ω–∏–µ —Å–¥–µ–ª–∫–∏">
                    </div>
                    <div class="mb-3">
                        <label for="dealDescription" class="form-label">–û–ø–∏—Å–∞–Ω–∏–µ</label>
                        <textarea class="form-control" id="dealDescription" rows="3" placeholder="–û–ø–∏—Å–∞–Ω–∏–µ —Å–¥–µ–ª–∫–∏"></textarea>
                    </div>
                    <div class="row">
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label for="dealAmount" class="form-label">–°—É–º–º–∞ —Å–¥–µ–ª–∫–∏ (‚ÇΩ)</label>
                                <input type="number" class="form-control" id="dealAmount" min="0" step="1000">
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label for="dealPrepayment" class="form-label">–ü—Ä–µ–¥–æ–ø–ª–∞—Ç–∞ (%)</label>
                                <input type="number" class="form-control" id="dealPrepayment" value="50" min="0" max="100">
                            </div>
                        </div>
                    </div>
                    <div class="mb-3">
                        <label for="dealPriority" class="form-label">–ü—Ä–∏–æ—Ä–∏—Ç–µ—Ç</label>
                        <select class="form-select" id="dealPriority">
                            <option value="low">–ù–∏–∑–∫–∏–π</option>
                            <option value="normal" selected>–ù–æ—Ä–º–∞–ª—å–Ω—ã–π</option>
                            <option value="high">–í—ã—Å–æ–∫–∏–π</option>
                            <option value="urgent">–°—Ä–æ—á–Ω—ã–π</option>
                        </select>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">–û—Ç–º–µ–Ω–∞</button>
                <button type="button" class="btn btn-success" onclick="executeConvertToDeal()">
                    <i class="fas fa-check me-2"></i>–°–æ–∑–¥–∞—Ç—å —Å–¥–µ–ª–∫—É
                </button>
            </div>
        </div>
    </div>
</div>
{% endblock %}