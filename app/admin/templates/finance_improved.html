{% extends "base.html" %}

{% block title %}–§–∏–Ω–∞–Ω—Å—ã - –ê–¥–º–∏–Ω-–ø–∞–Ω–µ–ª—å{% endblock %}

{% block page_title %}üí∞ –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ —Ñ–∏–Ω–∞–Ω—Å–∞–º–∏{% endblock %}

{% block extra_css %}
<style>
.finance-card {
    border: none;
    border-radius: 15px;
    box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
    transition: transform 0.2s, box-shadow 0.2s;
    position: relative;
    overflow: hidden;
}

.finance-card:hover {
    transform: translateY(-2px);
    box-shadow: 0 6px 12px rgba(0, 0, 0, 0.15);
}

.finance-card-income {
    background: linear-gradient(135deg, #28a745 0%, #20c997 100%);
    color: white;
}

.finance-card-expense {
    background: linear-gradient(135deg, #dc3545 0%, #fd7e14 100%);
    color: white;
}

.finance-card-profit {
    background: linear-gradient(135deg, #007bff 0%, #6610f2 100%);
    color: white;
}

.finance-card-balance {
    background: linear-gradient(135deg, #17a2b8 0%, #20c997 100%);
    color: white;
}

.finance-card-forecast {
    background: linear-gradient(135deg, #ffc107 0%, #fd7e14 100%);
    color: white;
}

/* –£–ª—É—á—à–µ–Ω–Ω—ã–π –¥–∏–∑–∞–π–Ω —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–π */
.transaction-item {
    border: none;
    border-left: 4px solid #dee2e6;
    transition: all 0.3s ease;
    background: white;
    margin-bottom: 8px;
    border-radius: 8px;
    box-shadow: 0 2px 4px rgba(0,0,0,0.1);
}

.transaction-item:hover {
    background-color: #f8f9fa;
    border-left-color: #007bff;
    transform: translateX(5px);
    box-shadow: 0 4px 8px rgba(0,0,0,0.15);
}

.transaction-income {
    border-left-color: #28a745;
}

.transaction-expense {
    border-left-color: #dc3545;
}

.amount-income {
    color: #28a745;
    font-weight: bold;
}

.amount-expense {
    color: #dc3545;
    font-weight: bold;
}

/* –ò–∫–æ–Ω–∫–∏ –¥–ª—è —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–π */
.transaction-icon {
    width: 40px;
    height: 40px;
    border-radius: 50%;
    display: flex;
    align-items: center;
    justify-content: center;
    margin-right: 15px;
    font-size: 18px;
}

.transaction-icon.income {
    background: rgba(40, 167, 69, 0.1);
    color: #28a745;
}

.transaction-icon.expense {
    background: rgba(220, 53, 69, 0.1);
    color: #dc3545;
}

/* –ë—ã—Å—Ç—Ä–∞—è —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏—è */
.quick-transaction {
    position: fixed;
    bottom: 30px;
    right: 30px;
    z-index: 1000;
}

.quick-transaction-btn {
    width: 60px;
    height: 60px;
    border-radius: 50%;
    background: linear-gradient(135deg, #007bff, #6610f2);
    border: none;
    color: white;
    font-size: 24px;
    box-shadow: 0 4px 12px rgba(0,0,0,0.3);
    transition: all 0.3s ease;
}

.quick-transaction-btn:hover {
    transform: scale(1.1);
    box-shadow: 0 6px 20px rgba(0,0,0,0.4);
}

/* –°–≤–æ–¥–∫–∞ –∑–∞ –ø–µ—Ä–∏–æ–¥ */
.period-summary {
    background: linear-gradient(135deg, #f8f9fa, #e9ecef);
    border-radius: 15px;
    padding: 20px;
    margin-bottom: 25px;
    border: 1px solid rgba(0,0,0,0.1);
}

.comparison-badge {
    font-size: 0.8rem;
    padding: 4px 8px;
    border-radius: 12px;
    font-weight: 600;
}

.comparison-up {
    background: rgba(40, 167, 69, 0.1);
    color: #28a745;
}

.comparison-down {
    background: rgba(220, 53, 69, 0.1);
    color: #dc3545;
}

/* –ö–∞—Ç–µ–≥–æ—Ä–∏–∏ —Å —Ç–µ–≥–∞–º–∏ */
.category-tag {
    display: inline-block;
    padding: 4px 8px;
    border-radius: 12px;
    font-size: 0.75rem;
    font-weight: 500;
    margin-right: 5px;
    margin-bottom: 3px;
    cursor: pointer;
    transition: all 0.2s ease;
}

.category-tag:hover {
    transform: translateY(-1px);
    box-shadow: 0 2px 4px rgba(0,0,0,0.2);
}

.category-tag.active {
    transform: scale(1.05);
    box-shadow: 0 2px 8px rgba(0,0,0,0.3);
}

/* –ú–∏–Ω–∏-–Ω–∞–ø–æ–º–∏–Ω–∞–Ω–∏—è */
.notifications-bell {
    position: relative;
}

.notification-badge {
    position: absolute;
    top: -5px;
    right: -5px;
    background: #dc3545;
    color: white;
    border-radius: 50%;
    width: 20px;
    height: 20px;
    font-size: 10px;
    display: flex;
    align-items: center;
    justify-content: center;
}

/* –£–ª—É—á—à–µ–Ω–Ω—ã–µ —Ñ–∏–ª—å—Ç—Ä—ã */
.filter-section {
    background: linear-gradient(135deg, #f8f9fa, #e9ecef);
    border-radius: 15px;
    padding: 20px;
    margin-bottom: 20px;
    border: 1px solid rgba(0,0,0,0.1);
}

.filter-chips {
    margin-top: 15px;
}

.filter-chip {
    background: white;
    border: 1px solid #dee2e6;
    border-radius: 20px;
    padding: 5px 12px;
    margin-right: 8px;
    margin-bottom: 5px;
    font-size: 0.8rem;
    cursor: pointer;
    transition: all 0.2s ease;
}

.filter-chip:hover {
    background: #e9ecef;
}

.filter-chip.active {
    background: #007bff;
    color: white;
    border-color: #007bff;
}

/* –ê–Ω–∏–º–∞—Ü–∏–∏ */
@keyframes slideIn {
    from {
        opacity: 0;
        transform: translateY(20px);
    }
    to {
        opacity: 1;
        transform: translateY(0);
    }
}

.animate-slide-in {
    animation: slideIn 0.3s ease-out;
}

/* –ê–¥–∞–ø—Ç–∏–≤–Ω–æ—Å—Ç—å */
@media (max-width: 768px) {
    .quick-transaction {
        bottom: 20px;
        right: 20px;
    }
    
    .quick-transaction-btn {
        width: 50px;
        height: 50px;
        font-size: 20px;
    }
    
    .transaction-icon {
        width: 35px;
        height: 35px;
        font-size: 16px;
    }
}

/* –ü—Ä–æ–≥–Ω–æ–∑ */
.forecast-chart {
    background: linear-gradient(135deg, rgba(255, 193, 7, 0.1), rgba(253, 126, 20, 0.1));
    border-radius: 12px;
    padding: 15px;
    margin-top: 15px;
}

/* –ò–º–ø–æ—Ä—Ç/–≠–∫—Å–ø–æ—Ä—Ç */
.import-export-section {
    background: white;
    border-radius: 12px;
    padding: 20px;
    border: 2px dashed #dee2e6;
    text-align: center;
    transition: all 0.3s ease;
}

.import-export-section:hover {
    border-color: #007bff;
    background: rgba(0, 123, 255, 0.05);
}

.dropzone {
    min-height: 120px;
    display: flex;
    align-items: center;
    justify-content: center;
    flex-direction: column;
}
</style>
{% endblock %}

{% block header_actions %}
<div class="btn-group">
    <button class="btn btn-primary" onclick="showQuickTransaction()">
        <i class="fas fa-plus me-1"></i> –ë—ã—Å—Ç—Ä–∞—è —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏—è
    </button>
    <button class="btn btn-success" onclick="showAddTransactionModal()">
        <i class="fas fa-plus me-1"></i> –ü–æ–¥—Ä–æ–±–Ω–∞—è —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏—è
    </button>
    <button class="btn btn-info" onclick="showAddCategoryModal()">
        <i class="fas fa-tags me-1"></i> –ö–∞—Ç–µ–≥–æ—Ä–∏—è
    </button>
    <div class="btn-group">
        <button class="btn btn-outline-secondary dropdown-toggle" data-bs-toggle="dropdown">
            <i class="fas fa-download me-1"></i> –≠–∫—Å–ø–æ—Ä—Ç/–ò–º–ø–æ—Ä—Ç
        </button>
        <ul class="dropdown-menu">
            <li><a class="dropdown-item" onclick="exportFinanceData()"><i class="fas fa-download me-2"></i>–≠–∫—Å–ø–æ—Ä—Ç –¥–∞–Ω–Ω—ã—Ö</a></li>
            <li><a class="dropdown-item" onclick="showImportModal()"><i class="fas fa-upload me-2"></i>–ò–º–ø–æ—Ä—Ç –∏–∑ CSV</a></li>
        </ul>
    </div>
    <div class="notifications-bell">
        <button class="btn btn-outline-warning" onclick="showNotifications()" id="notificationBtn">
            <i class="fas fa-bell"></i>
        </button>
        <span class="notification-badge" id="notificationBadge" style="display: none;">0</span>
    </div>
</div>
{% endblock %}

{% block content %}
<!-- –°–≤–æ–¥–∫–∞ –∑–∞ –ø–µ—Ä–∏–æ–¥ -->
<div class="period-summary">
    <div class="row align-items-center">
        <div class="col-md-8">
            <h5 class="mb-2">üìä –°–≤–æ–¥–∫–∞ –∑–∞ —Ç–µ–∫—É—â–∏–π –º–µ—Å—è—Ü</h5>
            <div class="row">
                <div class="col-md-4">
                    <div class="d-flex align-items-center">
                        <i class="fas fa-arrow-up text-success me-2"></i>
                        <div>
                            <div class="fw-bold" id="periodIncome">0 ‚ÇΩ</div>
                            <small class="text-muted">–î–æ—Ö–æ–¥—ã</small>
                            <span class="comparison-badge comparison-up ms-2" id="incomeComparison">+0%</span>
                        </div>
                    </div>
                </div>
                <div class="col-md-4">
                    <div class="d-flex align-items-center">
                        <i class="fas fa-arrow-down text-danger me-2"></i>
                        <div>
                            <div class="fw-bold" id="periodExpense">0 ‚ÇΩ</div>
                            <small class="text-muted">–†–∞—Å—Ö–æ–¥—ã</small>
                            <span class="comparison-badge comparison-down ms-2" id="expenseComparison">+0%</span>
                        </div>
                    </div>
                </div>
                <div class="col-md-4">
                    <div class="d-flex align-items-center">
                        <i class="fas fa-chart-line text-primary me-2"></i>
                        <div>
                            <div class="fw-bold" id="periodProfit">0 ‚ÇΩ</div>
                            <small class="text-muted">–ü—Ä–∏–±—ã–ª—å</small>
                            <span class="comparison-badge comparison-up ms-2" id="profitComparison">+0%</span>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        <div class="col-md-4">
            <div class="forecast-chart">
                <canvas id="miniChart" height="80"></canvas>
            </div>
        </div>
    </div>
</div>

<!-- –û—Å–Ω–æ–≤–Ω—ã–µ –ø–æ–∫–∞–∑–∞—Ç–µ–ª–∏ -->
<div class="row mb-4">
    <div class="col-md-2">
        <div class="card finance-card finance-card-income">
            <div class="card-body text-center">
                <i class="fas fa-arrow-up fa-2x mb-2"></i>
                <h3 class="mb-0" id="totalIncome">0 ‚ÇΩ</h3>
                <p class="mb-0">–î–æ—Ö–æ–¥—ã</p>
                <small id="incomeCount">0 –æ–ø–µ—Ä–∞—Ü–∏–π</small>
            </div>
        </div>
    </div>
    <div class="col-md-2">
        <div class="card finance-card finance-card-expense">
            <div class="card-body text-center">
                <i class="fas fa-arrow-down fa-2x mb-2"></i>
                <h3 class="mb-0" id="totalExpenses">0 ‚ÇΩ</h3>
                <p class="mb-0">–†–∞—Å—Ö–æ–¥—ã</p>
                <small id="expenseCount">0 –æ–ø–µ—Ä–∞—Ü–∏–π</small>
            </div>
        </div>
    </div>
    <div class="col-md-2">
        <div class="card finance-card finance-card-profit">
            <div class="card-body text-center">
                <i class="fas fa-chart-line fa-2x mb-2"></i>
                <h3 class="mb-0" id="totalProfit">0 ‚ÇΩ</h3>
                <p class="mb-0">–ü—Ä–∏–±—ã–ª—å</p>
                <small id="profitPercent">0%</small>
            </div>
        </div>
    </div>
    <div class="col-md-2">
        <div class="card finance-card finance-card-balance">
            <div class="card-body text-center">
                <i class="fas fa-wallet fa-2x mb-2"></i>
                <h3 class="mb-0" id="currentBalance">0 ‚ÇΩ</h3>
                <p class="mb-0">–ë–∞–ª–∞–Ω—Å</p>
                <small id="balanceStatus">–Ω–∞ –∫–æ–Ω–µ—Ü –º–µ—Å—è—Ü–∞</small>
            </div>
        </div>
    </div>
    <div class="col-md-2">
        <div class="card finance-card finance-card-forecast">
            <div class="card-body text-center">
                <i class="fas fa-crystal-ball fa-2x mb-2"></i>
                <h3 class="mb-0" id="forecastValue">0 ‚ÇΩ</h3>
                <p class="mb-0">–ü—Ä–æ–≥–Ω–æ–∑</p>
                <small id="forecastPeriod">–Ω–∞ —Å–ª–µ–¥. –º–µ—Å—è—Ü</small>
            </div>
        </div>
    </div>
    <div class="col-md-2">
        <div class="card finance-card finance-card-income">
            <div class="card-body text-center">
                <i class="fas fa-percentage fa-2x mb-2"></i>
                <h3 class="mb-0" id="savingsRate">0%</h3>
                <p class="mb-0">–≠–∫–æ–Ω–æ–º–∏—è</p>
                <small id="savingsInfo">–æ—Ç –¥–æ—Ö–æ–¥–æ–≤</small>
            </div>
        </div>
    </div>
</div>

<!-- –§–∏–ª—å—Ç—Ä—ã —Å —É–ª—É—á—à–µ–Ω–Ω—ã–º –¥–∏–∑–∞–π–Ω–æ–º -->
<div class="filter-section">
    <div class="row">
        <div class="col-md-2">
            <label class="form-label">–ü–µ—Ä–∏–æ–¥</label>
            <select class="form-select" id="periodFilter" onchange="loadFinanceData()">
                <option value="current_month">–¢–µ–∫—É—â–∏–π –º–µ—Å—è—Ü</option>
                <option value="last_month">–ü—Ä–æ—à–ª—ã–π –º–µ—Å—è—Ü</option>
                <option value="current_year">–¢–µ–∫—É—â–∏–π –≥–æ–¥</option>
                <option value="last_7_days">–ü–æ—Å–ª–µ–¥–Ω–∏–µ 7 –¥–Ω–µ–π</option>
                <option value="last_30_days">–ü–æ—Å–ª–µ–¥–Ω–∏–µ 30 –¥–Ω–µ–π</option>
                <option value="custom">–í—ã–±—Ä–∞—Ç—å –ø–µ—Ä–∏–æ–¥</option>
            </select>
        </div>
        <div class="col-md-2">
            <label class="form-label">–î–∞—Ç–∞ –æ—Ç</label>
            <input type="date" class="form-control" id="dateFrom" onchange="loadFinanceData()">
        </div>
        <div class="col-md-2">
            <label class="form-label">–î–∞—Ç–∞ –¥–æ</label>
            <input type="date" class="form-control" id="dateTo" onchange="loadFinanceData()">
        </div>
        <div class="col-md-2">
            <label class="form-label">–¢–∏–ø</label>
            <select class="form-select" id="typeFilter" onchange="loadFinanceData()">
                <option value="">–í—Å–µ</option>
                <option value="income">–î–æ—Ö–æ–¥—ã</option>
                <option value="expense">–†–∞—Å—Ö–æ–¥—ã</option>
            </select>
        </div>
        <div class="col-md-2">
            <label class="form-label">–ö–∞—Ç–µ–≥–æ—Ä–∏—è</label>
            <select class="form-select" id="categoryFilter" onchange="loadFinanceData()">
                <option value="">–í—Å–µ –∫–∞—Ç–µ–≥–æ—Ä–∏–∏</option>
            </select>
        </div>
        <div class="col-md-2">
            <label class="form-label">&nbsp;</label>
            <button class="btn btn-outline-danger w-100" onclick="clearFilters()">
                <i class="fas fa-times"></i> –û—á–∏—Å—Ç–∏—Ç—å
            </button>
        </div>
    </div>
    
    <!-- –ë—ã—Å—Ç—Ä—ã–µ —Ñ–∏–ª—å—Ç—Ä—ã -->
    <div class="filter-chips">
        <div class="filter-chip" onclick="quickFilter('today')">–°–µ–≥–æ–¥–Ω—è</div>
        <div class="filter-chip" onclick="quickFilter('yesterday')">–í—á–µ—Ä–∞</div>
        <div class="filter-chip" onclick="quickFilter('this_week')">–≠—Ç–∞ –Ω–µ–¥–µ–ª—è</div>
        <div class="filter-chip" onclick="quickFilter('last_week')">–ü—Ä–æ—à–ª–∞—è –Ω–µ–¥–µ–ª—è</div>
        <div class="filter-chip" onclick="quickFilter('large_amounts')">–ö—Ä—É–ø–Ω—ã–µ —Å—É–º–º—ã</div>
        <div class="filter-chip" onclick="quickFilter('recurring')">–ü–æ–≤—Ç–æ—Ä—è—é—â–∏–µ—Å—è</div>
    </div>
    
    <!-- –ö–∞—Ç–µ–≥–æ—Ä–∏–∏-—Ç–µ–≥–∏ -->
    <div class="mt-3">
        <label class="form-label">–ë—ã—Å—Ç—Ä—ã–π –≤—ã–±–æ—Ä –∫–∞—Ç–µ–≥–æ—Ä–∏–∏:</label>
        <div id="categoryTags">
            <!-- –¢–µ–≥–∏ –∫–∞—Ç–µ–≥–æ—Ä–∏–π –±—É–¥—É—Ç –∑–∞–≥—Ä—É–∂–µ–Ω—ã –∑–¥–µ—Å—å -->
        </div>
    </div>
</div>

<!-- –¢–∞–±—ã -->
<ul class="nav nav-tabs mb-4" id="financeTabs" role="tablist">
    <li class="nav-item" role="presentation">
        <button class="nav-link active" id="transactions-tab" data-bs-toggle="tab" data-bs-target="#transactions" type="button" role="tab">
            <i class="fas fa-list me-1"></i> –¢—Ä–∞–Ω–∑–∞–∫—Ü–∏–∏
        </button>
    </li>
    <li class="nav-item" role="presentation">
        <button class="nav-link" id="analytics-tab" data-bs-toggle="tab" data-bs-target="#analytics" type="button" role="tab">
            <i class="fas fa-chart-bar me-1"></i> –ê–Ω–∞–ª–∏—Ç–∏–∫–∞
        </button>
    </li>
    <li class="nav-item" role="presentation">
        <button class="nav-link" id="categories-tab" data-bs-toggle="tab" data-bs-target="#categories" type="button" role="tab">
            <i class="fas fa-tags me-1"></i> –ö–∞—Ç–µ–≥–æ—Ä–∏–∏
        </button>
    </li>
    <li class="nav-item" role="presentation">
        <button class="nav-link" id="import-export-tab" data-bs-toggle="tab" data-bs-target="#import-export" type="button" role="tab">
            <i class="fas fa-exchange-alt me-1"></i> –ò–º–ø–æ—Ä—Ç/–≠–∫—Å–ø–æ—Ä—Ç
        </button>
    </li>
</ul>

<div class="tab-content" id="financeTabContent">
    <!-- –¢—Ä–∞–Ω–∑–∞–∫—Ü–∏–∏ -->
    <div class="tab-pane fade show active" id="transactions" role="tabpanel">
        <div class="card">
            <div class="card-header d-flex justify-content-between align-items-center">
                <h5 class="card-title mb-0">–ü–æ—Å–ª–µ–¥–Ω–∏–µ —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–∏</h5>
                <div class="btn-group btn-group-sm">
                    <button class="btn btn-outline-primary" onclick="toggleViewMode('list')">
                        <i class="fas fa-list"></i>
                    </button>
                    <button class="btn btn-outline-primary" onclick="toggleViewMode('cards')">
                        <i class="fas fa-th"></i>
                    </button>
                </div>
            </div>
            <div class="card-body p-0">
                <div id="transactionsList" class="list-group list-group-flush">
                    <!-- –¢—Ä–∞–Ω–∑–∞–∫—Ü–∏–∏ –±—É–¥—É—Ç –∑–∞–≥—Ä—É–∂–µ–Ω—ã –∑–¥–µ—Å—å -->
                </div>
            </div>
        </div>
    </div>

    <!-- –ê–Ω–∞–ª–∏—Ç–∏–∫–∞ -->
    <div class="tab-pane fade" id="analytics" role="tabpanel">
        <div class="row">
            <div class="col-md-8">
                <div class="card">
                    <div class="card-header">
                        <h5 class="card-title mb-0">–î–∏–Ω–∞–º–∏–∫–∞ –¥–æ—Ö–æ–¥–æ–≤ –∏ —Ä–∞—Å—Ö–æ–¥–æ–≤</h5>
                    </div>
                    <div class="card-body">
                        <div class="chart-container">
                            <canvas id="monthlyChart"></canvas>
                        </div>
                    </div>
                </div>
                
                <!-- –¢–æ–ø-3 –∫–∞—Ç–µ–≥–æ—Ä–∏–∏ -->
                <div class="row mt-4">
                    <div class="col-md-6">
                        <div class="card">
                            <div class="card-header">
                                <h6 class="card-title mb-0">üèÜ –¢–æ–ø-3 –¥–æ—Ö–æ–¥–æ–≤</h6>
                            </div>
                            <div class="card-body">
                                <div id="topIncomeCategories">
                                    <!-- –¢–æ–ø –∫–∞—Ç–µ–≥–æ—Ä–∏–∏ –¥–æ—Ö–æ–¥–æ–≤ -->
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-6">
                        <div class="card">
                            <div class="card-header">
                                <h6 class="card-title mb-0">üìâ –¢–æ–ø-3 —Ä–∞—Å—Ö–æ–¥–æ–≤</h6>
                            </div>
                            <div class="card-body">
                                <div id="topExpenseCategories">
                                    <!-- –¢–æ–ø –∫–∞—Ç–µ–≥–æ—Ä–∏–∏ —Ä–∞—Å—Ö–æ–¥–æ–≤ -->
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            <div class="col-md-4">
                <div class="card">
                    <div class="card-header">
                        <h5 class="card-title mb-0">–°—Ç—Ä—É–∫—Ç—É—Ä–∞ —Ä–∞—Å—Ö–æ–¥–æ–≤</h5>
                    </div>
                    <div class="card-body">
                        <div class="chart-container">
                            <canvas id="expenseChart"></canvas>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- –ö–∞—Ç–µ–≥–æ—Ä–∏–∏ -->
    <div class="tab-pane fade" id="categories" role="tabpanel">
        <div class="row">
            <div class="col-md-6">
                <div class="card">
                    <div class="card-header">
                        <h5 class="card-title mb-0">–ö–∞—Ç–µ–≥–æ—Ä–∏–∏ –¥–æ—Ö–æ–¥–æ–≤</h5>
                    </div>
                    <div class="card-body">
                        <div id="incomeCategoriesList">
                            <!-- –ö–∞—Ç–µ–≥–æ—Ä–∏–∏ –¥–æ—Ö–æ–¥–æ–≤ –±—É–¥—É—Ç –∑–∞–≥—Ä—É–∂–µ–Ω—ã –∑–¥–µ—Å—å -->
                        </div>
                    </div>
                </div>
            </div>
            <div class="col-md-6">
                <div class="card">
                    <div class="card-header">
                        <h5 class="card-title mb-0">–ö–∞—Ç–µ–≥–æ—Ä–∏–∏ —Ä–∞—Å—Ö–æ–¥–æ–≤</h5>
                    </div>
                    <div class="card-body">
                        <div id="expenseCategoriesList">
                            <!-- –ö–∞—Ç–µ–≥–æ—Ä–∏–∏ —Ä–∞—Å—Ö–æ–¥–æ–≤ –±—É–¥—É—Ç –∑–∞–≥—Ä—É–∂–µ–Ω—ã –∑–¥–µ—Å—å -->
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <!-- –ò–º–ø–æ—Ä—Ç/–≠–∫—Å–ø–æ—Ä—Ç -->
    <div class="tab-pane fade" id="import-export" role="tabpanel">
        <div class="row">
            <div class="col-md-6">
                <div class="card">
                    <div class="card-header">
                        <h5 class="card-title mb-0"><i class="fas fa-upload me-2"></i>–ò–º–ø–æ—Ä—Ç –¥–∞–Ω–Ω—ã—Ö</h5>
                    </div>
                    <div class="card-body">
                        <div class="import-export-section dropzone" id="importDropzone">
                            <i class="fas fa-cloud-upload-alt fa-3x text-muted mb-3"></i>
                            <p class="mb-2">–ü–µ—Ä–µ—Ç–∞—â–∏—Ç–µ CSV —Ñ–∞–π–ª —Å—é–¥–∞ –∏–ª–∏</p>
                            <button class="btn btn-outline-primary" onclick="document.getElementById('csvFileInput').click()">
                                –í—ã–±–µ—Ä–∏—Ç–µ —Ñ–∞–π–ª
                            </button>
                            <input type="file" id="csvFileInput" accept=".csv" style="display: none;" onchange="handleFileUpload(this)">
                            <small class="text-muted mt-2 d-block">–§–æ—Ä–º–∞—Ç: –î–∞—Ç–∞, –¢–∏–ø, –°—É–º–º–∞, –ö–∞—Ç–µ–≥–æ—Ä–∏—è, –û–ø–∏—Å–∞–Ω–∏–µ</small>
                        </div>
                    </div>
                </div>
            </div>
            <div class="col-md-6">
                <div class="card">
                    <div class="card-header">
                        <h5 class="card-title mb-0"><i class="fas fa-download me-2"></i>–≠–∫—Å–ø–æ—Ä—Ç –¥–∞–Ω–Ω—ã—Ö</h5>
                    </div>
                    <div class="card-body">
                        <div class="d-grid gap-2">
                            <button class="btn btn-success" onclick="exportFinanceData('excel')">
                                <i class="fas fa-file-excel me-2"></i>–≠–∫—Å–ø–æ—Ä—Ç –≤ Excel
                            </button>
                            <button class="btn btn-info" onclick="exportFinanceData('csv')">
                                <i class="fas fa-file-csv me-2"></i>–≠–∫—Å–ø–æ—Ä—Ç –≤ CSV
                            </button>
                            <button class="btn btn-secondary" onclick="exportFinanceData('pdf')">
                                <i class="fas fa-file-pdf me-2"></i>–≠–∫—Å–ø–æ—Ä—Ç –≤ PDF
                            </button>
                        </div>
                        <hr>
                        <h6>–®–∞–±–ª–æ–Ω—ã</h6>
                        <button class="btn btn-outline-primary btn-sm" onclick="downloadTemplate()">
                            <i class="fas fa-download me-1"></i>–°–∫–∞—á–∞—Ç—å —à–∞–±–ª–æ–Ω CSV
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- –ë—ã—Å—Ç—Ä–∞—è —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏—è -->
<div class="quick-transaction">
    <button class="quick-transaction-btn" onclick="showQuickTransaction()" title="–ë—ã—Å—Ç—Ä–∞—è —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏—è">
        <i class="fas fa-plus"></i>
    </button>
</div>

<!-- –ú–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ –±—ã—Å—Ç—Ä–æ–π —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–∏ -->
<div class="modal fade" id="quickTransactionModal" tabindex="-1">
    <div class="modal-dialog modal-sm">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">‚ö° –ë—ã—Å—Ç—Ä–∞—è —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏—è</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <form id="quickTransactionForm">
                    <div class="mb-3">
                        <div class="btn-group w-100" role="group">
                            <input type="radio" class="btn-check" name="quickType" id="quickIncome" value="income">
                            <label class="btn btn-outline-success" for="quickIncome">
                                <i class="fas fa-arrow-up me-1"></i>–î–æ—Ö–æ–¥
                            </label>
                            <input type="radio" class="btn-check" name="quickType" id="quickExpense" value="expense" checked>
                            <label class="btn btn-outline-danger" for="quickExpense">
                                <i class="fas fa-arrow-down me-1"></i>–†–∞—Å—Ö–æ–¥
                            </label>
                        </div>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">–°—É–º–º–∞ (‚ÇΩ)</label>
                        <input type="number" class="form-control form-control-lg" id="quickAmount" required step="0.01" min="0" placeholder="0.00">
                    </div>
                    <div class="mb-3">
                        <label class="form-label">–ö–∞—Ç–µ–≥–æ—Ä–∏—è</label>
                        <select class="form-select" id="quickCategory" required>
                            <option value="">–í—ã–±–µ—Ä–∏—Ç–µ –∫–∞—Ç–µ–≥–æ—Ä–∏—é</option>
                        </select>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">–û–ø–∏—Å–∞–Ω–∏–µ</label>
                        <input type="text" class="form-control" id="quickDescription" required placeholder="–ö—Ä–∞—Ç–∫–æ–µ –æ–ø–∏—Å–∞–Ω–∏–µ">
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">–û—Ç–º–µ–Ω–∞</button>
                <button type="button" class="btn btn-primary" onclick="saveQuickTransaction()">
                    <i class="fas fa-save me-1"></i>–°–æ—Ö—Ä–∞–Ω–∏—Ç—å
                </button>
            </div>
        </div>
    </div>
</div>

<!-- –°—É—â–µ—Å—Ç–≤—É—é—â–∏–µ –º–æ–¥–∞–ª—å–Ω—ã–µ –æ–∫–Ω–∞ –æ—Å—Ç–∞—é—Ç—Å—è –±–µ–∑ –∏–∑–º–µ–Ω–µ–Ω–∏–π -->
<!-- ... -->

{% endblock %}

{% block scripts %}
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
    // –ê—É—Ç–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏—è –≤—ã–ø–æ–ª–Ω—è–µ—Ç—Å—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ —á–µ—Ä–µ–∑ –±—Ä–∞—É–∑–µ—Ä (HTTP Basic Auth)
    
    // –ì–ª–æ–±–∞–ª—å–Ω—ã–µ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ
    let financeCategories = [];
    let projects = [];
    let monthlyChart = null;
    let expenseChart = null;
    let miniChart = null;
    let currentViewMode = 'list';
    
    // –û—Ç–ª–∞–¥–æ—á–Ω–∞—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è
    console.log('[FINANCE DEBUG] User role: {{ user_role }}');
    console.log('[FINANCE DEBUG] Username: {{ username }}');
    
    // –ó–∞–≥—Ä—É–∑–∫–∞ –¥–∞–Ω–Ω—ã—Ö –ø—Ä–∏ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏–∏
    document.addEventListener('DOMContentLoaded', function() {
        // –ü—Ä–∏–Ω—É–¥–∏—Ç–µ–ª—å–Ω–æ –æ–±–Ω—É–ª—è–µ–º –∫–∞—Ä—Ç–æ—á–∫–∏ –¥–ª—è –∏—Å–ø–æ–ª–Ω–∏—Ç–µ–ª–µ–π
        if ('{{ user_role }}' === 'executor') {
            console.log('[DEBUG] Executor detected, clearing finance cards');
            // –ü—Ä–∏–Ω—É–¥–∏—Ç–µ–ª—å–Ω–æ –æ–±–Ω—É–ª—è–µ–º –≤—Å–µ –∫–∞—Ä—Ç–æ—á–∫–∏
            document.getElementById('totalIncome').textContent = '0 ‚ÇΩ';
            document.getElementById('totalExpenses').textContent = '0 ‚ÇΩ';
            document.getElementById('totalProfit').textContent = '0 ‚ÇΩ';
            document.getElementById('incomeCount').textContent = '0 –æ–ø–µ—Ä–∞—Ü–∏–π';
            document.getElementById('expenseCount').textContent = '0 –æ–ø–µ—Ä–∞—Ü–∏–π';
            document.getElementById('currentBalance').textContent = '0 ‚ÇΩ';
            document.getElementById('forecastValue').textContent = '0 ‚ÇΩ';
            document.getElementById('savingsRate').textContent = '0%';
            updateFinanceStats([]);
        }
        
        loadFinanceCategories();
        loadProjects();
        loadFinanceData();
        setDefaultDates();
        initializeMiniChart();
        checkNotifications();
        
        // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è drag & drop –¥–ª—è –∏–º–ø–æ—Ä—Ç–∞
        initializeDropzone();
    });
    
    // –ë—ã—Å—Ç—Ä–∞—è —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏—è
    function showQuickTransaction() {
        // –û—á–∏—â–∞–µ–º —Ñ–æ—Ä–º—É
        document.getElementById('quickTransactionForm').reset();
        document.getElementById('quickExpense').checked = true;
        
        // –û–±–Ω–æ–≤–ª—è–µ–º –∫–∞—Ç–µ–≥–æ—Ä–∏–∏
        updateQuickCategories();
        
        const modal = new bootstrap.Modal(document.getElementById('quickTransactionModal'));
        modal.show();
        
        // –§–æ–∫—É—Å –Ω–∞ —Å—É–º–º–µ
        setTimeout(() => {
            document.getElementById('quickAmount').focus();
        }, 300);
    }
    
    function updateQuickCategories() {
        const typeRadios = document.querySelectorAll('input[name="quickType"]');
        const categorySelect = document.getElementById('quickCategory');
        
        // –°–ª—É—à–∞–µ–º –∏–∑–º–µ–Ω–µ–Ω–∏–µ —Ç–∏–ø–∞
        typeRadios.forEach(radio => {
            radio.addEventListener('change', function() {
                const type = this.value;
                categorySelect.innerHTML = '<option value="">–í—ã–±–µ—Ä–∏—Ç–µ –∫–∞—Ç–µ–≥–æ—Ä–∏—é</option>';
                
                if (financeCategories && Array.isArray(financeCategories)) {
                    financeCategories.filter(cat => cat.type === type).forEach(category => {
                        const option = document.createElement('option');
                        option.value = category.id;
                        option.textContent = category.name;
                        categorySelect.appendChild(option);
                    });
                }
            });
        });
        
        // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –¥–ª—è —Ä–∞—Å—Ö–æ–¥–æ–≤ (–ø–æ —É–º–æ–ª—á–∞–Ω–∏—é)
        const expenseCategories = financeCategories.filter(cat => cat.type === 'expense');
        categorySelect.innerHTML = '<option value="">–í—ã–±–µ—Ä–∏—Ç–µ –∫–∞—Ç–µ–≥–æ—Ä–∏—é</option>';
        expenseCategories.forEach(category => {
            const option = document.createElement('option');
            option.value = category.id;
            option.textContent = category.name;
            categorySelect.appendChild(option);
        });
    }
    
    async function saveQuickTransaction() {
        const form = document.getElementById('quickTransactionForm');
        const type = document.querySelector('input[name="quickType"]:checked').value;
        const amount = parseFloat(document.getElementById('quickAmount').value);
        const categoryId = parseInt(document.getElementById('quickCategory').value);
        const description = document.getElementById('quickDescription').value.trim();
        
        // –í–∞–ª–∏–¥–∞—Ü–∏—è
        if (!amount || amount <= 0) {
            alert('–í–≤–µ–¥–∏—Ç–µ –∫–æ—Ä—Ä–µ–∫—Ç–Ω—É—é —Å—É–º–º—É');
            return;
        }
        if (!categoryId) {
            alert('–í—ã–±–µ—Ä–∏—Ç–µ –∫–∞—Ç–µ–≥–æ—Ä–∏—é');
            return;
        }
        if (!description) {
            alert('–í–≤–µ–¥–∏—Ç–µ –æ–ø–∏—Å–∞–Ω–∏–µ');
            return;
        }
        
        const formData = {
            type: type,
            amount: amount,
            category_id: categoryId,
            date: new Date().toISOString(),
            description: description,
            notes: '–ë—ã—Å—Ç—Ä–∞—è —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏—è'
        };
        
        try {
            const response = await fetch('/admin/api/finance/transactions', {
                method: 'POST',
                credentials: 'include',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify(formData)
            });
            
            const result = await response.json();
            
            if (result.success) {
                showNotification('–¢—Ä–∞–Ω–∑–∞–∫—Ü–∏—è —É—Å–ø–µ—à–Ω–æ —Å–æ–∑–¥–∞–Ω–∞!', 'success');
                
                // –ó–∞–∫—Ä—ã–≤–∞–µ–º –º–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ
                const modal = bootstrap.Modal.getInstance(document.getElementById('quickTransactionModal'));
                modal.hide();
                
                // –û—á–∏—â–∞–µ–º —Ñ–æ—Ä–º—É
                form.reset();
                
                // –û–±–Ω–æ–≤–ª—è–µ–º –¥–∞–Ω–Ω—ã–µ
                await loadFinanceData();
                
            } else {
                showNotification('–û—à–∏–±–∫–∞ —Å–æ–∑–¥–∞–Ω–∏—è —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–∏: ' + (result.error || '–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–∞—è –æ—à–∏–±–∫–∞'), 'error');
            }
        } catch (error) {
            console.error('–û—à–∏–±–∫–∞:', error);
            showNotification('–û—à–∏–±–∫–∞ –ø—Ä–∏ —Å–æ–∑–¥–∞–Ω–∏–∏ —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–∏', 'error');
        }
    }
    
    // –ë—ã—Å—Ç—Ä—ã–µ —Ñ–∏–ª—å—Ç—Ä—ã
    function quickFilter(filterType) {
        // –°–Ω–∏–º–∞–µ–º –∞–∫—Ç–∏–≤–Ω–æ—Å—Ç—å —Å–æ –≤—Å–µ—Ö —á–∏–ø–æ–≤
        document.querySelectorAll('.filter-chip').forEach(chip => {
            chip.classList.remove('active');
        });
        
        // –ê–∫—Ç–∏–≤–∏—Ä—É–µ–º —Ç–µ–∫—É—â–∏–π —á–∏–ø
        event.target.classList.add('active');
        
        const now = new Date();
        const today = new Date(now.getFullYear(), now.getMonth(), now.getDate());
        
        switch(filterType) {
            case 'today':
                document.getElementById('dateFrom').value = today.toISOString().split('T')[0];
                document.getElementById('dateTo').value = today.toISOString().split('T')[0];
                break;
            case 'yesterday':
                const yesterday = new Date(today);
                yesterday.setDate(yesterday.getDate() - 1);
                document.getElementById('dateFrom').value = yesterday.toISOString().split('T')[0];
                document.getElementById('dateTo').value = yesterday.toISOString().split('T')[0];
                break;
            case 'this_week':
                const weekStart = new Date(today);
                weekStart.setDate(weekStart.getDate() - weekStart.getDay());
                document.getElementById('dateFrom').value = weekStart.toISOString().split('T')[0];
                document.getElementById('dateTo').value = today.toISOString().split('T')[0];
                break;
            case 'last_week':
                const lastWeekEnd = new Date(today);
                lastWeekEnd.setDate(lastWeekEnd.getDate() - lastWeekEnd.getDay() - 1);
                const lastWeekStart = new Date(lastWeekEnd);
                lastWeekStart.setDate(lastWeekStart.getDate() - 6);
                document.getElementById('dateFrom').value = lastWeekStart.toISOString().split('T')[0];
                document.getElementById('dateTo').value = lastWeekEnd.toISOString().split('T')[0];
                break;
            case 'large_amounts':
                // –§–∏–ª—å—Ç—Ä –ø–æ –∫—Ä—É–ø–Ω—ã–º —Å—É–º–º–∞–º (–ø–æ–∫–∞ –ø—Ä–æ—Å—Ç–æ –ø—Ä–∏–º–µ–Ω–∏–º —Ñ–∏–ª—å—Ç—Ä)
                document.getElementById('dateFrom').value = '';
                document.getElementById('dateTo').value = '';
                break;
            case 'recurring':
                // –§–∏–ª—å—Ç—Ä –ø–æ –ø–æ–≤—Ç–æ—Ä—è—é—â–∏–º—Å—è —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏—è–º
                break;
        }
        
        loadFinanceData();
    }
    
    // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –º–∏–Ω–∏-–≥—Ä–∞—Ñ–∏–∫–∞
    function initializeMiniChart() {
        const ctx = document.getElementById('miniChart');
        if (!ctx) return;
        
        miniChart = new Chart(ctx, {
            type: 'line',
            data: {
                labels: [],
                datasets: [{
                    label: '–î–æ—Ö–æ–¥—ã',
                    data: [],
                    borderColor: '#28a745',
                    backgroundColor: 'rgba(40, 167, 69, 0.1)',
                    tension: 0.4,
                    fill: true
                }, {
                    label: '–†–∞—Å—Ö–æ–¥—ã',
                    data: [],
                    borderColor: '#dc3545',
                    backgroundColor: 'rgba(220, 53, 69, 0.1)',
                    tension: 0.4,
                    fill: true
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    legend: {
                        display: false
                    }
                },
                scales: {
                    y: {
                        display: false
                    },
                    x: {
                        display: false
                    }
                },
                elements: {
                    point: {
                        radius: 0
                    }
                }
            }
        });
    }
    
    // –ü–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏–µ —Ä–µ–∂–∏–º–∞ –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è
    function toggleViewMode(mode) {
        currentViewMode = mode;
        
        // –û–±–Ω–æ–≤–ª—è–µ–º –∫–Ω–æ–ø–∫–∏
        document.querySelectorAll('.btn-group button').forEach(btn => {
            btn.classList.remove('active');
        });
        event.target.classList.add('active');
        
        // –û–±–Ω–æ–≤–ª—è–µ–º –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏–µ
        loadFinanceData();
    }
    
    // –£–ª—É—á—à–µ–Ω–Ω–æ–µ –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏–µ —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–π
    function updateTransactionsList(transactions) {
        const container = document.getElementById('transactionsList');
        if (!container) return;
        
        if (!transactions || transactions.length === 0) {
            container.innerHTML = `
                <div class="list-group-item text-center py-4">
                    <div class="text-muted">
                        <i class="fas fa-receipt fa-3x mb-3"></i>
                        <h5>–ù–µ—Ç —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–π</h5>
                        <p class="mb-3">–°–æ–∑–¥–∞–π—Ç–µ –ø–µ—Ä–≤—É—é —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏—é, —á—Ç–æ–±—ã –Ω–∞—á–∞—Ç—å —É—á–µ—Ç —Ñ–∏–Ω–∞–Ω—Å–æ–≤</p>
                        <button class="btn btn-primary" onclick="showQuickTransaction()">
                            <i class="fas fa-plus me-1"></i>–î–æ–±–∞–≤–∏—Ç—å —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏—é
                        </button>
                    </div>
                </div>
            `;
            return;
        }
        
        // –°–æ—Ä—Ç–∏—Ä—É–µ–º —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–∏ –ø–æ –¥–∞—Ç–µ
        transactions.sort((a, b) => new Date(b.date || b.created_at) - new Date(a.date || a.created_at));
        
        const recentTransactions = transactions.slice(0, 20);
        
        const transactionsHtml = recentTransactions.map(transaction => {
            const date = new Date(transaction.date || transaction.created_at);
            const formattedDate = date.toLocaleDateString('ru-RU');
            const formattedTime = date.toLocaleTimeString('ru-RU', {
                hour: '2-digit',
                minute: '2-digit'
            });
            
            const category = financeCategories.find(cat => cat.id === transaction.category_id);
            const categoryName = category ? category.name : '–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–∞—è –∫–∞—Ç–µ–≥–æ—Ä–∏—è';
            const categoryIcon = category ? category.icon : 'fas fa-circle';
            const categoryColor = category ? category.color : '#6c757d';
            
            const amount = Math.abs(transaction.amount);
            const isIncome = transaction.type === 'income';
            
            // –í—ã–±–∏—Ä–∞–µ–º –∏–∫–æ–Ω–∫—É –¥–ª—è —Ç–∏–ø–∞ —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–∏
            const typeIcon = isIncome ? 'fas fa-arrow-up' : 'fas fa-arrow-down';
            
            return `
                <div class="list-group-item transaction-item ${isIncome ? 'transaction-income' : 'transaction-expense'} animate-slide-in">
                    <div class="d-flex align-items-center">
                        <div class="transaction-icon ${isIncome ? 'income' : 'expense'}">
                            <i class="${typeIcon}"></i>
                        </div>
                        <div class="flex-grow-1">
                            <div class="d-flex justify-content-between align-items-start mb-1">
                                <h6 class="mb-0 fw-bold">${transaction.description}</h6>
                                <div class="text-end">
                                    <div class="amount-${isIncome ? 'income' : 'expense'} h5 mb-0">
                                        ${isIncome ? '+' : '-'}${amount.toLocaleString('ru-RU')} ‚ÇΩ
                                    </div>
                                </div>
                            </div>
                            <div class="d-flex justify-content-between align-items-center">
                                <div>
                                    <span class="category-tag" style="background-color: ${categoryColor}20; color: ${categoryColor};">
                                        <i class="${categoryIcon} me-1"></i>${categoryName}
                                    </span>
                                    ${transaction.project_id ? `<span class="badge bg-primary ms-1">–ü—Ä–æ–µ–∫—Ç #${transaction.project_id}</span>` : ''}
                                </div>
                                <small class="text-muted">
                                    <i class="fas fa-calendar-alt me-1"></i>${formattedDate} ${formattedTime}
                                </small>
                            </div>
                            ${transaction.notes ? `<small class="text-muted d-block mt-1">${transaction.notes}</small>` : ''}
                        </div>
                        <div class="ms-3">
                            <div class="btn-group-vertical">
                                <button class="btn btn-sm btn-outline-primary" onclick="editTransaction(${transaction.id})" title="–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å">
                                    <i class="fas fa-edit"></i>
                                </button>
                                <button class="btn btn-sm btn-outline-danger" onclick="deleteTransaction(${transaction.id}, '${transaction.description}')" title="–£–¥–∞–ª–∏—Ç—å">
                                    <i class="fas fa-trash"></i>
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            `;
        }).join('');
        
        container.innerHTML = transactionsHtml;
    }
    
    // –§—É–Ω–∫—Ü–∏—è –¥–ª—è –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π
    function showNotification(message, type = 'info') {
        // –°–æ–∑–¥–∞–µ–º toast —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ
        const toastHtml = `
            <div class="toast align-items-center text-white bg-${type === 'success' ? 'success' : type === 'error' ? 'danger' : 'info'} border-0" role="alert">
                <div class="d-flex">
                    <div class="toast-body">
                        <i class="fas fa-${type === 'success' ? 'check-circle' : type === 'error' ? 'exclamation-triangle' : 'info-circle'} me-2"></i>
                        ${message}
                    </div>
                    <button type="button" class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast"></button>
                </div>
            </div>
        `;
        
        // –î–æ–±–∞–≤–ª—è–µ–º –≤ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π
        let container = document.getElementById('toast-container');
        if (!container) {
            container = document.createElement('div');
            container.id = 'toast-container';
            container.className = 'toast-container position-fixed top-0 end-0 p-3';
            container.style.zIndex = '9999';
            document.body.appendChild(container);
        }
        
        container.insertAdjacentHTML('beforeend', toastHtml);
        
        // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º toast
        const toastElement = container.lastElementChild;
        const toast = new bootstrap.Toast(toastElement);
        toast.show();
        
        // –£–¥–∞–ª—è–µ–º –ø–æ—Å–ª–µ —Å–∫—Ä—ã—Ç–∏—è
        toastElement.addEventListener('hidden.bs.toast', () => {
            toastElement.remove();
        });
    }
    
    // –ü—Ä–æ–≤–µ—Ä–∫–∞ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π
    function checkNotifications() {
        // –ó–¥–µ—Å—å –º–æ–∂–Ω–æ –¥–æ–±–∞–≤–∏—Ç—å –ª–æ–≥–∏–∫—É –ø—Ä–æ–≤–µ—Ä–∫–∏ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π
        // –ù–∞–ø—Ä–∏–º–µ—Ä, –ø—Ä–æ–≤–µ—Ä–∫–∞ –ø–æ–≤—Ç–æ—Ä—è—é—â–∏—Ö—Å—è —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–π, –ø—Ä–µ–≤—ã—à–µ–Ω–∏—è –±—é–¥–∂–µ—Ç–∞ –∏ —Ç.–¥.
        
        let notificationCount = 0;
        
        // –ü—Ä–∏–º–µ—Ä –ø—Ä–æ–≤–µ—Ä–æ–∫
        // if (–Ω–µ–∫–æ–µ —É—Å–ª–æ–≤–∏–µ) notificationCount++;
        
        const badge = document.getElementById('notificationBadge');
        if (notificationCount > 0) {
            badge.textContent = notificationCount;
            badge.style.display = 'flex';
        } else {
            badge.style.display = 'none';
        }
    }
    
    function showNotifications() {
        // –ü–æ–∫–∞–∑–∞—Ç—å —Å–ø–∏—Å–æ–∫ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π
        alert('–§—É–Ω–∫—Ü–∏—è —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π –±—É–¥–µ—Ç –¥–æ–±–∞–≤–ª–µ–Ω–∞ –≤ —Å–ª–µ–¥—É—é—â–µ–π –≤–µ—Ä—Å–∏–∏');
    }
    
    // Drag & Drop –¥–ª—è –∏–º–ø–æ—Ä—Ç–∞
    function initializeDropzone() {
        const dropzone = document.getElementById('importDropzone');
        if (!dropzone) return;
        
        dropzone.addEventListener('dragover', (e) => {
            e.preventDefault();
            dropzone.classList.add('dragover');
        });
        
        dropzone.addEventListener('dragleave', () => {
            dropzone.classList.remove('dragover');
        });
        
        dropzone.addEventListener('drop', (e) => {
            e.preventDefault();
            dropzone.classList.remove('dragover');
            
            const files = e.dataTransfer.files;
            if (files.length > 0) {
                handleFileUpload({ files: files });
            }
        });
    }
    
    function handleFileUpload(input) {
        const file = input.files[0];
        if (!file) return;
        
        if (!file.name.endsWith('.csv')) {
            showNotification('–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –≤—ã–±–µ—Ä–∏—Ç–µ CSV —Ñ–∞–π–ª', 'error');
            return;
        }
        
        const reader = new FileReader();
        reader.onload = function(e) {
            const csv = e.target.result;
            parseAndImportCSV(csv);
        };
        reader.readAsText(file);
    }
    
    function parseAndImportCSV(csv) {
        // –ü–∞—Ä—Å–∏–Ω–≥ CSV –∏ –∏–º–ø–æ—Ä—Ç –¥–∞–Ω–Ω—ã—Ö
        showNotification('–ò–º–ø–æ—Ä—Ç CSV —Ñ–∞–π–ª–æ–≤ –±—É–¥–µ—Ç —Ä–µ–∞–ª–∏–∑–æ–≤–∞–Ω –≤ —Å–ª–µ–¥—É—é—â–µ–π –≤–µ—Ä—Å–∏–∏', 'info');
    }
    
    function downloadTemplate() {
        // –°–∫–∞—á–∏–≤–∞–Ω–∏–µ —à–∞–±–ª–æ–Ω–∞ CSV
        const csvContent = '–î–∞—Ç–∞,–¢–∏–ø,–°—É–º–º–∞,–ö–∞—Ç–µ–≥–æ—Ä–∏—è,–û–ø–∏—Å–∞–Ω–∏–µ,–ó–∞–º–µ—Ç–∫–∏\n2024-01-01,income,5000,–ó–∞—Ä–ø–ª–∞—Ç–∞,–ó–∞—Ä–∞–±–æ—Ç–Ω–∞—è –ø–ª–∞—Ç–∞,\n2024-01-02,expense,500,–ü—Ä–æ–¥—É–∫—Ç—ã,–ü–æ–∫—É–ø–∫–∞ –ø—Ä–æ–¥—É–∫—Ç–æ–≤,';
        
        const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
        const link = document.createElement('a');
        link.href = URL.createObjectURL(blob);
        link.download = 'template_finance.csv';
        document.body.appendChild(link);
        link.click();
        document.body.removeChild(link);
    }
    
    // –†–∞—Å—à–∏—Ä–µ–Ω–∏–µ —Ñ—É–Ω–∫—Ü–∏–π —ç–∫—Å–ø–æ—Ä—Ç–∞
    async function exportFinanceData(format = 'excel') {
        try {
            const response = await fetch(`/admin/api/finance/export?format=${format}`, {
                method: 'GET',
                credentials: 'include'
            });
            
            if (response.ok) {
                const blob = await response.blob();
                const url = window.URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                
                const extensions = {
                    excel: 'xlsx',
                    csv: 'csv',
                    pdf: 'pdf'
                };
                
                a.download = `finance_export_${new Date().toISOString().split('T')[0]}.${extensions[format]}`;
                document.body.appendChild(a);
                a.click();
                window.URL.revokeObjectURL(url);
                document.body.removeChild(a);
                
                showNotification(`–î–∞–Ω–Ω—ã–µ —É—Å–ø–µ—à–Ω–æ —ç–∫—Å–ø–æ—Ä—Ç–∏—Ä–æ–≤–∞–Ω—ã –≤ ${format.toUpperCase()}!`, 'success');
            } else {
                showNotification('–û—à–∏–±–∫–∞ –ø—Ä–∏ —ç–∫—Å–ø–æ—Ä—Ç–µ –¥–∞–Ω–Ω—ã—Ö', 'error');
            }
        } catch (error) {
            console.error('–û—à–∏–±–∫–∞ —ç–∫—Å–ø–æ—Ä—Ç–∞:', error);
            showNotification('–û—à–∏–±–∫–∞ –ø—Ä–∏ —ç–∫—Å–ø–æ—Ä—Ç–µ –¥–∞–Ω–Ω—ã—Ö', 'error');
        }
    }
    
    // –£—Å—Ç–∞–Ω–æ–≤–∫–∞ –¥–∞—Ç –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é
    function setDefaultDates() {
        const now = new Date();
        const firstDay = new Date(now.getFullYear(), now.getMonth(), 1);
        
        document.getElementById('dateFrom').value = firstDay.toISOString().split('T')[0];
        document.getElementById('dateTo').value = now.toISOString().split('T')[0];
    }
    
    // –ó–∞–≥—Ä—É–∑–∫–∞ –∫–∞—Ç–µ–≥–æ—Ä–∏–π
    async function loadFinanceCategories() {
        try {
            const response = await fetch('/admin/api/finance/categories', {
                credentials: 'include'
            });
            
            if (response.ok) {
                const data = await response.json();
                
                if (data.success && data.data) {
                    financeCategories = Array.isArray(data.data) ? data.data : [];
                } else if (Array.isArray(data)) {
                    financeCategories = data;
                } else {
                    financeCategories = [];
                }
                
                updateCategoryFilter();
                updateQuickCategories();
                renderCategoryTags();
            } else {
                console.error('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –∫–∞—Ç–µ–≥–æ—Ä–∏–π: HTTP', response.status);
                financeCategories = [];
            }
        } catch (error) {
            console.error('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –∫–∞—Ç–µ–≥–æ—Ä–∏–π:', error);
            financeCategories = [];
        }
    }
    
    // –ó–∞–≥—Ä—É–∑–∫–∞ –ø—Ä–æ–µ–∫—Ç–æ–≤
    async function loadProjects() {
        try {
            const response = await fetch('/admin/api/projects', {
                credentials: 'include'
            });
            
            if (response.ok) {
                const data = await response.json();
                
                if (data.success && data.data) {
                    projects = Array.isArray(data.data) ? data.data : [];
                } else if (Array.isArray(data)) {
                    projects = data;
                } else {
                    projects = [];
                }
            } else {
                console.error('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –ø—Ä–æ–µ–∫—Ç–æ–≤: HTTP', response.status);
                projects = [];
            }
        } catch (error) {
            console.error('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –ø—Ä–æ–µ–∫—Ç–æ–≤:', error);
            projects = [];
        }
    }
    
    // –ó–∞–≥—Ä—É–∑–∫–∞ —Ñ–∏–Ω–∞–Ω—Å–æ–≤—ã—Ö –¥–∞–Ω–Ω—ã—Ö
    async function loadFinanceData() {
        console.log('–ó–∞–≥—Ä—É–∑–∫–∞ —Ñ–∏–Ω–∞–Ω—Å–æ–≤—ã—Ö –¥–∞–Ω–Ω—ã—Ö...');
        
        try {
            const params = new URLSearchParams();
            
            const dateFrom = document.getElementById('dateFrom').value;
            const dateTo = document.getElementById('dateTo').value;
            const typeFilter = document.getElementById('typeFilter').value;
            const categoryFilter = document.getElementById('categoryFilter').value;
            
            if (dateFrom) params.append('date_from', dateFrom);
            if (dateTo) params.append('date_to', dateTo);
            if (typeFilter) params.append('type', typeFilter);
            if (categoryFilter) params.append('category_id', categoryFilter);
            
            // –î–æ–±–∞–≤–ª—è–µ–º timestamp –¥–ª—è –∏–∑–±–µ–∂–∞–Ω–∏—è –∫—ç—à–∏—Ä–æ–≤–∞–Ω–∏—è
            params.append('_t', Date.now());
            
            const response = await fetch(`/admin/api/finance/transactions?${params}`, {
                credentials: 'include'  // –ò—Å–ø–æ–ª—å–∑—É–µ–º —Å—É—â–µ—Å—Ç–≤—É—é—â—É—é –∞—É—Ç–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏—é –±—Ä–∞—É–∑–µ—Ä–∞
            });
            
            if (response.ok) {
                const data = await response.json();
                
                let transactions = [];
                if (data.success && data.data) {
                    transactions = Array.isArray(data.data) ? data.data : [];
                } else if (Array.isArray(data)) {
                    transactions = data;
                }
                
                console.log(`[DEBUG] Loaded ${transactions.length} transactions for user role: {{ user_role }}`);
                console.log('[DEBUG] First transaction:', transactions[0] || 'none');
                
                updateTransactionsList(transactions);
                updateFinanceStats(transactions);
                updatePeriodSummary(transactions);
                
            } else {
                console.error('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–π: HTTP', response.status);
                updateTransactionsList([]);
            }
            
        } catch (error) {
            console.error('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ —Ñ–∏–Ω–∞–Ω—Å–æ–≤—ã—Ö –¥–∞–Ω–Ω—ã—Ö:', error);
            updateTransactionsList([]);
        }
    }
    
    // –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏
    function updateFinanceStats(transactions) {
        if (!transactions || transactions.length === 0) {
            document.getElementById('totalIncome').textContent = '0 ‚ÇΩ';
            document.getElementById('totalExpenses').textContent = '0 ‚ÇΩ';
            document.getElementById('totalProfit').textContent = '0 ‚ÇΩ';
            document.getElementById('incomeCount').textContent = '0 –æ–ø–µ—Ä–∞—Ü–∏–π';
            document.getElementById('expenseCount').textContent = '0 –æ–ø–µ—Ä–∞—Ü–∏–π';
            document.getElementById('currentBalance').textContent = '0 ‚ÇΩ';
            document.getElementById('forecastValue').textContent = '0 ‚ÇΩ';
            document.getElementById('savingsRate').textContent = '0%';
            return;
        }
        
        const incomeTransactions = transactions.filter(t => t.type === 'income');
        const expenseTransactions = transactions.filter(t => t.type === 'expense');
        
        const totalIncome = incomeTransactions.reduce((sum, t) => sum + Math.abs(t.amount), 0);
        const totalExpense = expenseTransactions.reduce((sum, t) => sum + Math.abs(t.amount), 0);
        const profit = totalIncome - totalExpense;
        const savingsRate = totalIncome > 0 ? ((totalIncome - totalExpense) / totalIncome * 100) : 0;
        
        // –ü—Ä–æ—Å—Ç–æ–π –ø—Ä–æ–≥–Ω–æ–∑ –Ω–∞ –æ—Å–Ω–æ–≤–µ —Å—Ä–µ–¥–Ω–∏—Ö –∑–Ω–∞—á–µ–Ω–∏–π
        const avgIncome = totalIncome / Math.max(1, incomeTransactions.length);
        const avgExpense = totalExpense / Math.max(1, expenseTransactions.length);
        const forecast = (avgIncome * 10) - (avgExpense * 10); // –ü—Ä–æ–≥–Ω–æ–∑ –Ω–∞ 10 –¥–Ω–µ–π
        
        document.getElementById('totalIncome').textContent = totalIncome.toLocaleString('ru-RU') + ' ‚ÇΩ';
        document.getElementById('totalExpenses').textContent = totalExpense.toLocaleString('ru-RU') + ' ‚ÇΩ';
        document.getElementById('totalProfit').textContent = profit.toLocaleString('ru-RU') + ' ‚ÇΩ';
        document.getElementById('incomeCount').textContent = `${incomeTransactions.length} –æ–ø–µ—Ä–∞—Ü–∏–π`;
        document.getElementById('expenseCount').textContent = `${expenseTransactions.length} –æ–ø–µ—Ä–∞—Ü–∏–π`;
        document.getElementById('currentBalance').textContent = profit.toLocaleString('ru-RU') + ' ‚ÇΩ';
        document.getElementById('forecastValue').textContent = forecast.toLocaleString('ru-RU') + ' ‚ÇΩ';
        document.getElementById('savingsRate').textContent = Math.round(savingsRate) + '%';
    }
    
    // –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ —Å–≤–æ–¥–∫–∏ –∑–∞ –ø–µ—Ä–∏–æ–¥
    function updatePeriodSummary(transactions) {
        const now = new Date();
        const currentMonth = now.getMonth();
        const currentYear = now.getFullYear();
        
        // –¢—Ä–∞–Ω–∑–∞–∫—Ü–∏–∏ –∑–∞ —Ç–µ–∫—É—â–∏–π –º–µ—Å—è—Ü
        const currentMonthTransactions = transactions.filter(t => {
            const date = new Date(t.date || t.created_at);
            return date.getMonth() === currentMonth && date.getFullYear() === currentYear;
        });
        
        // –¢—Ä–∞–Ω–∑–∞–∫—Ü–∏–∏ –∑–∞ –ø—Ä–æ—à–ª—ã–π –º–µ—Å—è—Ü
        const lastMonth = currentMonth === 0 ? 11 : currentMonth - 1;
        const lastMonthYear = currentMonth === 0 ? currentYear - 1 : currentYear;
        const lastMonthTransactions = transactions.filter(t => {
            const date = new Date(t.date || t.created_at);
            return date.getMonth() === lastMonth && date.getFullYear() === lastMonthYear;
        });
        
        // –†–∞—Å—á–µ—Ç —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏ –¥–ª—è —Ç–µ–∫—É—â–µ–≥–æ –º–µ—Å—è—Ü–∞
        const currentIncome = currentMonthTransactions
            .filter(t => t.type === 'income')
            .reduce((sum, t) => sum + Math.abs(t.amount), 0);
        const currentExpense = currentMonthTransactions
            .filter(t => t.type === 'expense')
            .reduce((sum, t) => sum + Math.abs(t.amount), 0);
        const currentProfit = currentIncome - currentExpense;
        
        // –†–∞—Å—á–µ—Ç —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏ –¥–ª—è –ø—Ä–æ—à–ª–æ–≥–æ –º–µ—Å—è—Ü–∞
        const lastIncome = lastMonthTransactions
            .filter(t => t.type === 'income')
            .reduce((sum, t) => sum + Math.abs(t.amount), 0);
        const lastExpense = lastMonthTransactions
            .filter(t => t.type === 'expense')
            .reduce((sum, t) => sum + Math.abs(t.amount), 0);
        const lastProfit = lastIncome - lastExpense;
        
        // –†–∞—Å—á–µ—Ç –∏–∑–º–µ–Ω–µ–Ω–∏–π –≤ –ø—Ä–æ—Ü–µ–Ω—Ç–∞—Ö
        const incomeChange = lastIncome > 0 ? ((currentIncome - lastIncome) / lastIncome * 100) : 0;
        const expenseChange = lastExpense > 0 ? ((currentExpense - lastExpense) / lastExpense * 100) : 0;
        const profitChange = lastProfit !== 0 ? ((currentProfit - lastProfit) / Math.abs(lastProfit) * 100) : 0;
        
        // –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ —ç–ª–µ–º–µ–Ω—Ç–æ–≤
        document.getElementById('periodIncome').textContent = currentIncome.toLocaleString('ru-RU') + ' ‚ÇΩ';
        document.getElementById('periodExpense').textContent = currentExpense.toLocaleString('ru-RU') + ' ‚ÇΩ';
        document.getElementById('periodProfit').textContent = currentProfit.toLocaleString('ru-RU') + ' ‚ÇΩ';
        
        // –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ —Å—Ä–∞–≤–Ω–µ–Ω–∏–π
        updateComparisonBadge('incomeComparison', incomeChange);
        updateComparisonBadge('expenseComparison', expenseChange);
        updateComparisonBadge('profitComparison', profitChange);
    }
    
    function updateComparisonBadge(elementId, change) {
        const element = document.getElementById(elementId);
        const isPositive = change >= 0;
        const sign = isPositive ? '+' : '';
        
        element.textContent = `${sign}${Math.round(change)}%`;
        element.className = `comparison-badge ${isPositive ? 'comparison-up' : 'comparison-down'}`;
    }
    
    // –û—Ç–æ–±—Ä–∞–∂–µ–Ω–∏–µ —Ç–µ–≥–æ–≤ –∫–∞—Ç–µ–≥–æ—Ä–∏–π
    function renderCategoryTags() {
        const container = document.getElementById('categoryTags');
        if (!container) return;
        
        container.innerHTML = '';
        
        financeCategories.forEach(category => {
            const tag = document.createElement('span');
            tag.className = 'category-tag';
            tag.style.backgroundColor = (category.color || '#6c757d') + '20';
            tag.style.color = category.color || '#6c757d';
            tag.innerHTML = `<i class="${category.icon || 'fas fa-circle'} me-1"></i>${category.name}`;
            tag.onclick = () => filterByCategory(category.id);
            container.appendChild(tag);
        });
    }
    
    function filterByCategory(categoryId) {
        // –°–Ω–∏–º–∞–µ–º –∞–∫—Ç–∏–≤–Ω–æ—Å—Ç—å —Å–æ –≤—Å–µ—Ö —Ç–µ–≥–æ–≤
        document.querySelectorAll('.category-tag').forEach(tag => {
            tag.classList.remove('active');
        });
        
        // –ê–∫—Ç–∏–≤–∏—Ä—É–µ–º –≤—ã–±—Ä–∞–Ω–Ω—ã–π —Ç–µ–≥
        event.target.classList.add('active');
        
        // –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º —Ñ–∏–ª—å—Ç—Ä
        document.getElementById('categoryFilter').value = categoryId;
        loadFinanceData();
    }
    
    function updateCategoryFilter() {
        const filter = document.getElementById('categoryFilter');
        if (!filter) return;
        
        filter.innerHTML = '<option value="">–í—Å–µ –∫–∞—Ç–µ–≥–æ—Ä–∏–∏</option>';
        
        financeCategories.forEach(category => {
            const option = document.createElement('option');
            option.value = category.id;
            option.textContent = category.name;
            filter.appendChild(option);
        });
    }
    
    function clearFilters() {
        document.getElementById('periodFilter').value = 'current_month';
        document.getElementById('typeFilter').value = '';
        document.getElementById('categoryFilter').value = '';
        
        // –°–Ω–∏–º–∞–µ–º –∞–∫—Ç–∏–≤–Ω–æ—Å—Ç—å —Å —á–∏–ø–æ–≤ –∏ —Ç–µ–≥–æ–≤
        document.querySelectorAll('.filter-chip, .category-tag').forEach(chip => {
            chip.classList.remove('active');
        });
        
        setDefaultDates();
        loadFinanceData();
    }
    
    // –ó–∞–≥–ª—É—à–∫–∏ –¥–ª—è —Ñ—É–Ω–∫—Ü–∏–π, –∫–æ—Ç–æ—Ä—ã–µ –±—É–¥—É—Ç –¥–æ–±–∞–≤–ª–µ–Ω—ã –ø–æ–∑–∂–µ
    function showAddTransactionModal() {
        showNotification('–§—É–Ω–∫—Ü–∏—è –±—É–¥–µ—Ç –¥–æ–±–∞–≤–ª–µ–Ω–∞ –≤ —Å–ª–µ–¥—É—é—â–µ–π –≤–µ—Ä—Å–∏–∏', 'info');
    }
    
    function showAddCategoryModal() {
        showNotification('–§—É–Ω–∫—Ü–∏—è –±—É–¥–µ—Ç –¥–æ–±–∞–≤–ª–µ–Ω–∞ –≤ —Å–ª–µ–¥—É—é—â–µ–π –≤–µ—Ä—Å–∏–∏', 'info');
    }
    
    function showImportModal() {
        // –ü–µ—Ä–µ–∫–ª—é—á–∞–µ–º—Å—è –Ω–∞ –≤–∫–ª–∞–¥–∫—É –∏–º–ø–æ—Ä—Ç/—ç–∫—Å–ø–æ—Ä—Ç
        const tab = new bootstrap.Tab(document.getElementById('import-export-tab'));
        tab.show();
    }
    
    function editTransaction(id) {
        showNotification('–§—É–Ω–∫—Ü–∏—è —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è –±—É–¥–µ—Ç –¥–æ–±–∞–≤–ª–µ–Ω–∞ –≤ —Å–ª–µ–¥—É—é—â–µ–π –≤–µ—Ä—Å–∏–∏', 'info');
    }
    
    async function deleteTransaction(id, description) {
        if (!confirm(`–£–¥–∞–ª–∏—Ç—å —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏—é "${description}"?`)) return;
        
        try {
            const response = await fetch(`/admin/api/finance/transactions/${id}`, {
                method: 'DELETE',
                credentials: 'include'
            });
            
            const result = await response.json();
            
            if (result.success) {
                showNotification('–¢—Ä–∞–Ω–∑–∞–∫—Ü–∏—è —É–¥–∞–ª–µ–Ω–∞', 'success');
                loadFinanceData();
            } else {
                showNotification('–û—à–∏–±–∫–∞ —É–¥–∞–ª–µ–Ω–∏—è —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–∏', 'error');
            }
        } catch (error) {
            showNotification('–û—à–∏–±–∫–∞ —É–¥–∞–ª–µ–Ω–∏—è —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–∏', 'error');
        }
    }
    
</script>
{% endblock %}