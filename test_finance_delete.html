<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Тест удаления финансовых транзакций</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
</head>
<body>
    <div class="container mt-4">
        <h1>Тест удаления финансовых транзакций</h1>
        
        <div class="alert alert-info">
            <strong>Инструкция:</strong>
            <ol>
                <li>Нажмите "Загрузить транзакции" для получения списка</li>
                <li>Используйте кнопки удаления для проверки функционала</li>
                <li>Проверьте консоль браузера для отладки</li>
            </ol>
        </div>
        
        <div class="mb-3">
            <button class="btn btn-primary" onclick="loadTransactions()">
                <i class="fas fa-sync"></i> Загрузить транзакции
            </button>
            <button class="btn btn-success" onclick="createTestTransaction()">
                <i class="fas fa-plus"></i> Создать тестовую транзакцию
            </button>
        </div>
        
        <div id="transactionsList" class="list-group">
            <!-- Транзакции будут загружены здесь -->
        </div>
        
        <div id="status" class="mt-3"></div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        const API_BASE = 'http://localhost:8001/admin/api';
        const AUTH_HEADER = 'Basic ' + btoa('admin:qwerty123');
        
        async function loadTransactions() {
            console.log('Загрузка транзакций...');
            showStatus('Загрузка транзакций...', 'info');
            
            try {
                const response = await fetch(`${API_BASE}/finance/transactions`, {
                    headers: {
                        'Authorization': AUTH_HEADER
                    }
                });
                
                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}`);
                }
                
                const data = await response.json();
                console.log('Транзакции загружены:', data);
                
                if (data.success && data.data) {
                    displayTransactions(data.data);
                    showStatus(`Загружено ${data.data.length} транзакций`, 'success');
                } else {
                    showStatus('Ошибка: ' + (data.error || 'Неизвестная ошибка'), 'danger');
                }
            } catch (error) {
                console.error('Ошибка загрузки:', error);
                showStatus('Ошибка загрузки: ' + error.message, 'danger');
            }
        }
        
        function displayTransactions(transactions) {
            const container = document.getElementById('transactionsList');
            
            if (!transactions || transactions.length === 0) {
                container.innerHTML = `
                    <div class="list-group-item text-center py-4">
                        <div class="text-muted">
                            <i class="fas fa-receipt fa-2x mb-2"></i>
                            <p class="mb-0">Нет транзакций</p>
                        </div>
                    </div>
                `;
                return;
            }
            
            const transactionsHtml = transactions.map(transaction => {
                const date = new Date(transaction.date || transaction.created_at);
                const formattedDate = date.toLocaleDateString('ru-RU');
                const isIncome = transaction.type === 'income';
                const amount = Math.abs(transaction.amount);
                const categoryName = transaction.category ? transaction.category.name : 'Без категории';
                
                return `
                    <div class="list-group-item d-flex justify-content-between align-items-center">
                        <div>
                            <h6 class="mb-1">${transaction.description}</h6>
                            <p class="mb-1"><small class="text-muted">${transaction.notes || ''}</small></p>
                            <small class="text-muted">
                                ${formattedDate} | ${categoryName}
                            </small>
                        </div>
                        <div class="d-flex align-items-center">
                            <span class="badge bg-${isIncome ? 'success' : 'danger'} me-2">
                                ${isIncome ? '+' : '-'}${amount.toLocaleString('ru-RU')} ₽
                            </span>
                            <button class="btn btn-sm btn-outline-danger" 
                                    onclick="deleteTransaction(${transaction.id}, '${transaction.description}')"
                                    title="Удалить">
                                <i class="fas fa-trash"></i>
                            </button>
                        </div>
                    </div>
                `;
            }).join('');
            
            container.innerHTML = transactionsHtml;
        }
        
        async function deleteTransaction(transactionId, description) {
            console.log('Удаление транзакции:', transactionId, description);
            
            if (!confirm(`Вы уверены, что хотите удалить транзакцию "${description}"?\\n\\nЭто действие нельзя отменить.`)) {
                return;
            }
            
            showStatus(`Удаление транзакции "${description}"...`, 'warning');
            
            try {
                const response = await fetch(`${API_BASE}/finance/transactions/${transactionId}`, {
                    method: 'DELETE',
                    headers: {
                        'Authorization': AUTH_HEADER
                    }
                });
                
                const result = await response.json();
                console.log('Ответ сервера:', result);
                
                if (result.success) {
                    showStatus('Транзакция успешно удалена!', 'success');
                    // Обновляем список
                    await loadTransactions();
                } else {
                    showStatus('Ошибка удаления: ' + (result.error || result.message || 'Неизвестная ошибка'), 'danger');
                }
            } catch (error) {
                console.error('Ошибка:', error);
                showStatus('Ошибка при удалении: ' + error.message, 'danger');
            }
        }
        
        async function createTestTransaction() {
            console.log('Создание тестовой транзакции...');
            showStatus('Создание тестовой транзакции...', 'info');
            
            const testData = {
                amount: Math.floor(Math.random() * 1000) + 100,
                type: Math.random() > 0.5 ? 'income' : 'expense',
                description: `Тестовая транзакция ${new Date().toLocaleTimeString('ru-RU')}`,
                date: new Date().toISOString(),
                category_id: 1,
                notes: 'Автоматически созданная тестовая транзакция'
            };
            
            try {
                const response = await fetch(`${API_BASE}/finance/transactions`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': AUTH_HEADER
                    },
                    body: JSON.stringify(testData)
                });
                
                const result = await response.json();
                console.log('Ответ сервера:', result);
                
                if (result.success) {
                    showStatus('Тестовая транзакция создана!', 'success');
                    // Обновляем список
                    await loadTransactions();
                } else {
                    showStatus('Ошибка создания: ' + (result.error || result.message || 'Неизвестная ошибка'), 'danger');
                }
            } catch (error) {
                console.error('Ошибка:', error);
                showStatus('Ошибка при создании: ' + error.message, 'danger');
            }
        }
        
        function showStatus(message, type) {
            const statusDiv = document.getElementById('status');
            statusDiv.innerHTML = `
                <div class="alert alert-${type} alert-dismissible fade show" role="alert">
                    ${message}
                    <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
                </div>
            `;
        }
        
        // Автоматически загружаем транзакции при загрузке страницы
        document.addEventListener('DOMContentLoaded', loadTransactions);
    </script>
</body>
</html>